(this["webpackJsonpqp-ampd-app"]=this["webpackJsonpqp-ampd-app"]||[]).push([[3],{1e3:function(e,t,i){"use strict";i.d(t,"a",(function(){return x}));var n=i(2),a=i(3),r=i(5),o=i(6),s=i(0),c=(i(15),i(4)),l=i(14),u=(i(18),i(1)),h=i(8),d=(i(12),i(21),i(22),i(37)),p=i(86),f=i(36),v=i(24),g=i(9),b=i(138),m=i(429),y=i(564),O=i(53),_=i(174),j=i(565),w=l.a.getLogger("esri.views.interactive.GraphicManipulator"),x=function(e){Object(r.a)(i,e);var t=Object(o.a)(i);function i(e){var a;return Object(n.a)(this,i),(a=t.call(this,e)).layer=null,a.interactive=!0,a.selectable=!1,a.grabbable=!0,a.dragging=!1,a.cursor=null,a.events=new p.a.EventEmitter,a._circleCollisionCache=null,a._graphicSymbolChangedHandle=null,a._originalSymbol=null,a}return Object(a.a)(i,[{key:"graphic",set:function(e){"mesh"!==Object(c.f)(e.geometry,"type")?(this._circleCollisionCache=null,this._originalSymbol=e.symbol,this._set("graphic",e),this.attachSymbolChanged()):w.error("Mesh geometries are not supported")}},{key:"elevationInfo",get:function(){var e="elevationInfo"in this.graphic.layer&&this.graphic.layer.elevationInfo,t=Object(_.e)(this.graphic),i=e?e.offset:0;return new m.a({mode:t,offset:i})}},{key:"focusedSymbol",set:function(e){e!==this._get("focusedSymbol")&&(this._set("focusedSymbol",e),this._updateGraphicSymbol(),this._circleCollisionCache=null)}},{key:"grabbableForEvent",value:function(){return!0}},{key:"grabbing",set:function(e){e!==this._get("grabbing")&&(this._set("grabbing",e),this._updateGraphicSymbol())}},{key:"hovering",set:function(e){e!==this._get("hovering")&&(this._set("hovering",e),this._updateGraphicSymbol())}},{key:"selected",set:function(e){e!==this._get("selected")&&(this._set("selected",e),this._updateGraphicSymbol(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}},{key:"_focused",get:function(){return this._get("hovering")||this._get("grabbing")}},{key:"destroy",value:function(){this.detachSymbolChanged(),this._resetGraphicSymbol(),this._set("view",null)}},{key:"intersectionDistance",value:function(e){var t=this._get("graphic");if(!1===t.visible)return null;var i=this._get("focusedSymbol"),n=Object(c.h)(i)?i:t.symbol,a=t.geometry;return Object(c.g)(a)?null:"2d"===this.view.type?this._intersectDistance2D(this.view,e,a,n):this._intersectDistance3D(this.view,e,t)}},{key:"attach",value:function(){this.attachSymbolChanged(),Object(c.h)(this.layer)&&this.layer.add(this.graphic)}},{key:"detach",value:function(){this.detachSymbolChanged(),this._resetGraphicSymbol(),Object(c.h)(this.layer)&&this.layer.remove(this.graphic)}},{key:"attachSymbolChanged",value:function(){var e=this;this.detachSymbolChanged(),this._graphicSymbolChangedHandle=this.graphic.watch("symbol",(function(t){Object(c.h)(t)&&t!==e.focusedSymbol&&t!==e._originalSymbol&&(e._originalSymbol=t,e._focused&&Object(c.h)(e.focusedSymbol)&&(e.graphic.symbol=e.focusedSymbol))}),!0)}},{key:"detachSymbolChanged",value:function(){Object(c.h)(this._graphicSymbolChangedHandle)&&(this._graphicSymbolChangedHandle.remove(),this._graphicSymbolChangedHandle=null)}},{key:"_updateGraphicSymbol",value:function(){this.graphic.symbol=this._focused&&Object(c.h)(this.focusedSymbol)?this.focusedSymbol:this._originalSymbol}},{key:"_resetGraphicSymbol",value:function(){this.graphic.symbol=this._originalSymbol}},{key:"_intersectDistance2D",value:function(e,t,i,n){if(n=n||Object(y.e)(i),Object(c.g)(n))return null;var a=this._circleCollisionCache;if("point"!==i.type||"simple-marker"!==n.type)return Object(j.b)(t,i,e)?1:null;if(Object(c.g)(a)||!a.originalPoint.equals(i)){var r=i,o=e.spatialReference;if(Object(b.b)(r.spatialReference,o)){var s=Object(b.i)(r,o);a={originalPoint:r.clone(),mapPoint:s,radiusPx:Object(f.g)(n.size)},this._circleCollisionCache=a}}if(Object(c.h)(a)){var l=Object(f.i)(t,S),u=e.toScreen(a.mapPoint),h=a.radiusPx,d=u.x+Object(f.g)(n.xoffset),p=u.y-Object(f.g)(n.yoffset);return Object(O.j)(l,[d,p])<h*h?1:null}return null}},{key:"_intersectDistance3D",value:function(e,t,i){var n=e.toMap(t,{include:[i]});return n&&Object(b.m)(n,M,e.renderSpatialReference)?Object(g.l)(M,e.state.camera.eye):null}}]),i}(d.a);Object(s.a)([Object(u.b)({constructOnly:!0,nonNullable:!0})],x.prototype,"graphic",null),Object(s.a)([Object(u.b)({readOnly:!0,dependsOn:["graphic"]})],x.prototype,"elevationInfo",null),Object(s.a)([Object(u.b)({constructOnly:!0,nonNullable:!0})],x.prototype,"view",void 0),Object(s.a)([Object(u.b)({value:null})],x.prototype,"focusedSymbol",null),Object(s.a)([Object(u.b)({constructOnly:!0})],x.prototype,"layer",void 0),Object(s.a)([Object(u.b)()],x.prototype,"interactive",void 0),Object(s.a)([Object(u.b)()],x.prototype,"selectable",void 0),Object(s.a)([Object(u.b)()],x.prototype,"grabbable",void 0),Object(s.a)([Object(u.b)({value:!1})],x.prototype,"grabbing",null),Object(s.a)([Object(u.b)()],x.prototype,"dragging",void 0),Object(s.a)([Object(u.b)()],x.prototype,"hovering",null),Object(s.a)([Object(u.b)({value:!1})],x.prototype,"selected",null),Object(s.a)([Object(u.b)()],x.prototype,"cursor",void 0),x=Object(s.a)([Object(h.a)("esri.views.interactive.GraphicManipulator")],x);var M=Object(v.e)(),S=Object(f.f)()},1003:function(e,t,i){"use strict";i.d(t,"a",(function(){return _}));var n,a,r,o,s,c,l,u,h,d,p,f,v,g,b=i(30),m=i(31),y=i(566);function O(e){var t=e.fragment.code;t.add(Object(m.a)(n||(n=Object(b.a)(["\n    vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)\n    {\n      return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;\n    }\n    "])))),t.add(Object(m.a)(a||(a=Object(b.a)(["\n    float integratedRadiance(float cosTheta2, float roughness)\n    {\n      return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);\n    }\n    "])))),t.add(Object(m.a)(r||(r=Object(b.a)(["\n    vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)\n    {\n      float cosTheta2 = 1.0 - RdotNG * RdotNG;\n      float intRadTheta = integratedRadiance(cosTheta2, roughness);\n\n      // Calculate the integrated directional radiance of the ground and the sky\n      float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;\n      float sky = 2.0 - ground;\n      return (ground * ambientGround + sky * ambientSky) * 0.5;\n    }\n    "]))))}function _(e,t){var i=e.fragment.code;e.include(y.a),3===t.pbrMode||4===t.pbrMode?(i.add(Object(m.a)(o||(o=Object(b.a)(["\n    struct PBRShadingWater\n    {\n        float NdotL;   // cos angle between normal and light direction\n        float NdotV;   // cos angle between normal and view direction\n        float NdotH;   // cos angle between normal and half vector\n        float VdotH;   // cos angle between view direction and half vector\n        float LdotH;   // cos angle between light direction and half vector\n        float VdotN;   // cos angle between view direction and normal vector\n    };\n\n    float dtrExponent = ",";\n    "])),t.useCustomDTRExponentForWater?"2.2":"2.0")),i.add(Object(m.a)(s||(s=Object(b.a)(["\n    vec3 fresnelReflection(float angle, vec3 f0, float f90) {\n      return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);\n    }\n    "])))),i.add(Object(m.a)(c||(c=Object(b.a)(["\n    float normalDistributionWater(float NdotH, float roughness)\n    {\n      float r2 = roughness * roughness;\n      float NdotH2 = NdotH * NdotH;\n      float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;\n      return r2 / denom;\n    }\n    "])))),i.add(Object(m.a)(l||(l=Object(b.a)(["\n    float geometricOcclusionKelemen(float LoH)\n    {\n        return 0.25 / (LoH * LoH);\n    }\n    "])))),i.add(Object(m.a)(u||(u=Object(b.a)(["\n    vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)\n    {\n      vec3  F = fresnelReflection(props.VdotH, F0, F0Max);\n      float dSun = normalDistributionWater(props.NdotH, roughness);\n      float V = geometricOcclusionKelemen(props.LdotH);\n\n      float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);\n      float strengthSunHaze  = 1.2;\n      float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;\n\n      return ((dSun + dSunHaze) * V) * F;\n    }\n\n    vec3 tonemapACES(const vec3 x) {\n      return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);\n    }\n    "]))))):1!==t.pbrMode&&2!==t.pbrMode||(e.include(O),i.add(Object(m.a)(h||(h=Object(b.a)(["\n    struct PBRShadingInfo\n    {\n        float NdotL;                  // cos angle between normal and light direction\n        float NdotV;                  // cos angle between normal and view direction\n        float NdotH;                  // cos angle between normal and half vector\n        float VdotH;                  // cos angle between view direction and half vector\n        float LdotH;                  // cos angle between view light direction and half vector\n        float NdotNG;                 // cos angle between normal and normal of the ground\n        float RdotNG;                 // cos angle between view direction reflected of the normal and normal of the ground\n        float NdotAmbDir;             // cos angle between view direction and the fill light in ambient illumination\n        float NdotH_Horizon;          // cos angle between normal and half vector defined with horizon illumination\n        vec3 skyRadianceToSurface;         // integrated radiance of the sky based on the surface roughness (used for specular reflection)\n        vec3 groundRadianceToSurface;      // integrated radiance of the ground based on the surface roughness (used for specular reflection)\n        vec3 skyIrradianceToSurface;       // irradiance of the sky (used for diffuse reflection)\n        vec3 groundIrradianceToSurface;    // irradiance of the ground (used for diffuse reflection)\n\n        float averageAmbientRadiance;      // average ambient radiance used to deduce black level in gamut mapping\n        float ssao;                   // ssao coefficient\n        vec3 albedoLinear;            // linear color of the albedo\n        vec3 f0;                      // fresnel value at normal incident light\n        vec3 f90;                     // fresnel value at 90o of incident light\n\n        vec3 diffuseColor;            // diffuse color of the material used in environment illumination\n        float metalness;              // metalness of the material\n        float roughness;              // roughness of the material\n    };\n    "])))),i.add(Object(m.a)(d||(d=Object(b.a)(["\n    float normalDistribution(float NdotH, float roughness)\n    {\n        float a = NdotH * roughness;\n        float b = roughness / (1.0 - NdotH * NdotH + a * a);\n        return b * b * INV_PI;\n    }\n    "])))),i.add(Object(m.a)(p||(p=Object(b.a)(["\n    const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);\n    const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);\n    const vec2 c2 = vec2(-1.04, 1.04);\n\n    vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {\n        vec4 r = roughness * c0 + c1;\n        float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;\n        return c2 * a004 + r.zw;\n    }\n    "])))),i.add(Object(m.a)(f||(f=Object(b.a)(["\n    vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {\n      vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);\n      vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);\n\n      // From diffuse illumination calculate reflected color\n      vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;\n\n      // From specular illumination calculate reflected color\n      vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);\n      vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;\n      vec3 specularComponent = specularColor * indirectSpecular;\n\n      return (diffuseComponent + specularComponent);\n    }\n    "])))),i.add(Object(m.a)(v||(v=Object(b.a)(["\n    float gamutMapChanel(float x, vec2 p){\n      return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );\n    }"])))),i.add(Object(m.a)(g||(g=Object(b.a)(["\n    vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){\n      vec3 outColor;\n      vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));\n      outColor.x = gamutMapChanel(inColor.x, p) ;\n      outColor.y = gamutMapChanel(inColor.y, p) ;\n      outColor.z = gamutMapChanel(inColor.z, p) ;\n      return outColor;\n    }\n    "])))))}},1019:function(e,t,i){"use strict";i.d(t,"a",(function(){return O})),i.d(t,"b",(function(){return x})),i.d(t,"c",(function(){return w})),i.d(t,"d",(function(){return _})),i.d(t,"e",(function(){return T})),i.d(t,"f",(function(){return D}));var n=i(3),a=i(2),r=i(4),o=i(24),s=i(9),c=i(87),l=i(263),u=i(117),h=i(292),d=i(116),p=i(220),f=i(90),v=i(518),g=i(76),b=(i(586),i(587)),m=i(55),y=i(431);var O=function e(){Object(a.a)(this,e),this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2},_=function(){function e(){Object(a.a)(this,e),this._transform=Object(u.b)(),this._transformInverse=new j({value:this._transform},c.a,u.b),this._transformInverseTranspose=new j(this._transformInverse,c.b,u.b),this._transformTranspose=new j({value:this._transform},c.b,u.b),this._transformInverseRotation=new j({value:this._transform},p.b,l.a)}return Object(n.a)(e,[{key:"invalidateLazyTransforms",value:function(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}},{key:"transform",get:function(){return this._transform}},{key:"inverse",get:function(){return this._transformInverse.value}},{key:"inverseTranspose",get:function(){return this._transformInverseTranspose.value}},{key:"inverseRotation",get:function(){return this._transformInverseRotation.value}},{key:"transpose",get:function(){return this._transformTranspose.value}},{key:"setTransformMatrix",value:function(e){Object(c.c)(this._transform,e)}},{key:"multiplyTransform",value:function(e){Object(c.l)(this._transform,this._transform,e)}},{key:"set",value:function(e){Object(c.c)(this._transform,e),this.invalidateLazyTransforms()}},{key:"setAndInvalidateLazyTransforms",value:function(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this.invalidateLazyTransforms()}}]),e}(),j=function(){function e(t,i,n){Object(a.a)(this,e),this.original=t,this.update=i,this.dirty=!0,this.transform=n()}return Object(n.a)(e,[{key:"invalidate",value:function(){this.dirty=!0}},{key:"value",get:function(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform}}]),e}(),w=function(){function e(){Object(a.a)(this,e),this.min=new x,this.max=new x,this.hud=new x,this.ground=new x}return Object(n.a)(e,[{key:"init",value:function(e){this.min.init(e),this.max.init(e),this.hud.init(e),this.ground.init(e),this.all=[]}}]),e}(),x=function(){function e(t){Object(a.a)(this,e),this.normal=Object(o.e)(),this.transformation=Object(u.b)(),this._ray=m.e.create(),this.init(t)}return Object(n.a)(e,[{key:"ray",get:function(){return this._ray}},{key:"hasIntersectionPoint",get:function(){return null!=this.dist}},{key:"distanceInRenderSpace",get:function(){if(null!=this.dist)return Object(s.b)(C,this.ray.direction,this.dist),Object(s.m)(C)}},{key:"getIntersectionPoint",value:function(e){return!!this.hasIntersectionPoint&&(Object(s.b)(C,this.ray.direction,this.dist),Object(s.c)(e,this.ray.origin,C),!0)}},{key:"getTransformedNormal",value:function(e){return Object(s.h)(P,this.normal),P[3]=0,Object(f.m)(P,P,this.transformation),Object(s.h)(e,P),Object(s.o)(e,e),e}},{key:"init",value:function(e){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",e?m.e.copy(e,this._ray):this._ray=m.e.create()}},{key:"set",value:function(e,t,i,n,a,r,l,u,h,d){e instanceof y.a&&(e={type:"stage",obj:e}),this.dist=i,Object(s.h)(this.normal,n),Object(c.c)(this.transformation,a),this.target=e,this.name=t,this.drapedLayerOrder=r,this.center=l?Object(o.d)(l):null,this.geometryId=u,this.triangleNr=h,this.drapedLayerGraphicOrder=d}},{key:"copyFrom",value:function(e){m.e.copy(e._ray,this._ray),this.dist=e.dist,this.target=e.target,this.name=e.name,this.drapedLayerOrder=e.drapedLayerOrder,this.center=e.center?Object(o.d)(e.center):null,this.geometryId=e.geometryId,this.triangleNr=e.triangleNr,this.intersector=e.intersector,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,Object(s.h)(this.normal,e.normal),Object(c.c)(this.transformation,e.transformation)}},{key:"toOwner",value:function(e){if(!this.target)return null;switch(this.target.type){case"stage":return M(this.target.obj.metadata,e);case"external":switch(this.intersector){case"PointRenderer":return function(e,t){var i=e.metadata.layerUid;return null!=i?t.map.findLayerByUid(i):null}(this.target,e);case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return M(this.target.metadata,e);case"TerrainRenderer":return e.map&&e.map.ground}}return null}},{key:"toGraphic",value:function(e){if(!this.target)return null;switch(this.target.type){case"stage":return S(this.target.obj.metadata,e);case"external":switch(this.intersector){case"PointRenderer":return this.target.metadata.createGraphic();case"I3S":case"IM":case"LodRenderer":case"OverlayRenderer":return S(this.target.metadata,e)}}return null}}]),e}();function M(e,t){return Object(r.g)(e)||null==e.layerUid?null:Object(r.h)(t.graphicsView)&&e.layerUid===t.graphicsView.mockLayerId?t.graphics:t.map.findLayerByUid(e.layerUid)}function S(e,t){if(Object(r.g)(e))return null;var i=M(e,t);if(Object(r.g)(i))return null;if(i===t.graphics)return Object(r.h)(t.graphicsView)?Object(r.n)(t.graphicsView.getGraphicFromGraphicUid(e.graphicUid)):null;var n,a,o=t.allLayerViews.find((function(e){return e.layer===i}));return o?(a=e,!(n=o)||n.suspended?null:"getGraphicFromIntersectorMetadata"in n&&a?n.getGraphicFromIntersectorMetadata(a):"getGraphicFromGraphicUid"in n&&null!=a.graphicUid?n.getGraphicFromGraphicUid(a.graphicUid):null):null}var k=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;Object(a.a)(this,e),this.offset=t,this.tmpVertex=Object(o.e)()}return Object(n.a)(e,[{key:"applyToVertex",value:function(e,t,i){var n=e+this.localOrigin[0],a=t+this.localOrigin[1],r=i+this.localOrigin[2],o=this.offset/Math.sqrt(n*n+a*a+r*r);return this.tmpVertex[0]=e+n*o,this.tmpVertex[1]=t+a*o,this.tmpVertex[2]=i+r*o,this.tmpVertex}},{key:"applyToAabb",value:function(e){var t=e[0]+this.localOrigin[0],i=e[1]+this.localOrigin[1],n=e[2]+this.localOrigin[2],a=e[3]+this.localOrigin[0],r=e[4]+this.localOrigin[1],o=e[5]+this.localOrigin[2],s=this.offset/Math.sqrt(t*t+i*i+n*n);e[0]+=t*s,e[1]+=i*s,e[2]+=n*s;var c=this.offset/Math.sqrt(a*a+r*r+o*o);return e[3]+=a*c,e[4]+=r*c,e[5]+=o*c,e}}]),e}(),R=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;Object(a.a)(this,e),this.offset=t,this.componentLocalOriginLength=0,this.tmpVertex=Object(o.e)(),this.mbs=Object(d.c)(),this.obb={center:Object(o.e)(),halfSize:Object(g.b)(),quaternion:null}}return Object(n.a)(e,[{key:"localOrigin",set:function(e){this.componentLocalOriginLength=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}},{key:"applyToVertex",value:function(e,t,i){var n=e,a=t,r=i+this.componentLocalOriginLength,o=this.offset/Math.sqrt(n*n+a*a+r*r);return this.tmpVertex[0]=e+n*o,this.tmpVertex[1]=t+a*o,this.tmpVertex[2]=i+r*o,this.tmpVertex}},{key:"applyToAabb",value:function(e){var t=e[0],i=e[1],n=e[2]+this.componentLocalOriginLength,a=e[3],r=e[4],o=e[5]+this.componentLocalOriginLength,s=this.offset/Math.sqrt(t*t+i*i+n*n);e[0]+=t*s,e[1]+=i*s,e[2]+=n*s;var c=this.offset/Math.sqrt(a*a+r*r+o*o);return e[3]+=a*c,e[4]+=r*c,e[5]+=o*c,e}},{key:"applyToMbs",value:function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this.offset/t;return this.mbs[0]=e[0]+e[0]*i,this.mbs[1]=e[1]+e[1]*i,this.mbs[2]=e[2]+e[2]*i,this.mbs[3]=e[3]+e[3]*this.offset/t,this.mbs}},{key:"applyToObb",value:function(e){var t=e.center,i=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);this.obb.center[0]=t[0]+t[0]*i,this.obb.center[1]=t[1]+t[1]*i,this.obb.center[2]=t[2]+t[2]*i,Object(s.r)(this.obb.halfSize,e.halfSize,e.quaternion),Object(s.c)(this.obb.halfSize,this.obb.halfSize,e.center);var n=this.offset/Math.sqrt(this.obb.halfSize[0]*this.obb.halfSize[0]+this.obb.halfSize[1]*this.obb.halfSize[1]+this.obb.halfSize[2]*this.obb.halfSize[2]);return this.obb.halfSize[0]+=this.obb.halfSize[0]*n,this.obb.halfSize[1]+=this.obb.halfSize[1]*n,this.obb.halfSize[2]+=this.obb.halfSize[2]*n,Object(s.g)(this.obb.halfSize,this.obb.halfSize,e.center),Object(v.a)(I,e.quaternion),Object(s.r)(this.obb.halfSize,this.obb.halfSize,I),this.obb.halfSize[0]*=this.obb.halfSize[0]<0?-1:1,this.obb.halfSize[1]*=this.obb.halfSize[1]<0?-1:1,this.obb.halfSize[2]*=this.obb.halfSize[2]<0?-1:1,this.obb.quaternion=e.quaternion,this.obb}}]),e}(),E=new(function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;Object(a.a)(this,e),this.offset=t,this.sphere=Object(b.a)(),this.tmpVertex=Object(o.e)()}return Object(n.a)(e,[{key:"applyToVertex",value:function(e,t,i){var n=this.objectTransform.transform,a=n[0]*e+n[4]*t+n[8]*i+n[12],r=n[1]*e+n[5]*t+n[9]*i+n[13],o=n[2]*e+n[6]*t+n[10]*i+n[14],s=this.offset/Math.sqrt(a*a+r*r+o*o);a+=a*s,r+=r*s,o+=o*s;var c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*a+c[4]*r+c[8]*o+c[12],this.tmpVertex[1]=c[1]*a+c[5]*r+c[9]*o+c[13],this.tmpVertex[2]=c[2]*a+c[6]*r+c[10]*o+c[14],this.tmpVertex}},{key:"applyToMinMax",value:function(e,t){var i=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*i,e[1]+=e[1]*i,e[2]+=e[2]*i;var n=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*n,t[1]+=t[1]*n,t[2]+=t[2]*n}},{key:"applyToAabb",value:function(e){var t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;var i=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*i,e[4]+=e[4]*i,e[5]+=e[5]*i,e}},{key:"applyToBoundingSphere",value:function(e,t){var i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),n=this.offset/i;return this.sphere.center[0]=t[0]+t[0]*n,this.sphere.center[1]=t[1]+t[1]*n,this.sphere.center[2]=t[2]+t[2]*n,this.sphere.radius=e+e*this.offset/i,this.sphere}}]),e}());function D(e){return Object(r.h)(e)?(E.offset=e,E):null}new R;new k;var T="terrain",C=(Object(o.e)(),Object(o.e)()),P=Object(d.c)(),I=Object(h.a)()},1033:function(e,t,i){"use strict";i.d(t,"a",(function(){return v})),i.d(t,"b",(function(){return a}));var n=i(2);function a(e,t,i){var n,a,c,l,u,h=t&&t.length,f=h?t[0]*i:e.length,v=r(e,0,f,i,!0),g=new Array;if(!v||v.next===v.prev)return g;if(h&&(v=function(e,t,i,n){for(var a=new Array,s=0,c=t.length;s<c;s++){var l=r(e,t[s]*n,s<c-1?t[s+1]*n:e.length,n,!1);l===l.next&&(l.steiner=!0),a.push(d(l))}a.sort(w);for(var u=0,h=a;u<h.length;u++){p(h[u],i),i=o(i,i.next)}return i}(e,t,v,i)),e.length>80*i){n=c=e[0],a=l=e[1];for(var b=i;b<f;b+=i){var m=e[b],y=e[b+1];n=Math.min(n,m),a=Math.min(a,y),c=Math.max(c,m),l=Math.max(l,y)}u=0!==(u=Math.max(c-n,l-a))?1/u:0}return s(v,g,i,n,a,u),g}function r(e,t,i,n,a){var r;if(a===m(e,t,i,n)>0)for(var o=t;o<i;o+=n)r=u(o,e[o],e[o+1],r);else for(var s=i-n;s>=t;s-=n)r=u(s,e[s],e[s+1],r);return r&&j(r,r.next)&&(h(r),r=r.next),r}function o(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;if(!e)return e;var i,n=e;do{if(i=!1,n.steiner||!j(n,n.next)&&0!==g(n.prev,n,n.next))n=n.next;else{if(h(n),(n=t=n.prev)===n.next)break;i=!0}}while(i||n!==t);return t}function s(e,t,i,n,a,r){var u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(e){!u&&r&&(e=f(e,n,a,r));for(var d=e;e.prev!==e.next;){var p=e.prev,v=e.next;if(r?l(e,n,a,r):c(e))t.push(p.index/i),t.push(e.index/i),t.push(v.index/i),h(e),e=v.next,d=v.next;else if((e=v)===d){u?1===u?s(e=x(e,t,i),t,i,n,a,r,2):2===u&&M(e,t,i,n,a,r):s(o(e),t,i,n,a,r,1);break}}}}function c(e){var t=e.prev,i=e,n=e.next;if(g(t,i,n)>=0)return!1;for(var a=e.next.next,r=a,o=0;a!==e.prev&&(0===o||a!==r);){if(o++,y(t.x,t.y,i.x,i.y,n.x,n.y,a.x,a.y)&&g(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}function l(e,t,i,n){var a=e.prev,r=e,o=e.next;if(g(a,r,o)>=0)return!1;for(var s=a.x<r.x?a.x<o.x?a.x:o.x:r.x<o.x?r.x:o.x,c=a.y<r.y?a.y<o.y?a.y:o.y:r.y<o.y?r.y:o.y,l=a.x>r.x?a.x>o.x?a.x:o.x:r.x>o.x?r.x:o.x,u=a.y>r.y?a.y>o.y?a.y:o.y:r.y>o.y?r.y:o.y,h=_(s,c,t,i,n),d=_(l,u,t,i,n),p=e.prevZ,f=e.nextZ;p&&p.z>=h&&f&&f.z<=d;){if(p!==e.prev&&p!==e.next&&y(a.x,a.y,r.x,r.y,o.x,o.y,p.x,p.y)&&g(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,f!==e.prev&&f!==e.next&&y(a.x,a.y,r.x,r.y,o.x,o.y,f.x,f.y)&&g(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;p&&p.z>=h;){if(p!==e.prev&&p!==e.next&&y(a.x,a.y,r.x,r.y,o.x,o.y,p.x,p.y)&&g(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;f&&f.z<=d;){if(f!==e.prev&&f!==e.next&&y(a.x,a.y,r.x,r.y,o.x,o.y,f.x,f.y)&&g(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function u(e,t,i,n){var a=new R(e,t,i);return n?(a.next=n.next,a.prev=n,n.next.prev=a,n.next=a):(a.prev=a,a.next=a),a}function h(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function d(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function p(e,t){if(t=function(e,t){var i,n=t,a=e.x,r=e.y,o=-1/0;do{if(r<=n.y&&r>=n.next.y&&n.next.y!==n.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=a&&s>o){if(o=s,s===a){if(r===n.y)return n;if(r===n.next.y)return n.next}i=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!i)return null;if(a===o)return i.prev;var c,l=i,u=i.x,h=i.y,d=1/0;for(n=i.next;n!==l;)a>=n.x&&n.x>=u&&a!==n.x&&y(r<h?a:o,r,u,h,r<h?o:a,r,n.x,n.y)&&(((c=Math.abs(r-n.y)/(a-n.x))<d||c===d&&n.x>i.x)&&O(n,e)&&(i=n,d=c)),n=n.next;return i}(e,t)){var i=k(t,e);o(i,i.next)}}function f(e,t,i,n){for(var a;a!==e;a=a.next){if(null===(a=a||e).z&&(a.z=_(a.x,a.y,t,i,n)),a.prev.next!==a||a.next.prev!==a)return a.prev.next=a,a.next.prev=a,f(e,t,i,n);a.prevZ=a.prev,a.nextZ=a.next}return e.prevZ.nextZ=null,e.prevZ=null,function(e){for(var t,i=1;;){var n=void 0,a=e;e=null,t=null;for(var r=0;a;){r++,n=a;for(var o=0;o<i&&n;o++)n=n.nextZ;for(var s=i;o>0||s>0&&n;){var c=void 0;0===o?(c=n,n=n.nextZ,s--):0!==s&&n?a.z<=n.z?(c=a,a=a.nextZ,o--):(c=n,n=n.nextZ,s--):(c=a,a=a.nextZ,o--),t?t.nextZ=c:e=c,c.prevZ=t,t=c}a=n}if(t.nextZ=null,i*=2,r<2)return e}}(e)}function v(e,t,i,n){var a=t&&t.length,r=a?t[0]*i:e.length,o=Math.abs(m(e,0,r,i));if(a)for(var s=0,c=t.length;s<c;s++){var l=t[s]*i,u=s<c-1?t[s+1]*i:e.length;o-=Math.abs(m(e,l,u,i))}for(var h=0,d=0;d<n.length;d+=3){var p=n[d]*i,f=n[d+1]*i,v=n[d+2]*i;h+=Math.abs((e[p]-e[v])*(e[f+1]-e[p+1])-(e[p]-e[f])*(e[v+1]-e[p+1]))}return 0===o&&0===h?0:Math.abs((h-o)/o)}function g(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function b(e,t,i,n){return!!(j(e,t)&&j(i,n)||j(e,n)&&j(i,t))||g(e,t,i)>0!=g(e,t,n)>0&&g(i,n,e)>0!=g(i,n,t)>0}function m(e,t,i,n){for(var a=0,r=t,o=i-n;r<i;r+=n)a+=(e[o]-e[r])*(e[r+1]+e[o+1]),o=r;return a}function y(e,t,i,n,a,r,o,s){return(a-o)*(t-s)-(e-o)*(r-s)>=0&&(e-o)*(n-s)-(i-o)*(t-s)>=0&&(i-o)*(r-s)-(a-o)*(n-s)>=0}function O(e,t){return g(e.prev,e,e.next)<0?g(e,t,e.next)>=0&&g(e,e.prev,t)>=0:g(e,t,e.prev)<0||g(e,e.next,t)<0}function _(e,t,i,n,a){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*a)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*a)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function j(e,t){return e.x===t.x&&e.y===t.y}function w(e,t){return e.x-t.x}function x(e,t,i){var n=e;do{var a=n.prev,r=n.next.next;!j(a,r)&&b(a,n,n.next,r)&&O(a,r)&&O(r,a)&&(t.push(a.index/i),t.push(n.index/i),t.push(r.index/i),h(n),h(n.next),n=e=r),n=n.next}while(n!==e);return n}function M(e,t,i,n,a,r){var c=e;do{for(var l=c.next.next;l!==c.prev;){if(c.index!==l.index&&S(c,l)){var u=k(c,l);return c=o(c,c.next),u=o(u,u.next),s(c,t,i,n,a,r),void s(u,t,i,n,a,r)}l=l.next}c=c.next}while(c!==e)}function S(e,t){return e.next.index!==t.index&&e.prev.index!==t.index&&!function(e,t){var i=e;do{if(i.index!==e.index&&i.next.index!==e.index&&i.index!==t.index&&i.next.index!==t.index&&b(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&O(e,t)&&O(t,e)&&function(e,t){var i=e,n=!1,a=(e.x+t.x)/2,r=(e.y+t.y)/2;do{i.y>r!=i.next.y>r&&i.next.y!==i.y&&a<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)}function k(e,t){var i=new R(e.index,e.x,e.y),n=new R(t.index,t.x,t.y),a=e.next,r=t.prev;return e.next=t,t.prev=e,i.next=a,a.prev=i,n.next=i,i.prev=n,r.next=n,n.prev=r,n}var R=function e(t,i,a){Object(n.a)(this,e),this.index=t,this.x=i,this.y=a,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}},1082:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var n=i(44);function a(e,t,i){var a=e.byteLength/(4*t),l=new Uint32Array(e,0,a*t),u=new Uint32Array(a),h=i&&i.minReduction||0,d=i&&i.originalIndices||null,p=i&&i.componentOffsets||null,f=0;if(p)for(var v=0;v<p.length-1;v++){var g=p[v+1]-p[v];g>f&&(f=g)}else f=a;var b=Math.floor(1.1*f)+1;(null==c||c.length<2*b)&&(c=new Uint32Array(Object(n.n)(2*b)));for(var m=0;m<2*b;m++)c[m]=0;for(var y=0,O=!!p&&!!d,_=O?d.length:a,j=O?new Uint32Array(d.length):null,w=1.96,x=0!==h?Math.ceil(4*w*w/(h*h)*h*(1-h)):_,M=1,S=p?p[1]:_,k=0;k<_;k++){if(k===x){var R=1-y/k;if(R+w*Math.sqrt(R*(1-R)/k)<h)return null;x*=2}if(k===S){for(var E=0;E<2*b;E++)c[E]=0;if(d)for(var D=p[M-1];D<p[M];D++)j[D]=u[d[D]];S=p[++M]}for(var T=O?d[k]:k,C=T*t,P=s(l,C,t),I=P%b,A=y;0!==c[2*I+1];){if(c[2*I]===P){var L=c[2*I+1]-1;if(r(l,C,L*t,t)){A=u[L];break}}++I>=b&&(I-=b)}A===y&&(c[2*I]=P,c[2*I+1]=T+1,y++),u[T]=A}if(0!==h&&1-y/a<h)return null;if(O){for(var G=p[M-1];G<j.length;G++)j[G]=u[d[G]];u=j}var z=new Uint32Array(t*y);y=0;for(var V=0;V<_;V++)u[V]===y&&(o(l,(O?d[V]:V)*t,z,y*t,t),y++);if(d&&!O){for(var F=new Uint32Array(d.length),H=0;H<F.length;H++)F[H]=u[d[H]];u=F}return{buffer:z.buffer,indices:u,uniqueCount:y}}function r(e,t,i,n){for(var a=0;a<n;a++)if(e[t+a]!==e[i+a])return!1;return!0}function o(e,t,i,n,a){for(var r=0;r<a;r++)i[n+r]=e[t+r]}function s(e,t,i){for(var n=0,a=0;a<i;a++)n=(n=e[t+a]+n|0)+(n<<11)+(n>>>2)|0;return n>>>0}var c=null},1083:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var n,a=i(30),r=i(31),o=i(1123);function s(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(o.b),e.fragment.code.add(Object(r.a)(n||(n=Object(a.a)(["\n      const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);\n\n      vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {\n        return 2.0 * texture2D(_tex, _uv).rg - 1.0;\n      }\n\n      float sampleNoiseTexture(vec2 _uv) {\n        return texture2D(texWavePerturbation, _uv).b;\n      }\n\n      vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {\n        return 2.0 * texture2D(_tex, _uv).rgb - 1.0;\n      }\n\n      float computeProgress(vec2 uv, float time) {\n        return fract(time);\n      }\n\n      float computeWeight(vec2 uv, float time) {\n        float progress = computeProgress(uv, time);\n        return 1.0 - abs(1.0 - 2.0 * progress);\n      }\n\n      vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {\n        float flowStrength = waveParams[2];\n        float flowOffset = waveParams[3];\n\n        vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;\n\n        float progress = computeProgress(uv, time + phaseOffset);\n        float weight = computeWeight(uv, time + phaseOffset);\n\n        vec2 result = uv;\n        result -= flowVector * (progress + flowOffset);\n        result += phaseOffset;\n        result += (time - progress) * FLOW_JUMP;\n\n        return vec3(result, weight);\n      }\n\n      const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;\n      const float TIME_NOISE_STRENGTH = 7.77;\n\n      vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {\n        float waveStrength = waveParams[0];\n\n        // overall directional shift in uv's for directional wave movement for\n        // now we do a hard coded scale for wave speed such that a unit length\n        // direction is not too fast.\n        vec2 waveMovement = time * -_waveDir;\n\n        float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;\n\n        // compute two perturbed uvs and blend weights\n        // then sample the wave normals at the two positions and blend\n        vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);\n        vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);\n\n        vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;\n        vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;\n\n        // logic to flatten the wave pattern\n        // scale xy components of the normal, then adjust z (up) component\n        vec3 mixNormal = normalize(normal_A + normal_B);\n        mixNormal.xy *= waveStrength;\n        mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));\n\n        return mixNormal;\n      }\n\n      vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {\n        float waveTextureRepeat = waveParams[1];\n        vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);\n        float foam  = normals2FoamIntensity(normal, waveParams[0]);\n        return vec4(normal, foam);\n      }\n    "]))))}(s||(s={})).bindUniforms=function(e,t){e.setUniform1i("texWaveNormal",0),e.setUniform1i("texWavePerturbation",1),e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}},1084:function(e,t,i){"use strict";i.d(t,"a",(function(){return k})),i.d(t,"b",(function(){return S}));var n,a,r,o,s,c,l,u,h,d,p=i(30),f=i(31),v=i(560),g=i(237),b=i(340),m=i(202),y=i(241),O=i(238),_=i(986),j=i(1083),w=i(999),x=i(1124),M=i(1156);function S(e){var t=new g.a;return t.include(v.a,{linearDepth:!1}),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),0!==e.output&&7!==e.output||(t.include(x.a,e),t.include(w.a,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),t.vertex.code.add(Object(f.a)(n||(n=Object(p.a)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vuv = uv0;\n        vpos = position;\n\n        vnormal = getLocalUp(vpos, localOrigin);\n        vtbnMatrix = getTBNMatrix(vnormal);\n\n        gl_Position = transformPosition(proj, view, vpos);\n        ","\n      }\n    "])),f.a.float(O.c),0===e.output?"forwardLinearDepth();":""))),7===e.output&&(t.include(m.a,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(Object(f.a)(a||(a=Object(p.a)(["\n        void main() {\n          discardBySlice(vpos);\n\n          gl_FragColor = vec4(waterColor.a);\n        }\n      "]))))),0===e.output&&(t.include(j.a,e),t.include(m.a,e),e.receiveShadows&&t.include(_.a,e),t.include(M.a,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(b.a),t.fragment.code.add(Object(f.a)(r||(r=Object(p.a)(["\n      void main() {\n        discardBySlice(vpos);\n        vec3 localUp = vnormal;\n        // the created normal is in tangent space\n        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n\n        // we rotate the normal according to the tangent-bitangent-normal-Matrix\n        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);\n        vec3 v = -normalize(vpos - camPos);\n        vec3 l = normalize(-lightingMainDirection);\n        float shadow = ",";\n        vec4 vPosView = view*vec4(vpos, 1.0);\n        vec4 final = vec4(getSeaColor(n, v, l, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);\n\n        // gamma correction\n        gl_FragColor = delinearizeGamma(final);\n        gl_FragColor = highlightSlice(gl_FragColor, vpos);\n        ","\n      }\n    "])),e.receiveShadows?Object(f.a)(o||(o=Object(p.a)(["1.0 - readShadowMap(vpos, linearDepth)"]))):"1.0",e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""))),2===e.output&&(t.include(x.a,e),t.include(j.a,e),t.include(m.a,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(Object(f.a)(s||(s=Object(p.a)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vuv = uv0;\n          vpos = position;\n\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),f.a.float(O.c))),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(Object(f.a)(c||(c=Object(p.a)(["\n        void main() {\n          discardBySlice(vpos);\n\n          // the created normal is in tangent space and foam\n          vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n          tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);\n\n          gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);\n        }\n    "]))))),5===e.output&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(Object(f.a)(l||(l=Object(p.a)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vpos = position;\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),f.a.float(O.c))),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(Object(f.a)(u||(u=Object(p.a)(["\n        void main() {\n          gl_FragColor = waterColor;\n        }\n    "]))))),4===e.output&&(t.include(y.a),t.varyings.add("vpos","vec3"),t.vertex.code.add(Object(f.a)(h||(h=Object(p.a)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n      }\n    "])),f.a.float(O.c))),t.include(m.a,e),t.fragment.code.add(Object(f.a)(d||(d=Object(p.a)(["\n      void main() {\n        discardBySlice(vpos);\n        outputHighlight();\n      }\n    "]))))),t}var k=Object.freeze({__proto__:null,build:S})},1085:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return c}));var n,a=i(30),r=i(31),o=i(237),s=i(575);function c(){var e=new o.a;return e.include(s.a),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(Object(r.a)(n||(n=Object(a.a)(["\n    void main() {\n      vec4 texColor = texture2D(tex, uv);\n      gl_FragColor = texColor * color;\n    }\n  "])))),e}var l=Object.freeze({__proto__:null,build:c})},1086:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var n,a,r=i(30),o=i(31);!function(e){e.builder=function(e,t){e.vertex.uniforms.add("camPos","vec3").add("perScreenPixelRatio","float").add("screenSize","float"),e.vertex.code.add(Object(o.a)(n||(n=Object(r.a)(["\n    float computeRenderPixelSizeAt( vec3 pWorld ){\n      vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);\n      float viewDirectionDistance = abs(dot(viewForward, pWorld - camPos));\n      return viewDirectionDistance*perScreenPixelRatio;\n    }\n\n    vec3 screenSizeScaling(vec3 position, vec3 anchor){\n      return position * screenSize * computeRenderPixelSizeAt(anchor) + anchor;\n    }\n  "]))))},e.bindPassUniforms=function(e,t,i){e.setUniform1f("perScreenPixelRatio",i.camera.perScreenPixelRatio),e.setUniform1f("screenSize",t.screenSize)}}(a||(a={}))},1087:function(e,t,i){"use strict";i.d(t,"a",(function(){return _})),i.d(t,"b",(function(){return O}));var n,a,r,o,s,c,l,u,h,d=i(30),p=i(31),f=i(560),v=i(237),g=i(340),b=i(202),m=i(238),y=i(1086);function O(e){var t=new v.a;return t.include(f.a,{linearDepth:!1}),t.include(y.a.builder,{}),t.include(b.a,e),t.fragment.include(g.a),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.fragment.uniforms.add("color","vec4"),t.attributes.add("position","vec3"),t.varyings.add("vWorldPosition","vec3"),e.screenSizeEnabled&&t.attributes.add("offset","vec3"),e.shadingEnabled&&(t.vertex.uniforms.add("viewNormal","mat4"),t.fragment.uniforms.add("shadedColor","vec4").add("shadingDirection","vec3"),t.attributes.add("normal","vec3"),t.varyings.add("vViewNormal","vec3")),t.vertex.code.add(Object(p.a)(n||(n=Object(d.a)(["\n    void main(void) {\n      vWorldPosition = ",";\n  "])),e.screenSizeEnabled?"screenSizeScaling(offset, position)":"position")),e.shadingEnabled&&t.vertex.code.add(Object(p.a)(a||(a=Object(d.a)(["\n      vec3 worldNormal = normal;\n      vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;\n    "])))),t.vertex.code.add(Object(p.a)(r||(r=Object(d.a)(["\n    gl_Position = transformPosition(proj, view, vWorldPosition);\n  }\n  "])))),t.fragment.code.add(Object(p.a)(o||(o=Object(d.a)(["\n    void main() {\n      discardBySlice(vWorldPosition);\n    "])))),e.shadingEnabled?t.fragment.code.add(Object(p.a)(s||(s=Object(d.a)(["\n      vec3 viewNormalNorm = normalize(vViewNormal);\n      float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);\n      vec4 finalColor = mix(color, shadedColor, shadingFactor);\n    "])))):t.fragment.code.add(Object(p.a)(c||(c=Object(d.a)(["\n      vec4 finalColor = color;\n    "])))),t.fragment.code.add(Object(p.a)(l||(l=Object(d.a)(["\n      if (finalColor.a < ",") {\n        discard;\n      }\n      ","\n\n      ","\n    }\n    "])),p.a.float(m.c),7===e.output?Object(p.a)(u||(u=Object(d.a)(["gl_FragColor = vec4(finalColor.a);"]))):"",0===e.output?Object(p.a)(h||(h=Object(d.a)(["gl_FragColor = highlightSlice(finalColor, vWorldPosition); ",""])),e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""):"")),t}var _=Object.freeze({__proto__:null,build:O})},1123:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return s}));var n,a,r=i(30),o=i(31);function s(e){e.fragment.code.add(Object(o.a)(n||(n=Object(r.a)(["\n    float normals2FoamIntensity(vec3 n, float waveStrength){\n      float normalizationFactor =  max(0.015, waveStrength);\n      return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);\n    }\n  "]))))}function c(e){e.fragment.code.add(Object(o.a)(a||(a=Object(r.a)(["\n    vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){\n      return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;\n    }\n  "]))))}},1124:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var n,a,r,o,s=i(30),c=i(31);function l(e,t){1===t.viewingMode?e.vertex.code.add(Object(c.a)(n||(n=Object(s.a)(["\n      vec3 getLocalUp(in vec3 pos, in vec3 origin) {\n          return normalize(pos + origin);\n      }\n    "])))):e.vertex.code.add(Object(c.a)(a||(a=Object(s.a)(["\n      vec3 getLocalUp(in vec3 pos, in vec3 origin) {\n          return vec3(0.0, 0.0, 1.0); // WARNING: up-axis dependent code\n      }\n    "])))),1===t.viewingMode?e.vertex.code.add(Object(c.a)(r||(r=Object(s.a)(["\n        mat3 getTBNMatrix(in vec3 n) {\n            vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));\n            vec3 b = normalize(cross(n, t));\n            return mat3(t, b, n);\n        }\n    "])))):e.vertex.code.add(Object(c.a)(o||(o=Object(s.a)(["\n        mat3 getTBNMatrix(in vec3 n) {\n            vec3 t = vec3(1.0, 0.0, 0.0);\n            vec3 b = normalize(cross(n, t));\n            return mat3(t, b, n);\n        }\n    "]))))}},1155:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var n,a,r=i(30),o=i(31),s=i(616);function c(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMat","mat4"),e.fragment.uniforms.add("rpProjectionMat","mat4"),e.fragment.code.add(Object(o.a)(n||(n=Object(r.a)(["\n  vec2 reprojectionCoordinate(vec3 projectionCoordinate)\n  {\n    vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);\n    vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);\n    reprojectedCoord.xy /= reprojectedCoord.w;\n    return reprojectedCoord.xy*0.5 + 0.5;\n  }\n  "]))))}function l(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("ssrViewMat","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.include(s.a),e.include(c),e.fragment.code.add(Object(o.a)(a||(a=Object(r.a)(["\n  const int maxSteps = ","\n\n  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)\n  {\n    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);\n    projectedCoord.xy /= projectedCoord.w;\n    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;\n    return projectedCoord;\n  }\n\n  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)\n  {\n    vec3 viewPos = startPosition;\n    vec3 viewPosEnd = startPosition;\n\n    // Project the start position to the screen\n    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);\n    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space\n    float k0 = 1.0/ projectedCoordStart.w;\n\n    // advance the position in the direction of the reflection\n    viewPos += dir;\n\n    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);\n\n    // Project the advanced position to the screen\n    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);\n    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space\n    float k1 = 1.0/ projectedCoordEnd.w;\n\n    // calculate the reflection direction in the screen space\n    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);\n    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);\n\n    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);\n\n    float projectedCoordDirLength = length(projectedCoordDir);\n    float maxSt = float(maxSteps);\n\n    // normalize the projection direction depending on maximum steps\n    // this determines how blocky the reflection looks\n    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);\n\n    // Normalize the homogeneous camera space coordinates\n    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);\n    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);\n\n    // initialize the variables for ray marching\n    vec2 P = projectedCoordStart.xy;\n    vec3 Q = Q0;\n    float k = k0;\n    float rayStartZ = -startPosition.z; // estimated ray start depth value\n    float rayEndZ = -startPosition.z;   // estimated ray end depth value\n    float prevEstimateZ = -startPosition.z;\n    float rayDiffZ = 0.0;\n    float dDepth;\n    float depth;\n    float rayDiffZOld = 0.0;\n\n    // early outs\n    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)\n      return vec3(P, 0.0);\n\n    for(int i = 0; i < maxSteps-1; i++)\n    {\n      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer\n\n      // estimate depth of the marching ray\n      rayStartZ = prevEstimateZ;\n      dDepth = -rayStartZ - depth;\n      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));\n      rayDiffZ = rayEndZ- rayStartZ;\n      prevEstimateZ = rayEndZ;\n\n      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )\n      {\n        return vec3(P, 0.);\n      }\n\n      // If we detect a hit - return the intersection point, two conditions:\n      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth\n      //  - if difference between dDepth and rayDiffZOld is not too large\n      //  - if difference between dDepth and 0.025/abs(k) is not too large\n      //  - if the sampled depth is not behind far plane or in front of near plane\n\n      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)\n      {\n          return vec3(P, depth);\n      }\n\n      // continue with ray marching\n      P += dP;\n      Q.z += dQ.z;\n      k += dk;\n      rayDiffZOld = rayDiffZ;\n    }\n    return vec3(P, 0.0);\n  }\n  "])),t.highStepCount?"150;":"75;"))}(c||(c={})).bindUniforms=function(e,t,i){e.setUniform1i("lastFrameColorMap",i.lastFrameColorTextureID),t.bindTexture(i.lastFrameColorTexture,i.lastFrameColorTextureID),e.setUniformMatrix4fv("reprojectionMat",i.reprojectionMat),e.setUniformMatrix4fv("rpProjectionMat",i.camera.projectionMatrix)},(l||(l={})).bindUniforms=function(e,t,i){i.ssrEnabled&&(e.setUniform1i("depthMapView",i.linearDepthTextureID),t.bindTexture(i.linearDepthTexture,i.linearDepthTextureID),e.setUniform2fv("nearFar",i.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",i.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/i.camera.height),c.bindUniforms(e,t,i))}},1156:function(e,t,i){"use strict";i.d(t,"a",(function(){return p}));var n,a=i(30),r=i(31),o=i(1155),s=i(1123);function c(e){e.fragment.code.add(Object(r.a)(n||(n=Object(a.a)(["\n    const float GAMMA = 2.2;\n    const float INV_GAMMA = 0.4545454545;\n\n    vec4 delinearizeGamma(vec4 color) {\n      return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);\n    }\n\n    vec3 linearizeGamma(vec3 color) {\n      return pow(color, vec3(GAMMA));\n    }\n  "]))))}var l,u,h,d=i(1003);function p(e,t){e.include(d.a,t),e.include(c),e.include(s.a),t.ssrEnabled&&e.include(o.a,t),e.fragment.code.add(Object(r.a)(l||(l=Object(a.a)(["\n    const vec3 fresnelSky =  vec3(0.02, 1.0, 15.0); // f0, f0max, exp\n    const vec2 fresnelMaterial =  vec2(0.02, 0.1); // f0, f0max for specular term\n    const float roughness = 0.015;\n    const float foamIntensityExternal = 1.7;\n    const float ssrIntensity = 0.65;\n    const float ssrHeightFadeStart = 300000.0;\n    const float ssrHeightFadeEnd = 500000.0;\n    const float waterDiffusion = 0.775;\n    const float waterSeeColorMod = 0.8;\n    const float correctionViewingPowerFactor = 0.4;\n\n    const vec3 skyZenitColor = vec3(0.52, 0.68, 0.90);\n    const vec3 skyColor = vec3(0.67, 0.79, 0.9);\n\n    PBRShadingWater shadingInfo;\n\n    /*\n    *   This function is an approximation for the sky gradient reflected\n    *   the water surface and describes a combination of two fresnel terms.\n    *   @parameter: cosTheta = is the result of max(dot(n,v), 0.0)\n    *   @parameter: horizon = the dominant color of the sky horizon\n    *   @parameter: cosTheta = the dominant color of the sky zenit\n    */\n    vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {\n      float exponent = pow((1.0 - cosTheta), fresnelSky[2]);\n      return mix(zenit, horizon, exponent);\n    }\n\n    /*\n    *   This function determines the water color per pixel.\n    *   @parameter: n = normal facing away from the surface\n    *   @parameter: v = view direction facing away from the surface.\n    *   @parameter: l = light direction facing away from the surface\n    *   @parameter: lightIntensity = light intensity, currently between 0...PI\n    *   @parameter: localUp = a normal for the general direction of the surface\n    *   @parameter: shadow = the amount of shadow at this pixel (0 = no shadow)\n    */\n    vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {\n\n      float reflectionHit = 0.;\n      vec3 seaWaterColor = linearizeGamma(color);\n      // using half vector to determine the specular light\n      vec3 h = normalize(l + v);\n      shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);\n      shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);\n      shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);\n      shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);\n      shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);\n      shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);\n\n      // angle between vertex normal and view direction\n      float upDotV = max(dot(localUp,v), 0.0);\n      // reflected sky color: the reflected sky color consists of two main colors, the\n      // reflected color at the horizon and the reflected color of the zenit.\n      // the reflected sky color is then an approximation based on the fresnel term.\n      vec3 skyHorizon = linearizeGamma(skyColor);\n      vec3 skyZenit = linearizeGamma(skyZenitColor);\n      vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );\n\n      // we use the upDotL to smoothen out the\n      // reflected color of the water\n      float upDotL = max(dot(localUp,l),0.0);\n\n      // The approximated sky color is adjusted according to the sun position.\n      // This is done as approximation for e.g. night views.\n      float daytimeMod = 0.1 + upDotL * 0.9;\n      skyColor *= daytimeMod;\n\n      // If a water surface is in shadow we just use a slight darkening of the\n      // water surface expressed with this shadowModifier.\n      float shadowModifier = clamp(shadow, 0.8, 1.0);\n\n      // The reflected sky color consists of the fresnel reflection multiplied with the approximated sky color.\n      // The shadow is influencing the frensel term to keep the shadow impression for really near views. As long\n      // as reflection are absent there is a need to have a slight shadow for depth perception.\n      vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);\n      vec3 reflSky = fresnelModifier * skyColor * shadowModifier;\n\n      // The reflected sea color is the input water color combined with the reflected sky color.\n      // The reflected sky color is modified by the incoming light.\n      vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;\n\n      vec3 specular = vec3(0.0);\n      // This prevents the specular light to be rendered when:\n      // - sun is behind a polygon (e.g. sundown for elevated polygons where nDotL might be still ok)\n      // - viewer is under water (for this localUp is better than n)\n      if(upDotV > 0.0 && upDotL > 0.0) {\n        // calculate the cook torrance BRDF but with simplified occlusion\n        vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);\n\n        // Normalize light intensity to be between 0...1. Shadow cancels out specular light here\n        vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;\n\n        specular = shadingInfo.NdotL * incidentLight * specularSun;\n      }\n\n      vec3 foam = vec3(0.0);\n      if(upDotV > 0.0) {\n        foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);\n      }\n      "])))),t.ssrEnabled?e.fragment.code.add(Object(r.a)(u||(u=Object(a.a)(["\n      // Convert the world position to view position\n      vec4 viewPosition = vec4(positionView.xyz, 1.0);\n      vec3 viewDir = normalize(viewPosition.xyz);\n      vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);\n      vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);\n      vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);\n\n      // at steeper viewing angles we use more of a vertex normal (in this case up) then the wave normal\n      // this removes some artifacts of normal mapping\n      float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);\n      vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);\n\n      vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));\n\n      // perform screen space reflection to detect hit\n      vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);\n      vec3 reflectedColor = vec3(0.0);\n\n      // if there is a hit with ssr find reflected color from the reprojeted frame\n      if (hitCoordinate.z > 0.0)\n      {\n        vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);\n\n        // fade out if there if the hit is near end of Y axis\n        vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));\n        float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);\n        reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;\n\n        reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;\n      }\n      float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);\n      // combining reflected sky, reflected sea, specular highlight and SSR reflections.\n      return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);\n    }\n  "])))):e.fragment.code.add(Object(r.a)(h||(h=Object(a.a)(["\n      // combining reflected sky, reflected sea, specular highlight and SSR reflections.\n      return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);\n    }\n  "]))))}},1224:function(e,t,i){"use strict";i.r(t),i.d(t,"DrawOperation",(function(){return n.a})),i.d(t,"DrawGraphicTool",(function(){return On})),i.d(t,"GraphicMoveTool",(function(){return rr})),i.d(t,"GraphicReshapeTool",(function(){return Or})),i.d(t,"GraphicTransformTool",(function(){return Rr}));var n=i(581),a=i(10),r=i(2),o=i(3),s=i(5),c=i(6),l=i(0),u=i(15),h=i(4),d=i(14),p=(i(18),i(1)),f=i(8),v=(i(12),i(21),i(22),i(86)),g=i(80),b=i(300),m=i(174),y=i(455),O=i(573),_=i(395),j=i(118),w=i(40),x=i(43),M=i(320),S=i(116),k=i(13),R=(i(290),i(112)),E=i(345),D=(i(516),function(){function e(){Object(r.a)(this,e),this.cache=new Map}return Object(o.a)(e,[{key:"dispose",value:function(){this.cache.forEach((function(e){Object(h.h)(e.texture)&&(e.texture.dispose(),e.texture=null)})),this.cache.clear()}},{key:"acquire",value:function(e){if(Object(h.g)(e))return null;var t=this.patternId(e),i=this.cache.get(t);if(i)return i.refCount++,i.bind;var n=this.patternToTextureData(e,2),a=n.length/2,r={refCount:1,texture:null,bind:function(e,t){return Object(h.g)(r.texture)&&(r.texture=new R.a(e,{width:n.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},n)),e.bindTexture(r.texture,t),a}};return this.cache.set(t,r),r.bind}},{key:"release",value:function(e){if(!Object(h.g)(e)){var t=this.patternId(e),i=this.cache.get(t);i&&(i.refCount--,0===i.refCount&&(Object(h.h)(i.texture)&&i.texture.dispose(),this.cache.delete(t)))}}},{key:"swap",value:function(e,t){var i=this.acquire(t);return this.release(e),i}},{key:"patternId",value:function(e){return e.join(",")}},{key:"patternToTextureData",value:function(e,t){var i,n=e.reduce((function(e,t){return e+t}))*t,a=new Uint8Array(n),r=!0,o=0,s=Object(k.a)(e);try{for(s.s();!(i=s.n()).done;){for(var c=i.value,l=0;l<c*t;l++)a[o++]=r?255:0;r=!r}}catch(u){s.e(u)}finally{s.f()}return a}}]),e}());function T(e){return Object(h.g)(e)?e:e.slice()}var C={main:new x.a([255,127,0]),selected:new x.a([255,255,255]),staged:new x.a([12,207,255]),outline:new x.a([0,0,0,.5]),selectedOutline:new x.a([255,255,255])};function P(e,t){var i=e.clone();return i.a*=t,i}function I(e,t){var i=e.clone(),n=Object(M.b)(i);n.s*=t;var a=Object(M.d)(n);return i.r=a.r,i.g=a.g,i.b=a.b,i}function A(e,t){if(t)for(var i in t)e[i]=t[i]}var L=function e(t){Object(r.a)(this,e),this.color=C.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=16,A(this,t)},G=function(){function e(t){Object(r.a)(this,e),this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=C.main,this.outlineColor=C.outline,this.renderOccluded=16,this.hoverOutlineColor=C.selectedOutline,A(this,t)}return Object(o.a)(e,[{key:"apply",value:function(e,t){var i=this[e];t.setParameterValues({color:B(i),transparent:"color"!==e||i.a<1,renderOccluded:this.renderOccluded})}}]),e}(),z=function e(t){Object(r.a)(this,e),this.vertex=new G({color:C.main,outlineColor:C.outline}),this.edge=new G({color:I(P(C.main,2/3),.5),outlineColor:P(C.outline,.5),size:8,collisionPadding:8}),this.selected=new G({color:C.selected,outlineColor:C.outline}),A(this,t)},V=function(){function e(t){Object(r.a)(this,e),this.color=C.selected,this.width=1.5,this.stipplePattern=T([5,5]),this.stippleOffColor=C.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=C.selected,this.renderOccluded=4,A(this,t)}return Object(o.a)(e,[{key:"apply",value:function(e){e.color=B(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=B(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=B(this.innerColor),e.renderOccluded=this.renderOccluded}}]),e}(),F=function(){function e(t){Object(r.a)(this,e),this.color=C.selected,this.size=4,this.outlineSize=1,this.outlineColor=C.outline,this.shape="square",A(this,t)}return Object(o.a)(e,[{key:"apply",value:function(e){e.color=B(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=B(this.outlineColor),e.primitive=this.shape}}]),e}(),H=function(){function e(t){Object(r.a)(this,e),this.innerColor=C.selected,this.innerWidth=1,this.glowColor=C.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.3,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=C.main,A(this,t)}return Object(o.a)(e,[{key:"apply",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i={glowColor:x.a.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:x.a.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*t,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=i:e.laserlineStyle=i}}]),e}(),N=function e(t){Object(r.a)(this,e),this.outline=new V({color:C.outline,renderOccluded:8,stippleOffColor:C.selected,stipplePattern:T([5,5]),width:1.5,innerWidth:0}),this.staged=new V({color:C.selected,renderOccluded:8,innerColor:C.staged,stippleOffColor:C.outline,stipplePattern:T([5,5]),width:1.5}),this.shadowStyle=new H({globalAlpha:.3,glowColor:C.main,glowFalloff:8,glowWidth:8,innerColor:C.selected,innerWidth:1}),A(this,t)},U=function e(t){Object(r.a)(this,e),this.outline=new F({color:C.selected,outlineColor:C.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new H({globalAlpha:.3,glowColor:C.main,glowFalloff:1.5,glowWidth:6,innerColor:C.selected,innerWidth:1,radius:2}),A(this,t)},W=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this)).extensionType=2,A(Object(w.a)(n),e),n}return i}(V),q=function e(t){Object(r.a)(this,e),this.lineGraphics=new N,this.pointGraphics=new U,this.heightPlane=new H({globalAlpha:.3,glowColor:C.main,glowFalloff:8,glowWidth:8,innerColor:C.selected,innerWidth:1}),this.heightBox=new H({globalAlpha:.3,glowColor:C.main,glowFalloff:8,glowWidth:8,innerColor:C.selected,innerWidth:0,heightFillColor:C.main}),this.zVerticalLine=new W({color:P(C.main,.5),falloff:2,innerColor:P(C.selected,0),renderOccluded:4,stipplePattern:null,width:5,extensionType:2}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,A(this,t)};function B(e){return Object(S.g)(x.a.toUnitRGBA(e))}var Z=new(function(){function e(t){Object(r.a)(this,e),this.visualElements=new q,this.reshapeManipulators=new z,this.zManipulator=new L,A(this,t)}return Object(o.a)(e,[{key:"colorToVec4",value:function(e){return B(e)}}]),e}()),Y=i(24),X=i(9),Q=i(138),K=i(90),J=i(165),$=i(195),ee=i(221),te=i(582),ie=i(175),ne=i(89),ae=i(354),re=i(289),oe=i(87),se=i(117),ce=i(26),le=i(536),ue=i(222),he=function(){function e(t,i,n,a,o,s,c){Object(r.a)(this,e),this.uniqueName=null,this.shaderTransformationDirty=!0,this.data=t.toRenderData(),this.boundingInfo=i,this.material=n,this.origin=null,this.center=Object(Y.e)(),this.bsRadius=0,this.transformation=null,this.calculateShaderTransformation=o,a&&this.updateTransformation(a,s),this.castShadow=c,this.instanceParameters={highlights:null,occludees:null,visible:!0}}return Object(o.a)(e,[{key:"updateTransformation",value:function(e,t){this.transformation=e,this.shaderTransformationDirty=!0,this.bsRadius=this.getBoundingSphere(e,t,this.center)}},{key:"shaderTransformationChanged",value:function(){this.shaderTransformationDirty=!0}},{key:"getBoundingSphere",value:function(e,t,i){return t=t||Object(re.f)(e),Object(X.j)(i,this.boundingInfo.getCenter(),e),this.boundingInfo.getBSRadius()*t}},{key:"hasShaderTransformation",get:function(){return!!this.calculateShaderTransformation}},{key:"getShaderTransformation",value:function(){return this.calculateShaderTransformation?(this.shaderTransformationDirty&&(this.shaderTransformation||(this.shaderTransformation=Object(se.b)()),Object(oe.c)(this.shaderTransformation,this.calculateShaderTransformation(Object(h.o)(this.transformation,se.a))),this.shaderTransformationDirty=!1),this.shaderTransformation):Object(h.o)(this.transformation,se.a)}},{key:"computeAttachmentOrigin",value:function(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&(Object(h.h)(this.transformation)&&Object(X.j)(e,e,this.transformation),!0);var t=this.getIndices(ce.a.POSITION),i=this.getAttribute(ce.a.POSITION);return!!Object(ee.c)(i,t,e)&&(Object(h.h)(this.transformation)&&Object(X.j)(e,e,this.transformation),!0)}},{key:"getIndices",value:function(e){return"indices"in this.data?this.data.indices[e]:null}},{key:"getAttribute",value:function(e){return"vertexAttr"in this.data?this.data.vertexAttr[e]:null}},{key:"addHighlight",value:function(){var e=Object(le.a)(0),t=this.instanceParameters;return t.highlights=Object(ue.b)(t.highlights,e),e}},{key:"removeHighlight",value:function(e){var t=this.instanceParameters;t.highlights=Object(ue.f)(t.highlights,e)}}]),e}(),de=i(111),pe=i(44),fe=i(137);i(1033),i(1082);function ve(e,t,i){for(var n=e.length,a=new Array(n),r=new Array(n),o=new Array(n),s=0,c=0,l=0,u=0,h=0;h<n;++h)u+=e[h].length;for(var d=new Float64Array(3*u),p=0,f=n-1;f>=0;f--){var v=e[f],g=1===i&&!Object(fe.f)(v,!1,!1);if(g&&1!==n)a[s++]=v;else{for(var b=v.length,m=0;m<s;++m)b+=a[m].length;var y={index:p,pathLengths:new Array(s+1),count:b,holeIndices:new Array(s)};y.pathLengths[0]=v.length,v.length>0&&(o[l++]={index:p,count:v.length}),p=g?ge(v,v.length-1,-1,d,p,v.length,t):ge(v,0,1,d,p,v.length,t);for(var O=0;O<s;++O){var _=a[O];y.holeIndices[O]=p,y.pathLengths[O+1]=_.length,_.length>0&&(o[l++]={index:p,count:_.length}),p=ge(_,0,1,d,p,_.length,t)}s=0,y.count>0&&(r[c++]=y)}}for(var j=0;j<s;++j){var w=a[j];w.length>0&&(o[l++]={index:p,count:w.length}),p=ge(w,0,1,d,p,w.length,t)}return c<n&&(r.length=c),l<n&&(o.length=l),{position:d,polygons:r,outlines:o}}function ge(e,t,i,n,a,r,o){a*=3;for(var s=0;s<r;++s){var c=e[t];n[a++]=c[0],n[a++]=c[1],n[a++]=o?c[2]:0,t+=i}return a/3}var be=i(147),me=i(577),ye=i(32),Oe=i(7),_e=i.n(Oe),je=i(16),we=i(140),xe=i(37),Me=i(60),Se=i(29),ke=i(437),Re=i(72),Ee=i(389),De=i(472),Te=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(Y.e)(),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(Y.g)(.57735,.57735,.57735),n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];Object(r.a)(this,e),this.intensity=t,this.direction=i,this.castShadows=n},Ce=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(Y.e)(),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(Y.g)(.57735,.57735,.57735);Object(r.a)(this,e),this.intensity=Object(Y.e)(),this.direction=Object(Y.e)(),this.intensity=t,this.direction=i},Pe=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(Y.e)();Object(r.a)(this,e),this.intensity=t},Ie=function e(){Object(r.a)(this,e),this.sh={r:[0],g:[0],b:[0]}},Ae=i(1019),Le=i(36),Ge=i(53),ze=i(229),Ve=i(55),Fe=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;Object(r.a)(this,e),this._viewUp=Object(Y.e)(),this._viewForward=Object(Y.e)(),this._viewRight=Object(Y.e)(),this._ray=Ve.e.createWrapper(),this._viewport=Object(S.d)(0,0,1,1),this._padding=Object(S.d)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Object(Re.d)(1,1e3),this._viewDirty=!0,this._viewMatrix=Object(se.b)(),this._projectionDirty=!0,this._projectionMatrix=Object(se.b)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Object(se.b)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Object(se.b)(),this._frustumDirty=!0,this._frustum=Ve.b.create(),this._fullViewport=Object(S.c)(),this._contextNavigation=!0,this.pixelRatio=1,this.relativeElevation=0,this._eye=Object(h.h)(t)?Object(Y.d)(t):Object(Y.e)(),this._center=Object(h.h)(i)?Object(Y.d)(i):Object(Y.e)(),this._up=Object(h.h)(n)?Object(Y.d)(n):Object(Y.g)(0,0,1)}return Object(o.a)(e,[{key:"eye",get:function(){return this._eye},set:function(e){this._compareAndSetView(e,this._eye)}},{key:"center",get:function(){return this._center},set:function(e){this._compareAndSetView(e,this._center)}},{key:"ray",get:function(){return this._ray.origin=this.eye,this._ray.direction||(this._ray.direction=Object(Y.e)()),Object(X.g)(this._ray.direction,this.center,this.eye),this._ray}},{key:"up",get:function(){return this._up},set:function(e){this._compareAndSetView(e,this._up)}},{key:"viewMatrix",get:function(){return this._ensureViewClean(),this._viewMatrix},set:function(e){Object(oe.c)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"viewForward",get:function(){return this._ensureViewClean(),this._viewForward}},{key:"viewUp",get:function(){return this._ensureViewClean(),this._viewUp}},{key:"viewRight",get:function(){return this._ensureViewClean(),this._viewRight}},{key:"nearFar",get:function(){return this._nearFar}},{key:"near",get:function(){return this._nearFar[0]},set:function(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"far",get:function(){return this._nearFar[1]},set:function(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewport",get:function(){return this._viewport},set:function(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}},{key:"x",get:function(){return this._viewport[0]},set:function(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"y",get:function(){return this._viewport[1]},set:function(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"width",get:function(){return this._viewport[2]},set:function(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"height",get:function(){return this._viewport[3]},set:function(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"fullWidth",get:function(){return this._viewport[2]+this._padding[1]+this._padding[3]},set:function(e){this.width=e-(this._padding[1]+this._padding[3])}},{key:"fullHeight",get:function(){return this._viewport[3]+this._padding[0]+this._padding[2]},set:function(e){this.height=e-(this._padding[0]+this._padding[2])}},{key:"fullViewport",get:function(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}},{key:"aspect",get:function(){return this.width/this.height}},{key:"padding",get:function(){return this._padding},set:function(e){this._padding[0]===e[0]&&this._padding[1]===e[1]&&this._padding[2]===e[2]&&this._padding[3]===e[3]||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),Object(K.c)(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewProjectionMatrix",get:function(){return this._viewProjectionDirty&&(Object(oe.l)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}},{key:"projectionMatrix",get:function(){if(this._projectionDirty){var e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2),n=i*this.aspect;Object(oe.h)(this._projectionMatrix,-n*(1+2*this._padding[3]/e),n*(1+2*this._padding[1]/e),-i*(1+2*this._padding[2]/t),i*(1+2*this._padding[0]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix},set:function(e){Object(oe.c)(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovX",get:function(){return Object(ce.c)(this._fov,this.width,this.height)},set:function(e){this._fov=Object(ce.e)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovY",get:function(){return Object(ce.d)(this._fov,this.width,this.height)},set:function(e){this._fov=Object(ce.f)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"distance",get:function(){return Object(X.l)(this._center,this._eye)}},{key:"frustum",get:function(){return this._recomputeFrustum(),this._frustum}},{key:"viewInverseTransposeMatrix",get:function(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Object(oe.a)(this._viewInverseTransposeMatrix,this.viewMatrix),Object(oe.b)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}},{key:"depthNDCToWorld",value:function(e){var t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}},{key:"perRenderPixelRatio",get:function(){return Math.tan(this.fovX/2)/(this.width/2)}},{key:"perScreenPixelRatio",get:function(){return this.perRenderPixelRatio*this.pixelRatio}},{key:"aboveGround",get:function(){return this.relativeElevation&&this.relativeElevation>=0}},{key:"copyFrom",value:function(e){var t=e;return Object(X.h)(this._eye,t._eye),Object(X.h)(this._center,t._center),Object(X.h)(this._up,t._up),Object(K.c)(this._viewport,t._viewport),Object(K.c)(this._padding,t._padding),Object(Ge.c)(this._nearFar,t._nearFar),this._fov=t._fov,this.relativeElevation=e.relativeElevation,this._viewDirty=t._viewDirty,this._viewDirty||(Object(oe.c)(this._viewMatrix,t._viewMatrix),Object(X.h)(this._viewRight,t._viewRight),Object(X.h)(this._viewUp,t._viewUp),Object(X.h)(this._viewForward,t._viewForward)),t._projectionDirty?this._projectionDirty=!0:(Object(oe.c)(this._projectionMatrix,t._projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(Ve.b.copy(t._frustum,this._frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Object(oe.c)(this._viewInverseTransposeMatrix,t._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Object(K.c)(this._fullViewport,t._fullViewport),this.pixelRatio=e.pixelRatio,this}},{key:"copyViewFrom",value:function(e){this.eye=e.eye,this.center=e.center,this.up=e.up}},{key:"clone",value:function(){return(new e).copyFrom(this)}},{key:"equals",value:function(e){return Object(X.n)(this._eye,e._eye)&&Object(X.n)(this._center,e._center)&&Object(X.n)(this._up,e._up)&&Object(K.g)(this._viewport,e._viewport)&&Object(K.g)(this._padding,e._padding)&&Object(Ge.k)(this._nearFar,e._nearFar)&&this._fov===e._fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}},{key:"almostEquals",value:function(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e._fov-this._fov)>=.001)return!1;var t=5e-4;Object(X.s)(Ue,e._eye,e._center),Object(X.s)(We,this._eye,this._center);var i=Object(X.e)(Ue,We),n=Object(X.v)(Ue),a=Object(X.v)(We);return i*i>=(1-1e-10)*n*a&&Object(X.w)(e._eye,this._eye)<Math.max(n,a)*t*t&&Object(K.i)(e._padding,this._padding)<.5&&Object(K.i)(e._viewport,this._viewport)<.5}},{key:"markViewDirty",value:function(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}},{key:"computeRenderPixelSizeAt",value:function(e){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(e))}},{key:"computeRenderPixelSizeAtDist",value:function(e){return e*this.perRenderPixelRatio}},{key:"computeScreenPixelSizeAt",value:function(e){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(e))}},{key:"viewDirectionDistance",value:function(e){return Math.abs(Object(ze.b)(this.viewForward,Object(X.g)(Ue,e,this._eye)))}},{key:"computeScreenPixelSizeAtDist",value:function(e){return e*this.perScreenPixelRatio}},{key:"computeDistanceFromRadius",value:function(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}},{key:"getScreenCenter",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(Le.f)();return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}},{key:"getRenderCenter",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return e||(e=Object(Le.d)()),e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*i,e.length>2&&(e[2]=.5),e}},{key:"setGLViewport",value:function(e){var t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}},{key:"applyProjection",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e!==He&&Object(X.h)(He,e),He[3]=1,i&&(t[2]=-He[2]),Object(K.m)(He,He,this.projectionMatrix),Object(X.b)(He,He,1/Math.abs(He[3]));var n=this.fullViewport;return t[0]=Object(pe.l)(0,n[0]+n[2],.5+.5*He[0]),t[1]=Object(pe.l)(0,n[1]+n[3],.5+.5*He[1]),i||(t[2]=.5*(He[2]+1)),t}},{key:"projectToScreen",value:function(e,t){return this.projectToRenderScreen(e,qe),this.renderToScreen(qe,t)}},{key:"projectToRenderScreen",value:function(e,t){if(He[0]=e[0],He[1]=e[1],He[2]=e[2],He[3]=1,Object(K.m)(He,He,this.viewProjectionMatrix),0===He[3])return null;Object(X.b)(He,He,1/Math.abs(He[3]));var i=this.fullViewport;return"x"in t?(t.x=Object(pe.l)(0,i[0]+i[2],.5+.5*He[0]),t.y=Object(pe.l)(0,i[1]+i[3],.5+.5*He[1])):(t[0]=Object(pe.l)(0,i[0]+i[2],.5+.5*He[0]),t[1]=Object(pe.l)(0,i[1]+i[3],.5+.5*He[1]),t.length>2&&(t[2]=.5*(He[2]+1))),t}},{key:"unprojectFromScreen",value:function(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,qe),t)}},{key:"unprojectFromRenderScreen",value:function(e,t){if(Object(oe.l)(Ne,this.projectionMatrix,this.viewMatrix),!Object(oe.a)(Ne,Ne))return null;var i=this.fullViewport;return He[0]=2*(e[0]-i[0])/i[2]-1,He[1]=2*(e[1]-i[1])/i[3]-1,He[2]=2*e[2]-1,He[3]=1,Object(K.m)(He,He,Ne),0===He[3]?null:(t[0]=He[0]/He[3],t[1]=He[1]/He[3],t[2]=He[2]/He[3],t)}},{key:"constrainWindowSize",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=e*this.pixelRatio,r=t*this.pixelRatio,o=Math.max(a-i*n/2,0),s=Math.max(this.fullHeight-r-i/2,0),c=-Math.min(a-i*n/2,0),l=-Math.min(this.fullHeight-r-i/2,0);return[o,s,i*n-c- -Math.min(this.fullWidth-a-i*n/2,0),i-l- -Math.min(r-i/2,0)]}},{key:"computeUp",value:function(e){1===e?this.computeUpGlobal():this.computeUpLocal()}},{key:"screenToRender",value:function(e,t){var i=e[0]*this.pixelRatio,n=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=n,t}},{key:"renderToScreen",value:function(e,t){var i=e[0]/this.pixelRatio,n=(this.fullHeight-e[1])/this.pixelRatio;return t[0]=i,t[1]=n,t}},{key:"computeUpGlobal",value:function(){Object(X.g)(Ue,this.center,this.eye);var e=Object(X.m)(this.center);e<1?(Object(X.t)(this.up,0,0,1),this.markViewDirty()):Math.abs(Object(X.e)(Ue,this.center))>.9999*Object(X.m)(Ue)*e||(Object(X.d)(this.up,Ue,this.center),Object(X.d)(this.up,this.up,Ue),Object(X.o)(this.up,this.up),this.markViewDirty())}},{key:"computeUpLocal",value:function(){Object(re.e)(Ue,this.eye,this.center),Math.abs(Ue[2])<=.9999&&(Object(X.b)(Ue,Ue,Ue[2]),Object(X.t)(this.up,-Ue[0],-Ue[1],1-Ue[2]),Object(X.o)(this.up,this.up),this.markViewDirty())}},{key:"_compareAndSetView",value:function(e,t){Object(X.n)(e,t)||(Object(X.h)(t,e),this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0)}},{key:"_recomputeFrustum",value:function(){this._frustumDirty&&(Ve.b.fromMatrix(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}},{key:"_ensureViewClean",value:function(){this._viewDirty&&(Object(oe.k)(this._viewMatrix,this._eye,this._center,this._up),Object(X.t)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),Object(X.t)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),Object(X.t)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}]),e}(),He=Object(S.c)(),Ne=Object(se.b)(),Ue=Object(Y.e)(),We=Object(Y.e)(),qe=Object(Le.d)(),Be=Fe,Ze=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,e.SCENEVIEW_LOCKING_LOG=!1,e.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED=!1,e.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,e.DECONFLICTOR_SHOW_VISIBLE=!1,e.DECONFLICTOR_SHOW_INVISIBLE=!1,e.DECONFLICTOR_SHOW_GRID=!1,e.LABELS_SHOW_BORDER=!1,e.OVERLAY_DRAW_DEBUG_TEXTURE=!1,e.OVERLAY_SHOW_CENTER=!1,e.SHOW_POI=!1,e.TERRAIN_DEBUG_POPUP=!1,e.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,e.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,e.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,e.DRAW_MESH_GEOMETRY_NORMALS=!1,e.FEATURE_TILE_FETCH_SHOW_TILES=!1,e.FEATURE_TILE_TREE_SHOW_TILES=!1,e.I3S_TREE_SHOW_TILES=!1,e.I3S_SHOW_MODIFICATIONS=!1,e.ENABLE_PROFILE_DEPTH_RANGE=!1,e.DISABLE_FAST_UPDATES=!1,e.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,e.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,e.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,e}return i}(xe.a);Object(l.a)([Object(p.b)()],Ze.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"SCENEVIEW_LOCKING_LOG",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"DECONFLICTOR_SHOW_GRID",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"LABELS_SHOW_BORDER",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"OVERLAY_SHOW_CENTER",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"SHOW_POI",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"TERRAIN_DEBUG_POPUP",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"I3S_TREE_SHOW_TILES",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"I3S_SHOW_MODIFICATIONS",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"DISABLE_FAST_UPDATES",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),Object(l.a)([Object(p.b)()],Ze.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0);var Ye=new(Ze=Object(l.a)([Object(f.a)("esri.views.3d.support.DebugFlags")],Ze)),Xe=i(615),Qe=function(){function e(t,i,n,a){Object(r.a)(this,e),this._renderTarget=null,this.id="".concat(i,"_").concat(++n),this._renderTarget=new E.a(t,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:a,maxAnisotropy:8,width:0,height:0})}return Object(o.a)(e,[{key:"dispose",value:function(){this._renderTarget.dispose(),this._renderTarget=null}},{key:"getTexture",value:function(){return this._renderTarget?this._renderTarget.colorTexture:null}},{key:"isValid",value:function(){return null!==this._renderTarget}},{key:"resize",value:function(e,t){this._renderTarget.resize(e,t)}},{key:"bind",value:function(e){e.bindFramebuffer(this._renderTarget)}},{key:"generateMipMap",value:function(){this._renderTarget.colorTexture.descriptor.hasMipmap&&this._renderTarget.colorTexture.generateMipmap()}},{key:"disposeRenderTargetMemory",value:function(){this._renderTarget&&this._renderTarget.resize(0,0)}},{key:"getGpuMemoryUsage",value:function(){var e=0;return this._renderTarget&&(e+=Object(Ee.b)(this._renderTarget)),e}}]),e}(),Ke=i(115),Je=function e(t,i){Object(r.a)(this,e),this.vec3=t,this.id=i};function $e(e,t,i,n){return new Je(Object(Y.g)(e,t,i),n)}var et=function(){function e(t,i){Object(r.a)(this,e),this.extent=Object(Ke.h)(),this.resolution=0,this.renderLocalOrigin=$e(0,0,0,"O"),this.pixelRatio=1,this.renderTargets={color:{fbo:new Qe(t,"overlay",i,!0),valid:!1,lastUsed:1/0},colorWithoutRasterImage:{fbo:new Qe(t,"overlayWithoutRasterImage",i,!0),valid:!1,lastUsed:1/0},highlight:{fbo:new Qe(t,"overlayHighlight",i,!1),valid:!1,lastUsed:1/0},water:{fbo:new Qe(t,"overlayWaterMask",i,!0),valid:!1,lastUsed:1/0},occluded:{fbo:new Qe(t,"overlayOccluded",i,!0),valid:!1,lastUsed:1/0}}}return Object(o.a)(e,[{key:"dispose",value:function(){this.renderTargets.color.fbo.dispose(),this.renderTargets.colorWithoutRasterImage.fbo.dispose(),this.renderTargets.highlight.fbo.dispose(),this.renderTargets.water.fbo.dispose(),this.renderTargets.occluded.fbo.dispose()}},{key:"drawRenderTargets",value:function(e,t,i){var n=this.renderTargets;n.color.valid=e.drawPass(0,n.color.fbo,t),n.highlight.valid=e.drawPass(5,n.highlight.fbo,t),n.water.valid=e.drawPass(3,n.water.fbo,t),n.occluded.valid=e.drawPass(0,n.occluded.fbo,t,1),n.colorWithoutRasterImage.valid=i&&e.drawPass(0,n.colorWithoutRasterImage.fbo,t,2)}},{key:"computeRenderTargetValidityBitfield",value:function(){var e=this.renderTargets;return+e.color.valid|+e.colorWithoutRasterImage.valid<<1|+e.highlight.valid<<2|+e.water.valid<<3|+e.occluded.valid<<4}},{key:"validateUsage",value:function(e,t){if(e.valid)e.lastUsed=t;else if(t-e.lastUsed>tt)e.fbo.disposeRenderTargetMemory(),e.lastUsed=1/0;else if(e.lastUsed<1/0)return!0;return!1}},{key:"collectUnusedMemory",value:function(e){var t=!1;return t=this.validateUsage(this.renderTargets.color,e)||t,t=this.validateUsage(this.renderTargets.colorWithoutRasterImage,e)||t,t=this.validateUsage(this.renderTargets.highlight,e)||t,t=this.validateUsage(this.renderTargets.occluded,e)||t,t=this.validateUsage(this.renderTargets.water,e)||t}},{key:"getGpuMemoryUsage",value:function(){return this.renderTargets.color.fbo.getGpuMemoryUsage()+this.renderTargets.colorWithoutRasterImage.fbo.getGpuMemoryUsage()+this.renderTargets.highlight.fbo.getGpuMemoryUsage()+this.renderTargets.water.fbo.getGpuMemoryUsage()+this.renderTargets.occluded.fbo.getGpuMemoryUsage()}}]),e}(),tt=1e3,it=i(154),nt=function(){function e(){Object(r.a)(this,e),this._uniforms={proj:[],shadowMapDistance:[],viewportPixelSz:[],lightingMainDirection:[]}}return Object(o.a)(e,[{key:"dispose",value:function(){this._uniforms=null}},{key:"getPrograms",value:function(e){return this._uniforms[e]||[]}},{key:"subscribeProgram",value:function(e){for(var t in this._uniforms)e.hasUniform(t)&&this._uniforms[t].push(e)}},{key:"unsubscribeProgram",value:function(e){for(var t in this._uniforms)Object(it.g)(this._uniforms[t],e)}}]),e}(),at=i(17),rt=function e(t){Object(r.a)(this,e),this.technique=t,this.refCount=0,this.refZeroFrame=0},ot=function(){function e(t){Object(r.a)(this,e),this._context=t,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}return Object(o.a)(e,[{key:"viewingMode",get:function(){return this._context.viewingMode}},{key:"constructionContext",get:function(){return this._context}},{key:"dispose",value:function(){this._perConstructorInstances.forEach((function(e){return e.forEach((function(e){return e.technique.dispose()}))})),this._perConstructorInstances.clear()}},{key:"acquire",value:function(e,t){var i=t.key,n=this._perConstructorInstances.get(e);n||(n=new Map,this._perConstructorInstances.set(e,n));var a=n.get(i);return void 0===a&&(a=new rt(new e(this._context,t)),n.set(i,a)),++a.refCount,a.technique}},{key:"acquireAndReleaseExisting",value:function(e,t,i){return Object(h.g)(i)?this.acquire(e,t):t.key===i.key&&i instanceof e?i:(this.release(i),this.acquire(e,t))}},{key:"release",value:function(e){var t=this._perConstructorInstances.get(e.constructor).get(e.key);t.refCount-=1,0===t.refCount&&(t.refZeroFrame=this._frameCounter)}},{key:"frameUpdate",value:function(){var e=this;this._frameCounter++,this._perConstructorInstances.forEach((function(t,i){t.forEach((function(i,n){0===i.refCount&&i.refZeroFrame+e._keepAliveFrameCount<e._frameCounter&&(i.technique.dispose(),t.delete(n))})),0===t.size&&e._perConstructorInstances.delete(i)}))}},{key:"getProgramsUsingUniform",value:function(e){return this._context.commonUniformStore.getPrograms(e)}},{key:"hotReload",value:function(){var e=Object(je.a)(_e.a.mark((function e(){var t,i=this;return _e.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Array,this._perConstructorInstances.forEach((function(e,n){t.push(function(){var e=Object(je.a)(_e.a.mark((function e(t,n){var a;return _e.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.shader,e.t0=a,!e.t0){e.next=6;break}return e.next=5,a.reload();case 5:t.forEach((function(e){e.technique.reload(i._context)}));case 6:case"end":return e.stop()}}),e)})));return function(t,i){return e.apply(this,arguments)}}()(e,n))})),e.next=4,Object(at.b)(t);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),st=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function ct(e,t){return e+"_"+st.find((function(e){return e.output===t})).name}var lt=d.a.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep"),ut=function(){function e(t){Object(r.a)(this,e),this.refCnt=0,this.glMaterial=t}return Object(o.a)(e,[{key:"incRefCnt",value:function(){++this.refCnt}},{key:"decRefCnt",value:function(){--this.refCnt,Object(ce.b)(this.refCnt>=0)}},{key:"getRefCnt",value:function(){return this.refCnt}},{key:"getGLMaterial",value:function(){return this.glMaterial}}]),e}(),ht=function(){function e(t,i,n){Object(r.a)(this,e),this._textureRep=t,this._techniqueRep=i,this.onMaterialChanged=n,this._id2glMaterialRef=new Map}return Object(o.a)(e,[{key:"dispose",value:function(){this._textureRep.dispose()}},{key:"acquire",value:function(e,t){this.ownMaterial(e);var i=ct(e.id,t),n=this._id2glMaterialRef.get(i);if(null==n){var a=e.getGLMaterial({material:e,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:t});return(n=new ut(a)).incRefCnt(),this._id2glMaterialRef.set(i,n),a}return n.incRefCnt(),n.getGLMaterial()}},{key:"release",value:function(e,t){var i=ct(e.id,t),n=this._id2glMaterialRef.get(i);if(n.decRefCnt(),0===n.getRefCnt()){var a=n.getGLMaterial();a&&a.dispose(),this._id2glMaterialRef.delete(i)}}},{key:"materialChanged",value:function(e){var t,i=Object(k.a)(st);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(5!==n.output&&6!==n.output){var a=this._id2glMaterialRef.get(ct(e.id,n.output));if(a&&a.getGLMaterial()){var r=a.getGLMaterial();r.updateParameters&&r.updateParameters()}}}}catch(o){i.e(o)}finally{i.f()}this.onMaterialChanged&&this.onMaterialChanged(e)}},{key:"ownMaterial",value:function(e){Object(h.h)(e.materialRepository)&&e.materialRepository!==this&&lt.error("Material is already owned by a different material repository"),e.materialRepository=this}}]),e}(),dt=i(48),pt=i(431),ft=i(444),vt=0,gt=function(){function e(){Object(r.a)(this,e),this.ROOT_ORIGIN_ID="rg_root_"+vt++,this._origins=new Map,this._gridSize=42e5}return Object(o.a)(e,[{key:"getOrigin",value:function(t){var i=this._origins.get(this.ROOT_ORIGIN_ID);if(null==i){if(Object(h.h)(e.testOrigin)){var n=e.testOrigin;return this._origins.set(this.ROOT_ORIGIN_ID,$e(n[0],n[1],n[2],this.ROOT_ORIGIN_ID)),this.getOrigin(t)}var a=$e(t[0]+Math.random()-.5,t[1]+Math.random()-.5,t[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,a),a}Object(X.g)(bt,t,i.vec3),bt[0]=Math.abs(bt[0]),bt[1]=Math.abs(bt[1]),bt[2]=Math.abs(bt[2]);var r=this._gridSize;if(bt[0]<r&&bt[1]<r&&bt[2]<r)return i;var o=Math.round(t[0]/r),s=Math.round(t[1]/r),c=Math.round(t[2]/r),l="rg_".concat(o,"/").concat(s,"/").concat(c),u=this._origins.get(l);return u||(u=$e(o*r,s*r,c*r,l),this._origins.set(l,u)),u}},{key:"_drawOriginBox",value:function(e){var t=window.view,i=t._stage;if(null==this._object){this._material=new ae.a({width:2,color:[0,1,0,1]},"GridLocalOriginMaterial"),i.add(3,this._material);var n=new ft.a("GridLocalOrigin",{isPickable:!1});i.add(0,n),this._object=new pt.a({idHint:"GridLocalOrigin",castShadow:!1}),i.add(1,this._object),n.addObject(this._object),i.addToViewContent([n.id])}for(var a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],r=a.length,o=new Float32Array(3*r),s=new Uint32Array(2*(r-1)),c=.5*this._gridSize,l=0;l<r;l++)o[3*l+0]=e[0]+(1&a[l]?c:-c),o[3*l+1]=e[1]+(2&a[l]?c:-c),o[3*l+2]=e[2]+(4&a[l]?c:-c),l>0&&(s[2*l+0]=l-1,s[2*l+1]=l);Object(Q.j)(o,dt.a.WebMercator,0,o,t.spatialReference,0,r);var u={};u[ce.a.POSITION]={size:3,data:o};var h={};h[ce.a.POSITION]=s;var d=new be.a(u,h,"line"),p=new ie.a(d,"GridLocalOriginBox");i.add(2,p),this._object.addGeometry(p,this._material,se.a),console.log(this._origins.size,e)}}]),e}(),bt=Object(Y.e)();(gt||(gt={})).testOrigin=null;var mt=gt,yt=function(){function e(t,i,n,a,o,s){Object(r.a)(this,e),this.camera=null,this.lastFrameCamera=new Be,this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=13,this.hasOccludees=!1,this.rctx=t,this.offscreenRenderingHelper=i,this.scenelightingData=n,this.shadowMap=a,this.ssaoHelper=o,this.sliceHelper=s}return Object(o.a)(e,[{key:"resetRenderOccludedMask",value:function(){this.renderOccludedMask=13}},{key:"isHighlightPass",get:function(){return 5===this.pass}}]),e}(),Ot=i(265);function _t(e){return t=e.data,Object(ce.g)(t.indices).length>=1;var t}var jt=i(38),wt=i(576),xt=i(149),Mt=i(230),St=function(){function e(t){Object(r.a)(this,e),null==t?t=16:t<65536&&(t=Object(pe.n)(t)),this._array=new Float32Array(t),this._size=0}return Object(o.a)(e,[{key:"resize",value:function(e,t){if(this._size=e,this._size>this._array.length){for(var i=this._array.length||1;i<this._size;)i*=2;var n=new Float32Array(i);return t&&n.set(this._array),this._array=n,!0}var a=2*this._size;if(a<=this._array.length){for(var r=this._array.length;r>=a;)r=Math.floor(r/2);var o=new Float32Array(r);return t&&o.set(this._array.subarray(0,r)),this._array=o,!0}return!1}},{key:"append",value:function(e){var t=this._size;this.resize(this._size+e.length,!0),this._array.set(e,t)}},{key:"erase",value:function(e,t){for(var i=e;i<t;++i)this._array[i]=0}},{key:"array",get:function(){return this._array}},{key:"size",get:function(){return this._size}}]),e}(),kt=i(353),Rt=i(243),Et=i(244),Dt=i(68),Tt=i(245),Ct=i(242),Pt=i(107),It=i(227),At=i(234),Lt=i(202),Gt=i(241),zt=i(160),Vt=i(986),Ft=i(1155),Ht=i(1083),Nt=i(1084),Ut=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e,n){var a;return Object(r.a)(this,i),(a=t.call(this,e,n)).waterTextureRepository=e.waterTextureRepository,a}return Object(o.a)(i,[{key:"initializeProgram",value:function(e){var t=i.shader.get(),n=this.configuration,a=t.build({OITEnabled:0===n.transparencyPassType,output:n.output,viewingMode:e.viewingMode,slicePlaneEnabled:n.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:n.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:n.useSSR,highStepCount:!0});return new Ct.a(e.rctx,a.generateSource("vertex"),a.generateSource("fragment"),Tt.a)}},{key:"ensureResource",value:function(e){return this.waterTextureRepository.ready||this.waterTextureRepository.updating||this.waterTextureRepository.loadTextures(e),this.waterTextureRepository.ready?2:1}},{key:"bindPass",value:function(e,t,i){It.a.bindProjectionMatrix(this.program,i.camera.projectionMatrix),0===this.configuration.output&&(i.lighting.setUniforms(this.program,!1),Ft.a.bindUniforms(this.program,e,i)),0!==this.configuration.output&&2!==this.configuration.output||(Ht.a.bindUniforms(this.program,t),this.waterTextureRepository.bindRepo(e)),this.program.setUniform4fv("waterColor",t.color),4===this.configuration.output&&Gt.a.bindOutputHighlight(e,this.program,i)}},{key:"bindDraw",value:function(e){It.a.bindView(this.program,e),0!==this.configuration.output&&7!==this.configuration.output||It.a.bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Vt.a.bindUniforms(this.program,e,At.a.SHADOW_MAP),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||Lt.a.bindUniformsWithOrigin(this.program,this.configuration,e)}},{key:"setPipelineState",value:function(e){var t=this.configuration,i=3===e,n=2===e;return Object(Pt.d)({blending:2!==t.output&&4!==t.output&&t.transparent?i?zt.f:Object(zt.a)(e):null,depthTest:{func:Object(zt.b)(e)},depthWrite:i?t.writeDepth&&Pt.c:Object(zt.c)(e),colorWrite:Pt.b,polygonOffset:i||n?null:Object(zt.g)(t.enableOffset)})}},{key:"initializePipeline",value:function(){return this.setPipelineState(this.configuration.transparencyPassType)}}]),i}(Et.a);Ut.shader=new Rt.a(Nt.a,(function(){return i.e(135).then(i.bind(null,1217))}));var Wt=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).output=0,e.receiveShadows=!1,e.slicePlaneEnabled=!1,e.transparent=!1,e.enableOffset=!0,e.writeDepth=!1,e.useSSR=!1,e.isDraped=!1,e.transparencyPassType=3,e}return i}(Dt.a);Object(l.a)([Object(Dt.b)({count:8})],Wt.prototype,"output",void 0),Object(l.a)([Object(Dt.b)()],Wt.prototype,"receiveShadows",void 0),Object(l.a)([Object(Dt.b)()],Wt.prototype,"slicePlaneEnabled",void 0),Object(l.a)([Object(Dt.b)()],Wt.prototype,"transparent",void 0),Object(l.a)([Object(Dt.b)()],Wt.prototype,"enableOffset",void 0),Object(l.a)([Object(Dt.b)()],Wt.prototype,"writeDepth",void 0),Object(l.a)([Object(Dt.b)()],Wt.prototype,"useSSR",void 0),Object(l.a)([Object(Dt.b)()],Wt.prototype,"isDraped",void 0),Object(l.a)([Object(Dt.b)({count:4})],Wt.prototype,"transparencyPassType",void 0);var qt=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e)).updateParameters(),n}return Object(o.a)(i,[{key:"updateParameters",value:function(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(Ut,this.material.getTechniqueConfig(this.output,e),this.technique)}},{key:"beginSlot",value:function(e){if(2===this.output)return 22===e;if(5===this.output)return null==e;if(4===this.output)return 3===e;var t=3;return this.material.params.transparent&&(t=this.material.params.writeDepth?5:8),e===t}},{key:"setElapsedTimeUniform",value:function(e){var t=.001*this.material.animation.time;e.setUniform1f("timeElapsed",t*this.material.params.animationSpeed)}},{key:"_updateShadowState",value:function(e){e.shadowMappingEnabled!==this.material.params.receiveShadows&&this.material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}},{key:"_updateSSRState",value:function(e){e.ssrEnabled!==this.material.params.ssrEnabled&&this.material.setParameterValues({ssrEnabled:e.ssrEnabled})}},{key:"ensureResources",value:function(e){return this.technique.ensureResource(e)}},{key:"ensureParameters",value:function(e){0===this.output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}},{key:"bind",value:function(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.params,t),2!==this.output&&0!==this.output||this.setElapsedTimeUniform(this.technique.program)}}]),i}(kt.a),Bt=function e(t,i,n,a,o,s){Object(r.a)(this,e),this.from=t,this.to=i,this.isVisible=n,this.hasHighlights=a,this.hasOccludees=o,this.transformation=s,null!=s&&(this.transformationNormal=Object(se.c)(s),Object(oe.a)(this.transformationNormal,this.transformationNormal),Object(oe.b)(this.transformationNormal,this.transformationNormal))};function Zt(e,t){var i=function(e){return{first:e.from,count:e.to-e.from}};if(0!==e.length){var n,a,r=e[e.length-1];if(a=t,(n=r).first+n.count>=a.from){var o=t.from-r.first+t.to-t.from;r.count=o}else e.push(i(t))}else e.push(i(t))}var Yt=i(92),Xt=i(361);function Qt(e,t,i){Object(h.h)(i)&&(i.drawCalls+=e,i.triangles+=t)}Xt.a;var Kt={begin:0,end:0},Jt=Object(se.b)(),$t=Object(se.b)(),ei=Object(se.b)(),ti=function(){function e(t,i,n){Object(r.a)(this,e),this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=t,this._material=n,this._materialRep=i,this._glMaterials=Object(ue.a)(this._material,this._materialRep),this._bufferWriter=n.createBufferWriter()}return Object(o.a)(e,[{key:"dispose",value:function(){Object(ue.e)(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((function(e){e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((function(e){e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)}},{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&Object(ke.a)(this._glMaterials,(function(e){return e instanceof qt}))}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"modify",value:function(e){this.updateGeometries(e.toUpdate),this.addAndRemoveGeometries(e.toAdd,e.toRemove),this.updateRenderCommands()}},{key:"addAndRemoveGeometries",value:function(e,t){var i=this,n=this._bufferWriter,a=n.vertexBufferLayout,r=a.stride/4,o=this._dataByOrigin,s=function(e,t,i,n){var a,r=new Map,o=t.vertexBufferLayout.stride/4,s=function(i,n){var a=i.origin,s=e.get(a.id),c=r.get(a.id);null==c&&(c={optimalCount:null==s?0:s.optimalCount,sparseCount:null==s?0:s.buffer.size,toAdd:[],toRemove:[],origin:a.vec3},r.set(a.id,c));var l=t.elementCount(i.data)*o;n?(c.optimalCount+=l,c.sparseCount+=l,c.toAdd.push(i)):(c.optimalCount-=l,c.toRemove.push(i))},c=Object(k.a)(i);try{for(c.s();!(a=c.n()).done;){s(a.value,!0)}}catch(h){c.e(h)}finally{c.f()}var l,u=Object(k.a)(n);try{for(u.s();!(l=u.n()).done;){s(l.value,!1)}}catch(h){u.e(h)}finally{u.f()}return r}(o,n,e,t);s.forEach((function(e,t){s.delete(t);var n=e.optimalCount,c=e.sparseCount,l=o.get(t);if(null==l)Object(ce.b)(n>0),l=i.createData(a,n,e.origin),o.set(t,l);else if(0===n)return l.vao.dispose(!0),l.vao=null,void o.delete(t);var u=n<e.sparseCount/2,h=u?n:c,d=Kt,p=l.buffer.size,f=l.buffer.array,v=l.buffer.resize(h,!1);u||v?i.removeAndRebuild(l,e.toRemove,r,f,d):e.toRemove.length>0?(i.removeByErasing(l,e.toRemove,r,d),e.toAdd.length>0&&(d.end=p)):(d.begin=p,d.end=p);var g=Jt;Object(ce.l)(g,-e.origin[0],-e.origin[1],-e.origin[2]),i.append(l,e.toAdd,r,g,d);var b=l.vao.vertexBuffers.geometry;if(b.byteSize!==l.buffer.array.buffer.byteLength)b.setData(l.buffer.array);else{var m=d.begin,y=d.end;if(m<y){var O=l.buffer.array,_=4*m,j=4*y;b.setSubData(O,_,_,j)}}l.drawCommandsDirty=!0}))}},{key:"updateGeometries",value:function(e){var t,i=this._bufferWriter,n=i.vertexBufferLayout.stride/4,a=Object(k.a)(e);try{for(a.s();!(t=a.n()).done;){var r=t.value,o=r.updateType,s=r.renderGeometry,c=this._dataByOrigin.get(s.origin.id),l=c&&c.instances.get(s.uniqueName);if(!l)return;if(1&o&&(l.isVisible=s.instanceParameters.visible),9&o){var u=s.instanceParameters.visible;l.hasHighlights=!!s.instanceParameters.highlights&&u}if(16&o&&(l.hasOccludees=!!s.instanceParameters.occludees),6&o){var h=c.buffer.array,d=c.vao;Object(ue.c)(s,$t,ei),i.write({transformation:$t,invTranspTransformation:ei},s.data,i.vertexBufferLayout.createView(h.buffer),l.from),Object(ce.b)(l.from+i.elementCount(s.data)===l.to,"material VBO layout has changed"),d.vertexBuffers.geometry.setSubData(h,l.from*n*4,l.from*n*4,l.to*n*4)}c.drawCommandsDirty=!0}}catch(p){a.e(p)}finally{a.f()}}},{key:"updateRenderCommands",value:function(){var e=this;this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((function(t){t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,Object(ke.a)(t.instances,(function(i){return i.isVisible?(i.hasHighlights&&(e._hasHighlights=!0,t.hasHighlights=!0),i.hasOccludees&&(e._hasOccludees=!0,t.hasOccludees=!0)):t.hasHiddenInstances=!0,t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees}))})),this._dataByOrigin.forEach((function(e){e.drawCommandsDirty&&(function(e){if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.stats={default:0,highlight:0,occludees:0},0!==e.instances.size){if(!(e.hasOccludees||e.hasHighlights||e.hasHiddenInstances)){var t=4*e.buffer.size/Object(Ee.c)(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0})}var i=function(e){return e.sort((function(e,t){return e.from===t.from?e.to>t.to?1:e.to<t.to?-1:0:e.from>t.from?1:e.from<t.from?-1:0}))}(Object(jt.a)(e.instances.values()));e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[];var n,a=Object(k.a)(i);try{for(a.s();!(n=a.n()).done;){var r=n.value;r.isVisible&&(r.hasOccludees?Zt(e.drawCommandsOccludees,r):Zt(e.drawCommandsDefault,r),r.hasHighlights&&Zt(e.drawCommandsHighlight,r))}}catch(s){a.e(s)}finally{a.f()}var o=function(e){var t,i=0,n=Object(k.a)(e);try{for(n.s();!(t=n.n()).done;){i+=t.value.count}}catch(s){n.e(s)}finally{n.f()}return i/3};e.stats={default:o(e.drawCommandsDefault),highlight:o(e.drawCommandsHighlight),occludees:o(e.drawCommandsOccludees)}}}(e),e.drawCommandsDirty=!1)}))}},{key:"updateLogic",value:function(e){return this._material.update(e)}},{key:"render",value:function(e,t,i,n){var a=this,r=this._rctx,o=this._glMaterials.get(t.pass),s=5===t.pass,c=e;if(3===t.pass&&null===c&&(c=22),!o||2!==o.ensureResources(r)||null!=c&&!o.beginSlot(c)||s&&!this._hasHighlights)return!1;o.ensureParameters(i);var l=o.getTechnique(),u=o.getPipelineState(c,!1);r.setPipelineState(u),o.bind(r,i);var d=!1;return this._dataByOrigin.forEach((function(e){if(!(Object(h.g)(e.drawCommandsDefault)&&Object(h.g)(e.drawCommandsHighlight)&&Object(h.g)(e.drawCommandsOccludees))&&(!s||e.hasHighlights)){i.origin=e.origin,l.bindDraw(i),l.ensureAttributeLocations(e.vao),r.bindVAO(e.vao);var t=l.primitiveType,p=s?e.drawCommandsHighlight:e.drawCommandsDefault,f=s?e.stats.highlight:e.stats.default;if(Object(h.h)(p)&&(a.renderCommands(r,t,p),Qt(p.length,f,n),d=!0),!s&&(p=e.drawCommandsOccludees,Object(h.h)(p))){var v=o.getPipelineState(c,!0);r.setPipelineState(v),a.renderCommands(r,t,p),r.setPipelineState(u),Qt(p.length,e.stats.occludees,n),d=!0}}})),d}},{key:"renderCommands",value:function(e,t,i){for(var n=0;n<i.length;n++)e.drawArrays(t,i[n].first,i[n].count)}},{key:"createData",value:function(e,t,i){return{instances:new Map,vao:new Mt.a(this._rctx,this._material.vertexAttributeLocations,{geometry:Object(wt.a)(e)},{geometry:xt.a.createVertex(this._rctx,35044)}),buffer:new St(t),optimalCount:0,origin:i,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,stats:{default:0,highlight:0,occludees:0}}}},{key:"removeAndRebuild",value:function(e,t,i,n,a){var r,o=Object(k.a)(t);try{for(o.s();!(r=o.n()).done;){var s=r.value.uniqueName,c=e.instances.get(s);e.optimalCount-=(c.to-c.from)*i,e.instances.delete(s)}}catch(f){o.e(f)}finally{o.f()}var l=0,u=e.buffer.array;a.begin=0,a.end=0;var h=-1,d=-1,p=0;e.instances.forEach((function(e){var t=e.from*i,a=e.to*i,r=a-t;h!==d&&d!==t?(u.set(n.subarray(h,d),p),p+=d-h,h=t):-1===h&&(h=t),d=a,e.from=l/i,l+=r,e.to=l/i})),h!==d&&u.set(n.subarray(h,d),p),a.end=l}},{key:"removeByErasing",value:function(e,t,i,n){n.begin=1/0,n.end=-1/0;var a,r=-1,o=-1,s=Object(k.a)(t);try{for(s.s();!(a=s.n()).done;){var c=a.value.uniqueName,l=e.instances.get(c),u=l.from*i,h=l.to*i;r!==o&&o!==u?(e.buffer.erase(r,o),r=u):-1===r&&(r=u),o=h,e.instances.delete(c),e.optimalCount-=h-u,u<n.begin&&(n.begin=u),h>n.end&&(n.end=h)}}catch(d){s.e(d)}finally{s.f()}r!==o&&e.buffer.erase(r,o)}},{key:"append",value:function(e,t,i,n,a){var r,o=this._bufferWriter,s=Object(k.a)(t);try{for(s.s();!(r=s.n()).done;){var c=r.value,l=Object(h.h)(c.transformation)?Object(oe.l)($t,n,c.transformation):n;Object(oe.a)(ei,l),Object(oe.b)(ei,ei);var u=a.end;o.write({transformation:l,invTranspTransformation:ei},c.data,o.vertexBufferLayout.createView(e.buffer.array.buffer),a.end/i);var d=o.elementCount(c.data)*i,p=u+d;Object(ce.b)(null==e.instances.get(c.uniqueName));var f=c.instanceParameters.visible,v=!!c.instanceParameters.highlights&&f,g=!!c.instanceParameters.occludees,b=new Bt(u/i,p/i,f,v,g);e.instances.set(c.uniqueName,b),e.optimalCount+=d,a.end+=d}}catch(m){s.e(m)}finally{s.f()}}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials}}}]),e}(),ii=function e(){Object(r.a)(this,e)},ni=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments))._pendingAddsRemoves=new Map,e._adds=new we.a,e._removes=new we.a,e._updates=new we.a({allocator:function(e){return e||new ii},deallocator:function(e){return e.renderGeometry=null,e}}),e._materialRenderers=new Map,e._sortedMaterialRenderers=new we.a,e._hasHighlights=!1,e._hasWater=!1,e}return Object(o.a)(i,[{key:"dispose",value:function(){this._adds.prune(),this._removes.prune(),this._updates.prune(),this._materialRenderers&&(this._materialRenderers.forEach((function(e){return e.dispose()})),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear())}},{key:"updating",get:function(){return this._pendingAddsRemoves.size>0||this._updates.length>0}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return Object(ke.a)(this._materialRenderers,(function(e){return e.rendersOccluded}))}},{key:"stopAnimationsAtTime",value:function(e){this._sortedMaterialRenderers.forAll((function(t){return Object(h.b)(t.material.animation,(function(t){return t.stopAtTime(e)}))}))}},{key:"isEmpty",get:function(){return!this.updating&&0===this._materialRenderers.size}},{key:"commitChanges",value:function(){var e=this,t=!1;if(!this.updating)return!1;this.updateAddsRemoves();var i=function(e){for(var t=new Map,i=null,n=null,a=function(e){if(e===i)return n;var a=t.get(e);return a||(a={toAdd:[],numToAdd:-1,toRemove:[],numToRemove:-1,toUpdate:[],numToUpdate:-1},t.set(e,a)),i=e,n=a,a},r=0;r<e.numToAdd;r++){var o=e.toAdd[r];_t(o)&&a(o.material).toAdd.push(o)}for(var s=0;s<e.numToRemove;s++){var c=e.toRemove[s];_t(c)&&a(c.material).toRemove.push(c)}for(var l=0;l<e.numToUpdate;l++){var u=e.toUpdate[l];_t(u.renderGeometry)&&a(u.renderGeometry.material).toUpdate.push(u)}return t}({numToAdd:this._adds.length,toAdd:this._adds.data,numToRemove:this._removes.length,toRemove:this._removes.data,numToUpdate:this._updates.length,toUpdate:this._updates.data}),n=!1,a=!1;return i.forEach((function(i,r){var o=e._materialRenderers.get(r);if(!o&&i.toAdd.length>0&&(o=new ti(e.rctx,e.materialRepository,r),e._materialRenderers.set(r,o),t=!0,n=!0,a=!0),o){var s=n||o.hasHighlights,c=a||o.hasWater;o.modify(i),n=n||s!==o.hasHighlights,a=a||c!==o.hasWater,o.isEmpty&&(e._materialRenderers.delete(r),o.dispose(),t=!0)}})),this._adds.clear(),this._removes.clear(),this._updates.clear(),this._pendingAddsRemoves.clear(),t&&this.updateSortedMaterialRenderers(),n&&(this._hasHighlights=Object(ke.a)(this._materialRenderers,(function(e){return e.hasHighlights}))),a&&(this._hasWater=Object(ke.a)(this._materialRenderers,(function(e){return e.hasWater}))),this.notifyChange("updating"),!0}},{key:"add",value:function(e){if(0!==e.length){var t,i=0===this._pendingAddsRemoves.size,n=Object(k.a)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;this._pendingAddsRemoves.set(a,0)}}catch(r){n.e(r)}finally{n.f()}i&&this.notifyChange("updating")}}},{key:"remove",value:function(e){var t,i=0===this._pendingAddsRemoves.size,n=Object(k.a)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value,r=this._pendingAddsRemoves.get(a);0===r?this._pendingAddsRemoves.set(a,2):2!==r&&this._pendingAddsRemoves.set(a,1)}}catch(o){n.e(o)}finally{n.f()}i&&this._pendingAddsRemoves.size>0&&this.notifyChange("updating")}},{key:"modify",value:function(e,t){var i,n=0===this._updates.length,a=Object(k.a)(e);try{for(a.s();!(i=a.n()).done;){var r=i.value,o=this._updates.pushNew();o.renderGeometry=r,o.updateType=t}}catch(s){a.e(s)}finally{a.f()}n&&this._updates.length>0&&this.notifyChange("updating")}},{key:"updateLogic",value:function(e){var t=!1;return this._sortedMaterialRenderers.forAll((function(i){var n=i.materialRenderer;n.updateLogic&&n.updateLogic(e)&&(t=!0)})),t}},{key:"draw",value:function(e,t){for(var i=0;i<this._sortedMaterialRenderers.length;i++){var n=this._sortedMaterialRenderers.data[i];Object(Ot.c)(n.material,e)&&n.materialRenderer.render(null,e,t,null)}}},{key:"updateSortedMaterialRenderers",value:function(){var e=this;this._sortedMaterialRenderers.clear();var t=0;this._materialRenderers.forEach((function(i,n){n.insertOrder=t++,e._sortedMaterialRenderers.push({material:n,materialRenderer:i})})),this._sortedMaterialRenderers.sort((function(e,t){var i=t.material.renderPriority-e.material.renderPriority;return 0!==i?i:e.material.insertOrder-t.material.insertOrder}))}},{key:"updateAddsRemoves",value:function(){var e=this;this._adds.clear(),this._removes.clear(),this._pendingAddsRemoves.forEach((function(t,i){switch(t){case 0:e._adds.push(i);break;case 1:e._removes.push(i)}}));for(var t=0;t<this._updates.length;){var i=this._updates.data[t].renderGeometry;this._pendingAddsRemoves.has(i)?this._updates.removeUnorderedIndex(t):t++}}},{key:"test",get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}}]),i}(xe.a);Object(l.a)([Object(p.b)()],ni.prototype,"rctx",void 0),Object(l.a)([Object(p.b)()],ni.prototype,"materialRepository",void 0),Object(l.a)([Object(p.b)()],ni.prototype,"updating",null),ni=Object(l.a)([Object(f.a)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],ni);var ai=i(1085),ri=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(){return Object(r.a)(this,i),t.apply(this,arguments)}return Object(o.a)(i,[{key:"initializeProgram",value:function(e){var t=i.shader.get().build();return new Ct.a(e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),Tt.a)}},{key:"initializePipeline",value:function(){return this.configuration.hasAlpha?Object(Pt.d)({blending:Object(Pt.e)(770,1,771,771),colorWrite:Pt.b}):Object(Pt.d)({colorWrite:Pt.b})}}]),i}(Et.a);ri.shader=new Rt.a(ai.a,(function(){return i.e(127).then(i.bind(null,1218))}));var oi=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).hasAlpha=!1,e}return i}(Dt.a);function si(e,t,i){(i=i||e).length=e.length;for(var n=0;n<e.length;n++)i[n]=e[n]*t[n];return i}function ci(e,t,i){(i=i||e).length=e.length;for(var n=0;n<e.length;n++)i[n]=e[n]*t;return i}function li(e,t,i){(i=i||e).length=e.length;for(var n=0;n<e.length;n++)i[n]=e[n]+t[n];return i}function ui(e){return(e+1)*(e+1)}function hi(e,t,i){var n=e[0],a=e[1],r=e[2],o=i||[];return o.length=ui(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*n,o[2]=.4886025119*r,o[3]=.4886025119*a),t>=2&&(o[4]=1.09254843059*n*a,o[5]=1.09254843059*a*r,o[6]=.31539156525*(3*r*r-1),o[7]=1.09254843059*n*r,o[8]=.54627421529*(n*n-a*a)),o}function di(e,t){var i,n=function(e){return Object(pe.d)(Math.floor(Math.sqrt(e)-1),0,2)}(t.r.length),a=Object(k.a)(e);try{for(a.s();!(i=a.n()).done;){var r=i.value;Object(X.q)(yi,r.direction),hi(yi,n,bi),si(bi,Oi),ci(bi,r.intensity[0],mi),li(t.r,mi),ci(bi,r.intensity[1],mi),li(t.g,mi),ci(bi,r.intensity[2],mi),li(t.b,mi)}}catch(o){a.e(o)}finally{a.f()}return t}function pi(e,t,i){(function(e,t){var i=ui(e),n=t||{r:[],g:[],b:[]};n.r.length=n.g.length=n.b.length=i;for(var a=0;a<i;a++)n.r[a]=n.g[a]=n.b[a]=0})(t,i.sphericalHarmonics.sh),Object(X.t)(i.main.intensity,0,0,0);var n=!1,a=fi,r=vi,o=gi;a.length=0,r.length=0,o.length=0;var s,c=Object(k.a)(e);try{for(c.s();!(s=c.n()).done;){var l=s.value;l instanceof Te&&!n?(Object(X.h)(i.main.direction,l.direction),i.main.intensity[0]=l.intensity[0],i.main.intensity[1]=l.intensity[1],i.main.intensity[2]=l.intensity[2],i.main.castShadows=l.castShadows,n=!0):l instanceof Te||l instanceof Ce?a.push(l):l instanceof Pe?r.push(l):l instanceof Ie&&o.push(l)}}catch(p){c.e(p)}finally{c.f()}di(a,i.sphericalHarmonics.sh),function(e,t){hi(yi,0,bi);var i,n=Object(k.a)(e);try{for(n.s();!(i=n.n()).done;){var a=i.value;t.r[0]+=bi[0]*Oi[0]*a.intensity[0]*4*Math.PI,t.g[0]+=bi[0]*Oi[0]*a.intensity[1]*4*Math.PI,t.b[0]+=bi[0]*Oi[0]*a.intensity[2]*4*Math.PI}}catch(p){n.e(p)}finally{n.f()}}(r,i.sphericalHarmonics.sh);var u,h=Object(k.a)(o);try{for(h.s();!(u=h.n()).done;){var d=u.value;li(i.sphericalHarmonics.sh.r,d.sh.r),li(i.sphericalHarmonics.sh.g,d.sh.g),li(i.sphericalHarmonics.sh.b,d.sh.b)}}catch(p){h.e(p)}finally{h.f()}}Object(l.a)([Object(Dt.b)()],oi.prototype,"hasAlpha",void 0);var fi=[],vi=[],gi=[],bi=[0],mi=[0],yi=Object(Y.e)(),Oi=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],_i=Object(Y.e)(),ji=function(){function e(){Object(r.a)(this,e),this._renderLighting={main:{intensity:Object(Y.e)(),direction:Object(Y.g)(1,0,0),castShadows:!1},sphericalHarmonics:{sh:{r:[0],g:[0],b:[0]}}},this._shOrder=2,this._oldSunlight={direction:Object(Y.e)(),ambient:{color:Object(Y.e)(),intensity:0},diffuse:{color:Object(Y.e)(),intensity:0}}}return Object(o.a)(e,[{key:"setLightDirectionUniform",value:function(e){e.setUniform3fv("lightingMainDirection",this._renderLighting.main.direction)}},{key:"setUniforms",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t){var i=(1-this._info.groundLightingFactor)*(1-this._info.globalFactor);e.setUniform1f("lightingFixedFactor",i)}else e.setUniform1f("lightingFixedFactor",0);e.setUniform1f("lightingGlobalFactor",this._info.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._renderLighting.main.intensity),e.setUniform1f("ambientBoostFactor",.4);var n=this._renderLighting.sphericalHarmonics.sh;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",n.r[0],n.r[1],n.r[2],n.r[3]),e.setUniform4f("lightingAmbientSH_G",n.g[0],n.g[1],n.g[2],n.g[3]),e.setUniform4f("lightingAmbientSH_B",n.b[0],n.b[1],n.b[2],n.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]),e.setUniform4f("lightingAmbientSH_R1",n.r[1],n.r[2],n.r[3],n.r[4]),e.setUniform4f("lightingAmbientSH_G1",n.g[1],n.g[2],n.g[3],n.g[4]),e.setUniform4f("lightingAmbientSH_B1",n.b[1],n.b[2],n.b[3],n.b[4]),e.setUniform4f("lightingAmbientSH_R2",n.r[5],n.r[6],n.r[7],n.r[8]),e.setUniform4f("lightingAmbientSH_G2",n.g[5],n.g[6],n.g[7],n.g[8]),e.setUniform4f("lightingAmbientSH_B2",n.b[5],n.b[6],n.b[7],n.b[8]))}},{key:"set",value:function(e){this._info=e,pi(e.lights,this._shOrder,this._renderLighting),Object(X.q)(this._oldSunlight.direction,this._renderLighting.main.direction);var t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._renderLighting.sphericalHarmonics.sh.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._renderLighting.sphericalHarmonics.sh.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._renderLighting.sphericalHarmonics.sh.b[0]*t,this._oldSunlight.ambient.intensity=1,this._oldSunlight.diffuse.color[0]=this._renderLighting.main.intensity[0]*t,this._oldSunlight.diffuse.color[1]=this._renderLighting.main.intensity[1]*t,this._oldSunlight.diffuse.color[2]=this._renderLighting.main.intensity[2]*t,this._oldSunlight.diffuse.intensity=1;var i=Object(X.h)(_i,this._oldSunlight.diffuse.color);Object(X.b)(i,i,.4*this._info.globalFactor),Object(X.c)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,i)}},{key:"globalFactor",get:function(){return this._info.globalFactor}},{key:"old",get:function(){return this._oldSunlight}}]),e}(),wi=d.a.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer"),xi=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e))._overlays=null,n._hasHighlights=!1,n._rendersOccluded=!1,n._hasWater=!1,n._lighting=new ji,n._localOrigins=new mt,n._handles=new Me.a,n._layerRenderers=new Map,n._sortedLayerRenderersDirty=!1,n._sortedLayerRenderers=new we.a,n._geometries=new Map,n._uniqueIdx=0,n.globalUnitScale=1,n.longitudeCyclical=null,n}return Object(o.a)(i,[{key:"initialize",value:function(){var e=this;this._rctx=this.renderView.renderingContext,this._renderContext=new yt(this._rctx,null,null,null,null,null),this._stippleTextureRepository=new D,this.waterTextureRepository=this.renderView.waterTextureRepository,this._shaderTechniqueRepository=new ot({rctx:this._rctx,viewingMode:2,commonUniformStore:new nt,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),Object(Se.a)(this.waterTextureRepository,"loadingState",(function(){return e.emitContentChanged()})),this._materialRepository=new ht(this.renderView.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=function(t){(t.renderOccluded&Di)>0!==e._rendersOccluded&&e.updateRendersOccluded(),e.emitContentChanged(),e.notifyChange("updating")},this._compositingHelper=this.renderView.compositingHelper,this._lighting.set({lights:[new Pe(Object(Y.g)(1,1,1))],groundLightingFactor:1,globalFactor:0}),this._bindParameters={slot:null,highlightDepthTexture:Object(De.a)(this._rctx),camera:ki,inverseViewport:Object(Re.a)(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3}}},{key:"dispose",value:function(){this._handles.destroy(),this._layerRenderers.forEach((function(e){return e.dispose()})),this._layerRenderers.clear(),this._bindParameters.highlightDepthTexture.dispose(),this._bindParameters.highlightDepthTexture=null,this._shaderTechniqueRepository.dispose(),this._shaderTechniqueRepository=null}},{key:"updating",get:function(){return this._sortedLayerRenderersDirty||Object(ke.a)(this._layerRenderers,(function(e){return e.updating}))||this.waterTextureRepository.updating}},{key:"hasOverlays",get:function(){return Object(h.h)(this._overlays)}},{key:"gpuMemoryUsage",get:function(){return Object(h.h)(this._overlays)?this._overlays[0].getGpuMemoryUsage()+this._overlays[1].getGpuMemoryUsage():0}},{key:"overlays",get:function(){return this._overlays}},{key:"forEachOverlay",value:function(e){Object(h.h)(this._overlays)&&(e(this._overlays[0],0),e(this._overlays[1],1))}},{key:"ensureOverlays",value:function(){if(Object(h.g)(this._overlays)){var e=this.renderView.renderingContext;this._overlays=[new et(e,0),new et(e,1)]}}},{key:"disposeOverlays",value:function(){Object(h.h)(this._overlays)&&(this._overlays.forEach((function(e){return e.dispose()})),this._overlays=null)}},{key:"commitChanges",value:function(){var e=this,t=!1;this._layerRenderers.forEach((function(i,n){i.commitChanges()&&(t=!0),i.isEmpty&&(e._layerRenderers.delete(n),e._sortedLayerRenderersDirty=!0,e._handles.remove(n))})),this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),t=!0),t&&(this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}},{key:"addGeometries",value:function(e,t,i){var n,a=Object(k.a)(e);try{for(a.s();!(n=a.n()).done;){var r=n.value;null==r.origin&&(r.origin=this._localOrigins.getOrigin(r.center)),r.uniqueName||(r.uniqueName="ov:"+this._uniqueIdx++),this._geometries.set(r.uniqueName,r)}}catch(o){a.e(o)}finally{a.f()}this.ensureLayerRenderer(t).add(e),2===i&&this.notifyGraphicUpdate(e,t,2)}},{key:"removeGeometries",value:function(e,t,i){var n,a=Object(k.a)(e);try{for(a.s();!(n=a.n()).done;){var r=n.value;this._geometries.delete(r.uniqueName)}}catch(s){a.e(s)}finally{a.f()}var o=this._layerRenderers.get(t);o&&(o.remove(e),2===i&&this.notifyGraphicUpdate(e,t,2))}},{key:"updateGeometries",value:function(e,t,i){var n=this._layerRenderers.get(t);n?(n.modify(e,i),this.notifyUpdateGeometries(e,t,i)):wi.warn("Attempted to update geometry for nonexistent layer")}},{key:"notifyUpdateGeometries",value:function(e,t,i){var n=4===i||2===i?2:1===i?1:0;this.notifyGraphicUpdate(e,t,n)}},{key:"notifyGraphicUpdate",value:function(e,t,i){if(0!==i&&!Object(h.g)(t.notifyGraphicUpdate)){var n,a=-1,r=Object(k.a)(e);try{for(r.s();!(n=r.n()).done;){var o=n.value.data.graphicUid;o!==a&&(t.notifyGraphicUpdate(o,i),a=o)}}catch(s){r.e(s)}finally{r.f()}}}},{key:"updateHighlights",value:function(e,t){var i=this._layerRenderers.get(t);i?i.modify(e,8):wi.warn("Attempted to update highlights for nonexistent layer")}},{key:"isEmpty",value:function(){return 0===this._geometries.size&&!Ye.OVERLAY_DRAW_DEBUG_TEXTURE}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"updateLogic",value:function(e){var t=!1;return this._layerRenderers.forEach((function(i){i.updateLogic(e)&&(t=!0)})),t}},{key:"updateLayerOrder",value:function(){this._sortedLayerRenderersDirty=!0}},{key:"drawPass",value:function(e,t,i){var n=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(0===i.numViews)return!1;if(this._screenToWorldRatio=i.pixelRatio*Math.abs(i.views[0].extent[2]-i.views[0].extent[0])/Math.abs(i.views[0].viewport[2]-i.views[0].viewport[0]),this.isEmpty()||5===e&&!this.hasHighlights||3===e&&!this.hasWater)return!1;if(!this.hasNonZeroSizedView(i))return!1;var r=i.width,o=i.height;if(!t.isValid())return!1;t.resize(r,o);var s=this._rctx;if(ki.pixelRatio=i.pixelRatio||1,this._renderContext.pass=e,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,t.bind(s),s.setClearColor(0,0,0,0),s.clearSafe(16384),1===a&&(this._renderContext.renderOccludedMask=Di),Ye.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==a)for(var c=0;c<i.numViews;c++)this.setViewParameters(i.views[c],ki),this.drawDebugTexture(r,o,Si[i.index%Si.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((function(c){var l=c.layerView,u=c.renderer;if(2!==a||!Object(h.h)(l)||0!==l.drapeSourceType){var d=Object(h.h)(l)&&Object(h.h)(l.fullOpacity)&&l.fullOpacity<1&&0===e;d&&(n.bindTemporaryFramebuffer(n._rctx,r,o),s.clearSafe(16384));for(var p=0;p<i.numViews;p++)n.setViewParameters(i.views[p],ki),u.draw(n._renderContext,n._bindParameters);d&&Object(h.h)(n._temporaryRenderTarget)&&(t.bind(s),n._compositingHelper.composite(n._temporaryRenderTarget.getTexture(),2,Object(h.n)(Object(h.n)(l).fullOpacity)))}})),s.bindFramebuffer(null),t.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}},{key:"bindTemporaryFramebuffer",value:function(e,t,i){Object(h.g)(this._temporaryRenderTarget)&&(this._temporaryRenderTarget=new Qe(e,"temp",0,!1)),this._temporaryRenderTarget.resize(t,i),this._temporaryRenderTarget.bind(e)}},{key:"reloadShaders",value:function(){var e=Object(je.a)(_e.a.mark((function e(){return _e.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._shaderTechniqueRepository.hotReload();case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"intersect",value:function(e,t,i){var n=this,a=0;this._geometries.forEach((function(r){if(!i||i(r)){n.intersectRenderGeometry(r,t,0,e,a);var o=n.longitudeCyclical;o&&(r.center[0]-r.bsRadius<o.min&&n.intersectRenderGeometry(r,t,o.range,e,a),r.center[0]+r.bsRadius>o.max&&n.intersectRenderGeometry(r,t,-o.range,e,a)),a++}}))}},{key:"intersectRenderGeometry",value:function(e,t,i,n,a){var r=this,o=0;Object(h.h)(e.transformation)&&(i+=e.transformation[12],o=e.transformation[13]),Ri[0]=t[0]-i,Ri[1]=t[1]-o,Ri[2]=1,Ei[0]=t[0]-i,Ei[1]=t[1]-o,Ei[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),n,Ri,Ei,(function(t,i,o){r.addIntersectionResult(o,e.material.renderPriority,a,n,e.data.layerUid,e.data.graphicUid)}),e.calculateShaderTransformation,!0)}},{key:"addIntersectionResult",value:function(e,t,i,n,a,r){var o={type:"external",metadata:{layerUid:a,graphicUid:r}},s=function(a){a.set(o,null,n.results.ground.dist,n.results.ground.normal,n.results.ground.transformation,t,null,null,e,i),a.intersector="OverlayRenderer"};if((null==n.results.min.drapedLayerOrder||t>=n.results.min.drapedLayerOrder)&&(null==n.results.min.dist||n.results.ground.dist<=n.results.min.dist)&&s(n.results.min),0!==n.options.store&&(null==n.results.max.drapedLayerOrder||t<n.results.max.drapedLayerOrder)&&(null==n.results.max.dist||n.results.ground.dist>n.results.max.dist)&&s(n.results.max),2===n.options.store){var c=new Ae.b(n.ray);s(c),n.results.all.push(c)}}},{key:"stopAnimationsAtTime",value:function(e){this._sortedLayerRenderers.forAll((function(t){return t.renderer.stopAnimationsAtTime(e)}))}},{key:"ensureLayerRenderer",value:function(e){var t=this,i=this._layerRenderers.get(e);return i||(i=new ni({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,i),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(function(){return t.emitContentChanged()})),e),this._handles.add(Object(Se.a)(i,"updating",(function(){return t.notifyChange("updating")})),e)),i}},{key:"updateSortedLayerRenderers",value:function(){var e=this;if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var t=this._layerRenderers.keys(),i=Object(ye.a)(t,1)[0].view.allLayerViews,n=new Set(this._layerRenderers.values());i.forEach((function(t){var i=t,a=e._layerRenderers.get(i);a&&(e._sortedLayerRenderers.push(new Mi(i,a)),n.delete(a))})),n.forEach((function(t){e._sortedLayerRenderers.push(new Mi(null,t))}))}}},{key:"setViewParameters",value:function(e,t){t.viewport=e.viewport;var i=e.extent;Object(oe.m)(t.projectionMatrix,0,i[2]-i[0],0,i[3]-i[1],t.near,t.far),Object(oe.i)(t.viewMatrix),Object(oe.q)(t.viewMatrix,t.viewMatrix,[-e.extent[0],-e.extent[1],0]),t.setGLViewport(this._rctx),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]}},{key:"hasNonZeroSizedView",value:function(e){for(var t=0;t<e.numViews;t++){var i=e.views[t];if(i.extent[0]!==i.extent[2]&&i.extent[1]!==i.extent[3])return!0}return!1}},{key:"emitContentChanged",value:function(){this.onContentChanged&&this.onContentChanged()}},{key:"updateHasWater",value:function(){var e=Object(ke.a)(this._layerRenderers,(function(e){return e.hasWater}));e!==this._hasWater&&(this._hasWater=e)}},{key:"updateHasHighlights",value:function(){var e=Object(ke.a)(this._layerRenderers,(function(e){return e.hasHighlights}));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}},{key:"updateRendersOccluded",value:function(){var e=Object(ke.a)(this._layerRenderers,(function(e){return e.rendersOccluded}));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}},{key:"drawDebugTexture",value:function(e,t,i){var n=this._rctx;this.ensureDebugPatternResources(e,t);var a=this._debugTextureTechnique.program;n.bindProgram(a),n.setPipelineState(this._debugTextureTechnique.pipeline),a.setUniform4f("color",i[0],i[1],i[2],1),a.setUniform1i("tex",0),n.bindTexture(this._debugPatternTexture,0),n.bindVAO(this._quadVAO),n.drawArrays(5,0,Object(Ee.e)(this._quadVAO,"geometry"))}},{key:"ensureDebugPatternResources",value:function(e,t){if(!this._debugPatternTexture){for(var i=new Uint8Array(e*t*4),n=0,a=0;a<t;a++)for(var r=0;r<e;r++){var o=Math.floor(r/10),s=Math.floor(a/10);o<2||s<2||10*o>e-20||10*s>t-20?(i[n++]=255,i[n++]=255,i[n++]=255,i[n++]=255):(i[n++]=255,i[n++]=255,i[n++]=255,i[n++]=1&o&&1&s?1&r^1&a?0:255:1&o^1&s?0:128)}this._debugPatternTexture=new R.a(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},i);var c=new oi;c.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(ri,c,this._debugTextureTechnique),this._quadVAO=Object(De.b)(this._rctx)}}},{key:"test",get:function(){return{layerRenderers:this._layerRenderers}}}]),i}(Object(Xe.b)(xe.a));Object(l.a)([Object(Xe.c)()],xi.prototype,"_shaderTechniqueRepository",void 0),Object(l.a)([Object(Xe.c)()],xi.prototype,"_stippleTextureRepository",void 0),Object(l.a)([Object(p.b)(),Object(Xe.c)()],xi.prototype,"waterTextureRepository",void 0),Object(l.a)([Object(p.b)({constructOnly:!0})],xi.prototype,"renderView",void 0),Object(l.a)([Object(p.b)()],xi.prototype,"globalUnitScale",void 0),Object(l.a)([Object(p.b)({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating"]})],xi.prototype,"updating",null),xi=Object(l.a)([Object(f.a)("esri.views.3d.terrain.OverlayRenderer")],xi);var Mi=function e(t,i){Object(r.a)(this,e),this.layerView=t,this.renderer=i},Si=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],ki=new Be;ki.near=1,ki.far=1e4,ki.relativeElevation=null;var Ri=Object(Y.e)(),Ei=Object(Y.e)(),Di=4,Ti=(S.b,S.a);function Ci(e){var t={},i={};!function(e,t,i){for(var n=e.attributeData.position,a=e.removeDuplicateStartEnd,r=function(e){var t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(n)&&1===a,o=n.length/3-(r?1:0),s=new Uint32Array(2*(o-1)),c=r?Object(de.m)(n,0,n.length-3):n,l=0,u=0;u<o-1;u++)s[l++]=u,s[l++]=u+1;t[ne.c.POSITION]={size:3,data:c,offsetIdx:0,strideIdx:3},i[ne.c.POSITION]=s}(e,i,t);var n=new Uint32Array(t[ne.c.POSITION].length);return function(e,t,i){var n=e.attributeData.mapPosition;Object(h.g)(n)||(i.mapPos=i[ne.c.POSITION],t.mapPos={size:3,data:n,offsetIdx:0,strideIdx:3})}(e,i,t),function(e,t,i,n){if(!Object(h.h)(e.attributeData.colorFeature)){var a=e.attributeData.color;t[ne.c.COLOR]={size:4,data:Object(h.o)(a,Ti),offsetIdx:0,strideIdx:4},i[ne.c.COLOR]=n}}(e,i,t,n),function(e,t,i,n){if(!Object(h.h)(e.attributeData.sizeFeature)){var a=e.attributeData.size;t[ne.c.SIZE]={size:1,data:new Float32Array([Object(h.o)(a,1)]),offsetIdx:0,strideIdx:1},i[ne.c.SIZE]=n}}(e,i,t,n),function(e,t,i,n){var a=e.attributeData.colorFeature;Object(h.g)(a)||(t[ne.c.COLORFEATUREATTRIBUTE]={size:1,data:new Float32Array([a]),offsetIdx:0,strideIdx:1},i[ne.c.COLOR]=n)}(e,i,t,n),function(e,t,i,n){var a=e.attributeData.sizeFeature;Object(h.g)(a)||(t[ne.c.SIZEFEATUREATTRIBUTE]={size:1,data:new Float32Array([a]),offsetIdx:0,strideIdx:1},i[ne.c.SIZEFEATUREATTRIBUTE]=n)}(e,i,t,n),function(e,t,i,n){var a=e.attributeData.opacityFeature;Object(h.g)(a)||(t[ne.c.OPACITYFEATUREATTRIBUTE]={size:1,data:new Float32Array([a]),offsetIdx:0,strideIdx:1},i[ne.c.OPACITYFEATUREATTRIBUTE]=n)}(e,i,t,n),function(e,t,i){if("round"===e.join){var n=t[ne.c.POSITION].data,a=n.length/3,r=new Float32Array(a),o=Ai,s=Li;Object(X.t)(o,0,0,0);for(var c=Object(h.o)(e.uniformSize,1),l=-1;l<a;++l){var u=l<0?a+l:l,d=(l+1)%a;if(Object(X.t)(s,n[3*d+0]-n[3*u+0],n[3*d+1]-n[3*u+1],n[3*d+2]-n[3*u+2]),Object(X.o)(s,s),l>=0){var p=(Math.PI-Object(pe.b)(Object(X.e)(o,s)))*Gi*1*Ii(c);r[l]=Math.max(Math.floor(p),0)}Object(X.b)(o,s,-1)}t[ne.c.SUBDIVISIONS]={size:1,data:r,offsetIdx:0,strideIdx:1},i[ne.c.SUBDIVISIONS]=i[ne.c.POSITION]}}(e,i,t),new be.a(i,t,"line")}function Pi(e,t,i){var n,a=new Array,r=Object(k.a)(e);try{for(r.s();!(n=r.n()).done;){var o=n.value,s=o.index,c=o.count;if(!(c<=1)){var l=3*s,u=l+3*c;a.push({position:t.subarray(l,u),mapPosition:i?i.subarray(l,u):void 0})}}}catch(h){r.e(h)}finally{r.f()}return a}function Ii(e){return 1.863798+-2.0062872/Math.pow(1+e/18.2313,.8856294)}var Ai=Object(Y.e)(),Li=Object(Y.e)(),Gi=4/Math.PI,zi=i(273),Vi=i(579),Fi=i(620),Hi=i(204),Ni=function(){function e(t){Object(r.a)(this,e),this.resourceFactory=t,this._resources=null,this._visible=!0,this._attached=!1}return Object(o.a)(e,[{key:"destroy",value:function(){this._destroyResources()}},{key:"resources",get:function(){return Object(h.h)(this._resources)?this._resources.external:null}},{key:"visible",get:function(){return this._visible},set:function(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}},{key:"attached",get:function(){return this._attached},set:function(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}},{key:"recreate",value:function(){this.attached&&this._createResources()}},{key:"recreateGeometry",value:function(){this.resourceFactory.recreateGeometry?Object(h.g)(this._resources)||(this.ensureRenderGeometriesRemoved(),this.resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}},{key:"_createOrDestroyResources",value:function(){this._attached?Object(h.g)(this._resources)&&this._createResources():this._destroyResources()}},{key:"_createResources",value:function(){var e;this._destroyResources();var t=this.resourceFactory.createResources();this._resources={layerView:new Ui({view:this.resourceFactory.view}),external:t,geometriesAdded:!1},this._syncGeometriesToRenderer();var i=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;i&&i.registerDrapeSource(this._resources.layerView)}},{key:"_destroyResources",value:function(){var e;if(!Object(h.g)(this._resources)){this.ensureRenderGeometriesRemoved();var t=null==(e=this.resourceFactory.view.basemapTerrain)?void 0:e.overlayManager;t&&t.unregisterDrapeSource(this._resources.layerView),this._resources=null}}},{key:"_syncGeometriesToRenderer",value:function(){this._visible?this.ensureRenderGeometriesAdded():this.ensureRenderGeometriesRemoved()}},{key:"ensureRenderGeometriesRemoved",value:function(){var e;!Object(h.g)(this._resources)&&null!=(e=this.resourceFactory.view)&&e.basemapTerrain&&this._resources.geometriesAdded&&(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.removeGeometries(this._resources.external.geometries,this._resources.layerView,2),this._resources.geometriesAdded=!1)}},{key:"ensureRenderGeometriesAdded",value:function(){Object(h.g)(this._resources)||this._resources.geometriesAdded||(this.resourceFactory.view.basemapTerrain.overlayManager.renderer.addGeometries(this._resources.external.geometries,this._resources.layerView,2),this._resources.geometriesAdded=!0)}}]),e}(),Ui=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e)).drapeSourceType=1,n}return i}(Object(Hi.a)(xe.a));Object(l.a)([Object(p.b)({constructOnly:!0})],Ui.prototype,"view",void 0),Object(l.a)([Object(p.b)({readOnly:!0})],Ui.prototype,"drapeSourceType",void 0),Ui=Object(l.a)([Object(f.a)("DrapedVisualElementLayerView")],Ui);var Wi=function(){function e(t){var i=this;Object(r.a)(this,e),this.view=null,this._attachmentOrigin=Object($.d)(0,0,0,null),this._attachmentOriginDirty=!0,this.events=new v.a,this._isDraped=!1,this._geometry=null,this._width=1,this._color=Object(zi.b)(1,0,1,1),this._innerWidth=0,this._innerColor=Object(zi.b)(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._falloff=0,this._elevationInfo=null,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=8,this.resources=new Fi.a({view:t.view,createResources:function(e){return i.createResources(e)},recreateGeometry:function(e,t){return e.geometries.length=0,i.recreateGeometry(t,e.material,e.geometries),e.geometries}}),this._attachmentOrigin.spatialReference=t.view.spatialReference,this.drapedResources=new Ni({view:t.view,createResources:function(){return i.createDrapedResources()},recreateGeometry:function(e){e.geometries=i.createRenderGeometriesDraped(e.material),i.attachmentOriginChanged()}});var n=!0;for(var a in this._laserline=new Vi.a({view:t.view}),t)a in this?"attached"===a?n=t[a]:this[a]=t[a]:console.error("Cannot set unknown property",a);this.attached=n}return Object(o.a)(e,[{key:"destroy",value:function(){this.resources.destroy(),this.drapedResources.destroy(),this._laserline.destroy()}},{key:"isDraped",get:function(){return this._isDraped},set:function(e){e!==this._isDraped&&(this._isDraped=e,this.updateAttached(this.attached),this._laserline.attached=this.laserlineAttached)}},{key:"laserlineAttached",get:function(){return this.attached&&this.visible&&Object(h.h)(this._laserlineStyle)&&!this.isDraped&&this.laserlineEnabled}},{key:"visible",get:function(){return this.resources.visible},set:function(e){this.resources.visible=e,this.drapedResources.visible=e,this._laserline.attached=this.laserlineAttached}},{key:"attached",get:function(){return this.resources.attached||this.drapedResources.attached},set:function(e){this.updateAttached(e)}},{key:"updateAttached",value:function(e){this.resources.attached=!this.isDraped&&e,this.drapedResources.attached=this.isDraped&&e,this._laserline.attached=this.laserlineAttached,this.attached&&this.attachmentOriginChanged()}},{key:"geometry",get:function(){return this._geometry},set:function(e){this._geometry=e,this.resources.recreateGeometry(),this.drapedResources.recreateGeometry()}},{key:"width",get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this.updateMaterial())}},{key:"color",get:function(){return this._color},set:function(e){Object(K.g)(e,this._color)||(Object(K.c)(this._color,e),this.updateMaterial())}},{key:"innerWidth",get:function(){return this._innerWidth},set:function(e){e!==this._innerWidth&&(this._innerWidth=e,this.updateMaterial())}},{key:"innerColor",get:function(){return this._innerColor},set:function(e){Object(K.g)(e,this._innerColor)||(Object(K.c)(this._innerColor,e),this.updateMaterial())}},{key:"stipplePattern",get:function(){return this._stipplePattern},set:function(e){var t=Object(h.h)(e)!==Object(h.h)(this._stipplePattern);this._stipplePattern=e,t?this.resources.recreate():this.updateMaterial()}},{key:"stippleOffColor",get:function(){return this._stippleOffColor},set:function(e){e&&this._stippleOffColor&&Object(K.g)(e,this._stippleOffColor)||(this._stippleOffColor=e?Object(zi.a)(e):null,this.updateMaterial())}},{key:"falloff",get:function(){return this._falloff},set:function(e){e!==this._falloff&&(this._falloff=e,this.updateMaterial())}},{key:"elevationInfo",get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this.resources.recreateGeometry()}},{key:"laserlineStyle",get:function(){return this._laserlineStyle},set:function(e){this._laserlineStyle=e,this._laserline.attached=this.laserlineAttached,Object(h.h)(e)&&(this._laserline.style=e)}},{key:"laserlineEnabled",get:function(){return this._laserlineEnabled},set:function(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this.laserlineAttached)}},{key:"renderOccluded",get:function(){return this._renderOccluded},set:function(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial())}},{key:"attachmentOrigin",get:function(){if(!this._attachmentOriginDirty)return this._attachmentOrigin;var e=Object(h.h)(this.resources.resources)?this.resources.resources.geometries:null;if(!e||0===e.length)return null;Object(X.t)(Zi,0,0,0);var t,i=ne.c.POSITION,n=0,a=Object(k.a)(e);try{for(a.s();!(t=a.n()).done;){var r=t.value,o=r.getAttribute(i),s=r.getIndices(i),c=Object(h.n)(this.resources.resources).material.isClosed(o.data,s);Object(ee.a)(o,s,c,Bi)&&(Object(X.c)(Zi,Zi,Bi),n++)}}catch(l){a.e(l)}finally{a.f()}return 0===n?null:(Object(X.b)(Zi,Zi,1/n),this.view.renderCoordsHelper.fromRenderCoords(Zi,this._attachmentOrigin),this._attachmentOriginDirty=!1,this._attachmentOrigin)}},{key:"updateMaterial",value:function(){Object(h.h)(this.resources.resources)&&this.resources.resources.material.setParameterValues(this.materialParameters),Object(h.h)(this.drapedResources.resources)&&this.drapedResources.resources.material.setParameterValues(this.materialParameters)}},{key:"isClosed",get:function(){return Object(h.h)(this.geometry)&&"polygon"===this.geometry.type}},{key:"materialParameters",get:function(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,isClosed:this.isClosed,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,join:"round",stippleIntegerRepeats:!0,polygonOffset:!0,renderOccluded:this.normalizedRenderOccluded}}},{key:"normalizedRenderOccluded",get:function(){return this.isDraped&&8===this._renderOccluded?4:this._renderOccluded}},{key:"recreateGeometry",value:function(e,t,i){var n,a=this.createRenderGeometries(),r=Object(k.a)(a);try{for(r.s();!(n=r.n()).done;){var o=n.value;e.addGeometry(o,t),i.push(o)}}catch(s){r.e(s)}finally{r.f()}this.attachmentOriginChanged()}},{key:"attachmentOriginChanged",value:function(){this._attachmentOriginDirty=!0,this.events.emit("attachment-origin-changed")}},{key:"createResources",value:function(e){var t=new ae.a(this.materialParameters,"lineVisualElement"),i=[];return this.recreateGeometry(e,t,i),{material:t,geometries:i,forEach:function(e){e(t),i.forEach(e)}}}},{key:"createDrapedResources",value:function(){var e=new ae.a(this.materialParameters,"lineVisualElement");return{material:e,geometries:this.createRenderGeometriesDraped(e)}}},{key:"createRenderGeometriesDraped",value:function(e){var t=this.geometry;if(Object(h.g)(t))return[];var i,n=function(e,t){for(var i="polygon"===e.type?1:0,n=ve("polygon"===e.type?e.rings:e.paths,!1,i),a=n.position,r=n.outlines,o=Object(Q.j)(a,e.spatialReference,0,a,t,0,a.length/3),s=2;s<a.length;s+=3)a[s]=-2;return{lines:o?Pi(r,a):[],projectionSuccess:o}}(t,this.view.basemapTerrain.spatialReference),a=[],r=Object(k.a)(n.lines);try{for(r.s();!(i=r.n()).done;){var o=i.value.position,s={attributeData:{position:o},removeDuplicateStartEnd:this.isClosed?1:0},c=new he(Ci(s));c.material=e;var l=Object(J.e)(qi);Object(J.h)(l,o),Object(X.t)(c.center,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0),c.bsRadius=.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1])),a.push(c)}}catch(u){r.e(u)}finally{r.f()}return a}},{key:"calculateMapBounds",value:function(e){if(Object(h.g)(this.resources.resources))return!1;var t,i=this.view.renderCoordsHelper,n=Object(k.a)(this.resources.resources.geometries);try{for(n.s();!(t=n.n()).done;){var a=t.value.data.getAttribute("position"),r=a.data,o=new Float64Array(r.length);Object(Q.j)(a.data,i.spatialReference,0,o,this.view.spatialReference,0,r.length/3),Object(J.h)(e,o)}}catch(s){n.e(s)}finally{n.f()}return!0}},{key:"createRenderGeometries",value:function(){var e=this.geometry;if(Object(h.g)(e))return[];var t,i=function(e,t,i,n){var a="polygon"===e.type?1:0,r=ve("polygon"===e.type?e.rings:e.paths,e.hasZ,a),o=r.position,s=r.outlines,c=new Float64Array(o.length),l=Object(me.b)(o,e.spatialReference,0,c,0,o,0,o.length/3,t,i,n),u=null!=l;return{lines:u?Pi(s,o,c):[],projectionSuccess:u,sampledElevation:l}}(e,this.view.elevationProvider,this.view.renderCoordsHelper,te.a.fromElevationInfo(this.elevationInfo)),n=[],a=[],r=Object(k.a)(i.lines);try{for(r.s();!(t=r.n()).done;){var o=t.value,s=o.position,c=Ci({attributeData:{position:s,mapPosition:o.mapPosition},removeDuplicateStartEnd:this.isClosed?1:0});n.push(new ie.a(c,"geometryOutlineVisualElement")),a.push(s)}}catch(l){r.e(l)}finally{r.f()}return this._laserline.pathVerticalPlane=a,n}}]),e}(),qi=Object(J.d)(),Bi=Object(Y.e)(),Zi=Object(Y.e)(),Yi=i(261),Xi=i(593);Object(Y.e)();var Qi=i(358),Ki=i(1086),Ji=i(1087),$i=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(){return Object(r.a)(this,i),t.apply(this,arguments)}return Object(o.a)(i,[{key:"initializeProgram",value:function(e){var t=i.shader.get(),n=this.configuration,a=t.build({output:n.output,slicePlaneEnabled:n.slicePlaneEnabled,sliceHighlightDisabled:n.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,screenSizeEnabled:n.screenSizeEnabled,shadingEnabled:n.shadingEnabled,OITEnabled:0===n.transparencyPassType});return new Ct.a(e.rctx,a.generateSource("vertex"),a.generateSource("fragment"),rn)}},{key:"bindPass",value:function(e,t,i){var n=this.configuration,a=n.screenSizeEnabled,r=n.shadingEnabled,o=t.color,s=t.shadingTint,c=t.shadingDirection;It.a.bindProjectionMatrix(this.program,i.camera.projectionMatrix),this.program.setUniform4fv("color",o),r&&(this.program.setUniform4fv("shadedColor",this.blendColor(on,s,o)),this.program.setUniform3fv("shadingDirection",c),this.program.setUniformMatrix4fv("viewNormal",i.camera.viewInverseTransposeMatrix)),a&&Ki.a.bindPassUniforms(this.program,t,i)}},{key:"blendColor",value:function(e,t,i){var n=1-t[3],a=t[3]+i[3]*n;return 0===a?(e[3]=a,e):(e[0]=(t[0]*t[3]+i[0]*i[3]*n)/a,e[1]=(t[1]*t[3]+i[1]*i[3]*n)/a,e[2]=(t[2]*t[3]+i[2]*i[3]*n)/a,e[3]=i[3],e)}},{key:"bindDraw",value:function(e){It.a.bindView(this.program,e),It.a.bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Lt.a.bindUniformsWithOrigin(this.program,this.configuration,e)}},{key:"setPipelineState",value:function(e){var t,i=this.configuration,n=3===e,a=2===e;return Object(Pt.d)({blending:0!==i.output&&7!==i.output||!i.transparent?null:n?zt.f:Object(zt.a)(e),culling:(t=i.cullFace,0!==t&&{face:1===t?1028:1029,mode:2305}),depthTest:{func:a?513:i.shadingEnabled?515:513},depthWrite:n?i.writeDepth&&Pt.c:Object(zt.c)(e),colorWrite:Pt.b,polygonOffset:n||a?null:zt.d})}},{key:"initializePipeline",value:function(){return this.setPipelineState(this.configuration.transparencyPassType)}}]),i}(Et.a);$i.shader=new Rt.a(Ji.a,(function(){return i.e(134).then(i.bind(null,1219))}));var en=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).output=0,e.cullFace=0,e.slicePlaneEnabled=!1,e.sliceHighlightDisabled=!1,e.transparent=!1,e.writeDepth=!0,e.screenSizeEnabled=!0,e.shadingEnabled=!0,e.transparencyPassType=3,e}return i}(Dt.a);Object(l.a)([Object(Dt.b)({count:8})],en.prototype,"output",void 0),Object(l.a)([Object(Dt.b)({count:3})],en.prototype,"cullFace",void 0),Object(l.a)([Object(Dt.b)()],en.prototype,"slicePlaneEnabled",void 0),Object(l.a)([Object(Dt.b)()],en.prototype,"sliceHighlightDisabled",void 0),Object(l.a)([Object(Dt.b)()],en.prototype,"transparent",void 0),Object(l.a)([Object(Dt.b)()],en.prototype,"writeDepth",void 0),Object(l.a)([Object(Dt.b)()],en.prototype,"screenSizeEnabled",void 0),Object(l.a)([Object(Dt.b)()],en.prototype,"shadingEnabled",void 0),Object(l.a)([Object(Dt.b)({count:4})],en.prototype,"transparencyPassType",void 0);var tn="position",nn="normal",an="offset",rn={position:0,normal:1,offset:2},on=Object(S.c)(),sn=i(113),cn=i(205),ln=i(197),un=i(301),hn=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e,n){var a;return Object(r.a)(this,i),(a=t.call(this,n,e,pn)).supportsEdges=!0,a.techniqueConfig=new en,a._vertexAttributeLocations=rn,a}return Object(o.a)(i,[{key:"getTechniqueConfig",value:function(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.params.cullFace,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.transparent=this.params.transparent,this.techniqueConfig.writeDepth=this.params.writeDepth,this.techniqueConfig.screenSizeEnabled=this.params.screenSizeEnabled,this.techniqueConfig.shadingEnabled=this.params.shadingEnabled,this.techniqueConfig.transparencyPassType=t?t.transparencyPassType:3,this.techniqueConfig}},{key:"getPassParameters",value:function(){return this.params}},{key:"intersect",value:function(e,t,i,n,a,r,o){var s=this;if(this.params.screenSizeEnabled){var c=e.getAttribute(an),l={applyToVertex:function(e,t,i,a){var r=Object(X.t)(vn,c.data[3*a+0],c.data[3*a+1],c.data[3*a+2]),o=Object(X.t)(gn,e,t,i);return Object(X.b)(r,r,s.params.screenSize*n.camera.computeRenderPixelSizeAt(r)),Object(X.c)(o,o,r),[o[0],o[1],o[2]]},applyToAabb:function(e){var t=Object(J.b)(e,vn);return Object(J.p)(e,s.params.screenSize*n.camera.computeRenderPixelSizeAt(t))}};Object(ln.d)(e,t,n,a,r,l,o)}else Object(ln.d)(e,t,n,a,r,void 0,o)}},{key:"getGLMaterial",value:function(e){return 0===e.output||7===e.output||4===e.output?new dn(e):void 0}},{key:"createBufferWriter",value:function(){return new fn(this.params.screenSizeEnabled)}}]),i}(Ot.a),dn=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e)).updateParameters(),n}return Object(o.a)(i,[{key:"updateParameters",value:function(e){this.technique=this.techniqueRep.acquireAndReleaseExisting($i,this.material.getTechniqueConfig(this.output,e),this.technique)}},{key:"beginSlot",value:function(e){if(4===this.output)return 3===e;var t=3;return this.technique.configuration.transparent&&(t=this.technique.configuration.writeDepth?5:8),e===t}},{key:"ensureParameters",value:function(e){this.updateParameters(e)}},{key:"bind",value:function(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.getPassParameters(),t)}}]),i}(kt.a),pn=Object(a.a)({color:[1,1,1,1],shadingTint:[0,0,0,.25],shadingDirection:Object(X.o)(Object(Y.e)(),[.5,-.5,-.5]),transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:0,screenSizeEnabled:!1,screenSize:14,shadingEnabled:!0},Ot.b),fn=function(){function e(t){Object(r.a)(this,e),this.screenSizeEnabled=t;var i=Object(cn.a)().vec3f(tn).vec3f(nn);this.screenSizeEnabled&&i.vec3f(an),this.vertexBufferLayout=i}return Object(o.a)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices[tn].length}},{key:"write",value:function(e,t,i,n){if(Object(un.c)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,n),this.screenSizeEnabled){if(!(an in t.vertexAttr))throw new Error("".concat(an," vertex attribute required for screenSizeEnabled ShadedColorMaterial"));var a=t.vertexAttr[an],r=t.indices[an];Object(ce.b)(3===a.size);var o=i.getField(an,sn.u);if(!o)throw new Error("unable to acquire view for "+an);Object(un.e)(r,a.data,e.invTranspTransformation,o,n)}}}]),e}(),vn=Object(Y.e)(),gn=Object(Y.e)(),bn=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e)).view=null,n._renderOccluded=4,n._vertices=null,n._spatialReference=null,n._color=Z.colorToVec4(Z.reshapeManipulators.vertex.color),n._size=Z.reshapeManipulators.vertex.size,n._outlineColor=Z.colorToVec4(Z.reshapeManipulators.vertex.outlineColor),n._outlineSize=Z.reshapeManipulators.vertex.outlineSize,n._elevationInfo=null,n.applyProps(e),n}return Object(o.a)(i,[{key:"renderOccluded",get:function(){return this._renderOccluded},set:function(e){e!==this._renderOccluded&&(this._renderOccluded=e,this.updateMaterial(),this.updateOutlineMaterial())}},{key:"vertices",get:function(){return this._vertices},set:function(e){this._vertices=e,this.recreateGeometry()}},{key:"spatialReference",get:function(){return this._spatialReference},set:function(e){this._spatialReference=e,this.recreateGeometry()}},{key:"color",get:function(){return this._color},set:function(e){Object(K.g)(e,this._color)||(Object(K.c)(this._color,e),this.updateMaterial())}},{key:"size",get:function(){return this._size},set:function(e){e!==this._size&&(this._size=e,this.updateMaterial())}},{key:"outlineColor",get:function(){return this._outlineColor},set:function(e){Object(K.g)(e,this._outlineColor)||(Object(K.c)(this._outlineColor,e),this.updateOutlineMaterial())}},{key:"outlineSize",get:function(){return this._outlineSize},set:function(e){e!==this._outlineSize&&(this._outlineSize=e,this.updateOutlineMaterial())}},{key:"elevationInfo",get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this.recreateGeometry()}},{key:"vertexMaterialParameters",get:function(){return{color:this._color,transparent:this._color[3]<1,screenSize:this.size,renderOccluded:this._renderOccluded}}},{key:"vertexOutlineMaterialParameters",get:function(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSize:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}},{key:"updateMaterial",value:function(){this.attached&&this.vertexMaterial.setParameterValues(this.vertexMaterialParameters)}},{key:"updateOutlineMaterial",value:function(){this.attached&&this.vertexOutlineMaterial.setParameterValues(this.vertexOutlineMaterialParameters)}},{key:"createRenderGeometries",value:function(){var e=this.vertices;if(Object(h.g)(e)||0===e.length)return[];for(var t=function(e,t,i,n,a){var r=new Float64Array(3*e.length),o=new Float64Array(r.length);e.forEach((function(e,t){r[3*t+0]=e[0],r[3*t+1]=e[1],r[3*t+2]=e.length>2?e[2]:0}));var s=Object(me.b)(r,t,0,o,0,r,0,r.length/3,i,n,a),c=null!=s;return{numVertices:e.length,position:r,mapPosition:o,projectionSuccess:c,sampledElevation:s}}(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,te.a.fromElevationInfo(this.elevationInfo)),i=[],n=t.numVertices,a=t.position,r=0;r<n;++r){var o=Object(X.t)(mn,a[3*r+0],a[3*r+1],a[3*r+2]),s=new ie.a(yn(.5,16,16,o),"VerticesVisualElement-vertex"),c=new ie.a(yn(.5,16,16,o),"VerticesVisualElement-vertexOutline");i.push({vertexGeometry:s,vertexOutlineGeometry:c})}return i}},{key:"createGeometries",value:function(e){var t,i=this.createRenderGeometries(),n=Object(k.a)(i);try{for(n.s();!(t=n.n()).done;){var a=t.value,r=a.vertexGeometry,o=a.vertexOutlineGeometry;e.addGeometry(r,this.vertexMaterial),e.addGeometry(o,this.vertexOutlineMaterial)}}catch(s){n.e(s)}finally{n.f()}}},{key:"createExternalResources",value:function(){this.vertexMaterial=new hn(Object(a.a)(Object(a.a)({},this.vertexMaterialParameters),{},{writeDepth:!0,cullFace:2,screenSizeEnabled:!0}),"manipulator"),this.vertexOutlineMaterial=new hn(Object(a.a)(Object(a.a)({},this.vertexOutlineMaterialParameters),{},{transparent:!0,writeDepth:!0,cullFace:1,screenSizeEnabled:!0,shadingEnabled:!1}),"manipulator-outline")}},{key:"destroyExternalResources",value:function(){this.vertexMaterial=null,this.vertexOutlineMaterial=null}},{key:"forEachExternalResource",value:function(e){e(this.vertexMaterial),e(this.vertexOutlineMaterial)}}]),i}(Qi.a),mn=Object(Y.e)();function yn(e,t,i,n){var a=Yi.a.createSphereGeometry(e,t,i,{attributes:{position:an,uv:null}});return a.indices[tn]=new Uint32Array(a.indexCount),a.vertexAttributes[tn]={size:3,data:Float64Array.from(n),offsetIdx:0,strideIdx:3},a}var On=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e)).drawOperation=null,n._createGraphic=null,n._outlineVisualElement=null,n._verticesVisualElement=null,n._stagedVerticesVisualElement=null,n.hasZ=!0,n.defaultZ=0,n.elevationInfo=null,n.snapToScene=!1,n.snappingOptions=new _.a,n.mode=null,n.geometryType=null,n.type="draw-3d",n}return Object(o.a)(i,[{key:"initialize",value:function(){var e=this,t=Object(h.o)(this.elevationInfo,{mode:this.hasZ?"absolute-height":"on-the-ground",offset:0});this._internalGraphicsLayer=new b.a({elevationInfo:t}),this.view.map.layers.add(this._internalGraphicsLayer),this.drawOperation=new n.a({view:this.view,manipulators:this.manipulators,geometryType:_n(this.geometryType),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,snappingDrawSurface:new y.b(this.view,t,[this._internalGraphicsLayer]),hasM:!1,elevationInfo:t,snappingOptions:this.snappingOptions}),this.drawOperation.on("vertex-add",(function(t){return e.onVertexAdd(t)})),this.drawOperation.on("vertex-remove",(function(t){return e.onVertexRemove(t)})),this.drawOperation.on("vertex-update",(function(t){return e.onVertexUpdate(t)})),this.drawOperation.on("cursor-update",(function(t){return e.onCursorUpdate(t)})),this.drawOperation.on("complete",(function(t){return e.onComplete(t)}))}},{key:"destroy",value:function(){this.drawOperation.destroy(),this.drawOperation=null,this._destroyAllVisualisations(),this.view.map.remove(this._internalGraphicsLayer),this._set("view",null)}},{key:"onInputEvent",value:function(e){this.drawOperation.onInputEvent(e)}},{key:"_getCreateGeometry",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(null==this.drawOperation)return null;var i=Object(h.h)(e)?e:this.drawOperation.hasStagedVertex?this.drawOperation.numVertices-1:null,n=this.drawOperation.vertices;if(0===n.length)return null;var a=this.drawOperation.spatialReference,r=n,o=r.slice(),s=[];Object(h.h)(i)&&(o.splice(i,1),s.push(r[i]));var c={regularVertices:null,stagedVertices:null,full:null,outline:null},l="3d"===this.view.type&&"global"===this.view.viewingMode;switch(this.geometryType){case"point":c.regularVertices=o,c.stagedVertices=s,c.full=this.drawOperation.coordinateHelper.createPointFromArray(n[0]);break;case"polyline":c.regularVertices=o,c.stagedVertices=s,r.length>0&&(c.full=Object(j.e)([r],a,l));break;case"polygon":c.regularVertices=o,c.stagedVertices=s,r.length>0&&(c.full=Object(j.d)([r],a,l,!0));break;case"circle":if(r.length>0){var u=Object(j.h)(this.view,n[0]);if(1===r.length&&t){var d=r[0],p=u.makeMapPoint(d[0]+jn*this.view.resolution,d[1]);c.full=Object(j.a)([d,p],u,!0)}else 2===r.length&&(c.full=this.forceUniformSize?Object(j.a)(n,u,this.centered):Object(j.b)(n,u,this.centered))}break;case"rectangle":if(r.length>0){var f=Object(j.h)(this.view,n[0]);if(1===r.length&&t){var v=r[0],g=f.makeMapPoint(v[0]+jn*this.view.resolution,v[1]);c.full=Object(j.g)([v,g],f,!0)}else 2===r.length&&(c.full=this.forceUniformSize?Object(j.g)(n,f,this.centered):Object(j.f)(n,f,this.centered))}break;default:return null}switch(this.geometryType){case"point":break;case"polyline":r.length>1&&(c.outline=Object(j.e)([r],a,l));break;case"polygon":r.length>1&&(c.outline=Object(j.d)([r],a,l));break;case"circle":case"rectangle":Object(h.h)(c.full)&&"polygon"===c.full.type&&(c.outline=Object(j.d)(c.full.rings,a,l))}return c}},{key:"_destroyAllVisualisations",value:function(){this._destroyCreateGraphic(),this._destroyOutlineVisualElement(),this._destroyVerticesVisualElement(),this._destroyStagedVerticesVisualElement()}},{key:"_destroyCreateGraphic",value:function(){Object(h.h)(this._createGraphic)&&(this._internalGraphicsLayer.remove(this._createGraphic),this._createGraphic.destroy(),this._createGraphic=null)}},{key:"_destroyOutlineVisualElement",value:function(){Object(h.h)(this._outlineVisualElement)&&(this._outlineVisualElement.destroy(),this._outlineVisualElement=null)}},{key:"_destroyVerticesVisualElement",value:function(){Object(h.h)(this._verticesVisualElement)&&(this._verticesVisualElement.destroy(),this._verticesVisualElement=null)}},{key:"_destroyStagedVerticesVisualElement",value:function(){Object(h.h)(this._stagedVerticesVisualElement)&&(this._stagedVerticesVisualElement.destroy(),this._stagedVerticesVisualElement=null)}},{key:"_updateCreateGraphic",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this._getCreateGeometry(e);if(Object(h.g)(t))this._destroyAllVisualisations();else{var i=this._internalGraphicsLayer.elevationInfo,n="on-the-ground"===Object(m.c)(this.hasZ,i);Object(h.h)(t.outline)?Object(h.g)(this._outlineVisualElement)?(this._outlineVisualElement=new Wi({view:this.view,geometry:t.outline,elevationInfo:Object(h.n)(i),isDraped:n,attached:!1}),Z.visualElements.lineGraphics.outline.apply(this._outlineVisualElement),Z.visualElements.lineGraphics.shadowStyle.apply(this._outlineVisualElement),this._outlineVisualElement.attached=!0,this._outlineVisualElement.laserlineEnabled=!0):this._outlineVisualElement.geometry=t.outline:this._destroyOutlineVisualElement(),Object(h.h)(t.regularVertices)?Object(h.g)(this._verticesVisualElement)?(this._verticesVisualElement=new bn({view:this.view,spatialReference:this.view.spatialReference,vertices:t.regularVertices,elevationInfo:Object(h.n)(this._internalGraphicsLayer.elevationInfo),renderOccluded:Z.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._verticesVisualElement.attached=!0):this._verticesVisualElement.vertices=t.regularVertices:this._destroyVerticesVisualElement(),Object(h.h)(t.stagedVertices)?Object(h.g)(this._stagedVerticesVisualElement)?(this._stagedVerticesVisualElement=new bn({view:this.view,spatialReference:this.view.spatialReference,vertices:t.stagedVertices,elevationInfo:Object(h.n)(this._internalGraphicsLayer.elevationInfo),renderOccluded:Z.reshapeManipulators.vertex.renderOccluded,attached:!1}),this._stagedVerticesVisualElement.color=Z.colorToVec4(Z.reshapeManipulators.selected.color),this._stagedVerticesVisualElement.attached=!0):this._stagedVerticesVisualElement.vertices=t.stagedVertices:this._destroyStagedVerticesVisualElement(),Object(h.h)(t.full)?Object(h.g)(this._createGraphic)?(this._createGraphic=new g.a({geometry:t.full,symbol:this.createGraphicSymbol}),this._internalGraphicsLayer.add(this._createGraphic),this.view.maskOccludee(this._createGraphic),this.notifyChange("createGraphic")):this._createGraphic.geometry=t.full:this._destroyCreateGraphic()}}},{key:"createGraphic",get:function(){return this._createGraphic}},{key:"enabled",set:function(e){this.drawOperation.interactive=e,this._set("enabled",e)}},{key:"centered",set:function(e){this._set("centered",e),this._updateCreateGraphic()}},{key:"forceUniformSize",set:function(e){this._set("forceUniformSize",e),this._updateCreateGraphic()}},{key:"reset",value:function(){}},{key:"canRedo",get:function(){return this.drawOperation.canRedo}},{key:"redo",value:function(){this.drawOperation.redo()}},{key:"canUndo",get:function(){return this.drawOperation.canUndo}},{key:"undo",value:function(){this.drawOperation.undo()}},{key:"completeCreateOperation",value:function(){this.drawOperation.complete()}},{key:"activate",value:function(){}},{key:"deactivate",value:function(){this.drawOperation.isCompleted||this.drawOperation.cancel()}},{key:"getVertexCoords",value:function(){return this.drawOperation.vertices}},{key:"onVertexAdd",value:function(e){this._updateCreateGraphic(),this.emit("vertex-add",e)}},{key:"onVertexRemove",value:function(e){this._updateCreateGraphic(),this.emit("vertex-remove",e)}},{key:"onVertexUpdate",value:function(e){this._updateCreateGraphic(),this.emit("vertex-update",e)}},{key:"onCursorUpdate",value:function(e){this._updateCreateGraphic(1===e.vertices.length?e.vertices[0].vertexIndex:null),this.emit("cursor-update",e)}},{key:"onComplete",value:function(e){this._updateCreateGraphic();var t=null;if(this.drawOperation.isCompleted){var i=this._getCreateGeometry(null,!0);Object(h.h)(i)&&(t=new g.a({geometry:i.full,symbol:this.createGraphicSymbol}))}this.emit("complete",Object(a.a)({graphic:t},e))}}]),i}(v.a.EventedMixin(O.a));function _n(e){switch(e){case"point":case"polyline":case"polygon":return e;case"circle":case"rectangle":return"segment";default:return null}}Object(l.a)([Object(p.b)({constructOnly:!0,nonNullable:!0})],On.prototype,"view",void 0),Object(l.a)([Object(p.b)()],On.prototype,"createGraphicSymbol",void 0),Object(l.a)([Object(p.b)()],On.prototype,"createGraphic",null),Object(l.a)([Object(p.b)({value:!0})],On.prototype,"enabled",null),Object(l.a)([Object(p.b)({value:!0})],On.prototype,"centered",null),Object(l.a)([Object(p.b)({value:!0})],On.prototype,"forceUniformSize",null),Object(l.a)([Object(p.b)({constructOnly:!0})],On.prototype,"hasZ",void 0),Object(l.a)([Object(p.b)({nonNullable:!0})],On.prototype,"defaultZ",void 0),Object(l.a)([Object(p.b)({constructOnly:!0})],On.prototype,"elevationInfo",void 0),Object(l.a)([Object(p.b)()],On.prototype,"snapToScene",void 0),Object(l.a)([Object(p.b)()],On.prototype,"snappingOptions",void 0),Object(l.a)([Object(p.b)({constructOnly:!0})],On.prototype,"mode",void 0),Object(l.a)([Object(p.b)({constructOnly:!0})],On.prototype,"geometryType",void 0),Object(l.a)([Object(p.b)({readOnly:!0})],On.prototype,"type",void 0),On=Object(l.a)([Object(f.a)("esri.views.3d.interactive.editingTools.draw3D.DrawTool")],On);var jn=48,wn=i(95),xn=i(39),Mn=i(425),Sn=i(51),kn=i(396),Rn=i(572),En=i(186),Dn=i(56),Tn=(i(99),i(224)),Cn=i(263),Pn=i(220),In=i(381),An=function(){function e(t){for(var i in Object(r.a)(this,e),this.camera=new Be,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=[],this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=Object(se.b)(),this._worldFrame=null,this._renderLocation=Object(Y.e)(),this._renderLocationDirty=!0,this._location=new Dn.a({x:0,y:0,z:0}),this._elevationAlignedLocation=new Dn.a,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=0,this._focused=!1,this.events=new v.a.EventEmitter,this._screenLocation={screenPointArray:Object(Le.f)(),renderScreenPointArray:Object(Le.d)(),pixelSize:0},this._screenLocationDirty=!0,this._applyObjectTransform=null,this._engineResourcesAddedToStage=!1,this._engineResources=null,this._attached=!1,this._engineLayerId=null,this._materialIdReferences=null,this._location.spatialReference=t.view.spatialReference,t)this[i]=t[i];this.view.state&&this.view.state.camera&&this.camera.copyFrom(this.view.state.camera)}return Object(o.a)(e,[{key:"destroy",value:function(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this.camera=null}},{key:"elevationInfo",get:function(){return this._elevationInfo},set:function(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}},{key:"renderObjects",get:function(){return this._renderObjects},set:function(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}},{key:"available",get:function(){return this._available},set:function(e){e!==this._available&&(this._available=e,this._updateEngineObject())}},{key:"disableDisplay",value:function(){var e=this;return this._noDisplayCount++,1===this._noDisplayCount&&this._updateEngineObject(),{remove:Object(Yt.d)((function(){e._noDisplayCount--,0===e._noDisplayCount&&e._updateEngineObject()}))}}},{key:"radius",get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}},{key:"worldSized",get:function(){return this._worldSized},set:function(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}},{key:"modelTransform",get:function(){return this._modelTransform},set:function(e){Ln(e)&&(this._screenLocationDirty=!0),Object(oe.c)(this._modelTransform,e),this._updateEngineObject()}},{key:"renderLocation",get:function(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=Object(se.b)()),function(e,t,i){switch(e.viewingMode){case"local":return Object(oe.i)(i),!0;case"global":var n=Object(Tn.e)(e.renderCoordsHelper.spatialReference);Object(Q.p)(t,0,Wn,0,n.radius),Object(Q.c)(Object(pe.f)(Wn[1]),Object(pe.f)(Wn[0]),i)}}(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation},set:function(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}},{key:"location",get:function(){return this._location},set:function(e){Object(kn.a)(e,this._location),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}},{key:"elevationAlignedLocation",get:function(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation},set:function(e){Object(kn.a)(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}},{key:"_updateElevationAlignedLocation",value:function(){this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y;var e=Object(h.h)(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=this.location.spatialReference,this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}},{key:"grabbableForEvent",value:function(){return!0}},{key:"grabbing",get:function(){return this._grabbing},set:function(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}},{key:"hovering",get:function(){return this._hovering},set:function(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}},{key:"selected",get:function(){return this._selected},set:function(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}},{key:"state",get:function(){return this._state},set:function(e){e!==this._state&&(this._state=e,this._updateEngineObject())}},{key:"updateStateEnabled",value:function(e,t){t?this.state|=e:this.state&=~e}},{key:"_setFocused",value:function(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:!0===e?"focus":"unfocus"}))}},{key:"focused",get:function(){return this._focused}},{key:"screenLocation",get:function(){return this.ensureScreenLocation(),this._screenLocation}},{key:"ensureScreenLocation",value:function(){if(this._screenLocationDirty){var e;if(this._screenLocation.pixelSize=this.camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1,Ln(this._modelTransform)){var t=this._calculateModelTransformOffset(Xn);e=Object(X.c)(t,t,this.renderLocation)}else e=this.renderLocation;this.camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this.camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}}},{key:"applyObjectTransform",get:function(){return this._applyObjectTransform},set:function(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}},{key:"intersectionDistance",value:function(e,t){if(!this.available)return null;var i=Object(Le.i)(e,Gn),n=this._getCollisionRadius(t),a=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(Object(Ge.j)(this.screenLocation.screenPointArray,i)<n*n)return this.screenLocation.renderScreenPointArray[2]+a;break;case"line":var r=this.collisionType.paths,o=this._getWorldToScreenObjectScale(),s=this._calculateObjectTransform(o,Nn),c=n*this.screenLocation.pixelSize,l=Ve.e.fromScreen(this.camera,i,Vn);if(Object(h.g)(l))return null;var u,d=Object(k.a)(r);try{for(d.s();!(u=d.n()).done;){var p=u.value;if(0!==p.length)for(var f=Object(X.j)(Wn,p[0],s),v=1;v<p.length;v++){var g=Object(X.j)(qn,p[v],s),b=Ve.c.closestRayDistance2(Ve.c.fromPoints(f,g,zn),l);if(null!=b&&b<c*c){var m=Object(X.c)(Sn.c.get(),f,g);Object(X.b)(m,m,.5);var y=Object(Le.a)(Sn.c.get());return this.camera.projectToRenderScreen(m,y),y[2]+a}Object(X.h)(f,g)}}}catch(ee){d.e(ee)}finally{d.f()}break;case"disc":var O,_=this.collisionType.direction,j=null!=(O=this.collisionType.offset)?O:Y.b,w=this._getWorldToScreenObjectScale(),x=this._calculateObjectTransform(w,Nn),M=n*this.screenLocation.pixelSize,S=Ve.e.fromScreen(this.camera,i,Vn);if(Object(h.g)(S))return null;var R=Object(Pn.d)(Fn,x),E=Object(X.u)(Zn,_,R),D=Object(X.j)(Yn,j,x);Ve.d.fromPositionAndNormal(D,E,Un);var T=Bn;if(Ve.d.intersectRay(Un,S,T)&&Object(X.i)(T,D)<M*M)return this.screenLocation.renderScreenPointArray[2]+a;break;case"ribbon":var C=this.collisionType,P=C.paths,I=C.direction,A=this._getWorldToScreenObjectScale(),L=this._calculateObjectTransform(A,Nn),G=n*this.camera.computeScreenPixelSizeAt(this.renderLocation),z=Ve.e.fromScreen(this.camera,i,Vn);if(Object(h.g)(z))return null;var V=Object(Pn.d)(Fn,L),F=Object(X.u)(Zn,I,V),H=this._calculateModelTransformPosition(Yn);Ve.d.fromPositionAndNormal(H,F,Un);var N=Bn;if(!Ve.d.intersectRay(Un,z,N))break;var U,W=Object(k.a)(P);try{for(W.s();!(U=W.n()).done;){var q=U.value;if(0!==q.length)for(var B=Object(X.j)(Wn,q[0],L),Z=1;Z<q.length;Z++){var Q=Object(X.j)(qn,q[Z],L),K=Ve.c.distance2(Ve.c.fromPoints(B,Q,zn),N);if(null!=K&&K<G*G){var J=Object(X.c)(Sn.c.get(),B,Q);Object(X.b)(J,J,.5);var $=Object(Le.a)(Sn.c.get());return this.camera.projectToRenderScreen(J,$),$[2]+a}Object(X.h)(B,Q)}}}catch(ee){W.e(ee)}finally{W.f()}break;default:Object(En.a)(this.collisionType)}return null}},{key:"attach",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{manipulator3D:{}};if(this.view._stage){var t=e.manipulator3D;if(this._engineLayerId=t.engineLayerId,Object(h.g)(this._engineLayerId)){var i=new ft.a("manipulator-3d",{isPickable:!1});this.view._stage.add(0,i),this.view._stage.addToViewContent([i.id]),this._engineLayerId=i.id,t.engineLayerId=i.id}t.engineLayerReferences=(t.engineLayerReferences||0)+1,this._materialIdReferences=t.materialIdReferences,Object(h.g)(this._materialIdReferences)&&(this._materialIdReferences=new Map,t.materialIdReferences=this._materialIdReferences),this.camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),Object(Q.b)(this._location.spatialReference,this.view.spatialReference)||(this.location=new Dn.a({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}}},{key:"detach",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{manipulator3D:{}},t=e.manipulator3D;t.engineLayerReferences--;var i=0===t.engineLayerReferences;i&&(t.engineLayerId=null),this._removeResourcesFromStage(i),this._engineResources=null,this._engineLayerId=null,this._materialIdReferences=null,this._attached=!1}},{key:"onViewChange",value:function(){this.camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}},{key:"onElevationChange",value:function(e){Object(Q.l)(this.location,Qn,e.spatialReference),Object(Ke.e)(e.extent,Qn)&&(this.location=this._location)}},{key:"_evaluateElevationAlignment",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.location;if(Object(h.g)(this.elevationInfo))return!1;var t=null,i=0,n=Object(h.o)(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":t=Object(In.a)(this.view.elevationProvider,e,"ground")||0;break;case"relative-to-ground":i=(Object(In.a)(this.view.elevationProvider,e,"ground")||0)+n;break;case"relative-to-scene":i=(Object(In.a)(this.view.elevationProvider,e,"scene")||0)+n;break;case"absolute-height":i=n}return(i!==this._elevation.offset||t!==this._elevation.override)&&(this._elevation.offset=i,this._elevation.override=t,!0)}},{key:"_updateEngineObject",value:function(){if(this._attached)if(this.available){var e=this._getWorldToScreenObjectScale(),t=Nn;if(!0===this.autoScaleRenderObjects){var i=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(i,t)}else this._calculateObjectTransform(e,t);var n,a=this._ensureEngineResources().objectsByState,r=(this.focused?2:1)|(this.selected?8:4),o=this._noDisplayCount>0,s=Object(k.a)(a);try{for(s.s();!(n=s.n()).done;){var c=n.value,l=c.stateMask,u=c.objects;if(o){var h,d=Object(k.a)(u);try{for(d.s();!(h=d.n()).done;){h.value.setVisible(!1)}}catch(O){d.e(O)}finally{d.f()}}else{var p=!(0!=(15&l))||(r&l)==(15&l),f=!(0!=(65520&l))||(this.state&l)==(65520&l);if(p&&f){var v,g=Object(k.a)(u);try{for(g.s();!(v=g.n()).done;){var b=v.value;b.setVisible(!0),b.objectTransformation=t}}catch(O){g.e(O)}finally{g.f()}}else{var m,y=Object(k.a)(u);try{for(y.s();!(m=y.n()).done;){m.value.setVisible(!1)}}catch(O){y.e(O)}finally{y.f()}}}}}catch(O){s.e(O)}finally{s.f()}}else this._removeResourcesFromStage()}},{key:"_ensureEngineResources",value:function(){if(Object(h.g)(this._engineResources)){var e=this.view._stage.getContent(0,Object(h.n)(this._engineLayerId)),t=[],i=new Set;this.renderObjects.forEach((function(e){var n=e.material;i.has(n)||(t.push(n),i.add(n))}));var n=new Map;this.renderObjects.forEach((function(e){var t=new pt.a({idHint:"manipulator",castShadow:!1});!function(e,t){var i=t.geometry,n=t.material,a=t.transform;Array.isArray(i)?i.forEach((function(t){return e.addGeometry(t,n,a)})):e.addGeometry(i,n,a)}(t,e);var i=e.stateMask||0,a=n.get(i)||[];a.push(t),n.set(i,a)}));var a=[];n.forEach((function(e,t){a.push({stateMask:t,objects:e})})),this._engineResources={objectsByState:a,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}},{key:"_addResourcesToStage",value:function(){var e=this;if(!this._engineResourcesAddedToStage&&!Object(h.g)(this._engineResources)){var t=this._engineResources,i=t.objectsByState,n=t.layer;t.materials.forEach((function(t){var i=Object(h.n)(e._materialIdReferences),n=i.get(t.id)||0;0===n&&e.view._stage.add(3,t),i.set(t.id,n+1)})),i.forEach((function(t){t.objects.forEach((function(t){n.addObject(t),e.view._stage.add(1,t)}))})),this._engineResourcesAddedToStage=!0}}},{key:"_removeResourcesFromStage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._engineResourcesAddedToStage&&!Object(h.g)(this._engineResources)){var i=this._engineResources,n=i.objectsByState,a=i.layer,r=i.materials;n.forEach((function(t){t.objects.forEach((function(t){a.removeObject(t),e.view._stage.remove(1,t.id)}))})),r.forEach((function(t){var i=Object(h.n)(e._materialIdReferences),n=i.get(t.id);1===n?(e.view._stage.remove(3,t.id),i.delete(t.id)):i.set(t.id,n-1)})),t&&this.view._stage.remove(0,a.id),this._engineResourcesAddedToStage=!1}}},{key:"_getCollisionRadius",value:function(e){return this._getFocusedSize(this.radius,!0)*("touch"===e?this.touchMultiplier:1)}},{key:"_getFocusedSize",value:function(e,t){return e*(t?this.focusMultiplier:1)}},{key:"_getWorldToScreenObjectScale",value:function(){return this._worldSized?1:this.screenLocation.pixelSize}},{key:"_calculateModelTransformPosition",value:function(e){var t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,Hn);return Object(X.t)(e,i[12],i[13],i[14])}},{key:"_calculateModelTransformOffset",value:function(e){var t=this._calculateModelTransformPosition(e);return Object(X.g)(e,t,this.renderLocation)}},{key:"_calculateObjectTransform",value:function(e,t){return Object(oe.d)(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&Object(oe.l)(t,t,this._worldFrame),Object(oe.l)(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,Object(h.h)(this._applyObjectTransform)&&this._applyObjectTransform(t),t}},{key:"test",get:function(){var e=!1;if(Object(h.h)(this._engineResources))for(var t in this._engineResources.objectsByState){var i,n=this._engineResources.objectsByState[t],a=Object(k.a)(n.objects);try{for(a.s();!(i=a.n()).done;){if(i.value.isVisible){e=!0;break}}}catch(r){a.e(r)}finally{a.f()}if(e)break}return{areAnyResourcesVisible:e}}}]),e}();function Ln(e){return 0!==e[12]||0!==e[13]||0!==e[14]}var Gn=Object(Le.f)(),zn=Ve.c.create(),Vn=Ve.e.create(),Fn=Object(Cn.a)(),Hn=Object(se.b)(),Nn=Object(se.b)(),Un=Ve.d.create(),Wn=Object(Y.e)(),qn=Object(Y.e)(),Bn=Object(Y.e)(),Zn=Object(Y.e)(),Yn=Object(Y.e)(),Xn=Object(Y.e)(),Qn=new Dn.a({x:0,y:0,z:0,spatialReference:null});function Kn(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,i=Object(S.d)(e[0],e[1],e[2],e.length>3?e[3]:1),n=e[3]<1;return new hn({color:i,transparent:n,writeDepth:!0,cullFace:2,renderOccluded:t},"manipulator")}function Jn(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,i=Object(S.d)(e[0],e[1],e[2],4===e.length?e[3]:1);return new Rn.a({color:i,transparent:!0,writeDepth:!0,cullFace:1,renderOccluded:t},"manipulator-outline")}function $n(e,t,i,n){var a=Object(X.g)(Sn.c.get(),e,i),r=function(e,t,i,n){var a=Object(X.o)(Sn.c.get(),e),r=Object(X.o)(Sn.c.get(),t),o=Object(X.d)(Sn.c.get(),a,r);return n[0]=a[0],n[1]=a[1],n[2]=a[2],n[3]=0,n[4]=r[0],n[5]=r[1],n[6]=r[2],n[7]=0,n[8]=o[0],n[9]=o[1],n[10]=o[2],n[11]=0,n[12]=i[0],n[13]=i[1],n[14]=i[2],n[15]=1,n}(a,Object(X.d)(Sn.c.get(),n,a),i,Sn.a.get());Object(oe.a)(r,r);var o=Object(X.j)(Sn.c.get(),t,r);return Math.atan2(o[1],o[0])}function ea(e,t){var i=e.getViewForGraphic(t);return Object(h.h)(i)&&"computeAttachmentOrigin"in i?i.computeAttachmentOrigin(t,e.spatialReference):null}function ta(e,t,i){var n=ea(e,i);Object(h.h)(n)?t.elevationAlignedLocation=n:function(e,t){if(!Object(h.g)(t)){var i=Object(Xi.a)(t);Object(h.g)(i)||(e.location=Object(kn.b)(i))}}(t,i.geometry)}var ia=i(621);function na(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(m.d)(e);return"on-the-ground"!==t.mode&&!(Object(h.g)(e.geometry)||!e.geometry.hasZ)}var aa=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e)).tracking=!1,n.displaying=!1,n.isDraped=!1,n}return i}(v.a.EventedAccessor);Object(l.a)([Object(p.b)({constructOnly:!0})],aa.prototype,"graphic",void 0),Object(l.a)([Object(p.b)()],aa.prototype,"tracking",void 0),Object(l.a)([Object(p.b)()],aa.prototype,"displaying",void 0),Object(l.a)([Object(p.b)()],aa.prototype,"isDraped",void 0),aa=Object(l.a)([Object(f.a)("esri.views.3d.layers.graphics.GraphicState")],aa);var ra=i(585),oa=function(){function e(){Object(r.a)(this,e),this.grabbingState=0,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}return Object(o.a)(e,[{key:"update",value:function(e){var t=this;this.grabbingState=0,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,e.forEachManipulator((function(e,i){if(0===i&&(t.zManipulator=e),e instanceof An&&(e.selected&&(0===t.numSelected&&(t.firstSelected=e),t.numSelected++),Object(h.g)(t.firstGrabbedXY)&&e.grabbing&&1===i&&(t.firstGrabbedXY=e)),e.grabbing)switch(t.grabbingState|=1,i){case 0:t.grabbingState|=2;break;case 1:t.grabbingState|=4}}))}}]),e}();function sa(e){var t=e.view,i=e.graphic,n=new aa({graphic:i}),a=function(e,t){var i=e.view,n=e.graphic,a=new Wi({view:i,geometry:ca(n)?n.geometry:null,elevationInfo:Object(m.d)(n),attached:!1});Z.visualElements.lineGraphics.shadowStyle.apply(a);var r=function(){a.attached=t.displaying};Z.visualElements.lineGraphics.outline.apply(a);var o=[t.watch("displaying",r),t.watch("isDraped",(function(e){return a.isDraped=e})),t.on("changed",(function(){return a.geometry=ca(n)?n.geometry:null})),Object(wn.a)(a)];return r(),{visualElement:a,remove:function(){return Object(wn.b)(o).remove()}}}(e,n),r=[a,function(e,t,i){var n=e.graphic,a=e.view,r=[],o=Object(m.d)(n),s="on-the-ground"===o.mode||!o.offset&&"absolute-height"!==o.mode,c=new oa,l=new ra.a({view:a,extensionType:Z.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});Z.visualElements.pointGraphics.shadowStyle.apply(l);var u=Object(pe.f)(Z.visualElements.heightPlaneAngleCutoff),d=new Vi.a({view:a,attached:!1,angleCutoff:u});Z.visualElements.heightPlane.apply(d);var p=1,f=1,v=function(){if(c.update(e),!i.displaying||s&&(i.isDraped||!ca(n)||!n.geometry.hasZ))return t.laserlineEnabled=!1,l.attached=!1,void(d.attached=!1);t.laserlineEnabled=!0;var a=4&c.grabbingState?Z.visualElements.laserlineAlphaMultiplier:1;a!==p&&(p=a,Z.visualElements.lineGraphics.shadowStyle.apply(t,a),Z.visualElements.pointGraphics.shadowStyle.apply(l,a));var r=2&c.grabbingState?Z.visualElements.laserlineAlphaMultiplier:1;r!==f&&(f=r,Z.visualElements.heightPlane.apply(d,r)),function(e,t){var i=1===t.numSelected?t.firstSelected:t.numSelected>1&&Object(h.h)(t.firstGrabbedXY)?t.firstGrabbedXY:null;Object(h.h)(i)?(e.setStartEndFromWorldDownAtLocation(i.renderLocation),e.attached=!0):e.attached=!1}(l,c),function(e,t,i,n){if(n.numSelected>0){Object(X.t)(la,0,0,0);var a=0;e.forEachManipulator((function(e,t){1===t&&e.selected&&e instanceof An&&(Object(X.c)(la,la,e.renderLocation),a++)})),a>0?(i.heightManifoldTarget=Object(X.b)(la,la,1/a),i.attached=!0):i.attached=!1}else{var r=t.attachmentOrigin;Object(h.h)(r)&&e.view.renderCoordsHelper.toRenderCoords(r,la)?(i.heightManifoldTarget=la,i.attached=!0):i.attached=!1}}(e,t,d,c)};Z.visualElements.zVerticalLine.apply(l),r.push(i.on("changed",v),i.watch("displaying",v),t.events.on("attachment-origin-changed",v),Object(wn.a)(l),Object(wn.a)(d));var g=[],b=function(){Object(wn.b)(g).remove(),g.length=0,e.forEachManipulator((function(e){return g.push(e.events.on("grab-changed",v))})),e.forEachManipulator((function(e){return g.push(e.events.on("select-changed",v))})),v()};return b(),r.push(e.onManipulatorsChanged(b),Object(wn.d)((function(){return Object(wn.b)(g)}))),Object(wn.b)(r)}(e,a.visualElement,n),t.maskOccludee(i),t.trackGraphicState(n)];return{visualElement:a.visualElement,remove:function(){return Object(wn.b)(r).remove()}}}function ca(e){return Object(h.h)(e.geometry)&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}var la=Object(Y.e)(),ua=i(713);function ha(e){var t=e.view,i=e.graphic,n=new aa({graphic:i}),a=[],r=function(e,t,i){var n=e.view,a=e.graphic,r=new ua.a({view:n,geometry:da(a)?a.geometry:null,elevationInfo:Object(m.d)(a),attached:!1});return function(e,t,i,n){(function(e,t,i,n){var a=e.view,r=e.graphic,o=null,s=function(){Object(h.h)(o)&&(o.remove(),o=null),i.isDraped&&da(r)&&(o=function(e,t,i){var n=e.elevationProvider.spatialReference;Object(Q.m)(t,pa,n);var a=pa[0],r=pa[1];return e.elevationProvider.on("elevation-change",(function(e){Object(Ke.g)(e.extent,a,r)&&i()}))}(a,r.geometry,(function(){t.geometry=r.geometry}))),t.geometry=da(r)?r.geometry:null};n.push(i.on("changed",s),Object(wn.d)((function(){return o}))),s()})(e,t,i,n),Z.visualElements.pointGraphics.outline.apply(t),n.push(Object(Se.a)(i,"displaying",(function(){return t.attached=i.displaying})))}(e,r,t,i),i.push(Object(wn.a)(r)),r}(e,n,a);return function(e,t,i,n){var a=e.view,r=e.graphic,o=new ra.a({view:a,extensionType:Z.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:4});Z.visualElements.zVerticalLine.apply(o);var s=new Vi.a({view:a,intersectsLineInfinite:!0,attached:!1});Z.visualElements.pointGraphics.shadowStyle.apply(s);var c=Object(pe.f)(Z.visualElements.heightPlaneAngleCutoff),l=new Vi.a({view:a,attached:!1,angleCutoff:c});Z.visualElements.heightPlane.apply(l);var u=Object(m.d)(e.graphic),h=te.a.fromElevationInfo(u),d="on-the-ground"===u.mode||!u.offset&&"absolute-height"!==u.mode,p=new oa,f=1,v=1,g=function(){p.update(e);var i=d&&(t.isDraped||!da(r)||!r.geometry.hasZ),c=!0;if(!i&&da(r)){var u=r.geometry,g=Object(me.c)(r.geometry,a.elevationProvider,h,a.renderCoordsHelper);Object(X.t)(pa,u.x,u.y,g),Object(Q.o)(pa,u.spatialReference,pa,a.renderCoordsHelper.spatialReference),o.setStartEndFromWorldDownAtLocation(pa),s.intersectsWorldUpAtLocation=pa}else c=!1;var b=2&p.grabbingState?Z.visualElements.laserlineAlphaMultiplier:1;b!==f&&(f=b,Z.visualElements.heightPlane.apply(l,b));var m=Object(J.e)(fa);!i&&t.displaying&&n.calculateMapBounds(m)&&Object(Q.o)(Object(J.m)(m,pa),a.spatialReference,pa,a.renderCoordsHelper.spatialReference)?(l.heightManifoldTarget=pa,l.attached=!0):l.attached=!1;var y=4&p.grabbingState?Z.visualElements.laserlineAlphaMultiplier:1;y!==v&&(v=y,Z.visualElements.pointGraphics.shadowStyle.apply(s,y));var O=c&&t.displaying&&!i;s.attached=O,o.attached=O};i.push(t.watch(["displaying","isDraped"],g),t.on("changed",g)),e.forEachManipulator((function(e){i.push(e.events.on("grab-changed",g))})),i.push(Object(wn.a)(s)),i.push(Object(wn.a)(o)),i.push(Object(wn.a)(l)),g()}(e,n,a,r),a.push(t.trackGraphicState(n)),{visualElement:r,remove:function(){Object(wn.b)(a).remove()}}}function da(e){return Object(h.h)(e.geometry)&&"point"===e.geometry.type}var pa=Object(Y.e)(),fa=Object(J.d)();function va(e){switch(Object(h.n)(e.graphic.geometry).type){case"point":return ha(e);case"polygon":case"polyline":return sa(e);default:return null}}var ga=[1,.5,0],ba=70,ma=Math.ceil(70/3*2),ya=160,Oa=5*Math.PI/12,_a=1*Math.PI/3,ja=i(453),wa=i(67);function xa(e,t,i){var n=t[0],a=t[1],r=t[2],o=t[3],s=i[0],c=i[1],l=i[2],u=i[3];return e[0]=n*s+r*c,e[1]=a*s+o*c,e[2]=n*l+r*u,e[3]=a*l+o*u,e}function Ma(e,t){var i=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=i,e[2]=-i,e[3]=n,e}function Sa(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}var ka=xa,Ra=Sa;Object.freeze({__proto__:null,copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},set:function(e,t,i,n,a){return e[0]=t,e[1]=i,e[2]=n,e[3]=a,e},transpose:function(e,t){if(e===t){var i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},invert:function(e,t){var i=t[0],n=t[1],a=t[2],r=t[3],o=i*r-a*n;return o?(o=1/o,e[0]=r*o,e[1]=-n*o,e[2]=-a*o,e[3]=i*o,e):null},adjoint:function(e,t){var i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},multiply:xa,rotate:function(e,t,i){var n=t[0],a=t[1],r=t[2],o=t[3],s=Math.sin(i),c=Math.cos(i);return e[0]=n*c+r*s,e[1]=a*c+o*s,e[2]=n*-s+r*c,e[3]=a*-s+o*c,e},scale:function(e,t,i){var n=t[0],a=t[1],r=t[2],o=t[3],s=i[0],c=i[1];return e[0]=n*s,e[1]=a*s,e[2]=r*c,e[3]=o*c,e},fromRotation:Ma,fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},frob:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2))},LDU:function(e,t,i,n){return e[2]=n[2]/n[0],i[0]=n[0],i[1]=n[1],i[3]=n[3]-e[2]*i[1],[e,t,i]},add:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},subtract:Sa,exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},equals:function(e,t){var i=e[0],n=e[1],a=e[2],r=e[3],o=t[0],s=t[1],c=t[2],l=t[3];return Math.abs(i-o)<=wa.a*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(n-s)<=wa.a*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(a-c)<=wa.a*Math.max(1,Math.abs(a),Math.abs(c))&&Math.abs(r-l)<=wa.a*Math.max(1,Math.abs(r),Math.abs(l))},multiplyScalar:function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},multiplyScalarAndAdd:function(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e[2]=t[2]+i[2]*n,e[3]=t[3]+i[3]*n,e},mul:ka,sub:Ra});function Ea(){return[1,0,0,1]}Object.freeze({__proto__:null,create:Ea,clone:function(e){return[e[0],e[1],e[2],e[3]]},fromValues:function(e,t,i,n){return[e,t,i,n]},createView:function(e,t){return new Float64Array(e,t,4)}});function Da(e,t,i){var n=e.graphic,a=function(e,i){return t({action:e,graphic:n,dxScreen:i.screenDeltaX,dyScreen:i.screenDeltaY})};return i((function(e,t,i){t.next((function(e){return"start"===e.action&&a("start",e),e})).next(Object(Mn.g)(n)).next((function(e){switch(e.action){case"start":case"update":(e.translationX||e.translationY||e.translationZ)&&a("update",e);break;case"end":a("end",e)}return e})),i.next(Object(Mn.i)(n)).next((function(){a("end",{screenDeltaX:0,screenDeltaY:0})}))}))}function Ta(e){if(Object(h.g)(e)||"polyline"!==e.type&&"polygon"!==e.type)return 0;var t=Object(ja.convexHull)(e),i=t&&t.rings&&t.rings[0];if(!i)return 0;!function(e){var t,i=0,n=0,a=Object(k.a)(e);try{for(a.s();!(t=a.n()).done;){var r=t.value;i+=r[0],n+=r[1]}}catch(l){a.e(l)}finally{a.f()}i/=e.length,n/=e.length;var o,s=Object(k.a)(e);try{for(s.s();!(o=s.n()).done;){var c=o.value;c[0]-=i,c[1]-=n}}catch(l){s.e(l)}finally{s.f()}}(i);for(var n=[],a=0;a<i.length-1;a++){var r=Math.atan2(i[a+1][1]-i[a][1],i[a+1][0]-i[a][0]),o=re.b.normalize(r)%(Math.PI/2);n.push(o)}var s,c=n.sort((function(e,t){return e-t})),l=null,u=0,d=Number.POSITIVE_INFINITY,p=0,f=Object(k.a)(c);try{for(f.s();!(s=f.n()).done;){var v=s.value;if(v!==l){l=v,Ma(Ca,v),Object(Ke.i)(Pa);var g,b=Object(k.a)(i);try{for(b.s();!(g=b.n()).done;){var m=g.value;Object(Ge.o)(Ia,m,Ca),Object(Ke.k)(Pa,Ia)}}catch(O){b.e(O)}finally{b.f()}var y=Object(Ke.b)(Pa);((y>d?d/y:y/d)>=.99&&v<u||y<d)&&(u=v,d=y),p=Math.max(p,y)}}}catch(O){f.e(O)}finally{f.f()}return d/p>=.95?0:u}var Ca=[1,0,0,1],Pa=Object(Ke.h)(),Ia=Object(Re.a)(),Aa=function(){function e(){Object(r.a)(this,e),this._available=!0}return Object(o.a)(e,[{key:"location",set:function(e){this.forEachManipulator3D((function(t){return t.location=e}))}},{key:"elevationAlignedLocation",set:function(e){this.forEachManipulator3D((function(t){return t.elevationAlignedLocation=e}))}},{key:"elevationInfo",set:function(e){this.forEachManipulator3D((function(t){return t.elevationInfo=e}))}},{key:"available",get:function(){return this._available},set:function(e){this._available=e,this.forEachManipulator3D((function(t){return t.available=e}))}},{key:"grabbing",get:function(){return this.someManipulator((function(e){return e.grabbing}))}},{key:"dragging",get:function(){return this.someManipulator((function(e){return e.dragging}))}},{key:"hasManipulator",value:function(e){return this.someManipulator((function(t){return t===e}))}},{key:"someManipulator",value:function(e){var t=!1;return this.forEachManipulator((function(i){!t&&e(i)&&(t=!0)})),t}},{key:"forEachManipulator3D",value:function(e){this.forEachManipulator((function(t,i){t instanceof An&&e(t,i)}))}}]),e}(),La=function(){function e(t){Object(r.a)(this,e),this.options=new Ae.a,this.results=new Ae.c,this.transform=new Ae.d,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=1e-5,this.verticalOffset=null,this._ray={origin:Object(Y.e)(),direction:Object(Y.e)()},this._rayEndPoint=Object(Y.e)(),this._rayStartPointTransformed=Object(Y.e)(),this._rayEndPointTransformed=Object(Y.e)(),this.viewingMode=null==t?1:t}return Object(o.a)(e,[{key:"ray",get:function(){return this._ray}},{key:"rayBeginPoint",get:function(){return this._ray.origin}},{key:"rayEndPoint",get:function(){return this._rayEndPoint}},{key:"reset",value:function(e,t){this.resetWithRay(Ve.e.fromPoints(e,t,this._ray))}},{key:"resetWithRay",value:function(e){e!==this._ray&&Ve.e.copy(e,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,Object(X.c)(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)}},{key:"intersect",value:function(e,t,i,n,a,r){var o=this;this.point=t,this.camera=i,this.filterPredicate=a,this.tolerance=null==n?1e-5:n;var s=Object(Ae.f)(this.verticalOffset),c=r?function(e){r(e)&&o.intersectObject(e)}:function(e){o.intersectObject(e)};if(e&&e.length>0){var l,u=Object(k.a)(e);try{for(u.s();!(l=u.n()).done;){var d=l.value,p=d.getSpatialQueryAccelerator&&d.getSpatialQueryAccelerator();if(p)Object(h.h)(s)?p.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,c,s):p.forEachAlongRay(this._ray.origin,this._ray.direction,c),this.options.selectionMode&&this.options.hud&&p.forEachDegenerateObject(c);else{var f,v=d.getObjects(),g=Object(k.a)(v);try{for(g.s();!(f=g.n()).done;){c(f.value)}}catch(b){g.e(b)}finally{g.f()}}}}catch(b){u.e(b)}finally{u.f()}}this.sortResults()}},{key:"intersectObject",value:function(e){var t=this;this._numObjectsTested++;var i=e.geometryRecords;if(i){var n,a,r=e.id,o=e.objectTransformation,s=Object(Ae.f)(this.verticalOffset),c=Object(k.a)(i);try{var l=function(){var i=a.value,c=i.geometry,l=i.material,u=i.instanceParameters;if(Object(ue.d)(u))return"continue";n=c.id,t.transform.setAndInvalidateLazyTransforms(o,i.getShaderTransformation()),Object(X.j)(t._rayStartPointTransformed,t._ray.origin,t.transform.inverse),Object(X.j)(t._rayEndPointTransformed,t._rayEndPoint,t.transform.inverse);var d=t.transform.transform;Object(h.h)(s)&&(s.objectTransform=t.transform),l.intersect(c,u,t.transform.transform,t,t._rayStartPointTransformed,t._rayEndPointTransformed,(function(i,a,o,s,c,l){if(i>=0){if(Object(h.h)(t.filterPredicate)&&!t.filterPredicate(t._ray.origin,t._rayEndPoint,i))return;if(c)return void((null==t.results.hud.dist||i<t.results.hud.dist)&&t.results.hud.set(e,r,i,a,se.a,s,l,n,o));var u=function(t){return t.set(e,r,i,a,d,s,null,n,o)};if((null==t.results.min.drapedLayerOrder||s>=t.results.min.drapedLayerOrder)&&(null==t.results.min.dist||i<t.results.min.dist)&&u(t.results.min),0!==t.options.store&&(null==t.results.max.drapedLayerOrder||s<t.results.max.drapedLayerOrder)&&(null==t.results.max.dist||i>t.results.max.dist)&&u(t.results.max),2===t.options.store){var p=new Ae.b(t._ray);u(p),t.results.all.push(p)}}}),i.shaderTransformation)};for(c.s();!(a=c.n()).done;)l()}catch(u){c.e(u)}finally{c.f()}}}},{key:"sortResults",value:function(){this.results.all.sort((function(e,t){return e.dist!==t.dist?e.dist-t.dist:e.drapedLayerOrder!==t.drapedLayerOrder?(void 0!==e.drapedLayerOrder?e.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE):(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==e.drapedLayerGraphicOrder?e.drapedLayerGraphicOrder:Number.MIN_VALUE)}))}}]),e}();function Ga(e,t){var i=Object(Y.e)(),n=Object(Y.e)(),r=!1;return function(o){if("start"===o.action){var s=Object(Le.i)(o.screenStart,Object(Le.c)(Sn.b.get())),c=Ve.e.fromScreen(e.state.camera,s,Wa);Object(h.h)(c)&&(r=Ve.d.intersectRay(t,c,i))}if(!r)return null;var l=Object(Le.i)(o.screenEnd,Object(Le.c)(Sn.b.get())),u=Ve.e.fromScreen(e.state.camera,l,Wa);return Object(h.g)(u)?null:Ve.d.intersectRay(t,u,n)?Object(a.a)(Object(a.a)({},o),{},{renderStart:i,renderEnd:n,plane:t,ray:u}):null}}function za(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=null;return function(o){if("start"===o.action&&(r=e.sceneIntersectionHelper.intersectElevationFromScreen(Object(Le.f)(o.screenStart.x,o.screenStart.y),t,i),Object(h.h)(r)&&Object(h.h)(n)&&!Object(Q.l)(r,r,n)))return null;if(Object(h.g)(r))return null;var s=e.sceneIntersectionHelper.intersectElevationFromScreen(Object(Le.f)(o.screenEnd.x,o.screenEnd.y),t,i);return Object(h.h)(s)?Object(h.h)(n)&&!Object(Q.l)(s,s,n)?null:Object(a.a)(Object(a.a)({},o),{},{mapStart:r,mapEnd:s}):null}}function Va(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return za(e,i,Object(m.f)(t,e,i),n)}function Fa(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return Va(e,i,Object(m.d)(t),n)}function Ha(e,t,i){var n=null,r=new Mn.a;return r.next(Ga(e,function(e,t){var i=Na,n=Ua,a=Ve.d.create();e.renderCoordsHelper.worldUpAtPosition(t,i);var r=Object(X.d)(a,i,Object(X.g)(n,t,e.state.camera.eye));return Object(X.d)(r,r,i),Ve.d.fromPositionAndNormal(t,r,a)}(e,t))).next(function(e,t){var i=Object(Y.e)(),n=Object(X.m)(t);e.renderCoordsHelper.worldUpAtPosition(t,i);var a=Object(Y.e)(),r=Object(Y.e)(),o=function(a){return Object(X.g)(a,a,t),Ve.g.projectPoint(i,a,a),"global"===e.viewingMode&&Object(X.m)(a)*Object(pe.q)(Object(X.e)(i,a))<.001-n&&Object(X.g)(a,Object(X.b)(a,i,.001),t),Object(X.c)(a,a,t),a};return function(e){return e.renderStart=o(Object(X.h)(a,e.renderStart)),e.renderEnd=o(Object(X.h)(r,e.renderEnd)),e}}(e,t)).next(function(e,t){var i=e.renderCoordsHelper;return function(e){var n=i.fromRenderCoords(e.renderStart,new Dn.a,t),r=i.fromRenderCoords(e.renderEnd,new Dn.a,t);return Object(h.h)(n)&&Object(h.h)(r)?Object(a.a)(Object(a.a)({},e),{},{mapStart:n,mapEnd:r}):null}}(e,i)).next((function(e){e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,n=e})),function(e){return n=null,r.execute(e),n}}La.DEFAULT_TOLERANCE=1e-5;var Na=Object(Y.e)(),Ua=Object(Y.e)(),Wa=Ve.e.create(),qa=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this))._handles=new Me.a,n._arrowManipulatorInfos=new Array,n._opaqueMaterial=n.createMaterial(),n._transparentMaterial=n.createMaterial(.5),n._angle=0,n._scale=1,n._radius=ba,n._updateAfterDrag=!1,n.events=new v.a,n._tool=e.tool,n._view=e.view,null!=e.radius&&(n._radius=e.radius),n._createManipulators(),n.forEachManipulator((function(e){return n._tool.manipulators.add(e)})),n}return Object(o.a)(i,[{key:"orthogonalAvailable",set:function(e){this._arrowManipulatorInfos[1].manipulator.available=e,this._arrowManipulatorInfos[3].manipulator.available=e}},{key:"destroy",value:function(){var e=this;this.forEachManipulator((function(t){e._tool.manipulators.remove(t),t.destroy()})),this._handles.removeAll(),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}},{key:"forEachManipulator",value:function(e){this._arrowManipulatorInfos.map((function(t){var i=t.manipulator;return e(i,1)}))}},{key:"createGraphicDragPipeline",value:function(e,t){var i=this,n=e.graphic,a=Object(m.d)(n),r=Object(h.n)(n.geometry).spatialReference;return Da(e,t,(function(e){return i.createDragPipeline(e,a,r)}))}},{key:"createDragPipeline",value:function(e,t,i){var n=this;return Object(wn.b)(this._arrowManipulatorInfos.map((function(r,o){var s=r.manipulator;return Object(Mn.e)(s,(function(r,s,c,l,u){var h=s.next((function(e){return Object(a.a)(Object(a.a)({},e),{},{manipulatorType:1})})).next(Object(Mn.f)(n._view,r.elevationAlignedLocation)).next(Va(n._view,r.elevationAlignedLocation,t,i)).next(Object(Mn.d)(r.location,n.angle+(o+1)*Math.PI*.5)).next(Object(Mn.c)());e(r,h,c,l,u)}))})))}},{key:"angle",get:function(){return this._angle},set:function(e){this._angle=e,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}},{key:"displayScale",get:function(){return this._scale},set:function(e){this._scale=e,this._updateManipulatorTransform()}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=e,this._updateManipulators())}},{key:"_updateManipulators",value:function(){for(var e=0;e<this._arrowManipulatorInfos.length;e++)this._updateArrowManipulator(this._arrowManipulatorInfos[e],e);this._updateManipulatorTransform()}},{key:"_updateArrowManipulator",value:function(e,t){var i=e.manipulator,n=e.transform,a=this._radius/ba,r=54*a,o=Math.sqrt(r*r*3/4),s=Yi.a.createExtrudedTriangle(o,r/2,r/2,.02);Yi.a.transformInPlace(s,Object(oe.r)(Sn.a.get(),Object(X.t)(Sn.c.get(),0,-o/3,0)));var c=new ie.a(s,"move-xy-axis-arrow");i.renderObjects=[{geometry:c,material:this._opaqueMaterial,stateMask:2},{geometry:c,material:this._transparentMaterial,stateMask:1}],i.radius=o/3*2*1.2;var l=Object(oe.i)(Sn.a.get());Object(oe.s)(l,t*Math.PI/2);var u=Object(oe.i)(Sn.a.get());Object(oe.r)(u,Object(X.t)(Sn.c.get(),0,100*a,0)),Object(oe.l)(n,l,u)}},{key:"_createManipulators",value:function(){for(var e=0;e<4;e++){var t=this._createArrowManipulator(e);this._arrowManipulatorInfos.push(t)}this._updateManipulatorTransform()}},{key:"_updateManipulatorTransform",value:function(){var e=this.angle,t=Object(oe.i)(Sn.a.get());Object(oe.o)(t,t,e,Object(Y.g)(0,0,1));var i=Object(oe.n)(Sn.a.get(),Object(X.t)(Sn.c.get(),this.displayScale,this.displayScale,this.displayScale)),n=Object(oe.i)(Sn.a.get());Object(oe.l)(n,i,t);var a,r=Object(k.a)(this._arrowManipulatorInfos);try{for(r.s();!(a=r.n()).done;){var o=a.value,s=Object(oe.l)(Sn.a.get(),n,o.transform);o.manipulator.modelTransform=s}}catch(c){r.e(c)}finally{r.f()}}},{key:"_createArrowManipulator",value:function(e){var t=this,i=new An({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:Object(Y.g)(0,0,1)}}),n={manipulator:i,transform:Object(se.b)()};return this._updateArrowManipulator(n,e),this._handles.add(i.events.on("drag",(function(e){t._updateAfterDrag&&"end"===e.action&&!t.dragging&&(t._updateManipulatorTransform(),t._updateAfterDrag=!1)}))),n}},{key:"createMaterial",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=x.a.toUnitRGBA(C.main);return t[3]*=e,new Rn.a({color:t,transparent:1!==e,cullFace:2,renderOccluded:2},"graphic-transform")}},{key:"test",get:function(){return{arrowManipulators:this._arrowManipulatorInfos.map((function(e){return e.manipulator}))}}}]),i}(Aa),Ba=function(){function e(){Object(r.a)(this,e),this.view=null,this.elevationInfo=null,this.lastDragEvent=null,this.next=new Mn.a,this._enabled=!1}return Object(o.a)(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&Object(h.h)(this.lastDragEvent)){var t=this.lastDragEvent.mapEnd,i=this.snap(this.lastDragEvent.screenEnd);if(Object(h.h)(i)){var n={action:"update",mapStart:this.lastDragEvent.mapStart,mapEnd:!0===e?i:t,screenStart:this.lastDragEvent.screenEnd,screenEnd:this.lastDragEvent.screenEnd};this.next.execute(n)}}this._enabled=e}},{key:"snap",value:function(e){var t=Object(h.h)(this.view)?this.view.toMap(e,{exclude:[]}):null;return Object(h.h)(t)&&Object(h.h)(this.view)&&(t.z=Object(m.f)(t,this.view,this.elevationInfo)),t}},{key:"createDragEventPipelineStep",value:function(e,t){var i=this;return this.view=e,this.elevationInfo=t,this.lastDragEvent=null,function(e){if(i.lastDragEvent="end"!==e.action?Object(a.a)({},e):null,i._enabled){var t=i.snap(e.screenEnd);return Object(h.h)(t)?{action:e.action,mapStart:e.mapStart,mapEnd:t,screenStart:e.screenStart,screenEnd:e.screenEnd}:null}return{action:e.action,mapStart:e.mapStart,mapEnd:e.mapEnd,screenStart:e.screenStart,screenEnd:e.screenEnd}}}}]),e}(),Za=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this))._handles=new Me.a,n._snapToScene=new Ba,n._discMaterial=n._createMaterial(),n._discMaterialTransparent=n._createMaterial(.5),n._scale=1,n._radius=ba,n._view=e.view,n._tool=e.tool,null!=e.snapToScene&&(n.snapToScene=e.snapToScene),null!=e.radius&&(n._radius=e.radius),n._createManipulator(),n.forEachManipulator((function(e){return n._tool.manipulators.add(e)})),n}return Object(o.a)(i,[{key:"destroy",value:function(){var e=this;this._handles.destroy(),this.forEachManipulator((function(t){e._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null}},{key:"forEachManipulator",value:function(e){e(this._manipulator,1)}},{key:"displayScale",get:function(){return this._scale},set:function(e){this._scale=e,this._updateManipulatorTransform()}},{key:"snapToScene",get:function(){return this._snapToScene.enabled},set:function(e){this._snapToScene.enabled=e}},{key:"radius",get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this._updateManipulator())}},{key:"createGraphicDragPipeline",value:function(e,t){var i=this,n=e.graphic,a=Object(m.d)(n),r=Object(h.n)(n.geometry).spatialReference;return Da(e,t,(function(e){return i.createDragPipeline(e,a,r)}))}},{key:"createDragPipeline",value:function(e,t,i){var n=this,r=this._view;return Object(Mn.e)(this._manipulator,(function(o,s,c,l,u){var h=s.next(Object(Mn.f)(r,o.elevationAlignedLocation)).next(Va(r,o.elevationAlignedLocation,t,i)).next(n._snapToScene.createDragEventPipelineStep(r,t),n._snapToScene.next).next((function(e){return Object(a.a)(Object(a.a)({},e),{},{manipulatorType:1})})).next(Object(Mn.c)());e(o,h,c,l,u)}))}},{key:"_updateManipulatorTransform",value:function(){var e=Object(oe.n)(Sn.a.get(),Object(X.t)(Sn.c.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=e}},{key:"_createManipulator",value:function(){var e=this._view;this._manipulator=new An({view:e,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:Object(Y.g)(0,0,1)},worldOriented:!0}),this._updateManipulator()}},{key:"_updateManipulator",value:function(){var e=new ie.a(Yi.a.createCylinderGeometry(.02,1,128,Object(Y.g)(0,0,1),Object(Y.g)(0,0,0)),"graphic-transform-disc"),t=Object(oe.n)(Object(se.b)(),Object(Y.g)(this._radius,this._radius,this._radius));this._manipulator.renderObjects=[{geometry:e,material:this._discMaterial,transform:t,stateMask:2},{geometry:e,material:this._discMaterialTransparent,transform:t,stateMask:1}],this._manipulator.radius=this._radius/ba*80}},{key:"_createMaterial",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=x.a.toUnitRGBA(C.main);return t[3]*=e,new Rn.a({color:t,transparent:1!==e,cullFace:2,renderOccluded:2},"move-xy-disc")}},{key:"test",get:function(){return{discManipulator:this._manipulator}}}]),i}(Aa),Ya=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this))._handles=new Me.a,n._radius=ba,n.events=new v.a,n._tool=e.tool,n._view=e.view,null!=e.radius&&(n._radius=e.radius),n.createManipulator(),n.forEachManipulator((function(e){return n._tool.manipulators.add(e)})),n}return Object(o.a)(i,[{key:"destroy",value:function(){var e=this;this._handles.destroy(),this.forEachManipulator((function(t){e._tool.manipulators.remove(t),t.destroy()}))}},{key:"forEachManipulator",value:function(e){e(this._manipulator,0)}},{key:"createGraphicDragPipeline",value:function(e,t){var i=this,n=Object(h.n)(e.graphic.geometry).spatialReference;return Da(e,t,(function(e){return i.createDragPipeline(e,n)}))}},{key:"createDragPipeline",value:function(e,t){var i=this._view;return Object(Mn.e)(this._manipulator,(function(n,r,o,s,c){var l=r.next((function(e){return Object(a.a)(Object(a.a)({},e),{},{manipulatorType:0})})).next(Ha(i,n.renderLocation,t)).next(Object(Mn.c)());e(n,l,o,s,c)}))}},{key:"radius",get:function(){return this._radius},set:function(e){e!==this._radius&&(this._radius=e,this.updateManipulator())}},{key:"updateManipulator",value:function(){var e=this._radius/ba,t=Z.zManipulator.height*e,i=Z.zManipulator.coneHeight*e,n=Z.zManipulator.coneWidth*e,a=Z.zManipulator.width*e,r=[Object(Y.g)(0,0,0),Object(Y.g)(0,0,t)],o=new ie.a(Yi.a.createTubeGeometry(r,a/2,16,!1),"move-z"),s=Yi.a.createConeGeometry(i,n/2,16,!1),c=new ie.a(s),l=[Object(Y.g)(0,0,0),Object(Y.g)(0,0,t+i)],u=function(e){var i=Object(se.b)();return Object(oe.q)(i,i,[0,0,t]),Object(oe.e)(i,i,Math.PI/2),i}(),h=function(e,t){var i=Object(M.a)(Z.zManipulator.color,t);return[i.r/255,i.g/255,i.b/255,Z.zManipulator.color.a*e]},d=Kn(h(1,.25),1),p=Kn(h(1,0),1),f=Kn(h(.7,0),Z.zManipulator.renderOccluded),v=Kn(h(.85,0),Z.zManipulator.renderOccluded);this._manipulator.renderObjects=[{geometry:c,transform:u,material:d,stateMask:1},{geometry:o,material:d,stateMask:1},{geometry:c,transform:u,material:p,stateMask:2},{geometry:o,material:p,stateMask:2},{geometry:c,transform:u,material:f,stateMask:1},{geometry:o,material:f,stateMask:1},{geometry:c,transform:u,material:v,stateMask:2},{geometry:o,material:v,stateMask:2}],this._manipulator.radius=a/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}},{key:"createManipulator",value:function(){var e=this,t=new An({view:this._view,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});t.applyObjectTransform=function(t){var i=e._view.state.camera,n=Xa;e._view.renderCoordsHelper.toRenderCoords(e._manipulator.elevationAlignedLocation,n);var a=Object(X.x)(i.eye,n),r=i.computeRenderPixelSizeAtDist(a),o=Object(X.g)(Qa,n,i.eye);Object(X.o)(o,o);var s=Ka;e._view.renderCoordsHelper.worldUpAtPosition(Xa,s);var c=Math.abs(Object(X.e)(o,s)),l=Object(X.d)(Qa,o,s),u=Object(X.d)(Qa,l,s),h=Object(pe.d)(c,.01,1),d=1-Math.sqrt(1-h*h)/h/i.fullWidth,p=e._radius/ba,f=Z.zManipulator.width*p;Object(X.b)(u,Object(X.o)(u,u),(1/d-1)*a+r*f),t[12]-=Qa[0],t[13]-=Qa[1],t[14]-=Qa[2]},this._manipulator=t,this.updateManipulator()}}]),i}(Aa),Xa=Object(Y.e)(),Qa=Object(Y.e)(),Ka=Object(Y.e)(),Ja=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;Object(r.a)(this,i),(n=t.call(this))._handles=new Me.a,n._angleDeferred=null,n._interactive=!0;var a=e.tool,o=e.view,s=e.snapToScene,c=e.radius;return n._view=o,n.xyManipulation=new Za({tool:a,view:o,snapToScene:s,radius:c}),n.xyAxisManipulation=new qa({tool:a,view:o,radius:c}),n.zManipulation=new Ya({tool:a,view:o,radius:c}),n.xyManipulation.available=e.xyAvailable,n.xyAxisManipulation.available=e.xyAxisAvailable,n.zManipulation.available=e.zAvailable,n.autoHideXYAxis(),n.forEachManipulator((function(e){n._handles.add(e.events.on("grab-changed",(function(){return n.updateManipulatorInteractivity()})))})),n}return Object(o.a)(i,[{key:"destroy",value:function(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}},{key:"createGraphicDragPipeline",value:function(e,t){return Object(wn.b)([this.xyManipulation.createGraphicDragPipeline(e,t),this.xyAxisManipulation.createGraphicDragPipeline(e,t),this.zManipulation.createGraphicDragPipeline(e,t)])}},{key:"createDragPipeline",value:function(e,t,i){return Object(wn.b)([this.xyManipulation.createDragPipeline(e,t,i),this.xyAxisManipulation.createDragPipeline(e,t,i),this.zManipulation.createDragPipeline(e,i)])}},{key:"snapToScene",set:function(e){this.xyManipulation.snapToScene=e}},{key:"angle",set:function(e){this._angleDeferred=null,this.xyAxisManipulation.angle=e}},{key:"angleDeferred",set:function(e){this.xyAxisVisible?this.angle=e():this._angleDeferred=e}},{key:"interactive",set:function(e){this._interactive!==e&&(this._interactive=e,this.updateManipulatorInteractivity())}},{key:"radius",set:function(e){this.xyAxisManipulation.radius=e,this.xyManipulation.radius=e,this.zManipulation.radius=e}},{key:"displayScale",set:function(e){this.xyManipulation.displayScale=e,this.xyAxisManipulation.displayScale=e}},{key:"forEachManipulator",value:function(e){this.xyManipulation.forEachManipulator((function(t){return e(t,1)})),this.xyAxisManipulation.forEachManipulator((function(t){return e(t,1)})),this.zManipulation.forEachManipulator((function(t){return e(t,0)}))}},{key:"xyAxisVisible",get:function(){var e=this.xyManipulation.someManipulator((function(e){return e.focused}))||this.xyAxisManipulation.someManipulator((function(e){return e.focused}));return this._view.inputManager&&"touch"===this._view.inputManager.latestPointerType||e}},{key:"autoHideXYAxis",value:function(){var e=this,t=this.xyAxisManipulation,i=this.xyManipulation;if(!Object(u.a)("esri-mobile")){var n=[];i.forEachManipulator((function(e){return n.push(e)})),t.forEachManipulator((function(e){return n.push(e)}));for(var a=function(){var i=[];e.xyAxisVisible?Object(h.h)(e._angleDeferred)&&(e.angle=e._angleDeferred()):t.forEachManipulator((function(e){return i.push(e.disableDisplay())})),e._handles.remove($a),e._handles.add(i,$a)},r=0,o=n;r<o.length;r++){var s=o[r];this._handles.add(s.events.on("focus-changed",a))}this._view.inputManager&&this._handles.add(this._view.inputManager.watch("latestPointerType",a)),a()}}},{key:"updateManipulatorInteractivity",value:function(){var e=this,t=this.grabbing;this.forEachManipulator((function(i){i.interactive=!t&&e._interactive||i.grabbing}))}}],[{key:"radiusForSymbol",value:function(e){var t=Object(h.h)(e)&&"point-3d"===e.type&&e.symbolLayers;return t&&t.length>0&&t.some((function(e){return"icon"===e.type}))?ma:ba}}]),i}(Aa),$a="disable-xy-axis-display",er=i(1e3),tr=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this))._handles=new Me.a,n._view=e.view,n._tool=e.tool,n._graphicState=e.graphicState,n._createManipulator(),n.forEachManipulator((function(e){return n._tool.manipulators.add(e)})),n}return Object(o.a)(i,[{key:"destroy",value:function(){var e=this;this._handles.destroy(),this.forEachManipulator((function(t){e._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulator=null,this._graphicState=null}},{key:"forEachManipulator",value:function(e){e(this._manipulator,1)}},{key:"createGraphicDragPipeline",value:function(e){var t=this;return Da(this._graphicState,e,(function(e){return t.createDragPipeline(e)}))}},{key:"createDragPipeline",value:function(e){var t=this._view,i=this._graphicState.graphic,n=Object(h.h)(i.geometry)?i.geometry.spatialReference:null;return Object(Mn.e)(this._manipulator,(function(a,r,o,s,c){var l=r.next(function(e,t,i,n){var a=t.toMap(e.screenStart,{include:[i]});return Object(h.h)(a)?Fa(t,i,a,n):null}(c,t,i,n)).next(Object(Mn.b)()).next(Object(Mn.c)());e(a,l,o,s,c)}))}},{key:"_createManipulator",value:function(){var e=this._view,t=this._graphicState.graphic;this._manipulator=new er.a({graphic:t,view:e,selectable:!0,cursor:"move"})}}]),i}(Aa),ir=function e(t){Object(r.a)(this,e),this.allGraphics=t,this.type="graphic-move-start"},nr=function e(t,i,n){Object(r.a)(this,e),this.dx=t,this.dy=i,this.allGraphics=n,this.type="graphic-move"},ar=function e(t){Object(r.a)(this,e),this.allGraphics=t,this.type="graphic-move-stop"},rr=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e)).graphics=new xn.a,n.enableZ=!0,n.type="move-3d",n._toolHandles=new Me.a,n._handles=new Me.a,n}return Object(o.a)(i,[{key:"initialize",value:function(){var e=this;this._toolHandles.add([this.graphics.on("change",(function(){return e._refreshManipulators()}))]),this._refreshManipulators()}},{key:"destroy",value:function(){this._handles.destroy(),this._handles=null,this._toolHandles.destroy(),this._toolHandles=null,this.graphics.removeAll(),this._set("view",null)}},{key:"reset",value:function(){}},{key:"_refreshManipulators",value:function(){var e=this;this._handles.removeAll(),this._moveManipulation&&this._moveManipulation.destroy(),this.manipulators.removeAll();var t=this.graphics.toArray().filter((function(e){return 0===Object(ia.a)(e)})).map((function(e){return new or(e)}));t.length&&(this.createManipulators(t),this.createVisualElements(t),this._handles.add(t.map((function(t){return e.view.trackGraphicState(t.state)}))),this.updateMoveManipulation(t))}},{key:"createManipulators",value:function(e){var t,i=this,n=Object(k.a)(e);try{var r=function(){var n=t.value,r=n.state;n.manipulationXY=new tr({tool:i,view:i.view,graphicState:r}),n.manipulationXY.forEachManipulator((function(e){return i._handles.add(e.events.on("immediate-click",(function(e){i.emit("immediate-click",Object(a.a)(Object(a.a)({},e),{},{graphic:r.graphic})),e.stopPropagation()})))})),i._handles.add(n.manipulationXY.createDragPipeline((function(t,n,a){return i.buildDragEventPipeline(t,n,a,e)})))};for(n.s();!(t=n.n()).done;)r()}catch(o){n.e(o)}finally{n.f()}this.createMoveManipulation(e)}},{key:"createMoveManipulation",value:function(e){var t=this,i=new Ja({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===e.length?Ja.radiusForSymbol(e[0].graphic.symbol):ba});this._moveManipulation=i,i.elevationInfo={mode:"absolute-height",offset:0},i.forEachManipulator((function(e){t._handles.add(e.events.on("immediate-click",(function(n){i.zManipulation.hasManipulator(e)||1!==t.graphics.length||t.emit("immediate-click",Object(a.a)(Object(a.a)({},n),{},{graphic:t.graphics.getItemAt(0)})),n.stopPropagation()})))}));var n,r=function(){return t.updateMoveManipulation(e)},o=Object(k.a)(e);try{for(o.s();!(n=o.n()).done;){var s=n.value;this._handles.add([s.state.on("changed",r),s.state.watch("displaying",r)])}}catch(l){o.e(l)}finally{o.f()}var c=e[e.length-1];this._handles.add(c.state.on("changed",(function(){return t.updateMoveManipulationAngle(c)}))),this._handles.add(i.createDragPipeline((function(i,n,a){t.buildDragEventPipeline(i,n,a,e)}),Object(m.d)(c.graphic),Object(h.n)(c.graphic.geometry).spatialReference)),this.updateMoveManipulationAngle(c)}},{key:"createVisualElements",value:function(e){var t,i=this,n=Object(k.a)(e);try{var a=function(){var n=t.value,a=n.graphic,r=va({view:i.view,graphic:a,forEachManipulator:function(e){n.manipulationXY.forEachManipulator(e),i._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:function(){return Object(wn.c)()}});n.geometryRepresentation=r.visualElement,n.geometryRepresentation instanceof Wi&&i._handles.add([n.geometryRepresentation.events.on("attachment-origin-changed",(function(){n.state.isDraped||i.updateMoveManipulation(e)})),n.state.watch("isDraped",(function(){return i.updateMoveManipulation(e)}))]),i._handles.add(r)};for(n.s();!(t=n.n()).done;)a()}catch(r){n.e(r)}finally{n.f()}}},{key:"updateMoveManipulationAngle",value:function(e){this._moveManipulation.angleDeferred=function(){return Ta(e.graphic.geometry)}}},{key:"updateMoveManipulation",value:function(e){var t,i=Object($.d)(0,0,0,this.view.spatialReference),n=0,a=!1,r=this._moveManipulation,o=Object(k.a)(e);try{for(o.s();!(t=o.n()).done;){var s=t.value;if(s.state.displaying){var c=s.state.graphic;this.enableZ&&na(c)&&(a=!0);var l=s.geometryRepresentation instanceof Wi&&!s.state.isDraped?s.geometryRepresentation.attachmentOrigin:ea(this.view,c);Object(h.h)(l)&&(i.x+=l.x,i.y+=l.y,i.z+=l.z,n++)}}}catch(u){o.e(u)}finally{o.f()}n>0?(i.x/=n,i.y/=n,i.z/=n,r.location=i,r.xyManipulation.available=!0,r.xyAxisManipulation.available=!0,r.zManipulation.available=a):r.available=!1}},{key:"buildDragEventPipeline",value:function(e,t,i,n){var a=this,r=[],o=[],s=null,c=null,l=function(){var e,t=Object(k.a)(r);try{for(t.s();!(e=t.n()).done;){e.value.dragging=!1}}catch(i){t.e(i)}finally{t.f()}r.length=0,o.length=0,s=null,c=null,a._moveManipulation.interactive=!0};t.next((function(t){if("start"===t.action){r.length=0,o.length=0;var i,l=Object(k.a)(n);try{for(l.s();!(i=l.n()).done;){var u=i.value;u.dragging||!u.manipulationXY.hasManipulator(e)&&u.manipulationXY.grabbing||(r.push(u),o.push(u.graphic),u.dragging=!0)}}catch(h){l.e(h)}finally{l.f()}if(0!==o.length&&(a._moveManipulation.interactive=!1,s=Object(Mn.h)(o),c=Object(Mn.j)(o),a.emit("graphic-move-start",new ir(o)),a.destroyed))return null}return 0!==o.length?t:null})).next((function(e){return s(e)})).next((function(e){switch(e.action){case"start":case"update":if(e.translationX||e.translationY||e.translationZ){var t=a.view.toScreen(e.mapStart),i=a.view.toScreen(e.mapEnd),n=i.x-t.x,r=i.y-t.y;if(a.emit("graphic-move",new nr(n,r,o)),a.destroyed)return null}break;case"end":if(a.emit("graphic-move-stop",new ar(o)),a.destroyed)return null;l()}})),i.next((function(e){return c(e)})).next((function(){if(a.emit("graphic-move-stop",new ar(o)),a.destroyed)return null;l()}))}}]),i}(v.a.EventedMixin(O.a));Object(l.a)([Object(p.b)({constructOnly:!0,nonNullable:!0})],rr.prototype,"view",void 0),Object(l.a)([Object(p.b)({readOnly:!0})],rr.prototype,"graphics",void 0),Object(l.a)([Object(p.b)({constructOnly:!0,nonNullable:!0})],rr.prototype,"enableZ",void 0),Object(l.a)([Object(p.b)({readOnly:!0})],rr.prototype,"type",void 0),rr=Object(l.a)([Object(f.a)("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],rr);var or=function(){function e(t){Object(r.a)(this,e),this.state=null,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1,this.state=new aa({graphic:t})}return Object(o.a)(e,[{key:"graphic",get:function(){return this.state.graphic}}]),e}(),sr=i(537),cr=i(169),lr=i(612),ur=i(226),hr=i(711),dr=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e))._vertexManipulatorMaterial=Kn(Z.colorToVec4(Z.reshapeManipulators.vertex.color),Z.reshapeManipulators.vertex.renderOccluded),n._vertexManipulatorOutlineMaterial=Jn(Z.colorToVec4(Z.reshapeManipulators.vertex.outlineColor),Z.reshapeManipulators.vertex.renderOccluded),n._vertexManipulatorHoverOutlineMaterial=Jn(Z.colorToVec4(Z.reshapeManipulators.vertex.hoverOutlineColor),Z.reshapeManipulators.vertex.renderOccluded),n._edgeManipulatorMaterial=Kn(Z.colorToVec4(Z.reshapeManipulators.edge.color),Z.reshapeManipulators.edge.renderOccluded),n._edgeManipulatorOutlineMaterial=Jn(Z.colorToVec4(Z.reshapeManipulators.edge.outlineColor),Z.reshapeManipulators.edge.renderOccluded),n._selectedManipulatorMaterial=Kn(Z.colorToVec4(Z.reshapeManipulators.selected.color),Z.reshapeManipulators.selected.renderOccluded),n._selectedManipulatorOutlineMaterial=Jn(Z.colorToVec4(Z.reshapeManipulators.selected.outlineColor),Z.reshapeManipulators.selected.renderOccluded),n._selectedManipulatorHoverOutlineMaterial=Jn(Z.colorToVec4(Z.reshapeManipulators.selected.hoverOutlineColor),Z.reshapeManipulators.selected.renderOccluded),n._selectedIndex=0,n._vertexManipulatorGeometry=null,n._vertexManipulatorOutlineGeometry=null,n._edgeManipulatorGeometry=null,n._edgeManipulatorOutlineGeometry=null,n._handles=new Me.a,n._manipulatorHandles=new Me.a,n._manipulatorInfos=[],n._reshapeHelper=null,n._graphicMoveManipulation=null,n._moveManipulation=null,n._numGrabbing=0,n._numDragging=0,n._reshapeEventState=0,n._outlineVisualElement=null,n.tool=null,n.outputGeometry=null,n._vertexLaserLineVisualElement=null,n.snappingEngine=new hr.a(e.tool.snappingOptions),n}return Object(o.a)(i,[{key:"initialize",value:function(){var e=this,t=new aa({graphic:this.graphic});this._graphicState=t,this._handles.add([t.watch("displaying",(function(t){var i,n=Object(k.a)(e._manipulatorInfos);try{for(n.s();!(i=n.n()).done;){i.value.manipulator.available=t}}catch(a){n.e(a)}finally{n.f()}})),this.view.trackGraphicState(t)])}},{key:"destroy",value:function(){this._clear(),this._handles.destroy(),this.snappingEngine.destroy()}},{key:"inputGeometry",get:function(){return Object(h.h)(this._reshapeHelper)?this._reshapeHelper.geometry:null},set:function(e){this._recreateManipulators(e)}},{key:"manipulators",get:function(){return this.tool.manipulators}},{key:"view",get:function(){return this.tool.view}},{key:"graphic",get:function(){return this.tool.graphic}},{key:"enableZ",get:function(){return this.tool.enableZ}},{key:"enableMoveGraphic",get:function(){return this.tool.enableMoveGraphic}},{key:"removeSelectedVertices",value:function(){var e=this._manipulatorInfos.filter((function(e){return e.manipulator.selected&&"vertex"===e.handle.type}));this._removeVertices(e)}},{key:"manipulatorSelectionChanged",value:function(){this.emit("manipulators-changed")}},{key:"_clear",value:function(){this._moveManipulation=Object(h.d)(this._moveManipulation),this._graphicMoveManipulation=Object(h.d)(this._graphicMoveManipulation),this._manipulatorHandles.removeAll(),this.manipulators.removeAll(),this._manipulatorInfos=[],this._reshapeHelper=null,this._numGrabbing=0,this._numDragging=0}},{key:"_recreateManipulators",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.inputGeometry;if(this._clear(),!Object(h.g)(e)){this._reshapeHelper=new yr(cr.c.fromGeometry(e,this.view.viewingMode),e.type);var t,i=Object(m.d)(this.graphic),n=Object(k.a)(this._reshapeHelper.data.components);try{for(n.s();!(t=n.n()).done;){var a,r=t.value,o=Object(k.a)(r.vertices);try{for(o.s();!(a=o.n()).done;){var s=a.value;this._createPerVertexManipulator(s,i)}}catch(d){o.e(d)}finally{o.f()}var c,l=Object(k.a)(r.edges);try{for(l.s();!(c=l.n()).done;){var u=c.value;this._createPerVertexManipulator(u,i)}}catch(d){l.e(d)}finally{l.f()}}}catch(d){n.e(d)}finally{n.f()}this._createGraphicMoveManipulators(i)}}},{key:"_perGraphicManipulatorDragAction",value:function(e,t){if("end"!==t.action){var i,n=[],a=this._manipulatorInfos.some((function(e){return"vertex"===e.handle.type&&e.manipulator.selected})),r=1===e&&a,o=Object(h.n)(this._reshapeHelper),s=Object(k.a)(this._manipulatorInfos);try{for(s.s();!(i=s.n()).done;){var c=i.value;"vertex"===c.handle.type&&(c.manipulator.grabbing||r&&!c.manipulator.selected||(Object(h.n)(o).moveVertices([c.handle],t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ),n.push(c.handle.pos),this._updateManipulatorPosition(c)))}}catch(p){s.e(p)}finally{s.f()}if(0!==n.length){var l,u=0,d=Object(k.a)(this._manipulatorInfos);try{for(d.s();!(l=d.n()).done;){"vertex"===l.value.handle.type&&u++}}catch(p){d.e(p)}finally{d.f()}if(this.outputGeometry=o.geometry,n.length===u){if(this._updateEventState(1),this.destroyed)return;if(this.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,mover:this.graphic}),this.destroyed)return}else{if(this._updateEventState(2),this.destroyed)return;if(this.emit("reshape",{type:"reshape",mover:this.graphic}),this.destroyed)return}}}}},{key:"isMultiVertexSelection",value:function(){var e,t=0,i=Object(k.a)(this._manipulatorInfos);try{for(i.s();!(e=i.n()).done;){var n=e.value;fr(n)&&n.manipulator.selected&&t++}}catch(a){i.e(a)}finally{i.f()}return t>1}},{key:"_perVertexManipulatorDragAction",value:function(e){if(this._updateEventState(2),!this.destroyed){var t=e.mapDeltaX,i=e.mapDeltaY,n=e.mapDeltaZ;if(t||i||n){var a,r=[],o=Object(k.a)(this._manipulatorInfos);try{for(o.s();!(a=o.n()).done;){var s=a.value;fr(s)&&(s.manipulator.selected&&!s.manipulator.grabbing||s===e.info)&&r.push(s)}}catch(g){o.e(g)}finally{o.f()}for(var c=Object(h.n)(this._reshapeHelper),l=0,u=r;l<u.length;l++){var d=u[l];c.moveVertices([d.handle],t,i,n)}this.outputGeometry=c.geometry;for(var p=0,f=r;p<f.length;p++){var v=f[p];this._updateManipulatorPosition(v)}this.emit("reshape",{type:"reshape",mover:this.graphic})}}}},{key:"_updateEventState",value:function(e){if(e===this._reshapeEventState)return!1;switch(e){case 0:if(0!==this._numGrabbing||0!==this._numDragging)return!1;switch(this._reshapeEventState){case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic})}break;case 1:switch(this._reshapeEventState){case 0:this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic});break;case 2:this.emit("reshape",{type:"reshape-stop",mover:this.graphic}),this.destroyed||this.emit("move",{type:"move-start",dx:0,dy:0,mover:this.graphic})}break;case 2:switch(this._reshapeEventState){case 0:this.emit("reshape",{type:"reshape-start",mover:this.graphic});break;case 1:this.emit("move",{type:"move-stop",dx:0,dy:0,mover:this.graphic}),this.destroyed||this.emit("reshape",{type:"reshape-start",mover:this.graphic})}}if(this.destroyed)return!1;var t=this._reshapeEventState!==e;return this._reshapeEventState=e,t}},{key:"_createGraphicMoveManipulators",value:function(e){var t=this;this._graphicMoveManipulation=new tr({tool:this.tool,view:this.view,graphicState:this._graphicState}),this.enableMoveGraphic?this._manipulatorHandles.add(this._graphicMoveManipulation.createDragPipeline((function(e,i,n){i.next((function(e){return t._trackNumDragging(e)})).next((function(e){t._perGraphicManipulatorDragAction(0,e)})),n.next(t._cancelDragOperation())}))):this._graphicMoveManipulation.forEachManipulator((function(e){e.grabbable=!1,e.cursor=null})),this._graphicMoveManipulation.forEachManipulator((function(e){return t._manipulatorHandles.add([t._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(function(e){t._manipulatorInfos.some((function(e){return e.manipulator.selected}))?t._clearSelection():t.emit("immediate-click"),e.stopPropagation()}))])})),this._moveManipulation=new Ja({tool:this.tool,view:this.view,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&na(this.graphic),snapToScene:!1,radius:Ja.radiusForSymbol(this.graphic.symbol)}),this._moveManipulation.forEachManipulator((function(e){t._handles.add([t._watchAndUpdateGrabState(e,!1),e.events.on("immediate-click",(function(i){t._moveManipulation.zManipulation.hasManipulator(e)||t._manipulatorInfos.some((function(e){return e.manipulator.selected}))||t.emit("immediate-click"),i.stopPropagation()}))])})),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};var i=Object(h.n)(this.graphic.geometry).spatialReference,n=null;this._handles.add([this._moveManipulation.createDragPipeline((function(i,a,r,o){a.next((function(e){return t._trackNumDragging(e)})).next((function(i){if("start"===i.action){var a=t._manipulatorInfos.filter((function(e){return fr(e)&&e.manipulator.selected}));if(1===i.manipulatorType&&1===a.length){var r=a[0].handle;n=new ur.b(Object(h.n)(t._reshapeHelper),t.view,e,o,r)}}return Object(h.h)(n)&&(i.mapEnd=t.snappingEngine.snap(i.mapEnd,n)),"end"===i.action&&(t.snappingEngine.doneSnapping(),n=null),i})).next(Object(Mn.b)()).next((function(e){t._perGraphicManipulatorDragAction(1,e)})),r.next(t._cancelDragOperation())}),e,i),Object(Se.a)(this._graphicState,"displaying",(function(){t._updateMoveManipulationPosition()})),this._graphicState.on("changed",(function(){return t._updateMoveManipulationPosition()})),Object(Se.a)(this._graphicState,"isDraped",(function(){var e="align-move-manipulation";t._graphicState.isDraped?t._handles.add(t.view.elevationProvider.on("elevation-change",(function(){return t._updateMoveManipulationPosition()})),e):t._handles.remove(e)}))]),this._updateMoveManipulationPosition();var a=va({view:this.view,graphic:this.graphic,forEachManipulator:function(e){if(!t.destroyed){Object(h.h)(t._graphicMoveManipulation)&&t._graphicMoveManipulation.forEachManipulator(e);var i,n=Object(k.a)(t._manipulatorInfos);try{for(n.s();!(i=n.n()).done;){e(i.value.manipulator,1)}}catch(a){n.e(a)}finally{n.f()}t._moveManipulation.forEachManipulator(e)}},onManipulatorsChanged:function(e){return t.on("manipulators-changed",e)}});this._outlineVisualElement=a.visualElement instanceof Wi?a.visualElement:null,Object(h.h)(this._outlineVisualElement)&&this._manipulatorHandles.add([this._outlineVisualElement.events.on("attachment-origin-changed",(function(){t._graphicState.isDraped||t._updateMoveManipulationPosition()})),this._graphicState.watch("isDraped",(function(){return t._updateMoveManipulationPosition()}))]),this._manipulatorHandles.add(a)}},{key:"_createPerVertexManipulator",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(m.d)(this.graphic);if(Object(h.g)(this._vertexManipulatorGeometry)||Object(h.g)(this._vertexManipulatorOutlineGeometry)){var n=Z.reshapeManipulators.vertex,r=n.size/2,o=r+n.collisionPadding,s=r/o;this._vertexManipulatorGeometry=new ie.a(Yi.a.createSphereGeometry(s,16,16),"reshape-manipulator");var c=(r+n.outlineSize)/o;this._vertexManipulatorOutlineGeometry=new ie.a(Yi.a.createSphereGeometry(c,16,16),"reshape-manipulator-outline")}if(Object(h.g)(this._edgeManipulatorGeometry)||Object(h.g)(this._edgeManipulatorOutlineGeometry)){var l=Z.reshapeManipulators.edge,u=l.size/2,d=u+l.collisionPadding,p=u/d;this._edgeManipulatorGeometry=new ie.a(Yi.a.createSphereGeometry(p,16,16),"reshape-manipulator");var f=(u+l.outlineSize)/d;this._edgeManipulatorOutlineGeometry=new ie.a(Yi.a.createSphereGeometry(f,16,16),"reshape-manipulator-outline")}var v=new An({view:this.view,renderObjects:[{geometry:this._vertexManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:4|gr.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorOutlineMaterial,stateMask:5|gr.Vertex},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|gr.Vertex},{geometry:this._edgeManipulatorGeometry,material:this._vertexManipulatorMaterial,stateMask:6|gr.Edge},{geometry:this._vertexManipulatorOutlineGeometry,material:this._vertexManipulatorHoverOutlineMaterial,stateMask:6|gr.Edge},{geometry:this._edgeManipulatorGeometry,material:this._edgeManipulatorMaterial,stateMask:5|gr.Edge},{geometry:this._edgeManipulatorOutlineGeometry,material:this._edgeManipulatorOutlineMaterial,stateMask:5|gr.Edge},{geometry:this._vertexManipulatorGeometry,material:this._selectedManipulatorMaterial,stateMask:8},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorOutlineMaterial,stateMask:9},{geometry:this._vertexManipulatorOutlineGeometry,material:this._selectedManipulatorHoverOutlineMaterial,stateMask:10}],elevationInfo:i,focusMultiplier:1,touchMultiplier:1,available:!(!this.graphic.visible||!this.graphic.layer.visible)});this._setTypeSpecificManipulatorSettings(v,e,i);var g="edge"===e.type?{manipulator:v,handle:e,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:v,handle:e,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(g),this.manipulators.add(v),this._updateManipulatorPosition(g),"edge"===g.type){var b=this._getManipulatorInfoFromHandle(g.handle.left).manipulator.events.on("location-update",(function(){return t._updateManipulatorPosition(g)})),y=this._getManipulatorInfoFromHandle(g.handle.right).manipulator.events.on("location-update",(function(){return t._updateManipulatorPosition(g)}));g.locationUpdateHandle=Object(wn.b)([b,y]),this._manipulatorHandles.add(g.locationUpdateHandle,v)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(v,!0),v);var O=Object(Mn.e)(v,(function(e,n,r,o){n.next((function(e){return t._trackNumDragging(e)})).next((function(e){return vr(g)?Object(a.a)(Object(a.a)({},e),{},{info:t._splitEdgeManipulator(g)}):Object(a.a)(Object(a.a)({},e),{},{info:g})})).next(Object(Mn.f)(t.view,e.elevationAlignedLocation)).next(Fa(t.view,t.graphic,e.elevationAlignedLocation,e.location.spatialReference)).next(t._snapDrag(i,o)).next(Object(Mn.b)()).next((function(e){t._perVertexManipulatorDragAction(e)})),r.next(t._cancelDragOperation())}));return this._manipulatorHandles.add(O,v),this._manipulatorHandles.add([v.events.on("immediate-click",(function(e){return t._manipulatorClickCallback(e,g)})),v.events.on("select-changed",(function(){g.selectedIndex=++t._selectedIndex,t._updateMoveManipulationPosition()}))]),this.emit("manipulators-changed"),v}},{key:"_snapDrag",value:function(e,t){var i=this,n=null,r=Object(h.n)(this._reshapeHelper);return function(o){if("start"===o.action&&(i.isMultiVertexSelection()||(n={context:new ur.b(r,i.view,e,t,o.info.handle),originalPos:r.data.coordinateHelper.createDehydratedPoint(o.info.handle.pos)})),Object(h.h)(n)){var s=Object(a.a)({},n.originalPos);s.x+=o.mapEnd.x-o.mapStart.x,s.y+=o.mapEnd.y-o.mapStart.y;var c=i.snappingEngine.snap(s,n.context);o.mapEnd.x=c.x+(o.mapStart.x-n.originalPos.x),o.mapEnd.y=c.y+(o.mapStart.y-n.originalPos.y)}return"end"===o.action&&(i.snappingEngine.doneSnapping(),n=null),o}}},{key:"_trackNumDragging",value:function(e){switch(e.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return e}},{key:"_cancelDragOperation",value:function(){var e=this,t=Object(h.h)(this._reshapeHelper)?this._reshapeHelper.geometry.clone():null;return function(){switch(e._numDragging--,e.inputGeometry=t,e.outputGeometry=t,e.snappingEngine.doneSnapping(),e._reshapeEventState){case 0:break;case 1:e.emit("move",{type:"move",dx:0,dy:0,mover:e.graphic});break;case 2:e.emit("reshape",{type:"reshape",mover:e.graphic})}e.destroyed||e._updateEventState(0)}}},{key:"_setTypeSpecificManipulatorSettings",value:function(e,t,i){switch(t.type){case"vertex":e.state=gr.Vertex,e.selectable=!0,e.cursor="move",e.collisionPriority=2,e.radius=Z.reshapeManipulators.vertex.size/2+Z.reshapeManipulators.vertex.collisionPadding,e.elevationInfo=i;break;case"edge":e.state=gr.Edge,e.selectable=!1,e.cursor="copy",e.collisionPriority=-1,e.radius=Z.reshapeManipulators.edge.size/2+Z.reshapeManipulators.edge.collisionPadding,e.elevationInfo="on-the-ground"===i.mode?i:{mode:"absolute-height",offset:0}}}},{key:"_watchAndUpdateGrabState",value:function(e,t){var i=this;return e.events.on("grab-changed",(function(n){if("start"===n.action)t&&i._updateSelection(e),i._numGrabbing++;else if(i._numGrabbing--,i._updateEventState(0),i.destroyed)return;i._moveManipulation.interactive=!i._numGrabbing}))}},{key:"_clearSelection",value:function(){var e,t=Object(k.a)(this._manipulatorInfos);try{for(t.s();!(e=t.n()).done;){var i=e.value;i.manipulator.grabbing||(i.manipulator.selected=!1)}}catch(n){t.e(n)}finally{t.f()}}},{key:"_updateSelection",value:function(e){e.grabbing&&!e.selected&&e.selectable&&(this._clearSelection(),e.selected=!0,this.emit("manipulators-changed"))}},{key:"_removeManipulator",value:function(e){e&&(this._manipulatorHandles.remove(e.manipulator),this._manipulatorInfos.splice(this._manipulatorInfos.indexOf(e),1),this.manipulators.remove(e.manipulator),this.emit("manipulators-changed"))}},{key:"_getManipulatorInfoFromHandle",value:function(e){if(e){var t,i=Object(k.a)(this._manipulatorInfos);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(e===n.handle)return n}}catch(a){i.e(a)}finally{i.f()}}return null}},{key:"_updateManipulatorPosition",value:function(e){if(e){var t=Object(h.n)(this._reshapeHelper);if("vertex"===e.handle.type)e.manipulator.location=t.data.coordinateHelper.toPoint(e.handle.pos,mr),e.manipulator.grabbing&&Object(h.h)(this._vertexLaserLineVisualElement)&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=e.manipulator.renderLocation);else if("edge"===e.handle.type){var i=this._getManipulatorInfoFromHandle(e.handle.left).manipulator,n=this._getManipulatorInfoFromHandle(e.handle.right).manipulator;if(Object(h.h)(e.manipulator.elevationInfo)&&"on-the-ground"===e.manipulator.elevationInfo.mode){var a=i.location,r=n.location,o=a.x+.5*(r.x-a.x),s=a.y+.5*(r.y-a.y),c=a.hasZ&&r.hasZ?0:void 0;e.manipulator.location=Object($.d)(o,s,c,t.geometry.spatialReference)}else{var l=i.elevationAlignedLocation,u=n.elevationAlignedLocation,d=l.x+.5*(u.x-l.x),p=l.y+.5*(u.y-l.y),f=l.hasZ&&u.hasZ?l.z+.5*(u.z-l.z):void 0;e.manipulator.elevationAlignedLocation=Object($.d)(d,p,f,t.geometry.spatialReference)}}}}},{key:"_splitEdgeManipulator",value:function(e){var t=Object(h.n)(this._reshapeHelper),i=Object(h.n)(t.splitEdge(e.handle,.5).createdVertex);e.locationUpdateHandle.remove(),e.locationUpdateHandle=void 0;var n=e;n.handle=i,n.type="vertex";var a=Object(m.d)(this.graphic);this._setTypeSpecificManipulatorSettings(e.manipulator,e.handle,a),i.left&&this._createPerVertexManipulator(i.left),i.right&&this._createPerVertexManipulator(i.right),this.outputGeometry=t.geometry,this._updateManipulatorPosition(n),this._updateSelection(e.manipulator);var r=this._updateEventState(2),o=t.data.coordinateHelper.toArray(n.handle.pos),s=t.data.components.indexOf(i.component);return this.emit("vertex-add",{type:"vertex-add",vertices:[{coordinates:o,componentIndex:s,vertexIndex:Object(h.n)(i.index)}],added:o}),r&&this._updateEventState(0),n}},{key:"_updateMoveManipulationPosition",value:function(){var e=this,t=Sn.c.get();Object(X.t)(t,0,0,0);var i,n=0,a=!1,r=null,o=null,s=Object(k.a)(this._manipulatorInfos);try{for(s.s();!(i=s.n()).done;){var c=i.value;fr(c)&&(c.manipulator.selected?(n++,Object(X.c)(t,t,c.manipulator.renderLocation),Object(h.g)(r)||c.selectedIndex>r.selectedIndex?(o=r,r=c):(Object(h.g)(o)||c.selectedIndex>o.selectedIndex)&&(o=c)):a=!0)}}catch(g){s.e(g)}finally{s.f()}if(0!==n){var l=this._graphicState.displaying;this._moveManipulation.xyManipulation.available=l,this._moveManipulation.xyAxisManipulation.available=l,this._moveManipulation.zManipulation.available=l&&this.enableZ&&na(this.graphic),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=l&&1!==n}else{var u=this._graphicState.displaying&&this.enableMoveGraphic;this._moveManipulation.xyManipulation.available=u,this._moveManipulation.xyAxisManipulation.available=u,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=u,this._moveManipulation.zManipulation.available=u&&this.enableZ&&na(this.graphic)}if(0!==n){var d=0;if(Object(h.h)(r)){var p=r.handle.pos,f=Object(h.h)(o)?o.handle.pos:r.handle.left&&r.handle.left.left?r.handle.left.left.pos:null,v=!Object(h.h)(o)&&r.handle.right&&r.handle.right.right?r.handle.right.right.pos:null;f&&v?this._moveManipulation.xyAxisManipulation.available=!1:f?d=pr(f,p):v&&(d=pr(p,v))}this._moveManipulation.angle=d,this._moveManipulation.radius=ma}else this._moveManipulation.angleDeferred=function(){return Ta(Object(h.n)(e.graphic.geometry))},this._moveManipulation.radius=Ja.radiusForSymbol(this.graphic.symbol);0!==n&&a?(Object(X.b)(t,t,1/n),mr.spatialReference=Object(h.n)(this._reshapeHelper).geometry.spatialReference,mr.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(t,mr),this._moveManipulation.elevationAlignedLocation=mr):Object(h.h)(this._outlineVisualElement)&&!this._graphicState.isDraped&&Object(h.h)(this._outlineVisualElement.attachmentOrigin)?this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin:ta(this.view,this._moveManipulation,this.graphic)}},{key:"_removeVertices",value:function(e){var t,i=[],n=Object(h.n)(this._reshapeHelper),a=Object(k.a)(e);try{for(a.s();!(t=a.n()).done;){var r=t.value;if("vertex"===r.handle.type&&n.canRemoveVertex()){i.push(r.handle),this._removeManipulator(r),this._removeManipulator(this._getManipulatorInfoFromHandle(r.handle.left)),this._removeManipulator(this._getManipulatorInfoFromHandle(r.handle.right));var o=Object(h.n)(n.removeVertices([r.handle]).removedVertices[0].createdEdge);o&&this._createPerVertexManipulator(o)}}}catch(l){a.e(l)}finally{a.f()}if(i.length>0){var s=i.map((function(e){var t=n.data.components.indexOf(e.component);return{coordinates:n.data.coordinateHelper.toArray(e.pos),componentIndex:t,vertexIndex:Object(h.n)(e.index)}}));this.outputGeometry=n.geometry;var c=this._updateEventState(2);if(this.destroyed)return;if(this.emit("vertex-remove",{type:"vertex-remove",removed:s.map((function(e){return e.coordinates})),vertices:s}),this.destroyed)return;if(c&&(this._updateEventState(0),this.destroyed))return;this._updateMoveManipulationPosition()}}},{key:"_manipulatorClickCallback",value:function(e,t){e.shiftKey||this._clearSelection(),"vertex"===t.handle.type&&(t.manipulator.selected=!t.manipulator.selected),"vertex"===t.handle.type&&2===e.button&&this._removeVertices([t]),vr(t)&&0===e.button&&this._splitEdgeManipulator(t),e.stopPropagation()}}]),i}(v.a.EventedAccessor);function pr(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI/2}function fr(e){return"vertex"===e.handle.type}function vr(e){return"edge"===e.handle.type}Object(l.a)([Object(p.b)({constructOnly:!0})],dr.prototype,"tool",void 0),Object(l.a)([Object(p.b)()],dr.prototype,"inputGeometry",null),Object(l.a)([Object(p.b)()],dr.prototype,"outputGeometry",void 0),dr=Object(l.a)([Object(f.a)("esri.views.3d.interactive.editingTools.graphicReshape3D.ReshapeOperation")],dr);var gr,br,mr=Object($.d)(0,0,null,null);(br=gr||(gr={})).Vertex=16,br.Edge=32;var yr=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e,n){var a;return Object(r.a)(this,i),(a=t.call(this,e,n)).type=n,a._geometry=null,a}return Object(o.a)(i,[{key:"geometry",get:function(){if(this._dirty){switch(this.type){case"polyline":this._geometry=this.data.toPolyline();break;case"polygon":this._geometry=this.data.toPolygon()}this._dirty=!1}return this._geometry}}]),i}(lr.a),Or=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e))._handles=new Me.a,n._reshapeOperation=null,n._internalGeometryUpdate=!1,n.enableZ=!0,n.enableMoveGraphic=!0,n.type="reshape-3d",n.snappingOptions=new _.a,n}return Object(o.a)(i,[{key:"destroy",value:function(){this._handles.removeAll(),this._reshapeOperation&&(this._reshapeOperation.destroy(),this._reshapeOperation=null),this._set("view",null),this._set("graphic",null)}},{key:"selectionManagementDisabled",get:function(){return!0}},{key:"_updateGeometry",value:function(){var e=this.graphic.geometry;0!==Object(sr.a)(this.graphic)||!Object(h.h)(e)||"polygon"!==e.type&&"polyline"!==e.type?this._reshapeOperation.inputGeometry=null:this._reshapeOperation.inputGeometry=e.clone()}},{key:"_updateGraphic",value:function(){var e=this;if(this._handles.remove("onGraphicGeometryChange"),this._updateGeometry(),0===Object(sr.a)(this.graphic)){var t=this.watch("graphic.geometry",(function(){!1===e._internalGeometryUpdate&&e._updateGeometry()}),!0);this._handles.add(t,"onGraphicGeometryChange")}}},{key:"manipulatorSelectionChanged",value:function(){this._reshapeOperation&&this._reshapeOperation.manipulatorSelectionChanged()}},{key:"_onReshapeGeometryChanged",value:function(){Object(h.g)(this.graphic)||(this._internalGeometryUpdate=!0,this.graphic.geometry=this._reshapeOperation.outputGeometry.clone(),this._internalGeometryUpdate=!1)}},{key:"initialize",value:function(){var e=this;this._reshapeOperation=new dr({tool:this}),this._handles.add([this._reshapeOperation.on("reshape",(function(t){"reshape"===t.type&&e._onReshapeGeometryChanged(),e.emit("reshape",t)})),this._reshapeOperation.on("move",(function(t){"move"===t.type&&e._onReshapeGeometryChanged(),e.emit("move",t)})),this._reshapeOperation.on("vertex-add",(function(t){e._onReshapeGeometryChanged(),e.emit("vertex-add",t)})),this._reshapeOperation.on("vertex-remove",(function(t){e._onReshapeGeometryChanged(),e.emit("vertex-remove",t)})),this._reshapeOperation.on("immediate-click",(function(){return e.emit("immediate-click")})),Object(Se.a)(this,"graphic",(function(){e._updateGraphic()}),!0)])}},{key:"beforeUndo",value:function(){this._reshapeOperation.snappingEngine.doneSnapping()}},{key:"onInputEvent",value:function(e){"key-down"!==e.type||"Delete"!==e.key&&"Backspace"!==e.key||this._reshapeOperation.removeSelectedVertices()}},{key:"reset",value:function(){}}]),i}(v.a.EventedMixin(O.a));Object(l.a)([Object(p.b)({constructOnly:!0,nonNullable:!0})],Or.prototype,"view",void 0),Object(l.a)([Object(p.b)({constructOnly:!0})],Or.prototype,"graphic",void 0),Object(l.a)([Object(p.b)({constructOnly:!0,nonNullable:!0})],Or.prototype,"enableZ",void 0),Object(l.a)([Object(p.b)({constructOnly:!0,nonNullable:!0})],Or.prototype,"enableMoveGraphic",void 0),Object(l.a)([Object(p.b)({readOnly:!0})],Or.prototype,"type",void 0),Object(l.a)([Object(p.b)()],Or.prototype,"snappingOptions",void 0),Or=Object(l.a)([Object(f.a)("esri.views.3d.interactive.editingTools.graphicReshape3D.GraphicReshapeTool")],Or);var _r,jr=i(177);!function(e){e.ScaleIn=32,e.ScaleOut=64,e.RotateLeft=128,e.RotateRight=256,e.Unlocked=1024,e.DelayedFocused=2048,e.TouchInput=32768}(_r||(_r={}));var wr=function(){function e(t){var i=this;Object(r.a)(this,e),this.mode=null,this._handles=new Me.a,this._scaleRotateDragData=null,this._activeAnimation=null,this.events=new v.a,this.getFocused=function(){return i.ringManipulator.focused},this.getScale=function(){return Object(h.h)(i._scaleRotateDragData)&&"scale"===i._scaleRotateDragData.mode?i._scaleRotateDragData.scale:1},this.tool=t.tool,this.mode=t.mode,this.createManipulator(),this.updateDragState(),this.updateManipulatorTransform()}return Object(o.a)(e,[{key:"destroy",value:function(){Object(h.h)(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null),this._handles.removeAll(),this.tool.manipulators.remove(this.ringManipulator),this.ringManipulator=null}},{key:"startAnimation",value:function(e){var t=this;this.cancelActiveAnimation(),e.start();var i=Object(jr.a)({update:function(i){var n=i.deltaTime;e.update(n)&&t.cancelActiveAnimation()}});this._activeAnimation=Object(a.a)(Object(a.a)({},e),{},{frameTask:i})}},{key:"cancelActiveAnimation",value:function(){Object(h.h)(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation.destroy(),this._activeAnimation=null)}},{key:"forEachManipulator",value:function(e){e(this.ringManipulator,2)}},{key:"createManipulator",value:function(){var e=this;this.ringManipulator=this.createRingManipulator(),this.tool.manipulators.add(this.ringManipulator);var t=this.ringManipulator,i=this.tool.graphicState.graphic,n=Object(Mn.e)(t,(function(t,n,a){e._scaleRotateDragData=null;var r=function(e,t){var i=e.allLayerViews.find((function(e){return e.layer===t.layer}));if(Object(h.g)(t.symbol))return null;var n=t.symbol;return{symbolLayers:n.symbolLayers.map((function(e){var t=null;return"object"===e.type&&(t=e.heading),{heading:t,size:i.getSymbolLayerSize(n,e)}})).toArray()}}(e.tool.view,i);if(Object(h.g)(r))return e.updateDragState(),null;var o={mode:"none",origin:Object(Y.d)(t.renderLocation),angle:0,startAngle:e.tool.symbolRotationAngle,angleDir:0,scale:1,scaleDir:0,startSymbolData:r};e._scaleRotateDragData=o,e.updateDragState();var s=Sn.c.get();e.tool.view.renderCoordsHelper.worldUpAtPosition(t.renderLocation,s),n.next(Ga(e.tool.view,Ve.d.fromPositionAndNormal(t.renderLocation,s))).next((function(t){var n=Ve.d.normal(t.plane),a=$n(t.renderStart,t.renderEnd,o.origin,n),r=re.d.shortestSignedDiff(o.angle,a);o.angleDir=Object(pe.d)(o.angleDir+r,-.3,.3),o.angle=a;var s=function(e,t){var i=Object(X.g)(Sn.c.get(),t.renderStart,e.origin),n=Object(X.g)(Sn.c.get(),t.renderEnd,e.origin),a=Object(X.m)(i),r=Object(X.m)(n);return 0===a?0:r/a}(o,t),c=s-o.scale;if(o.scaleDir=Object(pe.d)(o.scaleDir+c,-.2,.2),o.scale=s,e.onScaleChanged(),"none"===o.mode){var l=e.mode||function(e,t,i,n){var a=e.renderStart,r=e.renderEnd,o=xr(a,n,Sn.c.get()),s=xr(r,n,Sn.c.get());if(Object(X.i)(o,s)<100)return null;var c=Object(X.g)(Sn.c.get(),a,i),l=Object(X.d)(Sn.c.get(),c,t),u=a,h=Object(X.c)(Sn.c.get(),u,l),d=xr(i,n,Sn.c.get()),p=o,f=xr(h,n,Sn.c.get()),v=Object(X.g)(Sn.c.get(),f,p),g=Object(X.g)(Sn.c.get(),o,d),b=Ve.e.wrap(p,v),m=Ve.e.wrap(d,g);return Ve.e.distance2(b,s)<Ve.e.distance2(m,s)?"rotate":"scale"}(t,t.plane,o.origin,e.tool.view.state.camera);if(Object(h.h)(l)){switch(l){case"rotate":e.tool.emit("graphic-rotate-start",{graphic:i,angle:o.angle});break;case"scale":e.tool.emit("graphic-scale-start",{graphic:i,scale:o.scale})}o.mode=l}}if(e.updateDragState(),Object(h.h)(i.symbol)){var u=i.symbol.clone(),d=0,p=1;switch(o.mode){default:case"none":break;case"scale":p=o.scale;break;case"rotate":d=o.angle}e.applySymbolData(u,o.startSymbolData,d,p),i.symbol=u,e.updateManipulatorTransform()}switch(t.action){case"start":case"update":switch(o.mode){case"rotate":e.tool.emit("graphic-rotate",{graphic:i,angle:o.angle});break;case"scale":e.tool.emit("graphic-scale",{graphic:i,scale:o.scale})}break;case"end":switch(o.mode){case"rotate":e.tool.emit("graphic-rotate-stop",{graphic:i,angle:o.angle});break;case"scale":e.tool.emit("graphic-scale-stop",{graphic:i,scale:o.scale});break;default:case"none":}}"end"===t.action&&(e.startAnimation(Mr(e,(function(){return e.onScaleChanged()}))),e._scaleRotateDragData=null,e.updateDragState())})),a.next(Object(Mn.k)(i)).next((function(){if(Object(h.h)(e._scaleRotateDragData)){switch(e._scaleRotateDragData.mode){case"none":break;case"rotate":e.tool.emit("graphic-rotate-stop",{graphic:i,angle:e._scaleRotateDragData.startAngle});break;case"scale":e.tool.emit("graphic-scale-stop",{graphic:i,scale:1})}e.startAnimation(Mr(e,(function(){return e.onScaleChanged()}))),e._scaleRotateDragData=null}}))}));this._handles.add(n),this._handles.add([this.ringManipulator.events.on("focus-changed",(function(t){"focus"===t.action?e.startAnimation(function(e,t){var i=0,n=null,a=function(){return!1};return{start:function(){n=e.getFocused,e.getFocused=a,i=0,t()},update:function(e){return i+=e,!n()||i>200?1:0},destroy:function(){e.getFocused=n,t()}}}(e,(function(){return e.updateDelayedFocusedState()}))):e.updateDelayedFocusedState()})),this.ringManipulator.events.on("immediate-click",(function(e){e.stopPropagation()})),Object(Se.a)(this.tool.graphicState,"displaying",(function(t){return e.ringManipulator.available=t})),this.tool.graphicState.on("changed",(function(){return ta(e.tool.view,e.ringManipulator,i)}))]),ta(this.tool.view,this.ringManipulator,i)}},{key:"onScaleChanged",value:function(){this.events.emit("scale-changed"),this.updateManipulatorTransform()}},{key:"updateDelayedFocusedState",value:function(){this.ringManipulator.updateStateEnabled(_r.DelayedFocused,this.getFocused())}},{key:"updateDragState",value:function(){if(this.ringManipulator.updateStateEnabled(_r.Unlocked,!(Object(h.h)(this._scaleRotateDragData)&&"none"!==this._scaleRotateDragData.mode)),Object(h.h)(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case"rotate":this.ringManipulator.updateStateEnabled(_r.ScaleIn|_r.ScaleOut,!1),this.ringManipulator.updateStateEnabled(_r.RotateLeft,this._scaleRotateDragData.angleDir<0),this.ringManipulator.updateStateEnabled(_r.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this.ringManipulator.updateStateEnabled(_r.RotateLeft|_r.RotateRight,!1),this.ringManipulator.updateStateEnabled(_r.ScaleIn,this._scaleRotateDragData.scaleDir<0),this.ringManipulator.updateStateEnabled(_r.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this.ringManipulator.updateStateEnabled(_r.ScaleIn|_r.ScaleOut|_r.RotateLeft|_r.RotateRight,!1)}},{key:"updateManipulatorTransform",value:function(){var e=Object(oe.i)(Sn.a.get()),t=this.tool.symbolRotationAngle;Object(oe.o)(e,e,t,Object(Y.g)(0,0,1));var i=this.getScale(),n=Object(oe.n)(Sn.a.get(),Object(X.t)(Sn.c.get(),i,i,i)),a=Object(oe.i)(Sn.a.get());Object(oe.l)(a,n,e),this.ringManipulator.modelTransform=a}},{key:"createRingManipulator",value:function(){for(var e=function(e,t,i){for(var n=[],a=Math.ceil(128*(t-e)/(2*Math.PI)),r=0;r<a+1;r++){var o=e+r*(t-e)/a;n.push(Object(Y.g)(i*Math.cos(o),i*Math.sin(o),0))}return n},t=function(t){return e(0,2*Math.PI,t)},i=function(e,t){return new ie.a(Yi.a.createPathExtrusionGeometry(function(e){return[[-e/2,0],[e/2,0],[e/2,.25],[-e/2,.25]]}(t),e,[],[],!1),"graphic-transform-ring")},n=t(ya),a=i(n,24),r={left:[],right:[]},o=[],s=0;s<2;s++){var c=s*Math.PI-Math.PI/4,l=Math.PI/2-Oa,u=c+l,h=c+Math.PI/2-l,d=e(u,h,190),p=i(d,9);o.push(d),o.push(e(u,h,201)),r.left.push(p),r.right.push(p);for(var f=0;f<2;f++){var v=0===f,g=Object(se.b)();if(v){Object(oe.p)(g,g,[1,-1,1]),Object(oe.o)(g,g,-u,[0,0,1]);var b=Math.round(.2*(d.length-1));g[12]=d[b][0],g[13]=d[b][1],g[14]=d[b][2]}else{Object(oe.o)(g,g,h,[0,0,1]);var y=Math.round(.8*(d.length-1));g[12]=d[y][0],g[13]=d[y][1],g[14]=d[y][2]}var O=Yi.a.createExtrudedTriangle(60,0,23,.5);Yi.a.transformInPlace(O,g);var _=new ie.a(O,"graphic-transform-ring-rotate");(v?r.left:r.right).push(_)}}for(var j=[],w=0;w<2;w++){var x=w*Math.PI-Math.PI/4,M=Math.PI/2-_a,S=x+M,k=x+Math.PI/2-M,R=e(S,k,213);j.push(i(R,9))}var E=t(190),D=t(213),T=i(E,9),C=i(D,9),P=t(130),I=t(107),A=i(P,9),L=i(I,9),G=this.createMaterial(),z=this.createMaterial(.66),V=this.createMaterial(.5),F=this.createMaterial(.33),H=[{geometry:a,material:G,stateMask:_r.DelayedFocused},{geometry:a,material:V,stateMask:0}];this.mode&&"scale"!==this.mode||(H=H.concat([{geometry:j,material:G,stateMask:_r.DelayedFocused|_r.Unlocked},{geometry:T,material:z,stateMask:_r.DelayedFocused|_r.ScaleIn},{geometry:C,material:F,stateMask:_r.DelayedFocused|_r.ScaleIn},{geometry:A,material:z,stateMask:_r.DelayedFocused|_r.ScaleOut},{geometry:L,material:F,stateMask:_r.DelayedFocused|_r.ScaleOut}])),this.mode&&"rotate"!==this.mode||(H=H.concat([{geometry:r.right,material:G,stateMask:_r.DelayedFocused|_r.Unlocked},{geometry:r.left,material:G,stateMask:_r.DelayedFocused|_r.RotateLeft},{geometry:r.right,material:G,stateMask:_r.DelayedFocused|_r.RotateRight}]));var N=[n].concat(o);return new An({view:this.tool.view,renderObjects:H,autoScaleRenderObjects:!1,worldOriented:!0,radius:24,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:Object(m.d)(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:N,direction:Object(Y.g)(0,0,1)}})}},{key:"createMaterial",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=[].concat(Object(jt.a)(ga),[e]);return new Rn.a({color:t,transparent:1!==e,cullFace:2,renderOccluded:2},"graphic-transform")}},{key:"applySymbolData",value:function(e,t,i,n){var a=this;e.symbolLayers.forEach((function(e,r){var o=t.symbolLayers[r],s=o.heading,c=o.size;"object"===e.type&&(e.heading=(Object(h.h)(s)?s:0)-Object(wa.c)(i),Object(h.h)(c)&&"width"in c&&(c.width=a.enforceNonZeroSize(c.width),c.height=a.enforceNonZeroSize(c.height),c.depth=a.enforceNonZeroSize(c.depth),e.width=c.width*n,e.depth=c.depth*n,e.height=c.height*n))}))}},{key:"enforceNonZeroSize",value:function(e){return e||this.tool.view.state.camera.computeRenderPixelSizeAt(this.ringManipulator.renderLocation)}},{key:"test",get:function(){return{ringManipulator:this.ringManipulator}}}]),e}();function xr(e,t,i){var n=t.projectToRenderScreen(e,Object(Le.a)(Sr)),a=t.renderToScreen(n,kr);return Object(X.t)(i,a[0],a[1],0)}function Mr(e,t){var i=null,n=1,a=function(){return n};return{start:function(){n=e.getScale(),i=e.getScale,e.getScale=a,t()},update:function(e){return n+=((n+1)/2-n)*Math.min(3*e,1),t(),Math.abs(n-1)<.01?1:0},destroy:function(){e.getScale=i,t()}}}var Sr=Object(Y.e)(),kr=Object(Le.f)(),Rr=function(e){Object(s.a)(i,e);var t=Object(c.a)(i);function i(e){var n;return Object(r.a)(this,i),(n=t.call(this,e)).enableZ=!0,n.enableRotation=!0,n.enableScaling=!0,n.type="transform-3d",n.handles=new Me.a,n.scaleRotate=null,n}return Object(o.a)(i,[{key:"initialize",value:function(){var e=this;if(this.graphicState=new aa({graphic:this.graphic}),this.moveManipulation=new Ja({tool:this,view:this.view,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&na(this.graphic),radius:Ja.radiusForSymbol(this.graphic.symbol)}),this.moveManipulation.forEachManipulator((function(t){return e.handles.add(t.events.on("immediate-click",(function(e){return e.stopPropagation()})))})),this.moveManipulation.elevationInfo=Object(m.d)(this.graphic),this.moveManipulation.createGraphicDragPipeline(this.graphicState,(function(t){var i=t.action,n={graphic:t.graphic,dxScreen:t.dxScreen,dyScreen:t.dyScreen};switch(i){case"start":e.emit("graphic-translate-start",n);break;case"update":e.emit("graphic-translate",n);break;case"end":e.emit("graphic-translate-stop",n)}})),this.moveManipulation.angle=this.symbolRotationAngle,this.enableScaling||this.enableRotation){var t=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this.scaleRotate=new wr({tool:this,mode:t}),this.handles.add(this.scaleRotate.events.on("scale-changed",(function(){return e.onScaleChanged()})))}this.handles.add([va({view:this.view,graphic:this.graphic,forEachManipulator:function(t){return e.forEachManipulator(t)},onManipulatorsChanged:function(){return Object(wn.c)()}}),this.graphic.watch("symbol",(function(){return e.updateMoveAngle()})),this.graphicState.on("changed",(function(){return e.onGeometryChanged()})),this.hideManipulatorsForGraphicState(),this.view.watch("scale",(function(){return e.updateMoveAngle()}))]),this.handles.add(this.view.trackGraphicState(this.graphicState)),this.onGeometryChanged()}},{key:"forEachManipulator",value:function(e){this.moveManipulation.forEachManipulator(e),Object(h.h)(this.scaleRotate)&&this.scaleRotate.forEachManipulator(e)}},{key:"hideManipulatorsForGraphicState",value:function(){var e=this;return this.graphicState.watch("displaying",(function(t){e.forEachManipulator((function(e){return e.available=t})),e.moveManipulation.zManipulation.available=t&&e.enableZ&&na(e.graphic)}))}},{key:"destroy",value:function(){this.handles.destroy(),this.moveManipulation.destroy(),Object(h.h)(this.scaleRotate)&&(this.scaleRotate.destroy(),this.scaleRotate=null),this._set("view",null),this._set("graphic",null)}},{key:"snapToScene",set:function(e){this.moveManipulation&&(this.moveManipulation.snapToScene=e),this._set("snapToScene",e)}},{key:"symbolRotationAngle",get:function(){var e=this.graphic.symbol;if(e){var t=e.symbolLayers.find((function(e){return"object"===e.type})),i=t&&t.heading||0;return Object(wa.d)(-i)}return 0}},{key:"reset",value:function(){}},{key:"onDetach",value:function(){Object(h.h)(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}},{key:"onHide",value:function(){Object(h.h)(this.scaleRotate)&&this.scaleRotate.cancelActiveAnimation()}},{key:"onScaleChanged",value:function(){if(!Object(h.g)(this.scaleRotate)){var e=this.scaleRotate.getScale();this.moveManipulation.displayScale=e}}},{key:"updateMoveAngle",value:function(){"local"===this.view.viewingMode||this.view.scale<1e6?this.moveManipulation.angle=this.symbolRotationAngle:this.moveManipulation.angle=0}},{key:"onGeometryChanged",value:function(){ta(this.view,this.moveManipulation,this.graphic)}},{key:"test",get:function(){return{discManipulator:this.moveManipulation.xyManipulation.test.discManipulator,ringManipulator:Object(h.h)(this.scaleRotate)?this.scaleRotate.test.ringManipulator:null,arrowManipulators:this.moveManipulation.xyAxisManipulation.test.arrowManipulators}}}]),i}(v.a.EventedMixin(O.a));Object(l.a)([Object(p.b)({constructOnly:!0,nonNullable:!0})],Rr.prototype,"view",void 0),Object(l.a)([Object(p.b)({constructOnly:!0,nonNullable:!0})],Rr.prototype,"graphic",void 0),Object(l.a)([Object(p.b)({constructOnly:!0,nonNullable:!0})],Rr.prototype,"enableZ",void 0),Object(l.a)([Object(p.b)()],Rr.prototype,"enableRotation",void 0),Object(l.a)([Object(p.b)()],Rr.prototype,"enableScaling",void 0),Object(l.a)([Object(p.b)({value:!1})],Rr.prototype,"snapToScene",null),Object(l.a)([Object(p.b)({readOnly:!0})],Rr.prototype,"type",void 0),Rr=Object(l.a)([Object(f.a)("esri.views.3d.interactive.editingTools.graphicTransform3D.GraphicTransformTool")],Rr)},986:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var n,a,r=i(30),o=i(31),s=i(348);function c(e){e.fragment.include(s.a),e.fragment.uniforms.add("depthTex","sampler2D"),e.fragment.uniforms.add("shadowMapNum","int"),e.fragment.uniforms.add("shadowMapDistance","vec4"),e.fragment.uniforms.add("shadowMapMatrix","mat4",4),e.fragment.uniforms.add("depthHalfPixelSz","float"),e.fragment.code.add(Object(o.a)(n||(n=Object(r.a)(["\n    float readShadowMap(const in vec3 _vpos, float _linearDepth) {\n      float halfPixelSize = depthHalfPixelSz;\n      vec4 distance = shadowMapDistance;\n      float depth = _linearDepth;\n\n      //choose correct cascade\n      int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;\n\n      if (i >= shadowMapNum) { return 0.0; }\n\n      mat4 mat = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];\n\n      vec4 lv = mat * vec4(_vpos, 1.0);\n      lv.xy /= lv.w;\n\n      // vertex completely outside? -> no shadow\n      vec3 lvpos = 0.5 * lv.xyz + vec3(0.5);\n      if (lvpos.z >= 1.0) { return 0.0; }\n      if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }\n\n      // calc coord in cascade texture\n      vec2 uv = vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;\n\n      float texSize = 0.5 / halfPixelSize;\n\n      // filter, offset by half pixels\n      vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);\n\n      float s00 = rgba2float(texture2D(depthTex, uv + vec2(-halfPixelSize, -halfPixelSize))) < lvpos.z ? 1.0 : 0.0;\n      float s10 = rgba2float(texture2D(depthTex, uv + vec2(halfPixelSize, -halfPixelSize))) < lvpos.z ? 1.0 : 0.0;\n      float s11 = rgba2float(texture2D(depthTex, uv + vec2(halfPixelSize, halfPixelSize))) < lvpos.z ? 1.0 : 0.0;\n      float s01 = rgba2float(texture2D(depthTex, uv + vec2(-halfPixelSize, halfPixelSize))) < lvpos.z ? 1.0 : 0.0;\n\n      return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);\n    }\n  "]))))}(a=c||(c={})).bindUniforms=function(e,t,i){t.shadowMappingEnabled&&(t.shadowMap.bind(e,i),t.shadowMap.bindView(e,t.origin))},a.bindViewCustomOrigin=function(e,t,i){t.shadowMappingEnabled&&t.shadowMap.bindView(e,i)},a.bindView=function(e,t){t.shadowMappingEnabled&&t.shadowMap.bindView(e,t.origin)}},999:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var n,a,r,o=i(30),s=i(31);function c(e,t){0===t.output&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add(Object(s.a)(n||(n=Object(o.a)(["\n      void forwardLinearDepth() { linearDepth = gl_Position.w; }\n    "]))))):1===t.output||3===t.output?(e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("uCameraNearFar","vec2"),e.vertex.code.add(Object(s.a)(a||(a=Object(o.a)(["\n      void forwardLinearDepth() {\n        linearDepth = (-position_view().z - uCameraNearFar[0]) / (uCameraNearFar[1] - uCameraNearFar[0]);\n      }\n    "]))))):e.vertex.code.add(Object(s.a)(r||(r=Object(o.a)(["\n      void forwardLinearDepth() {}\n    "]))))}}}]);
//# sourceMappingURL=3.46e97600.chunk.js.map