(this["webpackJsonpqp-ampd-app"]=this["webpackJsonpqp-ampd-app"]||[]).push([[26],{1001:function(e,t,r){"use strict";function n(){return new Float32Array(2)}function i(e,t){var r=new Float32Array(2);return r[0]=e,r[1]=t,r}function a(){return n()}function s(){return i(1,1)}function o(){return i(1,0)}function u(){return i(0,1)}r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return i}));var c=a(),l=s(),h=o(),f=u();Object.freeze({__proto__:null,create:n,clone:function(e){var t=new Float32Array(2);return t[0]=e[0],t[1]=e[1],t},fromValues:i,createView:function(e,t){return new Float32Array(e,t,2)},zeros:a,ones:s,unitX:o,unitY:u,ZEROS:c,ONES:l,UNIT_X:h,UNIT_Y:f})},1002:function(e,t,r){"use strict";r.d(t,"a",(function(){return O})),r.d(t,"b",(function(){return j})),r.d(t,"c",(function(){return x})),r.d(t,"d",(function(){return I})),r.d(t,"e",(function(){return _})),r.d(t,"f",(function(){return w})),r.d(t,"g",(function(){return k})),r.d(t,"h",(function(){return m}));r(10);var n=r(13),i=(r(15),r(14)),a=r(20),s=(r(44),r(36),r(290),r(112),r(345),r(516),r(980)),o=(r(983),r(2)),u=r(3),c=r(145),l=function(){function e(){Object(o.a)(this,e),this.color=[0,0,0,0],this.haloColor=[0,0,0,0],this.haloSize=0,this.size=12,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}return Object(u.a)(e,[{key:"acquire",value:function(e,t,r,n,i,a,s,o,u){this.color=e,this.haloColor=t,this.haloSize=r,this.size=n,this.angle=i,this.offsetX=a,this.offsetY=s,this.hAnchor=o,this.vAnchor=u}},{key:"release",value:function(){this.color[0]=this.color[1]=this.color[2]=this.color[3]=0,this.haloColor[0]=this.haloColor[1]=this.haloColor[2]=this.haloColor[3]=0,this.haloSize=0,this.size=0,this.angle=0,this.offsetX=0,this.offsetY=0,this.hAnchor=0,this.vAnchor=0}}]),e}();l.pool=new c.a(l);var h=i.a.getLogger("esri.views.2d.engine.webgl.Utils");function f(e){var t,r={},i=Object(n.a)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;r[a.name]=a.strideInBytes}}catch(s){i.e(s)}finally{i.f()}return r}var d=f([{name:"geometry",strideInBytes:32,divisor:0}]),v=f([{name:"geometry",strideInBytes:32,divisor:0}]),p=f([{name:"geometry",strideInBytes:12,divisor:0}]),y=f([{name:"geometry",strideInBytes:36,divisor:0}]),b=f([{name:"geometry",strideInBytes:32,divisor:0}]),g=f([{name:"geometry",strideInBytes:36,divisor:0}]);function _(e,t){switch(e){case s.b.MARKER:return d;case s.b.FILL:return t?p:v;case s.b.LINE:return y;case s.b.TEXT:return b;case s.b.LABEL:return g}}function m(e){switch(e%4){case 0:case 2:return 4;case 1:case 3:return 1}}function O(e,t){switch(t%4){case 0:case 2:return new Uint32Array(e);case 1:case 3:return new Uint8Array(e)}}function k(e){return"number"==typeof e}function j(e,t){switch(e){case"butt":return 0;case"round":return t?2:1;case"square":return 2;default:return h.error(new a.a("mapview-invalid-type","Cap type ".concat(e," is not a valid option. Defaulting to round"))),1}}function x(e){switch(e){case"miter":return 2;case"bevel":return 0;case"round":return 1;default:return h.error(new a.a("mapview-invalid-type","Join type ".concat(e," is not a valid option. Defaulting to round"))),1}}function w(e){switch(e){case"opacity":return s.a.OPACITY;case"color":return s.a.COLOR;case"rotation":return s.a.ROTATION;case"size":return s.a.SIZE;default:return h.error("Cannot interpret unknown vv: ".concat(e)),null}}function I(e){switch(e){case 5121:return Uint8Array;case 32819:return Uint16Array;case 5126:return Float32Array;default:return void h.error(new a.a("webgl-utils","Unable to handle type ".concat(e)))}}new Map},1031:function(e,t,r){"use strict";r.d(t,"a",(function(){return h}));var n=r(13),i=r(2),a=r(3),s=r(97),o=(r(99),r(185)),u=r(515),c=r(998),l=0,h=function(){function e(t){Object(i.a)(this,e),this.type="FeatureSetReader",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._xmin=-1,this._xmax=0,this._ymin=0,this._ymax=0,this._joined=[],this.instance=t}return Object(a.a)(e,[{key:"_hasFilter",get:function(){return-1!==this._xmin}},{key:"getQuantizationTransform",value:function(){throw new Error("Unable to find transform for featureSet")}},{key:"getStorage",value:function(){return this._storage}},{key:"getComputedNumeric",value:function(e){return this.getComputedNumericAtIndex(0)}},{key:"setComputedNumeric",value:function(e,t){return this.setComputedNumericAtIndex(t,0)}},{key:"getComputedString",value:function(e){return this.getComputedStringAtIndex(0)}},{key:"setComputedString",value:function(e,t){return this.setComputedStringAtIndex(0,t)}},{key:"getComputedNumericAtIndex",value:function(e){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),e)}},{key:"setComputedNumericAtIndex",value:function(e,t){this._storage.setComputedNumericAtIndex(this.getDisplayId(),e,t)}},{key:"getComputedStringAtIndex",value:function(e){return this._storage.getComputedStringAtIndex(this.getDisplayId(),e)}},{key:"setComputedStringAtIndex",value:function(e,t){return this._storage.setComputedStringAtIndex(this.getDisplayId(),e,t)}},{key:"transform",value:function(e,t){var r=this.copy();return r._tx=e,r._ty=t,r}},{key:"extent",value:function(e,t,r,n){var i=this.copy();return i._xmin=e,i._xmax=r,i._ymin=t,i._ymax=n,i}},{key:"hasFilter",value:function(){return this._hasFilter}},{key:"readAttribute",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._readAttribute(e,t);if(void 0!==r)return r;var i,a=Object(n.a)(this._joined);try{for(a.s();!(i=a.n()).done;){var s=i.value;s.setIndex(this.getIndex());var o=s._readAttribute(e,t);if(void 0!==o)return o}}catch(u){a.e(u)}finally{a.f()}}},{key:"readAttributes",value:function(){return this._readAttributes()}},{key:"joinAttributes",value:function(e){this._joined.push(e)}},{key:"readArcadeFeature",value:function(){return this}},{key:"geometry",value:function(){var e=this.readHydratedGeometry(),t=Object(u.h)(e,this.geometryType,this.hasZ,this.hasM),r=Object(s.a)(t);return r.spatialReference=this._arcadeSpatialReference,r}},{key:"field",value:function(e){return this.readAttribute(e,!0)}},{key:"hasField",value:function(e){return!0}},{key:"setField",value:function(e,t){}},{key:"keys",value:function(){return[]}},{key:"castToText",value:function(){return""}},{key:"_computeCentroid",value:function(){if("esriGeometryPolygon"!==this.geometryType)return null;var e=this.readUnquantizedGeometry();if(!e||e.hasIndeterminateRingOrder)return null;var t=this.getQuantizationTransform();return Object(c.a)(new o.a,e,this.hasM,this.hasZ,t)}},{key:"copyInto",value:function(e){e.seen=this.seen,e._storage=this._storage,e._arcadeSpatialReference=this._arcadeSpatialReference,e._joined=this._joined,e._tx=this._tx,e._ty=this._ty,e._xmin=this._xmin,e._xmax=this._xmax,e._ymin=this._ymin,e._ymax=this._ymax}}],[{key:"createInstance",value:function(){return l=++l>65535?0:l}}]),e}()},1092:function(e,t,r){"use strict";r.d(t,"a",(function(){return F})),r.d(t,"b",(function(){return S})),r.d(t,"c",(function(){return I}));var n=r(32),i=r(7),a=r.n(i),s=r(13),o=r(20),u=r(262),c=r(185),l=a.a.mark(v),h=a.a.mark(p);function f(e){var t=[];return e.forEach((function(e){return t.push(e)})),t}var d={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function v(e){var t,r,n;return a.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:i.t0=e.type,i.next="Feature"===i.t0?3:"FeatureCollection"===i.t0?6:25;break;case 3:return i.next=5,e;case 5:return i.abrupt("break",25);case 6:t=Object(s.a)(e.features),i.prev=7,t.s();case 9:if((r=t.n()).done){i.next=17;break}if(n=r.value,i.t1=n,!i.t1){i.next=15;break}return i.next=15,n;case 15:i.next=9;break;case 17:i.next=22;break;case 19:i.prev=19,i.t2=i.catch(7),t.e(i.t2);case 22:return i.prev=22,t.f(),i.finish(22);case 25:case"end":return i.stop()}}),l,null,[[7,19,22,25]])}function p(e){var t,r,n,i,o,u,c,l,f;return a.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(e){a.next=2;break}return a.abrupt("return",null);case 2:a.t0=e.type,a.next="Point"===a.t0?5:"LineString"===a.t0||"MultiPoint"===a.t0?8:"MultiLineString"===a.t0||"Polygon"===a.t0?10:"MultiPolygon"===a.t0?27:58;break;case 5:return a.next=7,e.coordinates;case 7:return a.abrupt("break",58);case 8:return a.delegateYield(e.coordinates,"t1",9);case 9:return a.abrupt("break",58);case 10:t=Object(s.a)(e.coordinates),a.prev=11,t.s();case 13:if((r=t.n()).done){a.next=18;break}return n=r.value,a.delegateYield(n,"t2",16);case 16:a.next=13;break;case 18:a.next=23;break;case 20:a.prev=20,a.t3=a.catch(11),t.e(a.t3);case 23:return a.prev=23,t.f(),a.finish(23);case 26:return a.abrupt("break",58);case 27:i=Object(s.a)(e.coordinates),a.prev=28,i.s();case 30:if((o=i.n()).done){a.next=50;break}u=o.value,c=Object(s.a)(u),a.prev=33,c.s();case 35:if((l=c.n()).done){a.next=40;break}return f=l.value,a.delegateYield(f,"t4",38);case 38:a.next=35;break;case 40:a.next=45;break;case 42:a.prev=42,a.t5=a.catch(33),c.e(a.t5);case 45:return a.prev=45,c.f(),a.finish(45);case 48:a.next=30;break;case 50:a.next=55;break;case 52:a.prev=52,a.t6=a.catch(28),i.e(a.t6);case 55:return a.prev=55,i.f(),a.finish(55);case 58:case"end":return a.stop()}}),h,null,[[11,20,23,26],[28,52,55,58],[33,42,45,48]])}function y(e){for(;;){var t=e.next(),r=t.value;if(t.done)return!1;if(r.length>2)return!0}}function b(e){for(var t=0,r=0;r<e.length;r++){var n=e[r],i=e[(r+1)%e.length];t+=n[0]*i[1]-i[0]*n[1]}return t<=0}function g(e){var t=e[0],r=e[e.length-1];return t[0]===r[0]&&t[1]===r[1]&&t[2]===r[2]||e.push(t),e}function _(e,t,r){switch(t.type){case"LineString":return function(e,t,r){return k(e,t.coordinates,r),e}(e,t,r);case"MultiLineString":return function(e,t,r){var n,i=Object(s.a)(t.coordinates);try{for(i.s();!(n=i.n()).done;){k(e,n.value,r)}}catch(a){i.e(a)}finally{i.f()}return e}(e,t,r);case"MultiPoint":return function(e,t,r){return k(e,t.coordinates,r),e}(e,t,r);case"MultiPolygon":return function(e,t,r){var n,i=Object(s.a)(t.coordinates);try{for(i.s();!(n=i.n()).done;){var a=n.value;m(e,a[0],r);for(var o=1;o<a.length;o++)O(e,a[o],r)}}catch(u){i.e(u)}finally{i.f()}return e}(e,t,r);case"Point":return function(e,t,r){return x(e,t.coordinates,r),e}(e,t,r);case"Polygon":return function(e,t,r){var n=t.coordinates;m(e,n[0],r);for(var i=1;i<n.length;i++)O(e,n[i],r);return e}(e,t,r)}}function m(e,t,r){var n=g(t);b(n)?k(e,n,r):j(e,n,r)}function O(e,t,r){var n=g(t);b(n)?j(e,n,r):k(e,n,r)}function k(e,t,r){var n,i=Object(s.a)(t);try{for(i.s();!(n=i.n()).done;){x(e,n.value,r)}}catch(a){i.e(a)}finally{i.f()}e.lengths.push(t.length)}function j(e,t,r){for(var n=t.length-1;n>=0;n--)x(e,t[n],r);e.lengths.push(t.length)}function x(e,t,r){var i=Object(n.a)(t,3),a=i[0],s=i[1],o=i[2];e.coords.push(a,s),r.hasZ&&e.coords.push(o||0)}function w(e){switch(typeof e){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function I(e){if(!e)throw new o.a("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==e.type&&"FeatureCollection"!==e.type)throw new o.a("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:e});var t=e.crs;if(t){var r="string"==typeof t?t:"name"===t.type?t.properties.name:null,n=new RegExp(".*(CRS84H?|4326)$","i");if(!r||!n.test(r))throw new o.a("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:t})}}function S(e){for(var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=v(e),i=[],a=new Set,o=new Set,u=!1,c=Number.NEGATIVE_INFINITY,l=null,h=!1,b=r.geometryType,g=void 0===b?null:b,_=!1,m=function(){var e=n.next(),r=e.value;if(e.done){var v=l&&1===l.length&&l[0]||null;if(v){var b,m=Object(s.a)(i);try{for(m.s();!(b=m.n()).done;){var O=b.value;O.name===v&&(O.type="esriFieldTypeOID")}}catch(C){m.e(C)}finally{m.f()}}return{v:{fields:i,geometryType:g,hasZ:u,maxObjectId:Math.max(0,c),objectIdFieldName:v,objectIdFieldType:t,unknownFields:f(o)}}}var k=r.geometry,j=r.properties,x=r.id;if((!k||(g||(g=d[k.type]),d[k.type]===g))&&(u||(u=y(p(k))),h||(h=null!=x)&&("number"===(t=typeof x)&&(l=Object.keys(j).filter((function(e){return j[e]===x})))),h&&"number"===t&&null!=x&&(c=Math.max(c,x),l.length>1?l=l.filter((function(e){return j[e]===x})):1===l.length&&(l=j[l[0]]===x?l:[])),!_&&j)){var I=!0;for(var S in j)if(!a.has(S)){var F=j[S];if(null!=F){var T=w(F);"unknown"!==T?(o.delete(S),a.add(S),i.push({name:S,alias:S,type:T})):o.add(S)}else I=!1,o.add(S)}_=I}};;){var O=m();if("object"===typeof O)return O.v}}function F(e,t){return function(e){for(var t=[];;){var r=e.next(),n=r.value;if(r.done)return t;t.push(n)}}(a.a.mark((function e(t){var r,n,i,s,o,l,h,f,v,p,y=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=y.length>1&&void 0!==y[1]?y[1]:{},n=r.geometryType,i=r.objectIdFieldName;case 2:if(s=t.next(),o=s.value,!s.done){e.next=5;break}return e.abrupt("return");case 5:if(l=o.geometry,h=o.properties,f=o.id,!l||d[l.type]===n){e.next=8;break}return e.abrupt("continue",13);case 8:return v=h||{},i&&null!=f&&!v[i]&&(v[i]=f),p=new u.a(l?_(new c.a,l,r):null,v),e.next=13,p;case 13:e.next=2;break;case 15:case"end":return e.stop()}}),e)}))(v(e),t))}},1126:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var n=r(14),i=r(20),a=r(980),s=r(1002),o=n.a.getLogger("esri.views.2d.engine.webgl");function u(e){return Object(s.g)(e.minDataValue)&&Object(s.g)(e.maxDataValue)&&null!=e.minSize&&null!=e.maxSize?a.c.SIZE_MINMAX_VALUE:(e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops)?a.c.SIZE_SCALE_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels)?a.c.SIZE_FIELD_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit?a.c.SIZE_UNIT_VALUE:(o.error(new i.a("mapview-bad-type","Found invalid size VisualVariable",e)),a.c.NONE)}},1127:function(e,t,r){"use strict";r.d(t,"a",(function(){return y})),r.d(t,"b",(function(){return p}));var n=r(13),i=r(2),a=r(3),s=r(5),o=r(6),u=r(4),c=r(86),l=r(165),h=r(1007),f=r(1152);function d(e){return(4294901760&e)>>>16}function v(e){return 65535&e}var p={getObjectId:function(e){return e.getObjectId()},getAttributes:function(e){return e.readAttributes()},getAttribute:function(e,t){return e.readAttribute(t)},cloneWithGeometry:function(e,t){return e},getGeometry:function(e){return e.readHydratedGeometry()},getCentroid:function(e,t){return e.readCentroid()}},y=function(e){Object(s.a)(r,e);var t=Object(o.a)(r);function r(e,n){var a;return Object(i.a)(this,r),(a=t.call(this,e,n)).featureAdapter=p,a.events=new c.a,a._featureSetsByInstance=new Map,a._objectIdToDisplayId=new Map,a._spatialIndexInvalid=!0,a._index=Object(h.a)(9,(function(e){return{minX:a._storage.getXMin(e),minY:a._storage.getYMin(e),maxX:a._storage.getXMax(e),maxY:a._storage.getYMax(e)}})),a}return Object(a.a)(r,[{key:"storeStatistics",get:function(){return{featureCount:0,vertexCount:0}}},{key:"onTileData",value:function(e,t,r){if(Object(u.g)(t.addOrUpdate))return t;this._featureSetsByInstance.set(t.addOrUpdate.instance,t.addOrUpdate),this._storage=r,t.addOrUpdate._storage=r;for(var n=t.addOrUpdate.getCursor();n.next();){var i=n.getObjectId(),a=n.instance<<16|n.getIndex(),s=this._objectIdToDisplayId.get(i);s||(s=r.createDisplayId(),this._objectIdToDisplayId.set(i,s),this._spatialIndexInvalid=!0),n.setDisplayId(s),r.setInstanceId(s,a),this.setComputedAttributes(r,n,s,e.scale)}return"update"===t.type&&(this._spatialIndexInvalid=!0),this.events.emit("changed"),t}},{key:"forEach",value:function(e){var t=this;this._objectIdToDisplayId.forEach((function(r){var n=t._storage.getInstanceId(r),i=t._lookupFeature(n);e(i)}))}},{key:"forEachUnsafe",value:function(e){var t=this;this._objectIdToDisplayId.forEach((function(r){var n=t._storage.getInstanceId(r),i=d(n),a=v(n),s=t._getFeatureSet(i);s.setIndex(a),e(s)}))}},{key:"forEachInBounds",value:function(e,t){var r,i=this._searchIndex(e),a=Object(n.a)(i);try{for(a.s();!(r=a.n()).done;){var s=r.value,o=this.lookupFeatureByDisplayId(s,this._storage);t(Object(u.n)(o))}}catch(c){a.e(c)}finally{a.f()}}},{key:"forEachBounds",value:function(e,t,r){this._rebuildIndex();var i,a=[0,0,0,0],s=Object(n.a)(e);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(o.readGeometry()){var u=o.getDisplayId();a[0]=this._storage.getXMin(u),a[1]=this._storage.getYMin(u),a[2]=this._storage.getXMax(u),a[3]=this._storage.getYMax(u),t(Object(l.k)(r,a))}}}catch(c){s.e(c)}finally{s.f()}}},{key:"sweepFeatures",value:function(e,t,r){var n=this;this._objectIdToDisplayId.forEach((function(i,a){e.has(i)||(t.releaseDisplayId(i),r.unsetAttributeData(i),n._objectIdToDisplayId.delete(a))})),this.events.emit("changed")}},{key:"sweepFeatureSets",value:function(e){var t=this;this._featureSetsByInstance.forEach((function(r,n){e.has(n)||t._featureSetsByInstance.delete(n)}))}},{key:"lookupObjectId",value:function(e,t){var r=this.lookupFeatureByDisplayId(e,t);return Object(u.g)(r)?null:r.getObjectId()}},{key:"lookupDisplayId",value:function(e){return this._objectIdToDisplayId.get(e)}},{key:"lookupFeatureByDisplayId",value:function(e,t){var r=t.getInstanceId(e);return this._lookupFeature(r)}},{key:"lookupByDisplayIdUnsafe",value:function(e){var t=this._storage.getInstanceId(e),r=d(t),n=v(t),i=this._getFeatureSet(r);return i?(i.setIndex(n),i):null}},{key:"hasInstance",value:function(e){return this._featureSetsByInstance.has(e)}},{key:"_rebuildIndex",value:function(){var e=this;if(this._spatialIndexInvalid){this._index.clear();var t=[];this._objectIdToDisplayId.forEach((function(r){var n=e._storage.getInstanceId(r);e._storage.setBounds(r,e._lookupFeature(n))&&t.push(r)})),this._index.load(t),this._spatialIndexInvalid=!1}}},{key:"_lookupFeature",value:function(e){var t=d(e),r=v(e),n=this._getFeatureSet(t);if(!n)return null;var i=n.getCursor();return i.setIndex(r),i}},{key:"_getFeatureSet",value:function(e){return this._featureSetsByInstance.get(e)}},{key:"_searchIndex",value:function(e){this._rebuildIndex();var t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}}]),r}(f.a)},1149:function(e,t,r){"use strict";r.d(t,"a",(function(){return F})),r.d(t,"b",(function(){return x}));var n=r(7),i=r.n(n),a=r(16),s=r(13),o=r(2),u=r(3),c=r(15),l=r(4),h=r(14),f=r(20),d=r(17),v=r(44),p=r(426),y=r(423),b=r(558),g=r(1002);r(10),r(36),r(980),r(983),r(1126);var _,m=h.a.getLogger("esri.views.layers.2d.features.support.AttributeStore"),O=(_=m,!1&&function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return _.warn.apply(_,["DEBUG:"].concat(t))}||function(){return null}),k=function(e){return(2147483648&e)>>>31},j=function(e){return 2147483647&e};function x(e){return 1===k(e)}var w={sharedArrayBuffer:Object(c.a)("esri-shared-array-buffer"),atomics:Object(c.a)("esri-atomics")};function I(e,t){return function(r){return t(e(r))}}var S=function(){function e(t,r,n,i){Object(o.a)(this,e),this.size=0,this.texelSize=4;var a=i.pixelType,s=i.layout,u=i.textureOnly;this.textureOnly=u||!1,this.pixelType=a,this._ctype=r,this.layout=s,this._resetRange(),this._shared=t,this.size=n,u||(this.data=this._initData(a,n,t,r))}return Object(u.a)(e,[{key:"buffer",get:function(){return Object(l.a)(this.data,(function(e){return e.buffer}))}},{key:"unsetComponentAllTexels",value:function(e,t){for(var r=Object(l.n)(this.data),n=0;n<this.size*this.size;n++)r[n*this.texelSize+e]&=~t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}},{key:"setComponentAllTexels",value:function(e,t){for(var r=Object(l.n)(this.data),n=0;n<this.size*this.size;n++)r[n*this.texelSize+e]|=255&t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}},{key:"setComponent",value:function(e,t,r){var n,i=Object(l.n)(this.data),a=Object(s.a)(r);try{for(a.s();!(n=a.n()).done;){var o=n.value;i[o*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,o),this.dirtyEnd=Math.max(this.dirtyEnd,o)}}catch(u){a.e(u)}finally{a.f()}}},{key:"setComponentTexel",value:function(e,t,r){Object(l.n)(this.data)[r*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}},{key:"unsetComponentTexel",value:function(e,t,r){Object(l.n)(this.data)[r*this.texelSize+e]&=~t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}},{key:"getData",value:function(e,t){var r=j(e);return Object(l.n)(this.data)[r*this.texelSize+t]}},{key:"setData",value:function(e,t,r){var n=j(e),i=1<<t;0!=(this.layout&i)?(this.data[n*this.texelSize+t]=r,this.dirtyStart=Math.min(this.dirtyStart,n),this.dirtyEnd=Math.max(this.dirtyEnd,n)):m.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}},{key:"lock",value:function(){5121===this.pixelType&&this._shared&&w.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}},{key:"unlock",value:function(){5121===this.pixelType&&this._shared&&w.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}},{key:"expand",value:function(e){if(this.size=e,!this.textureOnly){var t=this._initData(this.pixelType,e,this._shared,this._ctype),r=Object(l.n)(this.data);t.set(r),this.data=t}}},{key:"toMessage",value:function(){var e=this.dirtyStart,t=this.dirtyEnd,r=this.texelSize;if(e>t)return null;this._resetRange();var n=!(this._shared||"local"===this._ctype),i=this.pixelType,a=this.layout,s=Object(l.n)(this.data);return s.slice?{start:e,end:t,data:n&&s.slice(e*r,(t+1)*r)||null,pixelType:i,layout:a}:n?{start:e,end:t,data:new(Object(g.d)(this.pixelType))(Array.prototype.slice.call(this.data,e*r,(t+1)*r)),pixelType:i,layout:a}:{start:e,end:t,data:null,pixelType:i,layout:a}}},{key:"_initData",value:function(e,t,r,n){for(var i=r&&"local"!==n?SharedArrayBuffer:ArrayBuffer,a=Object(g.d)(e),s=new a(new i(t*t*4*a.BYTES_PER_ELEMENT)),o=0;o<s.length;o+=4)s[o+1]=255;return s}},{key:"_resetRange",value:function(){this.dirtyStart=2147483647,this.dirtyEnd=0}}]),e}(),F=function(){function e(t,r){Object(o.a)(this,e),this._client=t,this.config=r,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(b.j),this._targetType=0,this._abortController=Object(d.d)(),this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;var n=r.supportsTextureFloat?5126:5121;O("Creating AttributeStore ".concat(w.sharedArrayBuffer?"with":"without"," shared memory")),this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:n,layout:15},{pixelType:n,layout:15}],this._blocks=this._blockDescriptors.map((function(){return null}))}return Object(u.a)(e,[{key:"destroy",value:function(){this._abortController.abort()}},{key:"hasScaleExpr",get:function(){return this._hasScaleExpr}},{key:"_signal",get:function(){return this._abortController.signal}},{key:"update",value:function(e,t){this.config=t;var r=t.schema.processors[0].storage,n=Object(p.a)(this._schema,r);if((e.targets.feature||e.targets.aggregate)&&(e.storage.data=!0),n&&(Object(c.a)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",n),e.storage.data=!0,this._schema=r,this._attributeComputeMap.clear(),!Object(l.g)(r))){switch(r.target){case"feature":this._targetType=0;break;case"aggregate":this._targetType=1}var i,a=Object(s.a)(r.mapping);try{for(a.s();!(i=a.n()).done;){var o=i.value;this._bindAttribute(o)}}catch(u){a.e(u)}finally{a.f()}}}},{key:"onTileData",value:function(e,t){if(!Object(l.g)(t.addOrUpdate))for(var r=t.addOrUpdate.getCursor();r.next();){var n=r.getDisplayId();this.setAttributeData(n,r)}}},{key:"invalidateResources",value:function(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=Object(d.d)()}},{key:"setHighlight",value:function(){var e=Object(a.a)(i.a.mark((function e(t,r){var n,a,o,u,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=this._getBlock(0),a=r.map((function(e){return j(e)})),n.lock(),n.unsetComponentAllTexels(0,1),n.setComponent(0,1,a),n.unlock(),this._idsToHighlight.clear(),o=Object(s.a)(t);try{for(o.s();!(u=o.n()).done;)c=u.value,this._idsToHighlight.add(c)}catch(i){o.e(i)}finally{o.f()}return e.next=6,this.sendUpdates();case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"updateFilters",value:function(){var e=Object(a.a)(i.a.mark((function e(t,r){var n,a,s,o,u,l=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.config,a=r.service,s=r.spatialReference,o=n.filters,u=o.map((function(e,t){return l._updateFilter(e,t,a,s)})),e.next=3,Object(d.b)(u);case 3:if(e.t0=e.sent.some((function(e){return e})),!e.t0){e.next=6;break}t.storage.filters=!0,Object(c.a)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed");case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"setData",value:function(e,t,r,n){var i=j(e);this._ensureSizeForTexel(i),this._getBlock(t).setData(e,r,n)}},{key:"getData",value:function(e,t,r){return this._getBlock(t).getData(e,r)}},{key:"getHighlightFlag",value:function(e){return this._idsToHighlight.has(e)?b.h:0}},{key:"unsetAttributeData",value:function(e){var t=j(e);this._getBlock(0).setData(t,0,0)}},{key:"setAttributeData",value:function(e,t){var r=this,n=j(e);if(this._ensureSizeForTexel(n),this._getBlock(0).setData(n,0,this.getFilterFlags(t)),this._targetType===k(e)){var i=this._attributeComputeMap,a=this.config.supportsTextureFloat?1:2;i.size&&i.forEach((function(e,i){var s=i*a%4,o=Math.floor(i*a/4),u=r._getBlock(o+b.b),c=e(t);if(r.config.supportsTextureFloat)u.setData(n,s,c);else if(c===b.k)u.setData(n,s,255),u.setData(n,s+1,255);else{var l=Object(v.d)(Math.round(c),-32767,32766)+32768,h=255&l,f=(65280&l)>>8;u.setData(n,s,h),u.setData(n,s+1,f)}}))}}},{key:"sendUpdates",value:function(){var e=this;if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=Object(d.g)(),this._nextUpdate.promise;var t={blocks:this._blocks.map((function(e){return Object(l.h)(e)?e.toMessage():null}))};return this._currUpdate=this._createResources().then((function(){var r=function(){if(e._currUpdate=null,e._nextUpdate){var t=e._nextUpdate;e._nextUpdate=null,e.sendUpdates().then((function(){return t.resolve()}))}},n=e._client.update(t,e._signal).then(r).catch(r);return e._client.render(e._signal),n})).catch((function(t){return Object(d.l)(t)?(e._createResourcesPromise=null,e._createResources()):(m.error(new f.a("mapview-attribute-store","Encountered an error during client update",t)),Object(d.s)())})),this._currUpdate}},{key:"_ensureSizeForTexel",value:function(e){for(;e>=this._size*this._size;)if(this._expand())return}},{key:"_bindAttribute",value:function(e){var t;if(null!=e.fieldIndex)e.normalizationField&&m.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),t=function(t){return t.getComputedNumericAtIndex(e.fieldIndex)};else{if(!e.field)return;t=e.normalizationField?function(t){var r=t.readAttribute(e.normalizationField);return r?t.readAttribute(e.field)/r:null}:function(t){return t.readAttribute(e.field)}}e.valueRepresentation&&(t=I(t,(function(t){return function(e,t){if(!e||!t)return e;switch(t){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e}(t,e.valueRepresentation)}))),this._attributeComputeMap.set(e.binding,I(t,(function(e){return null===e||isNaN(e)||e===1/0?b.k:e})))}},{key:"_createResources",value:function(){var e=this;if(Object(l.h)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(b.a),O("Initializing AttributeStore");var t={shared:w.sharedArrayBuffer&&!("local"===this._client.type),size:this._size,blocks:Object(l.j)(this._blocks,(function(e){return{textureOnly:e.textureOnly,buffer:e.buffer,pixelType:e.pixelType}}))},r=this._client.initialize(t,this._signal).catch((function(t){Object(d.l)(t)?e._createResourcesPromise=null:m.error(new f.a("mapview-attribute-store","Encountered an error during client initialization",t))}));return this._createResourcesPromise=r,r.then((function(){return Object(l.g)(e._createResourcesPromise)?e._createResources():void 0})),r}},{key:"_getBlock",value:function(e){var t=this._blocks[e];if(Object(l.h)(t))return t;O("Initializing AttributeBlock at index ".concat(e));var r=w.sharedArrayBuffer,n=this._client.type,i=new S(r,n,this._size,this._blockDescriptors[e]);return this._blocks[e]=i,this._createResourcesPromise=null,i}},{key:"_expand",value:function(){if(this._size<this.config.maxTextureSize){var e=this._size<<=1;return O("Expanding block size to",e,this._blocks),Object(l.e)(this._blocks,(function(t){return t.expand(e)})),this._createResourcesPromise=null,this._size=e,0}return m.error(new f.a("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}},{key:"_updateFilter",value:function(){var e=Object(a.a)(i.a.mark((function e(t,r,n,a){var s,o,u,c,h;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this._filters[r],o=Object(l.h)(s)&&s.hash,s||t){e.next=3;break}return e.abrupt("return",!1);case 3:if(o!==JSON.stringify(t)){e.next=5;break}return e.abrupt("return",!1);case 5:if(!Object(l.g)(t)){e.next=8;break}return u=1<<r+1,c=this._getBlock(0),e.abrupt("return",(this._filters[r]=null,c.setComponentAllTexels(0,u),this.sendUpdates(),!0));case 8:return e.next=10,this._getFilter(r,n);case 10:return h=e.sent,e.next=13,h.update(t,a);case 13:return e.abrupt("return",!0);case 14:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_getFilter",value:function(){var e=Object(a.a)(i.a.mark((function e(t,n){var a,s,o,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this._filters[t],!Object(l.h)(a)){e.next=3;break}return e.abrupt("return",a);case 3:return e.next=5,r.e(116).then(r.bind(null,1243));case 5:return s=e.sent,o=s.default,u=new o({geometryType:n.geometryType,hasM:!1,hasZ:!1,timeInfo:n.timeInfo,fieldsIndex:new y.a(n.fields)}),e.abrupt("return",(this._filters[t]=u,u));case 9:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"isVisible",value:function(e){return!!(2&this._getBlock(0).getData(e,0))}},{key:"getFilterFlags",value:function(e){for(var t,r=0,n=(t=e.getDisplayId(),1===k(t)?254:255),i=0;i<this._filters.length;i++){var a=!!(n&1<<i),s=this._filters[i];r|=(!a||Object(l.g)(s)||s.check(e)?1:0)<<i}var o=0;if(this._idsToHighlight.size){var u=e.getObjectId();o=this.getHighlightFlag(u)}return r<<1|o}}]),e}()},1152:function(e,t,r){"use strict";r.d(t,"a",(function(){return g}));var n=r(10),i=r(13),a=r(7),s=r.n(a),o=r(16),u=r(2),c=r(3),l=r(15),h=r(4),f=r(17),d=r(144),v=r(426),p=r(14);var y=function(e,t,r){e.referencesGeometry();var i=t.readArcadeFeature();try{return e.evaluate(Object(n.a)(Object(n.a)({},r),{},{$feature:i}))}catch(e){return p.a.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",e),null}},b=r.e(118).then(r.bind(null,1220)),g=function(){function e(t,r){Object(u.a)(this,e),this._canCacheExpressionValue=!1,this._sourceInfo=t,this._bitsets={computed:r.getBitset(r.createBitset())}}return Object(c.a)(e,[{key:"updateSchema",value:function(){var e=Object(o.a)(s.a.mark((function e(t,r){var n,i,a,o,u,c;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=Object(v.a)(this._schema,r),this._schema=r,r&&!Object(h.g)(n)&&Object(v.b)(n,"attributes")){e.next=3;break}return e.abrupt("return");case 3:Object(l.a)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",n),this._bitsets.computed.clear(),t.targets[r.name]=!0,i=r.attributes,a=[],o=[],e.t0=s.a.keys(i);case 6:if((e.t1=e.t0()).done){e.next=20;break}u=e.t1.value,c=i[u],e.t2=c.type,e.next="field"===e.t2?12:"expression"===e.t2?13:"label-expression"===e.t2?15:"statistic"===e.t2?17:18;break;case 12:return e.abrupt("break",18);case 13:return a.push(this._createArcadeComputedField(c)),e.abrupt("break",18);case 15:return a.push(this._createLabelArcadeComputedField(c)),e.abrupt("break",18);case 17:o.push(c);case 18:e.next=6;break;case 20:return e.next=22,Object(f.b)(a);case 22:this._computedFields=e.sent,this._canCacheExpressionValue=!this._computedFields.some((function(e){return"expression"===e.type&&e.expression.referencesScale()})),this._statisticFields=o;case 25:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"setComputedAttributes",value:function(e,t,r,n){var a=this._bitsets.computed;if(!this._canCacheExpressionValue||!a.has(r)){a.set(r);var s,o=Object(i.a)(this._computedFields);try{for(o.s();!(s=o.n()).done;){var u=s.value,c=this._evaluateField(t,u,n);switch(u.resultType){case"numeric":e.setComputedNumericAtIndex(r,u.fieldIndex,c);break;case"string":e.setComputedStringAtIndex(r,u.fieldIndex,c)}}}catch(l){o.e(l)}finally{o.f()}}}},{key:"_createArcadeComputedField",value:function(){var e=Object(o.a)(s.a.mark((function e(t){var r,i;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._sourceInfo.spatialReference,i=this._sourceInfo.fieldsIndex,e.t0=n.a,e.t1=Object(n.a)({},t),e.t2={},e.next=6,Object(d.d)(t.valueExpression,r,i);case 6:return e.t3=e.sent,e.t4={expression:e.t3},e.abrupt("return",(0,e.t0)(e.t1,e.t2,e.t4));case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createLabelArcadeComputedField",value:function(){var e=Object(o.a)(s.a.mark((function e(t){var r,i,a,o,u;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._sourceInfo.spatialReference,i=this._sourceInfo.fields,e.next=4,b;case 4:return a=e.sent,o=a.createLabelFunction,e.next=8,o(t.label,i,r);case 8:return u=e.sent,e.abrupt("return",Object(n.a)(Object(n.a)({},t),{},{builder:u}));case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_evaluateField",value:function(e,t,r){switch(t.type){case"label-expression":var n=e.readArcadeFeature();return t.builder.evaluate(n)||"";case"expression":var i=t.expression;return y(i,e,{$view:{scale:r}})}}}]),e}()},1226:function(e,t,r){"use strict";r.r(t),r.d(t,"getInstances",(function(){return zr}));var n,i=r(7),a=r.n(i),s=r(16),o=r(2),u=r(3),c=r(5),l=r(6),h=r(0),f=r(15),d=r(14),v=r(18),p=r(1),y=r(8),b=(r(12),r(21),r(22),r(17)),g=r(105),_=r(143),m=r(27),O=r(56),k=r(74),j=r(99),x=r(67),w=r(4),I=r(62),S=r(97),F=r(34),T=r(35),C=r(44),A=r(289),E=n=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(){var e;Object(o.a)(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(e=t.call.apply(t,[this].concat(i))).position=new O.a([0,0,0]),e.heading=0,e.tilt=0,e.fov=55,e}return Object(u.a)(r,[{key:"normalizeCtorArgs",value:function(e,t,r,n){if(e&&"object"==typeof e&&("x"in e||Array.isArray(e))){var i={position:e};return null!=t&&(i.heading=t),null!=r&&(i.tilt=r),null!=n&&(i.fov=n),i}return e}},{key:"writePosition",value:function(e,t,r,n){var i=e.clone();i.x=Object(v.i)(e.x||0),i.y=Object(v.i)(e.y||0),i.z=e.hasZ?Object(v.i)(e.z||0):e.z,t[r]=i.write(null,n)}},{key:"readPosition",value:function(e,t){var r=new O.a;return r.read(e,t),r.x=Object(v.i)(r.x||0),r.y=Object(v.i)(r.y||0),r.z=r.hasZ?Object(v.i)(r.z||0):r.z,r}},{key:"equals",value:function(e){return!!e&&this.tilt===e.tilt&&this.heading===e.heading&&this.fov===e.fov&&this.position.equals(e.position)}},{key:"clone",value:function(){return new n({position:this.position.clone(),heading:this.heading,tilt:this.tilt,fov:this.fov})}}]),r}(m.a);Object(h.a)([Object(p.b)({type:O.a,json:{write:{isRequired:!0}}})],E.prototype,"position",void 0),Object(h.a)([Object(T.a)("position")],E.prototype,"writePosition",null),Object(h.a)([Object(F.a)("position")],E.prototype,"readPosition",null),Object(h.a)([Object(p.b)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),Object(I.a)((function(e){return A.c.normalize(Object(v.i)(e))}))],E.prototype,"heading",void 0),Object(h.a)([Object(p.b)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),Object(I.a)((function(e){return Object(C.d)(Object(v.i)(e),-180,180)}))],E.prototype,"tilt",void 0),Object(h.a)([Object(p.b)({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],E.prototype,"fov",void 0);var M,R=E=n=Object(h.a)([Object(y.a)("esri.Camera")],E),q=M=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){var n;return Object(o.a)(this,r),(n=t.call(this,e)).rotation=0,n.scale=0,n.targetGeometry=null,n.camera=null,n}return Object(u.a)(r,[{key:"castRotation",value:function(e){return(e%=360)<0&&(e+=360),e}},{key:"clone",value:function(){return new M({rotation:this.rotation,scale:this.scale,targetGeometry:Object(w.h)(this.targetGeometry)?this.targetGeometry.clone():null,camera:Object(w.h)(this.camera)?this.camera.clone():null})}}]),r}(m.a);function z(){return{enabled:!this.camera}}Object(h.a)([Object(p.b)({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:z}}}}})],q.prototype,"rotation",void 0),Object(h.a)([Object(I.a)("rotation")],q.prototype,"castRotation",null),Object(h.a)([Object(p.b)({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:z}}}}})],q.prototype,"scale",void 0),Object(h.a)([Object(p.b)({types:j.b,json:{read:S.a,write:!0,origins:{"web-scene":{read:S.a,write:{overridePolicy:z}}}}})],q.prototype,"targetGeometry",void 0),Object(h.a)([Object(p.b)({type:R,json:{write:!0}})],q.prototype,"camera",void 0);var L=q=M=Object(h.a)([Object(y.a)("esri.Viewpoint")],q),N=r(72),P=r(220),D=r(53),G=r(188),B=r(454),U=r(13),Q=r(54),V=r(48),Y=(r(157),r(73)),X=r(79),H=(r(39),r(70)),Z=180/Math.PI;function W(e,t,r,n){return n&&r&&!n.equals(r)&&Object(X.a)(n,r)&&n.isWebMercator?n.isWebMercator?function(e,t){var r=t[1];return r>89.99999?r=89.99999:r<-89.99999&&(r=-89.99999),r=Math.sin(Object(x.d)(r)),Object(D.r)(e,Object(x.d)(t[0])*Y.a.radius,.5*Y.a.radius*Math.log((1+r)/(1-r)))}(e,t):function(e,t,r){var n=Object(x.c)(t[0]/Y.a.radius);return Object(D.r)(e,n-360*Math.floor((n+180)/360),Object(x.c)(.5*Math.PI-2*Math.atan(Math.exp(-1*t[1]/Y.a.radius))))}(e,t):Object(D.c)(e,t)}function J(e){return e.wkid?e:e.spatialReference||V.a.WGS84}function $(e,t){return t.type?Object(D.r)(e,t.x,t.y):Object(D.c)(e,t)}function K(e){return Object(H.b)(e)}function ee(e,t){var r=e.targetGeometry,n=t.targetGeometry;return r.x=n.x,r.y=n.y,r.spatialReference=n.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}var te=function(){var e=Object(N.a)();return function(t,r,n){var i=r.targetGeometry;$(e,i);var a=.5*ie(r);return t.xmin=e[0]-a*n[0],t.ymin=e[1]-a*n[1],t.xmax=e[0]+a*n[0],t.ymax=e[1]+a*n[1],t.spatialReference=i.spatialReference,t}}();var re=function(){var e=Object(N.a)();return function(t,r,n){return Object(D.b)(t,function(e,t){return Object(D.a)(e,t,.5)}(t,r),function(e,t,r){return r?Object(D.r)(e,.5*(t[0]-r.right+r.left),.5*(t[1]-r.bottom+r.top)):Object(D.a)(e,t,.5)}(e,r,n))}}(),ne=function(){var e=Object(B.b)(),t=Object(N.a)();return function(r,n,i,a){var s=ie(n),o=ae(n);return Object(D.r)(t,s,s),Object(G.c)(e,t),Object(G.f)(e,e,o),Object(G.h)(e,e,re(t,i,a)),Object(G.h)(e,e,[0,a.top-a.bottom]),Object(D.r)(r,e[4],e[5])}}();function ie(e){return e.scale*(t=e.targetGeometry,Object(w.h)(t)&&Object(Q.i)(t.spatialReference)?1/(39.37*K(t.spatialReference)*96):1);var t}function ae(e){return Object(x.d)(e.rotation)||0}var se=function(){var e=Object(N.a)(),t=Object(N.a)(),r=Object(N.a)();return function(n,i,a,s,o,u){return Object(D.n)(e,i),Object(D.a)(t,a,.5*u),Object(D.r)(r,1/s*u,-1/s*u),Object(G.d)(n),Object(G.h)(n,n,t),o&&Object(G.f)(n,n,o),Object(G.g)(n,n,r),Object(G.h)(n,n,e),n}}(),oe=function(){var e=Object(N.a)();return function(t,r,n,i){var a=ie(r),s=ae(r);return $(e,r.targetGeometry),se(t,e,n,a,s,i)}}(),ue=function(){var e=Object(N.a)();return function(t,r,n,i){var a=ie(r);return $(e,r.targetGeometry),se(t,e,n,a,0,i)}}();function ce(e,t){return Math.round(function(e){if(e.isWrappable){var t=Object(Q.d)(e);return t.valid[1]-t.valid[0]}return 0}(e)/t)}(function(){var e=Object(N.a)(),t=Object(N.a)(),r=[0,0,0]})(),function(){var e=Object(N.a)()}(),function(){var e=Object(N.a)()}(),function(){var e=Object(N.a)()}();!function(){var e=Object(N.a)()}();var le=function(){var e=Object(N.a)();return function(t,r,n,i,a){return ee(t,r),isNaN(n)||0===n||(de(e,i,r,a),t.scale=r.scale*n,ve(e,e,t,a),pe(t,t,Object(D.r)(e,e[0]-i[0],i[1]-e[1]))),t}}();var he,fe=function(){var e=Object(N.a)();return function(t,r,n,i,a,s){return ee(t,r),isNaN(n)||0===n||(de(e,a,r,s),t.scale=r.scale*n,t.rotation+=i,ve(e,e,t,s),pe(t,t,Object(D.r)(e,e[0]-a[0],a[1]-e[1]))),t}}(),de=(function(){var e=Object(N.a)(),t=Object(N.a)()}(),function(){var e=Object(B.b)();return function(t,r,n,i){return Object(D.s)(t,r,function(e,t,r,n){return oe(e,t,r,1),Object(G.a)(e,e)}(e,n,i))}}()),ve=function(){var e=Object(B.b)();return function(t,r,n,i){return Object(D.s)(t,r,oe(e,n,i,1))}}(),pe=function(){var e=Object(N.a)(),t=Object(B.b)();return function(r,n,i){ee(r,n);var a=ie(n),s=r.targetGeometry;return Object(G.b)(t,ae(n)),Object(G.g)(t,t,Object(N.d)(a,a)),Object(D.s)(e,i,t),s.x+=e[0],s.y+=e[1],r}}(),ye=r(517),be=r(407),ge=r(1001);function _e(e){return(t=e)instanceof Float32Array&&t.length>=2||function(e){return Array.isArray(e)&&e.length>=2}(e);var t}var me=[0,0],Oe=he=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(){var e;Object(o.a)(this,r);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(e=t.call.apply(t,[this].concat(i)))._viewpoint2D={center:Object(N.a)(),rotation:0,scale:0,spatialReference:null},e.center=[0,0],e.extent=new k.a,e.id=0,e.inverseTransform=Object(B.b)(),e.resolution=0,e.rotation=0,e.scale=0,e.transform=Object(B.b)(),e.transformNoRotation=Object(B.b)(),e.displayMat3=Object(be.a)(),e.displayViewMat3=Object(be.a)(),e.viewMat3=Object(be.a)(),e.viewMat2d=Object(ye.a)(),e.worldScreenWidth=0,e.size=[0,0],e}return Object(u.a)(r,[{key:"pixelRatio",set:function(e){this._set("pixelRatio",e),this._update()}},{key:"size",set:function(e){this._set("size",e),this._update()}},{key:"viewpoint",set:function(e){if(e){var t=this._viewpoint2D,r=e.targetGeometry;t.center[0]=r.x,t.center[1]=r.y,t.rotation=e.rotation,t.scale=e.scale,t.spatialReference=r.spatialReference}this._update()}},{key:"copy",value:function(e){var t=this.size,r=this.viewpoint;return r&&t?(this.viewpoint=ee(r,e.viewpoint),this._set("size",Object(D.c)(t,e.size))):(this.viewpoint=e.viewpoint.clone(),this._set("size",[e.size[0],e.size[1]])),this._set("pixelRatio",e.pixelRatio),this}},{key:"clone",value:function(){return new he({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}},{key:"toMap",value:function(e,t,r){return _e(t)?Object(D.s)(e,t,this.inverseTransform):(me[0]=t,me[1]=r,Object(D.s)(e,me,this.inverseTransform))}},{key:"toScreen",value:function(e,t,r){return _e(t)?Object(D.s)(e,t,this.transform):(me[0]=t,me[1]=r,Object(D.s)(e,me,this.transform))}},{key:"toScreenNoRotation",value:function(e,t,r){return _e(t)?Object(D.s)(e,t,this.transformNoRotation):(me[0]=t,me[1]=r,Object(D.s)(e,me,this.transformNoRotation))}},{key:"getScreenTransform",value:function(e,t){var r=this._viewpoint2D.center,n=this._get("pixelRatio")||1,i=this._get("size");return se(e,r,i,t,0,n),e}},{key:"_update",value:function(){var e=this._viewpoint2D,t=e.center,r=e.spatialReference,n=e.scale,i=e.rotation,a=this._get("pixelRatio")||1,s=this._get("size"),o=new L({targetGeometry:new O.a(t[0],t[1],r),scale:n,rotation:i});if(this._set("viewpoint",o),s&&r&&n){this.resolution=ie(o),this.rotation=i,this.scale=n,this.spatialReference=r,Object(D.c)(this.center,t);var u=0!==s[0]?2/s[0]:0,c=0!==s[1]?-2/s[1]:0;Object(P.i)(this.displayMat3,u,0,0,0,c,0,-1,1,1);var l=Object(P.e)(this.viewMat3),h=Object(ge.b)(s[0]/2,s[1]/2),f=Object(ge.b)(-s[0]/2,-s[1]/2),d=Object(x.d)(i);Object(P.a)(l,l,h),Object(P.h)(l,l,d),Object(P.a)(l,l,f),Object(P.f)(this.displayViewMat3,this.displayMat3,l);var v=Object(G.d)(this.viewMat2d);return Object(G.h)(v,v,h),Object(G.f)(v,v,d),Object(G.h)(v,v,f),te(this.extent,o,s),oe(this.transform,o,s,a),Object(G.a)(this.inverseTransform,this.transform),ue(this.transformNoRotation,o,s,a),this.worldScreenWidth=ce(this.spatialReference,this.resolution),this._set("id",this.id+1),this}}}]),r}(m.a);Object(h.a)([Object(p.b)({readOnly:!0})],Oe.prototype,"id",void 0),Object(h.a)([Object(p.b)({value:1,json:{write:!0}})],Oe.prototype,"pixelRatio",null),Object(h.a)([Object(p.b)({json:{write:!0}})],Oe.prototype,"size",null),Object(h.a)([Object(p.b)({type:L,json:{write:!0}})],Oe.prototype,"viewpoint",null);var ke=Oe=he=Object(h.a)([Object(y.a)("esri.views.2d.ViewState")],Oe),je=r(32),xe=r(387);function we(e,t){return[e,t]}function Ie(e,t,r){return e[0]=t,e[1]=r,e}var Se=new xe.a("0/0/0/0"),Fe=function(){function e(t,r,n,i,a,s,u,c,l,h,f,d){Object(o.a)(this,e),this.level=t,this.resolution=r,this.scale=n,this.origin=i,this.first=a,this.last=s,this.size=u,this.norm=c,this.worldStart=l,this.worldEnd=h,this.worldSize=f,this.wrap=d}return Object(u.a)(e,[{key:"normalizeCol",value:function(e){if(!this.wrap)return e;var t=this.worldSize[0];return e<0?t-1-Math.abs((e+1)%t):e%t}},{key:"denormalizeCol",value:function(e,t){return this.wrap?this.worldSize[0]*t+e:e}},{key:"getWorldForColumn",value:function(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}},{key:"getFirstColumnForWorld",value:function(e){return e*this.worldSize[0]+this.first[0]}},{key:"getLastColumnForWorld",value:function(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}},{key:"getColumnForX",value:function(e){return(e-this.origin[0])/this.norm[0]}},{key:"getXForColumn",value:function(e){return this.origin[0]+e*this.norm[0]}},{key:"getRowForY",value:function(e){return(this.origin[1]-e)/this.norm[1]}},{key:"getYForRow",value:function(e){return this.origin[1]-e*this.norm[1]}},{key:"getTileBounds",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];Se.set(t);var n=r?Se.col:this.denormalizeCol(Se.col,Se.world),i=Se.row;return function(e,t,r,n,i){e[0]=t,e[1]=r,e[2]=n,e[3]=i}(e,this.getXForColumn(n),this.getYForRow(i+1),this.getXForColumn(n+1),this.getYForRow(i)),e}},{key:"getTileCoords",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];Se.set(t);var n=r?Se.col:this.denormalizeCol(Se.col,Se.world);return Array.isArray(e)?Ie(e,this.getXForColumn(n),this.getYForRow(Se.row)):(e.x=this.getXForColumn(n),e.y=this.getYForRow(Se.row)),e}}],[{key:"create",value:function(t,r,n){var i,a,s,o,u=Object(Q.d)(t.spatialReference),c=we(t.origin.x,t.origin.y),l=we(t.size[0]*r.resolution,t.size[1]*r.resolution),h=we(-1/0,-1/0),f=we(1/0,1/0),d=we(1/0,1/0);return n&&(Ie(h,Math.max(0,Math.floor((n.xmin-c[0])/l[0])),Math.max(0,Math.floor((c[1]-n.ymax)/l[1]))),Ie(f,Math.max(0,Math.floor((n.xmax-c[0])/l[0])),Math.max(0,Math.floor((c[1]-n.ymin)/l[1]))),Ie(d,f[0]-h[0]+1,f[1]-h[1]+1)),t.isWrappable?(i=we(Math.ceil(Math.round((u.valid[1]-u.valid[0])/r.resolution)/t.size[0]),d[1]),a=we(Math.floor((u.origin[0]-c[0])/l[0]),h[1]),s=we(i[0]+a[0]-1,f[1]),o=!0):(a=h,s=f,i=d,o=!1),new e(r.level,r.resolution,r.scale,c,h,f,d,l,a,s,i,o)}}]),e}(),Te=r(145),Ce=function(){function e(){Object(o.a)(this,e),this.spans=[]}return Object(u.a)(e,[{key:"acquire",value:function(e){this.lodInfo=e}},{key:"release",value:function(){this.lodInfo=null,this.spans.length=0}},{key:"forEach",value:function(e,t){var r=this.spans,n=this.lodInfo,i=n.level;if(0!==r.length){var a,s=Object(U.a)(r);try{for(s.s();!(a=s.n()).done;)for(var o=a.value,u=o.row,c=o.colFrom,l=o.colTo,h=c;h<=l;h++)e.call(t,i,u,n.normalizeCol(h),n.getWorldForColumn(h))}catch(f){s.e(f)}finally{s.f()}}}}]),e}();Ce.pool=new Te.a(Ce);var Ae=Ce,Ee=function e(t,r,n){Object(o.a)(this,e),this.row=t,this.colFrom=r,this.colTo=n},Me=new xe.a("0/0/0/0"),Re=function(){function e(t,r,n,i,a,s,u,c){Object(o.a)(this,e),this.x=t,this.ymin=r,this.ymax=n,this.invM=i,this.leftAdjust=a,this.rightAdjust=s,this.leftBound=u,this.rightBound=c}return Object(u.a)(e,[{key:"incrRow",value:function(){this.x+=this.invM}},{key:"getLeftCol",value:function(){return Math.max(this.x+this.leftAdjust,this.leftBound)}},{key:"getRightCol",value:function(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}],[{key:"create",value:function(t,r){var n;t[1]>r[1]&&(t=(n=[r,t])[0],r=n[1]);var i=t,a=Object(je.a)(i,2),s=a[0],o=a[1],u=r,c=Object(je.a)(u,2),l=c[0],h=c[1],f=l-s,d=h-o,v=0!==d?f/d:0,p=(Math.ceil(o)-o)*v,y=(Math.floor(o)-o)*v;return new e(s,Math.floor(o),Math.ceil(h),v,f<0?p:y,f<0?y:p,f<0?l:s,f<0?s:l)}}]),e}(),qe=[[0,0],[0,0],[0,0],[0,0]],ze=function(){function e(t,r){var n=this;Object(o.a)(this,e),this.tileInfo=t,this.fullExtent=r,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};var i=t.lods.slice();i.sort((function(e,t){return t.scale-e.scale}));var a=this._lodInfos=i.map((function(e){return Fe.create(t,e,r)}));i.forEach((function(e,t){n._infoByLevel[e.level]=a[t],n._infoByScale[e.scale]=a[t],n.scales[t]=e.scale}),this),this._wrap=t.isWrappable}return Object(u.a)(e,[{key:"spatialReference",get:function(){return this.tileInfo.spatialReference}},{key:"getLODInfoAt",value:function(e){return this._infoByLevel["number"==typeof e?e:e.level]}},{key:"getTileBounds",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];Me.set(t);var n=this._infoByLevel[Me.level];return n?n.getTileBounds(e,Me,r):e}},{key:"getTileCoords",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];Me.set(t);var n=this._infoByLevel[Me.level];return n?n.getTileCoords(e,Me,r):e}},{key:"getTileCoverage",value:function(e){var t,r,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:192,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"closest",s="closest"===a?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),o=Ae.pool.acquire(s),u=this._wrap,c=1/0,l=-1/0,h=o.spans;qe[0][0]=qe[0][1]=qe[1][1]=qe[3][0]=-i,qe[1][0]=qe[2][0]=e.size[0]+i,qe[2][1]=qe[3][1]=e.size[1]+i;var f,d=Object(U.a)(qe);try{for(d.s();!(f=d.n()).done;){var v=f.value;e.toMap(v,v),v[0]=s.getColumnForX(v[0]),v[1]=s.getRowForY(v[1])}}catch(I){d.e(I)}finally{d.f()}for(var p=[],y=3,b=0;b<4;b++)if(qe[b][1]!==qe[y][1]){var g=Re.create(qe[b],qe[y]);c=Math.min(g.ymin,c),l=Math.max(g.ymax,l),void 0===p[g.ymin]&&(p[g.ymin]=[]),p[g.ymin].push(g),y=b}else y=b;if(null==c||null==l||l-c>100)return null;var _=[];for(t=c;t<l;){null!=p[t]&&(_=_.concat(p[t])),r=1/0,n=-1/0;for(var m=_.length-1;m>=0;m--){var O=_[m];r=Math.min(r,O.getLeftCol()),n=Math.max(n,O.getRightCol())}if(r=Math.floor(r),n=Math.floor(n),t>=s.first[1]&&t<=s.last[1])if(u)if(s.size[0]<s.worldSize[0])for(var k=Math.floor(n/s.worldSize[0]),j=Math.floor(r/s.worldSize[0]);j<=k;j++)h.push(new Ee(t,Math.max(s.getFirstColumnForWorld(j),r),Math.min(s.getLastColumnForWorld(j),n)));else h.push(new Ee(t,r,n));else r>s.last[0]||n<s.first[0]||(r=Math.max(r,s.first[0]),n=Math.min(n,s.last[0]),h.push(new Ee(t,r,n)));t+=1;for(var x=_.length-1;x>=0;x--){var w=_[x];w.ymax>=t?w.incrRow():_.splice(x,1)}}return o}},{key:"getTileParentId",value:function(e){Me.set(e);var t=this._infoByLevel[Me.level],r=this._lodInfos.indexOf(t)-1;return r<0?null:(this._getTileIdAtLOD(Me,this._lodInfos[r],Me),Me.id)}},{key:"getTileResolution",value:function(e){var t=this._infoByLevel["object"==typeof e?e.level:e];return t?t.resolution:-1}},{key:"getTileScale",value:function(e){var t=this._infoByLevel[e.level];return t?t.scale:-1}},{key:"intersects",value:function(e,t){Me.set(t);var r=this._infoByLevel[Me.level],n=e.lodInfo;if(n.resolution>r.resolution){this._getTileIdAtLOD(Me,n,Me);var i,a=n.denormalizeCol(Me.col,Me.world),s=Object(U.a)(e.spans);try{for(s.s();!(i=s.n()).done;){var o=i.value;if(o.row===Me.row&&o.colFrom<=a&&o.colTo>=a)return!0}}catch(m){s.e(m)}finally{s.f()}}if(n.resolution<r.resolution){var u=e.spans.reduce((function(e,t){return e[0]=Math.min(e[0],t.row),e[1]=Math.max(e[1],t.row),e[2]=Math.min(e[2],t.colFrom),e[3]=Math.max(e[3],t.colTo),e}),[1/0,-1/0,1/0,-1/0]),c=Object(je.a)(u,4),l=c[0],h=c[1],f=c[2],d=c[3],v=r.denormalizeCol(Me.col,Me.world),p=n.getColumnForX(r.getXForColumn(v)),y=n.getRowForY(r.getYForRow(Me.row)),b=n.getColumnForX(r.getXForColumn(v+1))-1,g=n.getRowForY(r.getYForRow(Me.row+1))-1;return!(p>d||b<f||y>h||g<l)}var _=n.denormalizeCol(Me.col,Me.world);return e.spans.some((function(e){return e.row===Me.row&&e.colFrom<=_&&e.colTo>=_}))}},{key:"normalizeBounds",value:function(e,t,r){if(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],this._wrap){var n=Object(Q.d)(this.tileInfo.spatialReference),i=-r*(n.valid[1]-n.valid[0]);e[0]+=i,e[2]+=i}return e}},{key:"getSmallestInfoForScale",value:function(e){var t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(var r=1;r<t.length-1;r++)if(e>t[r]+1e-6)return this._infoByScale[t[r-1]];return this._infoByScale[t[t.length-1]]}},{key:"getClosestInfoForScale",value:function(e){var t=this.scales;return this._infoByScale[e]||(e=t.reduce((function(t,r){return Math.abs(r-e)<Math.abs(t-e)?r:t}),t[0])),this._infoByScale[e]}},{key:"scaleToLevel",value:function(e){var t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(var r=t.length-1;r>=0;r--)if(e<t[r])return r===t.length-1?this._infoByScale[t[t.length-1]].level:this._infoByScale[t[r]].level+(t[r]-e)/(t[r]-t[r+1]);return this._infoByScale[t[0]].level}},{key:"scaleToZoom",value:function(e){return this.tileInfo.scaleToZoom(e)}},{key:"_getTileIdAtLOD",value:function(e,t,r){var n=this._infoByLevel[r.level];return e.set(r),t.resolution<n.resolution?null:(t.resolution===n.resolution||(e.level=t.level,e.col=Math.floor(r.col*n.resolution/t.resolution+.01),e.row=Math.floor(r.row*n.resolution/t.resolution+.01)),e)}}]),e}(),Le=r(86),Ne=r(1007),Pe=r(211),De=r(115),Ge=r(608);var Be=function(){function e(t,r){Object(o.a)(this,e),this.key=new xe.a(0,0,0,0),this.bounds=Object(De.h)(),this.objectIds=new Set,this.key.set(r);var n=t.getLODInfoAt(this.key);this.tileInfoView=t,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=n.resolution,this.scale=n.scale,this.level=n.level,this.needsClear=!0}return Object(u.a)(e,[{key:"id",get:function(){return this.key.id}},{key:"extent",get:function(){return k.a.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}},{key:"transform",get:function(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}},{key:"bbox",get:function(){var e=this.bounds;return{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}}},{key:"clone",value:function(){return new e(this.tileInfoView,this.key)}},{key:"createChildTiles",value:function(){for(var t=this.key.getChildKeys(),r=Pe.a.acquire(),n=0;n<t.length;n++)r[n]=new e(this.tileInfoView,t[n]);return r}},{key:"getQuantizationParameters",value:function(){return Ge.a.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}]),e}(),Ue={added:[],removed:[]},Qe=new Set,Ve=new xe.a(0,0,0,0),Ye=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){var n;return Object(o.a)(this,r),(n=t.call(this))._tiles=new Map,n._index=Object(Ne.a)(9,Object(f.a)("csp-restrictions")?function(e){return{minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}}:[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),n.tiles=[],n.tileScheme=e,n}return Object(u.a)(r,[{key:"destroy",value:function(){this.clear()}},{key:"clear",value:function(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}},{key:"has",value:function(e){return this._tiles.has(e)}},{key:"get",value:function(e){return this._tiles.get(e)}},{key:"findByKey",value:function(e){return this._tiles.get(e.id)}},{key:"intersections",value:function(e,t){var r="string"==typeof e?this.get(e):e;if(!r)return[];var n,i=t*r.resolution,a=r.bounds[0]-i,s=r.bounds[1]-i,o=r.bounds[2]+i,u=r.bounds[3]+i,c=[],l=Object(U.a)(this._index.search({minX:a,minY:s,maxX:o,maxY:u}));try{for(l.s();!(n=l.n()).done;){var h=n.value,f=h.bounds.slice();f[0]=Math.max(f[0],a),f[1]=Math.max(f[1],s),f[2]=Math.min(f[2],o),f[3]=Math.min(f[3],u),f[2]-f[0]>0&&f[3]-f[1]>0&&c.push({bounds:f,tile:h})}}catch(d){l.e(d)}finally{l.f()}return c}},{key:"boundsIntersections",value:function(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}},{key:"updateTiles",value:function(e){var t,r=this,n={added:[],removed:[]},i=Object(U.a)(e.added);try{for(i.s();!(t=i.n()).done;){var a=t.value;if(!this.has(a)){var s=new Be(this.tileScheme,a);this._tiles.set(a,s),this._index.insert(s),n.added.push(s)}}}catch(h){i.e(h)}finally{i.f()}var o,u=Object(U.a)(e.removed);try{for(u.s();!(o=u.n()).done;){var c=o.value;if(this.has(c)){var l=this.get(c);this._tiles.delete(c),this._index.remove(l),n.removed.push(l)}}}catch(h){u.e(h)}finally{u.f()}this.tiles.length=0,this._tiles.forEach((function(e){return r.tiles.push(e)})),(n.added.length||n.removed.length)&&this.emit("update",n)}},{key:"setViewState",value:function(e){var t=this.tileScheme.getTileCoverage(e,0);if(t){var r=t.spans,n=t.lodInfo,i=n.level;if(r.length>0){var a,s=Object(U.a)(r);try{for(s.s();!(a=s.n()).done;)for(var o=a.value,u=o.row,c=o.colFrom,l=o.colTo,h=c;h<=l;h++){var f=Ve.set(i,u,n.normalizeCol(h),n.getWorldForColumn(h)).id;if(Qe.add(f),!this.has(f)){var d=new Be(this.tileScheme,f);this._tiles.set(f,d),this._index.insert(d),this.tiles.push(d),Ue.added.push(d)}}}catch(y){s.e(y)}finally{s.f()}}for(var v=this.tiles.length-1;v>=0;v--){var p=this.tiles[v];Qe.has(p.id)||(this._tiles.delete(p.id),this.tiles.splice(v,1),this._index.remove(p),Ue.removed.push(p))}(Ue.added.length||Ue.removed.length)&&this.emit("update",Ue),Ae.pool.release(t),Qe.clear(),Ue.added.length=0,Ue.removed.length=0}}}]),r}(Le.a);function Xe(e){return"heatmap"===e?r.e(56).then(r.bind(null,1242)):Promise.all([r.e(12),r.e(14),r.e(38)]).then(r.bind(null,1225))}var He=function(){function e(){Object(o.a)(this,e),this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}return Object(u.a)(e,[{key:"any",value:function(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}},{key:"describe",value:function(){var e=0,t="";if(this.mesh){e+=20,t+="-> (20) Mesh needs update\n";var r,n=Object(U.a)(this.why.mesh);try{for(n.s();!(r=n.n()).done;){var i=r.value;t+="    + ".concat(i,"\n")}}catch(c){n.e(c)}finally{n.f()}}if(this.source){e+=10,t+="-> (10) The source needs update\n";var a,s=Object(U.a)(this.why.source);try{for(s.s();!(a=s.n()).done;){var o=a.value;t+="    + ".concat(o,"\n")}}catch(c){s.e(c)}finally{s.f()}}this.targets.feature&&(e+=5,t+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(e+=5,t+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(e+=4,t+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(e+=1,t+="-> (1) Texture storage parameters changed");var u=e<5?"Fastest":e<10?"Fast":e<15?"Moderate":e<20?"Slow":"Very Slow";console.debug("Applying ".concat(u," update of cost ").concat(e,"/45 ")),console.debug(t)}},{key:"toJSON",value:function(){return{source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh,queryFilter:this.queryFilter}}}],[{key:"create",value:function(t){var r=new e;for(var n in t){var i=t[n];if("object"==typeof i)for(var a in i){var s=i[a];r[n][a]=s}r[n]=i}return r}},{key:"empty",value:function(){return e.create({})}},{key:"all",value:function(){return e.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}}]),e}(),Ze=r(10),We=r(29),Je=r(515),$e=r(423),Ke=r(61),et=r(57),tt=r(1031),rt=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e,n,i){var a;return Object(o.a)(this,r),(a=t.call(this,e))._featureIndex=-1,a._dateFields=new Set,a._geometryType=i,a._features=n,a}return Object(u.a)(r,[{key:"_current",get:function(){return this._features[this._featureIndex]}},{key:"geometryType",get:function(){return this._geometryType}},{key:"hasFeatures",get:function(){return!!this._features.length}},{key:"hasNext",get:function(){return this._featureIndex+1<this._features.length}},{key:"exceededTransferLimit",get:function(){return this._exceededTransferLimit}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"getApproximateSize",value:function(){return this._features.length}},{key:"getCursor",value:function(){return this.copy()}},{key:"getQuantizationTransform",value:function(){return this._transform}},{key:"getAttributeHash",value:function(){var e="";for(var t in this._current.attributes)e+=this._current.attributes[t];return e}},{key:"getIndex",value:function(){return this._featureIndex}},{key:"setIndex",value:function(e){this._featureIndex=e}},{key:"getObjectId",value:function(){return this._current.objectId}},{key:"getDisplayId",value:function(){return this._current.displayId}},{key:"setDisplayId",value:function(e){this._current.displayId=e}},{key:"getGroupId",value:function(){return this._current.groupId}},{key:"setGroupId",value:function(e){this._current.groupId=e}},{key:"copy",value:function(){var e=new r(this.instance,this._features,this.geometryType);return this.copyInto(e),e}},{key:"next",value:function(){if(!this._hasFilter)return++this._featureIndex<this._features.length;for(;++this._featureIndex<this._features.length&&!this._passesFilter(););return this._featureIndex<this._features.length}},{key:"readLegacyFeature",value:function(){return Object(Je.f)(this._current,this.geometryType,this.hasZ,this.hasM)}},{key:"readOptimizedFeature",value:function(){return this._current}},{key:"readLegacyPointGeometry",value:function(){var e=this.readGeometry();return e?{x:e.coords[0],y:e.coords[1]}:null}},{key:"readLegacyGeometry",value:function(){var e=this.readGeometry();return Object(Je.h)(e,this.geometryType,this.hasZ,this.hasM)}},{key:"readLegacyCentroid",value:function(){var e=this.readCentroid();return e?{x:e.coords[0],y:e.coords[1]}:null}},{key:"readGeometryArea",value:function(){return Object(Je.p)(this._current.geometry,2)}},{key:"readUnquantizedGeometry",value:function(){var e=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!e)return e;var t=e.clone();return function(e){var t,r=e.coords,n=e.lengths,i=0,a=Object(U.a)(n);try{for(a.s();!(t=a.n()).done;){for(var s=t.value,o=1;o<s;o++)r[2*(i+o)]+=r[2*(i+o)-2],r[2*(i+o)+1]+=r[2*(i+o)-1];i+=s}}catch(u){a.e(u)}finally{a.f()}}(t),t}},{key:"readHydratedGeometry",value:function(){var e=this._current.geometry;if(!e)return null;var t=e.clone();return Object(Je.v)(t,t,this.hasZ,this.hasM,this._transform),t}},{key:"getXHydrate",value:function(){var e=this._current.geometry.coords[0]+this._tx,t=this.getQuantizationTransform();return e*t.scale[0]+t.translate[0]}},{key:"getYHydrate",value:function(){var e=this._current.geometry.coords[1]+this._ty,t=this.getQuantizationTransform();return t.translate[1]-e*t.scale[1]}},{key:"readGeometry",value:function(){if(!this._current.hasGeometry)return null;var e=this._current.geometry.clone();if(e.isPoint)return e.coords[0]+=this._tx,e.coords[1]+=this._ty,e;var t,r=0,n=Object(U.a)(e.lengths);try{for(n.s();!(t=n.n()).done;){var i=t.value;e.coords[2*r]+=this._tx,e.coords[2*r+1]+=this._ty,r+=i}}catch(a){n.e(a)}finally{n.f()}return e}},{key:"readCentroid",value:function(){if(!this._current.hasGeometry)return null;if(!this._current.centroid){var e=this._computeCentroid();if(!e)return null;e.coords[0]-=this._tx,e.coords[1]-=this._ty,this._current.centroid=e}var t=this._current.centroid.clone();return t.coords[0]+=this._tx,t.coords[1]+=this._ty,t}},{key:"_readAttribute",value:function(e,t){var r=this._current.attributes[e];if(void 0!==r)return t&&this._dateFields.has(e)?new Date(r):r;var n=this.readAttributes(),i=e.toLocaleLowerCase().trim();for(var a in n)if(a.toLocaleLowerCase().trim()===i){var s=this._current.attributes[a];return this._dateFields.has(a)?new Date(s):s}}},{key:"copyInto",value:function(e){Object(Ke.a)(Object(et.a)(r.prototype),"copyInto",this).call(this,e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._dateFields=this._dateFields}},{key:"_readAttributes",value:function(){return this._current.attributes}},{key:"_passesFilter",value:function(){if(!this._hasFilter)return!0;var e=0,t=0;switch(this.geometryType){case"esriGeometryPoint":var r=this._current.geometry;if(!r)return!1;var n=Object(je.a)(r.coords,2);e=n[0],t=n[1];break;case"esriGeometryPolygon":var i,a,s=this.readCentroid();if(!s)return!1;i=s.coords,e=(a=Object(je.a)(i,2))[0],t=a[1],e-=this._tx,t-=this._ty;break;default:return!1}return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax}}],[{key:"fromFeatures",value:function(e,t,n){for(var i=Object(Je.c)([],e,t,!1,!1,n),a=0;a<i.length;a++)i[a].displayId=e[a].displayId;return r.fromOptimizedFeatures(i,t)}},{key:"fromFeatureSet",value:function(e,t){var n=Object(Je.b)(e,t);return r.fromOptimizedFeatureSet(n)}},{key:"fromOptimizedFeatureSet",value:function(e){var t=e.features,n=e.geometryType,i=r.fromOptimizedFeatures(t,n);i._exceededTransferLimit=e.exceededTransferLimit,i._transform=e.transform;var a,s=Object(U.a)(e.fields);try{for(s.s();!(a=s.n()).done;){var o=a.value;"esriFieldTypeDate"===o.type&&i._dateFields.add(o.name)}}catch(u){s.e(u)}finally{s.f()}return i}},{key:"fromOptimizedFeatures",value:function(e,t,n){var i=new r(tt.a.createInstance(),e,t);return i._transform=n,i}}]),r}(tt.a),nt=r(177),it=r(534),at=function e(t,r){Object(o.a)(this,e),this.item=t,this.controller=r,this.promise=null},st=function(){function e(t){var r=this;Object(o.a)(this,e),this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,t.concurrency&&(this.concurrency=t.concurrency),this._queue=new it.a(t.peeker),this.process=t.process;var n=t.scheduler;t.task&&Object(w.h)(n)&&(this._task=n.registerTask(t.task,(function(e){return r.update(e)}),(function(){return r.needsUpdate()})))}return Object(u.a)(e,[{key:"destroy",value:function(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}},{key:"length",get:function(){return this._processingItems.size+this._queue.length}},{key:"abort",value:function(e){var t=this._controllers.get(e);t&&t.abort()}},{key:"clear",value:function(){this._queue.clear();var e=[];this._controllers.forEach((function(t){return e.push(t)})),this._controllers.clear(),e.forEach((function(e){return e.abort()})),this._processingItems.clear(),this._cancelNext()}},{key:"forEach",value:function(e){this._deferreds.forEach((function(t,r){return e(r)}))}},{key:"get",value:function(e){var t=this._deferreds.get(e);return t?t.promise:void 0}},{key:"isOngoing",value:function(e){return this._processingItems.has(e)}},{key:"has",value:function(e){return this._deferreds.has(e)}},{key:"pause",value:function(){this._isPaused||(this._isPaused=!0,this._cancelNext())}},{key:"push",value:function(e,t){var r,n=this,i=this.get(e);if(i)return i;var a=Object(b.d)(),s=null;t&&(s=Object(b.p)(t,(function(){return a.abort()})));var o=function(){u.remove(),Object(w.h)(s)&&s.remove(),n._deferreds.delete(e),n._controllers.delete(e),n._queue.remove(e),n._processingItems.delete(e),n._scheduleNext()},u=Object(b.q)(a.signal,(function(){var t=n._processingItems.get(e);t&&t.controller.abort(),o(),r.reject(Object(b.e)())}));return r=Object(b.f)(),this._deferreds.set(e,r),this._controllers.set(e,a),r.promise.then(o,o),this._queue.push(e),this._scheduleNext(),r.promise}},{key:"reset",value:function(){var e=[];this._processingItems.forEach((function(t){return e.push(t)})),this._processingItems.clear();for(var t=0,r=e;t<r.length;t++){var n=r[t];this._queue.push(n.item),n.controller.abort()}this._scheduleNext()}},{key:"resume",value:function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}},{key:"takeAll",value:function(){for(var e=[];this._queue.length;)e.push(this._queue.pop());return this.clear(),e}},{key:"needsUpdate",value:function(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}},{key:"update",value:function(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}},{key:"_scheduleNext",value:function(){var e=this;this._task||this._isPaused||this._schedule||(this._schedule=Object(nt.b)((function(){e._schedule=null,e._next()})))}},{key:"_next",value:function(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}},{key:"_cancelNext",value:function(){this._schedule&&(this._schedule.remove(),this._schedule=null)}},{key:"_processResult",value:function(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}},{key:"_processError",value:function(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}},{key:"_canProcessFulfillment",value:function(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}},{key:"_process",value:function(e){var t=this;if(!Object(w.g)(e)){var r,n,i=Object(b.d)(),a=new at(e,i);this._processingItems.set(e,a);try{r=this.process(e,i.signal)}catch(e){this._processError(a,e)}(n=r)&&"function"==typeof n.then?(a.promise=r,r.then((function(e){return t._processResult(a,e)}),(function(e){return t._processError(a,e)}))):this._processResult(a,r)}}},{key:"test",get:function(){var e=this;return{update:function(t){return e.update(t)}}}}]),e}(),ot=r(1149);var ut=function(){function e(){Object(o.a)(this,e),this._freeIds=[],this._idCounter=1}return Object(u.a)(e,[{key:"createId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return function(e,t){return((t?2147483648:0)|e)>>>0}(this._getFreeId(),e)}},{key:"releaseId",value:function(e){this._freeIds.push(e)}},{key:"_getFreeId",value:function(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}]),e}(),ct=function(){function e(t,r){Object(o.a)(this,e),this._mask=0,this._buf=t,this._mask=r}return Object(u.a)(e,[{key:"_getIndex",value:function(e){return Math.floor(e/32)}},{key:"has",value:function(e){var t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}},{key:"set",value:function(e){var t=this._mask&e,r=this._getIndex(t),n=1<<t%32;this._buf[r]|=n}},{key:"unset",value:function(e){var t=this._mask&e,r=this._getIndex(t),n=1<<t%32;this._buf[r]&=4294967295^n}},{key:"resize",value:function(e){var t=this._buf,r=new Uint32Array(Math.ceil(e/32));r.set(t),this._buf=r}},{key:"or",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}},{key:"and",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}},{key:"xor",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}},{key:"ior",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}},{key:"iand",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}},{key:"ixor",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}},{key:"any",value:function(){for(var e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}},{key:"copy",value:function(e){for(var t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}},{key:"clone",value:function(){return new e(this._buf.slice(),this._mask)}},{key:"clear",value:function(){for(var e=0;e<this._buf.length;e++)this._buf[e]=0}},{key:"forEachSet",value:function(e){for(var t=0;t<this._buf.length;t++){var r=this._buf[t],n=32*t;if(r)for(;r;)1&r&&e(n),r>>>=1,n++}}},{key:"countSet",value:function(){var e=0;return this.forEachSet((function(t){e++})),e}}],[{key:"fromBuffer",value:function(t,r){return new e(t,r)}},{key:"create",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4294967295,n=new Uint32Array(Math.ceil(t/32));return new e(n,r)}}]),e}();function lt(e,t,r){if(!(e.length>t))for(;e.length<=t;)e.push(r)}var ht=function(){function e(){Object(o.a)(this,e),this._numerics=[],this._strings=[],this._idGenerator=new ut,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}return Object(u.a)(e,[{key:"createBitset",value:function(){var e=this._bitsets.length;return this._bitsets.push(ct.create(this._allocatedSize,2147483647)),e+1}},{key:"getBitset",value:function(e){return this._bitsets[e-1]}},{key:"_expand",value:function(){this._allocatedSize<<=1;var e,t=Object(U.a)(this._bitsets);try{for(t.s();!(e=t.n()).done;){e.value.resize(this._allocatedSize)}}catch(r){t.e(r)}finally{t.f()}}},{key:"_ensureNumeric",value:function(e,t){this._numerics[e]||(this._numerics[e]=[]),lt(this._numerics[e],t,0)}},{key:"_ensureInstanceId",value:function(e){lt(this._instanceIds,e,0)}},{key:"_ensureString",value:function(e,t){this._strings[e]||(this._strings[e]=[]),lt(this._strings[e],t,null)}},{key:"createDisplayId",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this._idGenerator.createId();return t>this._allocatedSize&&this._expand(),function(e,t){return((t?2147483648:0)|e)>>>0}(t,e)}},{key:"releaseDisplayId",value:function(e){var t,r=Object(U.a)(this._bitsets);try{for(r.s();!(t=r.n()).done;){t.value.unset(e)}}catch(n){r.e(n)}finally{r.f()}return this._idGenerator.releaseId(2147483647&e)}},{key:"getComputedNumeric",value:function(e,t){return this.getComputedNumericAtIndex(2147483647&e,0)}},{key:"setComputedNumeric",value:function(e,t,r){return this.setComputedNumericAtIndex(2147483647&e,r,0)}},{key:"getComputedString",value:function(e,t){return this.getComputedStringAtIndex(2147483647&e,0)}},{key:"setComputedString",value:function(e,t,r){return this.setComputedStringAtIndex(2147483647&e,0,r)}},{key:"getComputedNumericAtIndex",value:function(e,t){var r=2147483647&e;return this._ensureNumeric(t,r),this._numerics[t][r]}},{key:"setComputedNumericAtIndex",value:function(e,t,r){var n=2147483647&e;this._ensureNumeric(t,n),this._numerics[t][n]=r}},{key:"getInstanceId",value:function(e){var t=2147483647&e;return this._ensureInstanceId(t),this._instanceIds[t]}},{key:"setInstanceId",value:function(e,t){var r=2147483647&e;this._ensureInstanceId(r),this._instanceIds[r]=t}},{key:"getComputedStringAtIndex",value:function(e,t){var r=2147483647&e;return this._ensureString(t,r),this._strings[t][r]}},{key:"setComputedStringAtIndex",value:function(e,t,r){var n=2147483647&e;this._ensureString(t,n),this._strings[t][n]=r}},{key:"getXMin",value:function(e){return this._bounds[4*(2147483647&e)]}},{key:"getYMin",value:function(e){return this._bounds[4*(2147483647&e)+1]}},{key:"getXMax",value:function(e){return this._bounds[4*(2147483647&e)+2]}},{key:"getYMax",value:function(e){return this._bounds[4*(2147483647&e)+3]}},{key:"setBounds",value:function(e,t){var r=t.readHydratedGeometry();if(!r||!r.coords.length)return!1;var n=1/0,i=1/0,a=-1/0,s=-1/0;r.forEachVertex((function(e,t){n=Math.min(n,e),i=Math.min(i,t),a=Math.max(a,e),s=Math.max(s,t)}));var o=2147483647&e;return lt(this._bounds,4*o+4,0),this._bounds[4*o]=n,this._bounds[4*o+1]=i,this._bounds[4*o+2]=a,this._bounds[4*o+3]=s,!0}}]),e}(),ft=r(1127),dt=r(1055),vt=r(38),pt=r(194),yt=r(426),bt=r(152),gt=r(558),_t=r(178),mt=r(20),Ot=r(65),kt=r(430),jt=r(321),xt=(r(574),r(452)),wt=(r(287),r(991)),It=r(1092);r(1005),d.a.getLogger("esri.layers.graphics.sources.ogcfeature");function St(e,t,r){return Ft.apply(this,arguments)}function Ft(){return(Ft=Object(s.a)(a.a.mark((function e(t,r,n){var i,s,o,u,c,l,h,f,d,v,p,y,b,g,_,m,O,k,j,x,I,S,F,T,C,A,E,M,R,q,z,L,N,P;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.capabilities.query.maxRecordCount,o=t.collectionId,u=t.layerDefinition,c=t.url,l="".concat(c,"/collections/").concat(o,"/items"),h=r.geometry,f=r.num,d=r.start,v=r.timeExtent,p=r.where,y=Object(w.h)(r.outSpatialReference)?r.outSpatialReference:Q.a,b=function(e){if(Object(w.g)(e))return null;var t=e.xmin,r=e.ymin,n=e.xmax,i=e.ymax;return"".concat(t,",").concat(r,",").concat(n,",").concat(i)}(Object(wt.b)(h,Q.a)),g=function(e){if(Object(w.g)(e))return null;var t=e.start,r=e.end;return"".concat(t?t.toISOString():"..","/").concat(r?r.toISOString():"..")}(v),a=p,_=Object(w.g)(a)||!a||"1=1"===a?null:a,m=null!=f?f:null!=d&&void 0!==d?10:s,e.next=17,Object(Ot.default)(l,Object(Ze.a)(Object(Ze.a)({},n),{},{query:{bbox:b,datetime:g,query:_,limit:m,startindex:d,f:"json"}}));case 17:if(O=e.sent,k=O.data,j=null==(i=k.links)?void 0:i.filter((function(e){return"next"===e.rel})),x=0!==(null==j?void 0:j.length),I=u.fields,S=u.globalIdField,F=u.hasM,T=u.hasZ,C=u.objectIdField,A=u.geometryType,E=Object(It.a)(k,{geometryType:A,hasZ:T,objectIdFieldName:C}),!Object(Q.c)(y,Q.a)){M=Object(U.a)(E);try{for(M.s();!(R=M.n()).done;)(q=R.value).geometry&&(q.geometry=Object(Je.d)(Object(wt.b)(Object(Je.h)(q.geometry,A,T,!1),Q.a,y)))}catch(D){M.e(D)}finally{M.f()}}z=Object(U.a)(E);try{for(z.s();!(L=z.n()).done;)(N=L.value).objectId=N.attributes[C]}catch(D){z.e(D)}finally{z.f()}return P=new xt.a,e.abrupt("return",(P.exceededTransferLimit=x,P.features=E,P.fields=I,P.geometryType=A,P.globalIdFieldName=S,P.hasM=F,P.hasZ=T,P.objectIdFieldName=C,P.spatialReference=y||Q.a,P));case 33:case"end":return e.stop()}var a}),e)})))).apply(this,arguments)}var Tt=r(262),Ct=r(185),At=r(584),Et=r(610),Mt=function(){function e(){Object(o.a)(this,e),this.hasFeatures=!1,this.fieldIndexMap=new Map,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.dateFields=new Set,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}return Object(u.a)(e,[{key:"hasFieldIndex",value:function(e){return this.fieldIndexMap.has(e)}},{key:"isDateField",value:function(e){return this.dateFields.has(e)}},{key:"getFieldIndex",value:function(e){return this.fieldIndexMap.get(e)}}]),e}();function Rt(e){for(var t=e.getLength(),r=e.pos()+t,n={name:"",isDate:!1};e.pos()<r&&e.next();)switch(e.tag()){case 1:n.name=e.getString();break;case 2:"esriFieldTypeDate"===Object(Et.b)(e.getEnum())&&(n.isDate=!0);break;default:e.skip()}return n}var qt=d.a.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF");function zt(e){for(;e.next();)switch(e.tag()){case 1:return e.getMessage();default:e.skip()}return null}var Lt=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e,n,i,a){var s;return Object(o.a)(this,r),(s=t.call(this,e))._hasNext=!1,s._isPoints=!1,s._isPolygons=!1,s._featureIndex=-1,s._featureOffset=0,s._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},s._geometryType=a,s._reader=n,s._header=i,s._hasNext=i.hasFeatures,s._isPoints="esriGeometryPoint"===a,s._isPolygons="esriGeometryPolygon"===a,s}return Object(u.a)(r,[{key:"geometryType",get:function(){return this._geometryType}},{key:"size",get:function(){return this._header.featureCount}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"stride",get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}},{key:"hasFeatures",get:function(){return this._header.hasFeatures}},{key:"hasNext",get:function(){return this._hasNext}},{key:"exceededTransferLimit",get:function(){return this._header.exceededTransferLimit}},{key:"getApproximateSize",value:function(){if(this._hasFilter){var e=Math.abs(this._xmax-this._xmin)*Math.abs(this._ymax-this._ymin),t=this.size*e/262144;return Math.max(Math.round(t),0)}return this.size}},{key:"getQuantizationTransform",value:function(){return this._header.transform}},{key:"getCursor",value:function(){return this.copy()}},{key:"getIndex",value:function(){return this._featureIndex}},{key:"setIndex",value:function(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}},{key:"getAttributeHash",value:function(){var e=this,t="";return this._header.fieldIndexMap.forEach((function(r){t+=e._readAttributeAtIndex(r)+"."})),t}},{key:"getObjectId",value:function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}},{key:"getDisplayId",value:function(){return this._header.displayIds[this._featureIndex]}},{key:"setDisplayId",value:function(e){this._header.displayIds[this._featureIndex]=e}},{key:"getGroupId",value:function(){return this._header.groupIds[this._featureIndex]}},{key:"setGroupId",value:function(e){this._header.groupIds[this._featureIndex]=e}},{key:"readLegacyFeature",value:function(){if(void 0===this._cache.legacyFeature){var e,t=this.readCentroid(),r={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(e=t&&{x:t.coords[0],y:t.coords[1]})?e:null};return this._cache.legacyFeature=r,r}return this._cache.legacyFeature}},{key:"readOptimizedFeature",value:function(){if(void 0===this._cache.optFeature){var e=new Tt.a(this.readGeometry(),this.readAttributes(),this.readCentroid());return this._cache.optFeature=e,e}return this._cache.optFeature}},{key:"getXHydrate",value:function(){var e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return e*t.scale[0]+t.translate[0]}},{key:"getYHydrate",value:function(){var e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return t.translate[1]-e*t.scale[1]}},{key:"readLegacyPointGeometry",value:function(){return{x:this._header.centroid[2*this._featureIndex]+this._tx,y:this._header.centroid[2*this._featureIndex+1]+this._ty}}},{key:"readLegacyGeometry",value:function(){var e=this.readGeometry();return Object(Je.h)(e,this.geometryType,!1,!1)}},{key:"readLegacyCentroid",value:function(){var e=this.readCentroid();if(!e)return null;var t=Object(je.a)(e.coords,2);return{x:t[0],y:t[1]}}},{key:"readGeometryArea",value:function(){return this._cache.area||this.readGeometry(),this._cache.area}},{key:"readUnquantizedGeometry",value:function(){if(void 0===this._cache.unquantGeometry){var e=this.readGeometry();if(!e)return this._cache.unquantGeometry=null,null;for(var t=e.clone(),r=t.lengths,n=t.coords,i=0,a=2;i<r.length;i++,a+=2)for(var s=r[i],o=1;o<s;o+=1,a+=2)n[a]+=n[a-2],n[a+1]+=n[a-1];return this._cache.unquantGeometry=t,t}return this._cache.unquantGeometry}},{key:"readHydratedGeometry",value:function(){var e=this.readGeometry();if(!e)return null;var t=e.clone();return this._isPoints&&(t.coords[0]-=this._tx,t.coords[1]-=this._ty),Object(Je.v)(t,t,this.hasZ,this.hasM,this.getQuantizationTransform()),t}},{key:"readGeometry",value:function(){if(void 0===this._cache.geometry){var e=null;if(this._isPoints){var t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;e=new Ct.a([],[t,r])}else{var n=this._header.offsets.geometry[this._featureIndex],i=this._reader;if(0===n)return null;i.move(n);try{e=this._parseGeometry(i)}catch(Dt){return console.error("Failed to parse geometry!",Dt),null}}return this._cache.geometry=e,e}return this._cache.geometry}},{key:"readCentroid",value:function(){if(void 0===this._cache.centroid){var e=null,t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;return 268435455===t?(e=this._computeCentroid())&&(this._header.centroid[2*this._featureIndex]=e.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=e.coords[1]-this._ty):e=new Ct.a([],[t,r]),this._cache.centroid=e,e}return this._cache.centroid}},{key:"copy",value:function(){var e=this._reader.clone(),t=new r(this.instance,e,this._header,this.geometryType);return this.copyInto(t),t}},{key:"next",value:function(){if(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,!this._hasFilter)return++this._featureIndex<this.size;for(;++this._featureIndex<this.size&&!this._passesFilter(););return this._featureIndex<this.size}},{key:"_readAttribute",value:function(e,t){var r=this._header.hasFieldIndex(e)?e:function(e){return e.toLowerCase().trim()}(e),n=this._header.getFieldIndex(r);if(null!=n){var i=this._readAttributeAtIndex(n);return t&&this._header.isDateField(r)?new Date(i):i}}},{key:"_readAttributes",value:function(){var e=this,t={};return this._header.fieldIndexMap.forEach((function(r,n){t[n]=e._readAttributeAtIndex(r)})),t}},{key:"copyInto",value:function(e){Object(Ke.a)(Object(et.a)(r.prototype),"copyInto",this).call(this,e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext}},{key:"_passesFilter",value:function(){if(!this._hasFilter)return!0;var e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];if(268435455===e){if(this._isPolygons&&!this.readCentroid())return!1;e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1]}return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax}},{key:"_readAttributeAtIndex",value:function(e){var t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;return r.move(t),function(e){for(var t=e.getLength(),r=e.pos()+t;e.pos()<r&&e.next();)switch(e.tag()){case 1:var n=e.getString();return""===n?null:n;case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}(r)}},{key:"_preprocessPolygon",value:function(e,t){for(var r=0,n=0,i=0,a=!1,s=!1,o=!1,u=-1,c=[],l=0,h=!1,f=0;f<t.length;f++){for(var d=t[f],v=e[2*r],p=e[2*r+1],y=0,b=1;b<d;b++){var g=v,_=p,m=v+e[2*(r+b)],O=p+e[2*(r+b)+1];v=m,p=O,y+=(m-g)*(O+_)*.5}var k=y>0;if(k&&h&&(n+=d),k||(u++,h=!1),u>=1e6)break;l+=y,a&&k&&s&&(o=!0),e[2*i]=e[2*n],e[2*i+++1]=e[2*n+++1];for(var j=1,x=e[2*n],w=e[2*n+++1],I=2;I<d;I++){var S=e[2*n],F=e[2*n+++1];x*F-S*w==0?(x+=S,w+=F):(e[2*i]=x,e[2*i+++1]=w,j++,x=S,w=F)}e[2*i]=x,e[2*i+++1]=w,j++,c.push(j),a=!1,s=!0,r+=d}return c.length?(this._cache.area=Math.abs(l),new Ct.a(c,e,o)):null}},{key:"_parseGeometry",value:function(e){for(var t=e.getLength(),r=e.pos()+t,n=[],i=[];e.pos()<r&&e.next();)switch(e.tag()){case 2:for(var a=e.getUInt32(),s=e.pos()+a;e.pos()<s;)i.push(e.getUInt32());break;case 3:for(var o=e.getUInt32(),u=e.pos()+o;e.pos()<u;)n.push(e.getSInt32()),n.push(e.getSInt32()),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();break;case 1:default:e.skip()}for(var c=0,l=0,h=i;l<h.length;l++){var f=h[l];n[2*c]+=this._tx,n[2*c+1]+=this._ty,c+=f}return this._isPolygons?this._preprocessPolygon(n,i):new Ct.a(i,n)}}],[{key:"fromBuffer",value:function(e,t){var n=function(e){try{for(var t=new At.a(new Uint8Array(e),new DataView(e));t.next();)switch(t.tag()){case 2:return zt(t.getMessage());default:t.skip()}}catch(e){var r=new mt.a("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});qt.error(r)}return null}(e),i=function(e,t){for(var r=e.pos(),n=new Mt,i=0,a=0,s=null,o=null,u=null,c=!1;e.next();)switch(e.tag()){case 1:s=e.getString();break;case 3:o=e.getString();break;case 12:u=e.processMessage(Et.c);break;case 9:n.exceededTransferLimit=e.getBool(),n.exceededTransferLimit&&(n.offsets.geometry=new Int32Array(8e3),n.centroid=new Int32Array(16e3));break;case 13:var l=Rt(e),h=l.name.toLowerCase().trim(),f=i++;n.fieldIndexMap.set(l.name,f),n.fieldIndexMap.set(h,f),l.isDate&&(n.dateFields.add(l.name),n.dateFields.add(h));break;case 15:var d=e.getLength(),v=e.pos()+d;if(!n.exceededTransferLimit){var p=n.offsets.geometry,y=n.centroid;p.push(0),y.push(268435455),y.push(268435455)}!c&&n.exceededTransferLimit&&(c=!0,n.offsets.attributes=new Uint32Array(8e3*i));for(var b=a*i;e.pos()<v&&e.next();)switch(e.tag()){case 1:c?n.offsets.attributes[b++]=e.pos():n.offsets.attributes.push(e.pos());var g=e.getLength();e.skipLen(g);break;case 2:if(t)for(var _=e.getLength(),m=e.pos()+_;e.pos()<m&&e.next();)switch(e.tag()){case 3:e.getUInt32();var O=e.getSInt32(),k=e.getSInt32();n.centroid[2*a]=O,n.centroid[2*a+1]=k;break;default:e.skip()}else{n.offsets.geometry[a]=e.pos();var j=e.getLength();e.skipLen(j)}break;case 4:for(var x=e.getLength(),w=e.pos()+x;e.pos()<w&&e.next();)switch(e.tag()){case 3:e.getUInt32();var I=e.getSInt32(),S=e.getSInt32();n.centroid[2*a]=I,n.centroid[2*a+1]=S;break;default:e.skip()}break;default:e.skip()}a++,n.hasFeatures=!0;break;default:e.skip()}var F=s||o;if(!F)throw new mt.a("FeatureSet has no objectId or globalId field name");return n.featureCount=a,n.fieldCount=i,n.objectIdFieldIndex=n.getFieldIndex(F),n.transform=u,n.displayIds=new Uint32Array(n.featureCount),n.groupIds=new Uint16Array(n.featureCount),e.move(r),n}(n,"esriGeometryPoint"===t);return new r(tt.a.createInstance(),n,i,t)}}]),r}(tt.a),Nt=function(){function e(t){Object(o.a)(this,e),this.service=t}return Object(u.a)(e,[{key:"destroy",value:function(){}}]),e}();var Pt,Dt,Gt=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){var n;return Object(o.a)(this,r),(n=t.call(this,e))._portsOpen=Object(kt.b)(e.source).then((function(e){return n.client=e})),n}return Object(u.a)(r,[{key:"destroy",value:function(){this.client.close(),this.client=null}},{key:"executeQuery",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._portsOpen;case 2:return e.next=4,this.client.invoke("queryFeatures",t.toJSON(),r);case 4:return n=e.sent,e.abrupt("return",rt.fromFeatureSet(n,this.service.objectIdField));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(Nt),Bt=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(){return Object(o.a)(this,r),t.apply(this,arguments)}return Object(u.a)(r,[{key:"executeQuery",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(jt.executeQueryPBFBuffer)(this.service.source,t,Object(Ze.a)(Object(Ze.a)({},r),{},{query:Object(Ze.a)(Object(Ze.a)({},this.service.customParameters),null==r?void 0:r.query)}));case 2:return n=e.sent,i=n.data,e.abrupt("return",Lt.fromBuffer(i,this.service.geometryType));case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(Nt),Ut=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(){return Object(o.a)(this,r),t.apply(this,arguments)}return Object(u.a)(r,[{key:"executeQuery",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i,s,o,u,c,l,h,f,d,v;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.service,i=n.source,s=n.capabilities,o=n.spatialReference,u=n.objectIdField,!t.quantizationParameters||s.query.supportsQuantization){e.next=10;break}return(c=t.clone()).quantizationParameters=null,e.next=6,Object(jt.executeQuery)(i,c,o,Object(Ze.a)(Object(Ze.a)({},r),{},{query:Object(Ze.a)(Object(Ze.a)({},this.service.customParameters),null==r?void 0:r.query)}));case 6:return l=e.sent,h=l.data,f=Object(Je.b)(h,u),e.abrupt("return",(Object(Je.q)(r.transform,f),rt.fromOptimizedFeatureSet(f)));case 10:return e.next=12,Object(jt.executeQuery)(i,t,this.service.spatialReference,Object(Ze.a)(Object(Ze.a)({},r),{},{query:Object(Ze.a)(Object(Ze.a)({},Object(w.n)(this.service.customParameters)),null==r?void 0:r.query)}));case 12:return d=e.sent,v=d.data,e.abrupt("return",rt.fromFeatureSet(v,this.service.objectIdField));case 15:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(Nt),Qt=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(){return Object(o.a)(this,r),t.apply(this,arguments)}return Object(u.a)(r,[{key:"executeQuery",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.service.capabilities,!t.quantizationParameters||n.query.supportsQuantization){e.next=7;break}return t.clone().quantizationParameters=null,e.next=5,St(this.service.source,t,r);case 5:return i=e.sent,e.abrupt("return",(Object(Je.q)(r.transform,i),rt.fromOptimizedFeatureSet(i)));case 7:return e.next=9,St(this.service.source,t,r);case 9:return s=e.sent,e.abrupt("return",rt.fromOptimizedFeatureSet(s));case 11:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(Nt),Vt=function(){function e(t){Object(o.a)(this,e),this._abortController=new AbortController,this.requests={pending:new Array,done:new Array},this.tile=t}return Object(u.a)(e,[{key:"signal",get:function(){return this._abortController.signal}},{key:"add",value:function(e){this.requests.done.push(e),e.request.end&&(this.resolved=!0)}},{key:"abort",value:function(){this._abortController.abort()}}]),e}(),Yt=function(){function e(t){Object(o.a)(this,e),this.events=new Le.a,this._subscriptions=new Map,this._serviceQueryInfo={outSpatialReference:t.outSR},this._serviceInfo=t.serviceInfo,this._onRequest=t.onRequest}return Object(u.a)(e,[{key:"queryLastEditDate",value:function(){var e=Object(s.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Service does not support query type");case 1:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"query",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Service does not support query");case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"geometryType",get:function(){return this._serviceInfo.geometryType}},{key:"update",value:function(e){Object(yt.a)(e,this._sourceQueryInfo)&&(this._sourceQueryInfo=e)}},{key:"updateSubscriptions",value:function(){}},{key:"setViewState",value:function(e){}},{key:"subscribe",value:function(e){var t=new Vt(e);this._subscriptions.set(e.id,t)}},{key:"unsubscribe",value:function(e){var t=this.get(e.id);Object(w.h)(t)&&t.abort(),this._subscriptions.delete(e.id)}},{key:"pause",value:function(){}},{key:"resume",value:function(){}},{key:"get",value:function(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null}},{key:"enableEvent",value:function(e,t){}}]),e}(),Xt=d.a.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource"),Ht=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){var n;return Object(o.a)(this,r),(n=t.call(this,e)).type="feature",n._adapter=function(e){var t,r=e.capabilities;return(t=e.source)&&t.capabilities&&t.collectionId&&t.layerDefinition&&t.url?new Qt(e):function(e){return Array.isArray(e.source)}(e)?new Gt(e):r.query.supportsFormatPBF?new Bt(e):new Ut(e)}(e.serviceInfo),n._queue=new st({concurrency:8,process:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,i,s,o;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Object(b.u)(t),r=t.tile.key.id,i=t.tile,s=t.signal,o={query:Object(f.a)("esri-tiles-debug")?{tile:r.replace(/\//g,"."),depth:t.depth}:void 0,signal:s,transform:i.transform},e.abrupt("return",n._adapter.executeQuery(t.query,o));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}),n._patchQueue=new st({concurrency:8,process:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,i,s,o;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Object(b.u)(t),r=t.tile.key.id,i=t.tile,s=t.signal,o={query:Object(f.a)("esri-tiles-debug")?{tile:r.replace(/\//g,"."),depth:t.depth}:void 0,signal:s,transform:i.transform},e.abrupt("return",n._adapter.executeQuery(t.query,o));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}),n}return Object(u.a)(r,[{key:"destroy",value:function(){this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}},{key:"setViewState",value:function(e){}},{key:"updating",get:function(){return!!this._queue.length}},{key:"subscribe",value:function(e){Object(Ke.a)(Object(et.a)(r.prototype),"subscribe",this).call(this,e),this._fetchDataTile(e).catch((function(t){Object(b.l)(t)||Xt.error(new mt.a("mapview-query-error","Encountered error when fetching tile",{tile:e,error:t}))}))}},{key:"unsubscribe",value:function(e){Object(Ke.a)(Object(et.a)(r.prototype),"unsubscribe",this).call(this,e)}},{key:"pause",value:function(){this._queue.pause()}},{key:"resume",value:function(){this._queue.resume()}},{key:"query",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._adapter.executeQuery(t,r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"queryLastEditDate",value:function(){var e=Object(s.a)(a.a.mark((function e(){var t,r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._serviceInfo.source,r=Object(Ze.a)(Object(Ze.a)({},t.query),{},{f:"json"}),e.next=3,Object(Ot.default)(t.path,{query:r,responseType:"json"});case 3:return e.abrupt("return",e.sent.data.editingInfo.lastEditDate);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"forEachRequest",value:function(e,t){var r,n=this._subscriptions.get(e),i=n.requests,a=n.signal,s=Object(U.a)(i.done);try{for(s.s();!(r=s.n()).done;){t(r.value.request,{signal:a})}}catch(o){s.e(o)}finally{s.f()}}},{key:"_executePatchQuery",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,n,i){var s,o,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(s=r.clone()).outFields=[this._serviceInfo.objectIdField].concat(Object(vt.a)(n)),s.returnCentroid=!1,s.returnGeometry=!1,o=Object(w.h)(s.start)?s.start/8e3:0,u=i.signal,e.abrupt("return",this._patchQueue.push({tile:t,query:s,signal:u,depth:o}));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}()},{key:"_resendRequest",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i,s,o,u,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.query,i=t.request,s=Object(w.h)(n.outFields)?n.outFields:[],o=this._sourceQueryInfo.outFields,u=o.filter((function(e){return-1===s.indexOf(e)})),Object(w.g)(i.features)){e.next=15;break}if(!u.length){e.next=14;break}return e.prev=3,e.next=6,this._executePatchQuery(i.tile,n,u,r);case 6:c=e.sent,Object(b.u)(r),n.outFields=o,i.features.joinAttributes(c),this._onRequest(Object(Ze.a)(Object(Ze.a)({},i),{},{end:i.end||r.end}),"new",r),e.next=12;break;case 10:e.prev=10,e.t0=e.catch(3);case 12:e.next=15;break;case 14:this._onRequest(Object(Ze.a)(Object(Ze.a)({},i),{},{end:i.end||r.end}),"new",r);case 15:case"end":return e.stop()}}),e,this,[[3,10]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"resend",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n,i,s,o=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(r=t.dataTileOnly,n=0,i=!1,s=[],this._subscriptions.forEach((function(e){if(!e.requests.done.length){var t=e.tile;o._onRequest({tile:t,id:t.id,features:null,noData:!0,end:!1},"new",{dataTileOnly:!0})}}));!i;)i=!0,this._subscriptions.forEach((function(e){var t=e.requests,a=e.signal;if(t.done.length>n){i=!1;var u=t.done.length===n+1;s.push(o._resendRequest(t.done[n],{signal:a,dataTileOnly:r,end:u}))}})),n++;return e.next=6,Object(b.b)(s);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createQuery",value:function(e,t){var r=new bt.a(Object(Ze.a)(Object(Ze.a)(Object(Ze.a)({},this._serviceQueryInfo),this._sourceQueryInfo),t));return this._serviceInfo.capabilities.query.supportsQuantization||(t.quantizationParameters=null,r.maxAllowableOffset=e.resolution),t.quantizationParameters&&"esriGeometryPolyline"===this.geometryType&&(r.maxAllowableOffset=e.resolution),r.resultType="tile",r.geometry=e.extent,r}}]),r}(Yt),Zt=Object(f.a)("esri-featurelayer-webgl"),Wt=Object(f.a)("esri-mobile"),Jt={maxDrillLevel:Zt&&"object"==typeof Zt&&null!=Zt.maxDrillLevel?Zt.maxDrillLevel:Wt?1:4,maxRecordCountFactor:Zt&&"object"==typeof Zt&&null!=Zt.maxRecordCountFactor?Zt.maxRecordCountFactor:Wt?1:3},$t=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){return Object(o.a)(this,r),t.call(this,e)}return Object(u.a)(r,[{key:"_fetchDataTile",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n,i,o,u,c,l=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,n=this._subscriptions.get(t.key.id),i=n.signal,o=t.getQuantizationParameters(),u=0,(c=function(){var e=Object(s.a)(a.a.mark((function e(s,h){var f,d,v,p,y,g,_;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return f=l._sourceQueryInfo,d=l._createQuery(s,{maxRecordCountFactor:r?Jt.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:o}),u++,e.prev=2,e.next=5,l._queue.push({tile:t,query:d,signal:i,depth:h});case 5:if(v=e.sent,u--,Object(b.u)(i),v){e.next=8;break}return e.abrupt("return");case 8:if(f===l._sourceQueryInfo){e.next=10;break}return e.abrupt("return",void c(s,h));case 10:if(!(v.exceededTransferLimit&&h<Jt.maxDrillLevel)){e.next=14;break}p=Object(U.a)(s.createChildTiles());try{for(p.s();!(y=p.n()).done;)g=y.value,c(g,h+1)}catch(a){p.e(a)}finally{p.f()}return e.abrupt("return");case 14:_={tile:t,id:t.id,features:v,end:0===u},n.requests.done.push({query:d,request:_}),l._onRequest(_,"new"),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(2),Object(b.l)(e.t0)||l._onRequest({tile:t,id:t.id,features:null,end:!0},"new");case 21:case"end":return e.stop()}}),e,null,[[2,18]])})));return function(t,r){return e.apply(this,arguments)}}())(t,0);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),r}(Ht),Kt=r(40),er=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Number.POSITIVE_INFINITY;Object(o.a)(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=isFinite(t)?new Array(t):[]}return Object(u.a)(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return isFinite(this.maxSize)?this._buffer[(this._start+this.size++)%this.maxSize]=e:this._buffer[this._start+this.size++]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"clear",value:function(){for(;Object(w.h)(this.dequeue()););}}]),e}(),tr=function(){function e(t,r,n,i){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:128;Object(o.a)(this,e),this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=n,this._purgeOptions=i,this.store=t,this.objectIdField=r,this.purgeInterval=a,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}return Object(u.a)(e,[{key:"add",value:function(e){if(this._useGeneratedIds){var t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),this._timeInfo.trackIdField){var r=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(r)){var n=Object(w.h)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,i=Object(C.d)(n,0,1e3);this._trackIdToObservations.set(r,new er(i))}var a=this._trackIdToObservations.get(r).enqueue(e.objectId);Object(w.h)(a)&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(a))}}},{key:"checkForUpdates",value:function(){var e=this._getToAdd(),t=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);var n=[];if(Object(w.h)(t)){var i,a=Object(U.a)(t);try{for(a.s();!(i=a.n()).done;){var s=i.value,o=this.store.removeById(s);Object(w.h)(o)&&n.push(o)}}catch(h){a.e(h)}finally{a.f()}}if(Object(w.h)(e)){var u,c=Object(U.a)(e);try{for(c.s();!(u=c.n()).done;){var l=u.value;l.attributes.__esri_timestamp__=r,this.store.add(l)}}catch(h){c.e(h)}finally{c.f()}}(e||n)&&this.store.update(e,n)}},{key:"_getToAdd",value:function(){if(!this._addOrUpdated.size)return null;var e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach((function(r){return e[t++]=r})),this._addOrUpdated.clear(),e}},{key:"_getToRemove",value:function(){var e=this._removed;return this._removed.length?(this._removed=[],e):null}},{key:"_nextId",value:function(){var e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}},{key:"_purge",value:function(e){var t=this._purgeOptions;Object(w.h)(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}},{key:"_purgeSomeByDisplayCount",value:function(e){var t=this;if(e.displayCount){var r=this.store.size;r>e.displayCount&&this._trackIdToObservations.forEach((function(n){if(r>e.displayCount&&n.size){var i=Object(w.n)(n.dequeue());t._removed.push(i),r--}}))}}},{key:"_purgeByAge",value:function(e){var t,r=this;if(e.age&&null!=(t=this._timeInfo)&&t.startTimeField){var n=60*e.age*1e3,i=this._maxAge-n;this.store.forEach((function(e){e.attributes[r._timeInfo.startTimeField]<i&&r._removed.push(e.objectId)}))}}},{key:"_purgeByAgeReceived",value:function(e,t){var r=this;if(t.ageReceived){var n=e+60*t.ageReceived*1e3;this.store.forEach((function(e){e.attributes.__esri_timestamp__<n&&r._removed.push(e.objectId)}))}}},{key:"_purgeTracks",value:function(){var e=this;this._trackIdToObservations.forEach((function(t,r){0===t.size&&e._trackIdToObservations.delete(r)}))}}]),e}(),rr=r(347),nr=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(){return Object(o.a)(this,r),t.apply(this,arguments)}return Object(u.a)(r,[{key:"onFeature",value:function(e){this.emit("feature",e)}}]),r}(Le.a.EventedMixin(g.a)),ir=nr=Object(h.a)([Object(y.a)("esri.layers.graphics.sources.connections.StreamConnection")],nr),ar=d.a.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");(Dt=Pt||(Pt={}))[Dt.CONNECTING=0]="CONNECTING",Dt[Dt.OPEN=1]="OPEN",Dt[Dt.CLOSING=2]="CLOSING",Dt[Dt.CLOSED=3]="CLOSED";var sr=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){var n;Object(o.a)(this,r),(n=t.call(this)).errorString=null;var i=e.geometryType,a=e.spatialReference,s=e.sourceSpatialReference;return n._config=e,n._featureZScaler=Object(rr.a)(i,s,a),n._open(),n}return Object(u.a)(r,[{key:"_open",value:function(){var e=Object(s.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tryCreateWebSocket();case 2:if(e.t0=this.destroyed,e.t0){e.next=6;break}return e.next=6,this._handshake();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){Object(w.h)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if(Object(w.g)(this._websocket))return"disconnected";switch(this._websocket.readyState){case Pt.CONNECTING:case Pt.OPEN:return"connected";case Pt.CLOSING:case Pt.CLOSED:return"disconnected"}}},{key:"_tryCreateWebSocket",value:function(){var e=Object(s.a)(a.a.mark((function e(){var t,r,n,i,s=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=s.length>0&&void 0!==s[0]?s[0]:this._config.source.path,r=s.length>1&&void 0!==s[1]?s[1]:1e3,n=s.length>2&&void 0!==s[2]?s[2]:0,e.prev=3,!this.destroyed){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,this._createWebSocket(t);case 8:this._websocket=e.sent,this.notifyChange("connectionStatus"),e.next=24;break;case 12:if(e.prev=12,e.t0=e.catch(3),i=r/1e3,!(this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts)){e.next=19;break}e.t1=(ar.error(new mt.a("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()),e.next=23;break;case 19:return ar.error(new mt.a("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(i,"s"),e.t0)),e.next=22,Object(b.a)(r);case 22:e.t1=this._tryCreateWebSocket(t,Math.min(1.5*r,1e3*this._config.maxReconnectionInterval),n+1);case 23:return e.abrupt("return",e.t1);case 24:case"end":return e.stop()}}),e,this,[[3,12]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createWebSocket",value:function(e){var t=this,r=new WebSocket(e),n=Object(b.c)((function(e,t){r.onopen=function(){return e(r)},r.onclose=function(e){return t(e)}}));return n.then((function(){if(t.destroyed)return r.onclose=function(){},void r.close();r.onclose=function(e){return t._onClose(e)},r.onerror=function(e){return t._onError(e)},r.onmessage=function(e){return t._onMessage(e)}})),n}},{key:"_handshake",value:function(){var e=Object(s.a)(a.a.mark((function e(){var t,r,n,i,s,o,u,c,l=this,h=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=h.length>0&&void 0!==h[0]?h[0]:1e4,r=this._websocket,!Object(w.g)(r)){e.next=4;break}return e.abrupt("return");case 4:return n=Object(b.g)(),i=r.onmessage,s=this._config,o=s.filter,u=s.outFields,c=s.spatialReference,e.abrupt("return",(n.timeout(t),r.onmessage=function(e){var t,a=null;try{a=JSON.parse(e.data)}catch(e){}a&&"object"==typeof a||(ar.error(new mt.a("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),n.reject(),l.destroy()),(null==(t=a.spatialReference)?void 0:t.wkid)!==(null==c?void 0:c.wkid)&&(ar.error(new mt.a("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(c.wkid),e.data)),n.reject(),l.destroy()),"json"!==a.format&&(ar.error(new mt.a("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),n.reject(),l.destroy()),o&&a.filter!==o&&ar.error(new mt.a("websocket-connection","Tried to set filter, but server doesn't support it")),u&&a.outFields!==u&&ar.error(new mt.a("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=i,n.resolve()},r.send(JSON.stringify({filter:o,outFields:u,format:"json",spatialReference:{wkid:c.wkid}})),n.promise));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){try{var t=JSON.parse(e.data);if("featureResult"!==t.type)throw new mt.a("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);var r,n=Object(U.a)(t.features);try{for(n.s();!(r=n.n()).done;){var i=r.value;this._featureZScaler&&this._featureZScaler(i.geometry),this.onFeature(i)}}catch(a){n.e(a)}finally{n.f()}}catch(e){return ar.error(new mt.a("websocket-connection","Failed to parse message",e)),void this.destroy()}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),ar.error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&ar.error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),r}(ir);Object(h.a)([Object(p.b)()],sr.prototype,"connectionStatus",null),Object(h.a)([Object(p.b)()],sr.prototype,"errorString",void 0),sr=Object(h.a)([Object(y.a)("esri.layers.graphics.sources.connections.WebSocketConnection")],sr);var or=d.a.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),ur={maxQueryDepth:5,maxRecordCountFactor:3},cr=function(e){Object(c.a)(n,e);var t=Object(l.a)(n);function n(e){return Object(o.a)(this,n),t.call(this,Object(Ze.a)(Object(Ze.a)({},ur),e))}return Object(u.a)(n,[{key:"_open",value:function(){var e=Object(s.a)(a.a.mark((function e(){var t,r,n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchServiceDefinition(this._config.source);case 2:return(t=e.sent).timeInfo.trackIdField||or.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),e.next=6,this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference);case 6:return r=e.sent,this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),e.next=10,this._buddyServicesQuery;case 10:return e.next=12,this._tryCreateWebSocket(r);case 12:n=this._config,i=n.filter,s=n.outFields,this.destroyed||this._setFilter(i,s);case 14:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){var t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(e){return void or.error(new mt.a("geoevent-connection","Failed to parse message",e))}this.onFeature(t)}},{key:"_fetchServiceDefinition",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Object(Ot.default)(t.path,{query:{f:"json"},responseType:"json"}),e.next=3,r;case 3:return n=e.sent.data,e.abrupt("return",(this._serviceDefinition=n,n));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchWebSocketUrl",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t[0],i=n.urls,s=n.token,e.abrupt("return","".concat(this._inferWebSocketBaseUrl(i),"/subscribe?outSR=").concat(r.wkid).concat(s?"&token="+s:""));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t,r=Object(U.a)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(-1!==n.indexOf("wss"))return n}}catch(i){r.e(i)}finally{r.f()}return or.error(new mt.a("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i,s,o,u=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._websocket,!(Object(w.g)(n)||Object(w.g)(t)&&Object(w.g)(r))){e.next=3;break}return e.abrupt("return");case 3:return i=JSON.stringify({filter:this._serializeFilter(t,r)}),s=!1,o=Object(b.g)(),e.abrupt("return",(n.onmessage=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(or.error(new mt.a("geoevent-connection","Failed to set service filter",t.error)),u._set("errorString","Could not set service filter - ".concat(t.error)),o.reject(t.error)),n.onmessage=u._onMessage.bind(u),s=!0,o.resolve())},n.send(i),setTimeout((function(){s||(u.destroyed||u._websocket!==n||or.error(new mt.a("geoevent-connection","Server timed out when setting filter")),o.reject())}),1e4),o.promise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_serializeFilter",value:function(e,t){var r={};if(Object(w.g)(e)&&Object(w.g)(t))return r;if(Object(w.h)(e)&&e.geometry)try{var n=Object(S.a)(e.geometry);if("extent"!==n.type)throw new mt.a("Expected extent but found type ".concat(n.type));r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(e){or.error(new mt.a("geoevent-connection","Encountered an error when setting connection geometryDefinition",e))}return Object(w.h)(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),Object(w.h)(t)&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return or.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),i=n.attributes,a=n.geometry;for(var s in i)e.attributes[s]=i[s];return a&&(e.geometry=a),e.geometry||e.centroid||or.error(new mt.a("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var e=Object(s.a)(a.a.mark((function e(){var t,r,n,i,s,o,u,c,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._serviceDefinition,r=t.relatedFeatures,n=t.keepLatestArchive,i=this._queryRelatedFeatures(r),s=this._queryArchive(n),e.next=4,i;case 4:return e.next=6,s;case 6:if(o=e.sent){e.next=9;break}return e.abrupt("return");case 9:u=Object(U.a)(o.features);try{for(u.s();!(c=u.n()).done;)l=c.value,this.onFeature(this._enrich(l))}catch(a){u.e(a)}finally{u.f()}e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),or.error(new mt.a("geoevent-connection","Encountered an error when querying buddy services",{error:e.t0}));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRelatedFeatures",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._queryBuddy(t.featuresUrl);case 4:r=e.sent,this._addRelatedFeatures(r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryArchive",value:function(){var e=Object(s.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",this._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryBuddy",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var n,i,s,o,u,c,l,h,f,d,v;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.resolve().then(r.bind(null,383));case 2:return e.t0=e.sent.default,e.t1={url:t},n=new e.t0(e.t1),e.next=7,n.load();case 7:if(i=e.sent,s=i.capabilities,o=s.query.supportsMaxRecordCountFactor,u=s.query.supportsPagination,c=s.query.supportsCentroid,l=this._config.maxRecordCountFactor,h=n.capabilities.query.maxRecordCount,f=o?h*l:h,(d=new bt.a).outFields=Object(w.o)(this._config.outFields,["*"]),d.where=Object(w.o)(Object(w.f)(this._config.filter,"where"),"1=1"),d.returnGeometry=!0,d.returnExceededLimitFeatures=!0,d.outSpatialReference=V.a.fromJSON(this._config.spatialReference),c&&(d.returnCentroid=!0),o&&(d.maxRecordCountFactor=l),!u){e.next=18;break}return e.abrupt("return",(d.num=f,n.destroy(),this._queryPages(t,d)));case 18:return e.next=20,Object(jt.executeQuery)(t,d,this._config.sourceSpatialReference);case 20:return v=e.sent,e.abrupt("return",(n.destroy(),v.data));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryPages",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i,s,o,u=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=u.length>2&&void 0!==u[2]?u[2]:[],i=u.length>3&&void 0!==u[3]?u[3]:0,r.start=Object(w.h)(r.num)?i*r.num:null,e.next=5,Object(jt.executeQuery)(t,r,this._config.sourceSpatialReference);case 5:return s=e.sent,o=s.data,e.abrupt("return",o.exceededTransferLimit&&i<this._config.maxQueryDepth?(o.features.forEach((function(e){return n.push(e)})),this._queryPages(t,r,n,i+1)):(n.forEach((function(e){return o.features.push(e)})),o));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addRelatedFeatures",value:function(e){var t,r=new Map,n=e.features,i=this._serviceDefinition.relatedFeatures.joinField,a=Object(U.a)(n);try{for(a.s();!(t=a.n()).done;){var s=t.value,o=s.attributes[i];r.set(o,s)}}catch(u){a.e(u)}finally{a.f()}this._relatedFeatures=r}}]),n}(sr),lr=cr=Object(h.a)([Object(y.a)("esri.layers.graphics.sources.connections.GeoEventConnection")],cr);function hr(e,t){var r=e.weakClone(),n=Object(Je.s)(t,e.geometry.coords[0]),i=Object(Je.t)(t,e.geometry.coords[1]);return r.geometry=new Ct.a([],[n,i]),r}function fr(e,t){var r=Object(Ne.a)(9,function(e){switch(e){case"esriGeometryPoint":return function(e){return{minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]}};default:return function(e){var t=1/0,r=1/0,n=-1/0,i=-1/0;return e.geometry.forEachVertex((function(e,a){t=Math.min(t,e),r=Math.min(r,a),n=Math.max(n,e),i=Math.max(i,a)})),{minX:t,minY:r,maxX:n,maxY:i}}}}(t));return r.load(e),r}function dr(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}var vr=function(){function e(t,r){Object(o.a)(this,e),this.onUpdate=t,this._geometryType=r,this._objectIdToFeature=new Map}return Object(u.a)(e,[{key:"_features",get:function(){var e=[];return this._objectIdToFeature.forEach((function(t){return e.push(t)})),e}},{key:"add",value:function(e){this._objectIdToFeature.set(e.objectId,e),this._index=null}},{key:"get",value:function(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null}},{key:"forEach",value:function(e){this._objectIdToFeature.forEach(e)}},{key:"search",value:function(e){return this._index||(this._index=fr(this._features,this._geometryType)),dr(this._index,e)}},{key:"removeById",value:function(e){var t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null}},{key:"update",value:function(e,t){this.onUpdate(e,t)}},{key:"size",get:function(){return this._objectIdToFeature.size}}]),e}(),pr=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){var n;Object(o.a)(this,r),(n=t.call(this,e)).type="geoevent",n._dataReceiveEventEnabled=!1,n._updateInfo={websocket:0,client:0};var i=e.outSR,a=e.serviceInfo,s=a.geometryType,u=a.objectIdField,c=a.timeInfo,l=a.purgeOptions,h=a.source,f=a.spatialReference,d=a.serviceFilter,v=a.maxReconnectionAttempts,p=a.maxReconnectionInterval,y=a.updateInterval,b=new vr(n._onUpdate.bind(Object(Kt.a)(n)),s),g=new tr(b,u,c,l),_=function(e,t,r,n,i,a,s){var o=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),u={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:i,maxReconnectionAttempts:a,maxReconnectionInterval:s};return o?new sr(u):new lr(u)}(h,f,i,s,d,v,p);n._store=b,n._manager=g,n._connection=_,n._quantize=function(e){switch(e){case"esriGeometryPoint":return hr;case"esriGeometryPolygon":case"esriGeometryPolyline":default:return function(t,r){var n=t.weakClone(),i=new Ct.a,a=Object(Je.r)(i,t.geometry,!1,!1,e,r,!1,!1);return n.geometry=a,n}}}(s),n._handles=[n._connection.on("feature",(function(e){return n._onFeature(e)})),n._connection.watch("connectionStatus",(function(e){return n.events.emit("connectionStatus",e)})),n._connection.watch("errorString",(function(e){return n.events.emit("errorString",e)}))];var m=performance.now();return n._updateIntervalId=setInterval((function(){var t=performance.now(),r=t-m;if(r>2500){m=t;var i=Math.round(n._updateInfo.client/(r/1e3)),a=Math.round(n._updateInfo.websocket/(r/1e3));n._updateInfo.client=0,n._updateInfo.websocket=0,n.events.emit("updateRate",{client:i,websocket:a})}e.canAcceptRequest()&&n._manager.checkForUpdates()}),y),n}return Object(u.a)(r,[{key:"destroy",value:function(){clearInterval(this._updateIntervalId),this._handles.forEach((function(e){return e.remove()})),this._connection.destroy()}},{key:"_fetchDataTile",value:function(){}},{key:"enableEvent",value:function(e,t){"data-received"===e&&(this._dataReceiveEventEnabled=t)}},{key:"updating",get:function(){return!1}},{key:"subscribe",value:function(e){Object(Ke.a)(Object(et.a)(r.prototype),"subscribe",this).call(this,e);var t=this._getTileFeatures(e);this._onRequest({tile:e,id:e.key.id,features:t,end:!0},"new")}},{key:"unsubscribe",value:function(e){Object(Ke.a)(Object(et.a)(r.prototype),"unsubscribe",this).call(this,e)}},{key:"forEachRequest",value:function(e,t){var r=this._subscriptions.get(e),n=r.tile,i=r.signal;t({tile:n,id:e,features:this._getTileFeatures(n),end:!0},{signal:i})}},{key:"resend",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._subscriptions.forEach((function(e){var n=e.tile,i={tile:n,id:n.id,features:r._getTileFeatures(n),end:!0};r._onRequest(i,"update",t)}));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getTileFeatures",value:function(e){var t=this,r=this._store.search(e).map((function(r){return t._quantize(r,e.transform)}));return rt.fromOptimizedFeatures(r,this.geometryType,e.transform)}},{key:"_onFeature",value:function(e){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",e);var t=Object(Je.a)(e,this.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(e){}}},{key:"_onUpdate",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i,s=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Object(w.a)(t,(function(e){return fr(e,s.geometryType)})),i=Object(w.a)(r,(function(e){return fr(e,s.geometryType)})),Object(w.h)(t)&&(this._updateInfo.client+=t.length),this._subscriptions.forEach((function(e,t){var r=e.tile,a=Object(w.a)(n,(function(e){return dr(e,r)})),o=Object(w.a)(a,(function(e){return e.map((function(e){return s._quantize(e,r.transform)}))})),u=Object(w.a)(o,(function(e){return rt.fromOptimizedFeatures(e,s.geometryType,r.transform)})),c=Object(w.a)(i,(function(e){return dr(e,r)})),l=Object(w.a)(c,(function(e){return e.map((function(e){return e.objectId}))}));s._onRequest({tile:r,id:t,features:u,remove:Object(w.o)(l,[]),end:!0},"update")}));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(Yt),yr=d.a.getLogger("esri.views.2d.layers.features.sources.FeatureSource"),br=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){return Object(o.a)(this,r),t.call(this,e)}return Object(u.a)(r,[{key:"_fetchDataTile",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n,i,s,o,u,c,l,h,f,d=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this._subscriptions.get(t.key.id),n=!1,i=0,s=0,o=function(e,i){s--,Object(b.u)(r);var a=e.reader,o=e.query;if(!a.exceededTransferLimit){if(n=!0,0!==i&&!a.hasFeatures){var u={tile:t,id:t.id,features:a,end:0===s};return r.requests.done.push({request:u,query:o}),void d._onRequest(u,"new")}var c={tile:t,id:t.id,features:a,end:0===s};return r.requests.done.push({request:c,query:o}),void d._onRequest(c,"new")}var l={tile:t,id:t.id,features:a,end:n&&0===s};r.requests.done.push({request:l,query:o}),d._onRequest(l,"new")},u=0,c=0;case 4:if(n||!(c++<20)){e.next=14;break}for(l=void 0,h=function(e){var a=i++;s++,l=d._fetchDataTilePage(t,a,r).then((function(e){return e&&o(e,a)})).catch((function(e){n=!0,Object(b.l)(e)||(yr.error(new mt.a("mapview-query-error","Encountered error when fetching tile",{tile:t,error:e})),d._onRequest({tile:t,id:t.id,features:null,end:n},"new"))}))},f=0;f<u+1;f++)h();return e.next=10,l;case 10:Object(b.u)(r),u=Math.min(u+2,6);case 12:e.next=4;break;case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchDataTilePage",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,n){var i,s,o,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._sourceQueryInfo,s=this._createQuery(t,{start:8e3*r,num:8e3,maxRecordCountFactor:3,returnExceededLimitFeatures:!0,quantizationParameters:t.getQuantizationParameters()}),e.prev=1,o=n.signal,e.next=5,this._queue.push({tile:t,query:s,signal:o,depth:r});case 5:return u=e.sent,e.abrupt("return",(Object(b.u)(n),u?i!==this._sourceQueryInfo?this._fetchDataTilePage(t,r,n):{reader:u,query:s}:null));case 9:return e.prev=9,e.t0=e.catch(1),e.abrupt("return",(Object(b.v)(e.t0),null));case 12:case"end":return e.stop()}}),e,this,[[1,9]])})));return function(t,r,n){return e.apply(this,arguments)}}()}]),r}(Ht);function gr(e,t,r){var n=function(e,t,r){var n=e.clone(),i=1<<n.level,a=n.col+t,s=n.row+r;return a<0&&a!==n.col?(n.col=a+i,n.world-=1):a>=i?(n.col=a-i,n.world+=1):n.col=a,n.row=s,n}(e.key,t,r);return new Be(e.tileInfoView,n)}var _r=0,mr=function(){function e(t,r){Object(o.a)(this,e),this.didSend=!1,this.dataTileCount=0,this.update=He.all(),this._abortController=new AbortController,this.invalid=!1,this.displayTile=t,this._pixelBuffer=r,this.partitions=kr(t,r)}return Object(u.a)(e,[{key:"setUpdate",value:function(e,t){this.update=e,this.dataTileCount=0,t!==this._pixelBuffer&&(this._pixelBuffer=t,this.partitions=kr(this.displayTile,t)),e.mesh&&(this.didSend=!1)}},{key:"signal",get:function(){return this._abortController.signal}},{key:"abort",value:function(){this._abortController.abort()}}]),e}(),Or=function(){function e(t,r,n){Object(o.a)(this,e),this.resolved=!1,this.tile=r,this.offset=t,this.extent=n}return Object(u.a)(e,[{key:"reset",value:function(){this.resolved=!1}}]),e}();function kr(e,t){var r=[];if(r.push(new Or([0,0],e,null)),0===t)return r;var n=Math.min(t,gt.p),i=gt.p;return r.push(new Or([-i,-i],gr(e,-1,-1),[i-n,i-n,i,i])),r.push(new Or([0,-i],gr(e,0,-1),[0,i-n,i,i])),r.push(new Or([i,-i],gr(e,1,-1),[0,i-n,n,i])),r.push(new Or([-i,0],gr(e,-1,0),[i-n,0,i,i])),r.push(new Or([i,0],gr(e,1,0),[0,0,n,i])),r.push(new Or([-i,i],gr(e,-1,1),[i-n,0,i,n])),r.push(new Or([0,i],gr(e,0,1),[0,0,i,n])),r.push(new Or([i,i],gr(e,1,1),[0,0,n,n])),r}var jr=function(){function e(t,r,n){var i=this;Object(o.a)(this,e),this.type="remote",this._pendingEdits=new Set,this._queryInfo=null,this._subscriptions={display:new Map},this._invalid={outFields:!1,queryFilterParameters:!1};var a=this._onDataTileRequest.bind(this);this._source=function(e,t,r,n,i){var a=function(e,t,r,n,i){switch(e.type){case"stream":return{type:"geoevent",serviceInfo:e,onRequest:n,outSR:t,canAcceptRequest:i};case"memory":case"on-demand":return{type:"feature",serviceInfo:e,onRequest:n,outSR:t,origin:function(e){return Array.isArray(e)?"local":"path"in e&&Object(_t.c)(e.path)?"hosted":"unknown"}(e.source),tileInfoView:r,canAcceptRequest:i}}}(e,t,r,n,i);switch(a.type){case"feature":switch(a.origin){case"hosted":case"local":return new br(a);case"unknown":return new $t(a)}case"geoevent":return new pr(a)}}(t,r,n,a,(function(){return i.canAcceptPatch()})),this._serviceInfo=t,this._geometryType=t.geometryType,this._outSR=r}return Object(u.a)(e,[{key:"destroy",value:function(){var e=this;this._getSubscriptions().map((function(t){var r=t.displayTile;return e.unsubscribe(r)})),this._source.destroy()}},{key:"updating",get:function(){return this._source.updating||this._getSubscriptions().some((function(e){return!e.didSend}))}},{key:"isStream",get:function(){return"geoevent"===this._source.type}},{key:"sourceEvents",get:function(){return"geoevent"===this._source.type?{type:"geoevent",events:this._source.events}:{type:"feature",events:this._source.events}}},{key:"enableEvent",value:function(e,t){this._source.enableEvent(e,t)}},{key:"setViewState",value:function(e){this._source.setViewState(e)}},{key:"update",value:function(e,t){var r,n,i,a,s=this._serviceInfo.fields.length,o=null!=(r=null==(n=this._schema)?void 0:n.outFields)?r:[],u=null!=(i=null==(a=this._schema)?void 0:a.pixelBuffer)?i:0,c=t.outFields.filter((function(e){return-1===o.indexOf(e)})),l=[].concat(Object(vt.a)(o),Object(vt.a)(c)),h=0===t.pixelBuffer?0:Math.max(t.pixelBuffer,u);t.pixelBuffer=h,t.outFields=l.length>=.75*s?["*"]:l,t.outFields.sort();var d=Object(yt.a)(this._schema,t);if(this._subscriptions.display.forEach((function(t){t.invalid&&(e.queryFilter=!0)})),d){var v=this._schema&&Object(yt.b)(d,"outFields"),p=this._schema&&Object(yt.b)(d,"pixelBuffer"),y=this._schema&&Object(yt.c)(d,["definitionExpression","gdbVersion","historicMoment"]);Object(f.a)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",d);var b={returnCentroid:"esriGeometryPolygon"===this._geometryType,returnGeometry:!0,outFields:t.outFields,outSpatialReference:this._outSR,orderByFields:["".concat(this._serviceInfo.objectIdField," ASC")],where:t.definitionExpression||"1=1",gdbVersion:t.gdbVersion,historicMoment:t.historicMoment?new Date(t.historicMoment):null,timeExtent:pt.a.fromJSON(t.timeExtent)};e.source=!0,p&&(e.why.mesh.push("Pixel buffer changed"),e.mesh=!0),y&&(e.why.mesh.push("Layer filter changed"),e.why.source.push("Layer filter changed"),e.mesh=!0,e.queryFilter=!0,this._invalid.queryFilterParameters=!0),v&&(e.why.source.push("Layer required fields changed"),this._invalid.outFields=!0),this._schema=t,this._source.update(b),this._queryInfo=b}}},{key:"subscribe",value:function(e){this._subscriptions.display.has(e.id)||this._subscribeDisplayTile(e)}},{key:"unsubscribe",value:function(e){if(this._subscriptions.display.has(e.id)){var t=this._subscriptions.display.get(e.id);this._subscriptions.display.delete(e.id),this._source.unsubscribe(e),t.abort()}}},{key:"forEachRequest",value:function(e,t){this._source.forEachRequest(e,t)}},{key:"query",value:function(e){return this._source.query(e)}},{key:"createQuery",value:function(){return new bt.a(Object(Ze.a)({},this._queryInfo))}},{key:"createTileQuery",value:function(e){if("stream"===this._serviceInfo.type)throw new Error("Service does not support tile  queries");var t=this.createQuery();return t.quantizationParameters=e.getQuantizationParameters(),t.resultType="tile",t.geometry=e.extent,"esriGeometryPolyline"===this._serviceInfo.geometryType&&(t.maxAllowableOffset=e.resolution),this._serviceInfo.capabilities.query.supportsQuantization||(t.quantizationParameters=null,t.maxAllowableOffset=e.resolution),t}},{key:"invalidate",value:function(){this._subscriptions.display.forEach((function(e){return e.invalid=!0}))}},{key:"forEachPendingEdit",value:function(e){this._getSubscriptions().some((function(e){return e.invalid}))?this._pendingEdits.forEach(e):this._pendingEdits.clear()}},{key:"onEdits",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n,i,o,u,c=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.addedFeatures.filter((function(e){return!e.error})).map((function(e){return e.objectId})),n=t.updatedFeatures.filter((function(e){return!e.error})).map((function(e){return e.objectId})),i=t.deletedFeatures.filter((function(e){return!e.error})).map((function(e){return e.objectId})),o=[].concat(Object(vt.a)(r),Object(vt.a)(n)),i.forEach((function(e){c._pendingEdits.has(e)&&c._pendingEdits.delete(e)})),o.forEach((function(e){return c._pendingEdits.add(e)})),u=this._getSubscriptions().map((function(e){return e.displayTile})).map((function(e){var t=c.createTileQuery(e);return t.objectIds=o,{tile:e,query:t}})).map(function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.tile,n=t.query,e.t0=r,e.next=4,c._source.query(n);case 4:return e.t1=e.sent,e.abrupt("return",{tile:e.t0,result:e.t1});case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=5,Object(b.b)(u);case 5:e.sent.forEach((function(e){var t=e.tile,r=e.result,a=c._subscriptions.display.get(t.key.id);if(a){var s=a.signal,o=He.all();c.onDisplayTilePatch({type:"update",id:t.key.id,version:_r++,update:o,addOrUpdate:r,remove:[].concat(Object(vt.a)(n),Object(vt.a)(i)),end:!0,noData:!1},{signal:s})}})),this.invalidate();case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"resubscribe",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n,i,s,o=this,u=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>1&&void 0!==u[1]&&u[1],n=this._schema.pixelBuffer,this._subscriptions.display.forEach((function(e){return e.setUpdate(t,n)})),i=!1,this._subscriptions.display.forEach((function(e){e.invalid&&(i=!0)})),this._invalid.outFields&&(this._invalid.outFields=!1),!(r||this._invalid.queryFilterParameters||i)){e.next=9;break}(s=this._getSubscriptions().map((function(e){return e.displayTile}))).forEach((function(e){return o.unsubscribe(e)})),s.forEach((function(e){return o.subscribe(e)})),this._source.resume(),this._invalid.queryFilterParameters=!1,e.next=16;break;case 9:if(!t.mesh){e.next=14;break}return e.next=12,this._source.resend({dataTileOnly:!1});case 12:e.next=16;break;case 14:return e.next=16,this._source.resend({dataTileOnly:!0});case 16:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"pause",value:function(){this._source.pause()}},{key:"resume",value:function(){this._source.resume()}},{key:"_getSubscriptions",value:function(){var e=[];return this._subscriptions.display.forEach((function(t){e.push(t)})),e}},{key:"_subscribeDisplayTile",value:function(e){var t=new mr(e,this._schema.pixelBuffer);this._subscriptions.display.set(e.id,t),this._source.subscribe(e);var r,n=Object(U.a)(t.partitions);try{for(n.s();!(r=n.n()).done;){var i=r.value,a=i.tile,s=this._source.get(a.id);if(Object(w.h)(s)){var o,u=Object(U.a)(s.requests.done);try{for(u.s();!(o=u.n()).done;){var c=o.value;this._onPartitionMessage(e.id,i,c.request,"new")}}catch(l){u.e(l)}finally{u.f()}}}}catch(l){n.e(l)}finally{n.f()}}},{key:"_onDataTileRequest",value:function(e,t,r){var n=this,i=this._subscriptions.display.get(e.id);if(r&&r.dataTileOnly){var a,s=Object(U.a)(i.partitions);try{for(s.s();!(a=s.n()).done;){var o=a.value;if(o.tile.id===e.id){this._onPartitionMessage(e.id,o,e,t);break}}}catch(h){s.e(h)}finally{s.f()}}else{var u,c=Object(U.a)(i.partitions);try{for(c.s();!(u=c.n()).done;){var l=u.value;if(l.tile.id===e.id){this._onPartitionMessage(e.id,l,e,t);break}}}catch(h){c.e(h)}finally{c.f()}this._subscriptions.display.forEach((function(r,i){if(i!==e.id){var a,s=Object(U.a)(r.partitions);try{for(s.s();!(a=s.n()).done;){var o=a.value;if(o.tile.id===e.id){n._onPartitionMessage(i,o,e,t);break}}}catch(h){s.e(h)}finally{s.f()}}}))}}},{key:"_onPartitionMessage",value:function(e,t,r,n){var i=Object(w.a)(r.features,(function(e){return function(e,t){if(Object(w.g)(t.extent))return e;var r=t.offset,n=t.extent,i=Object(je.a)(n,4),a=i[0],s=i[1],o=i[2],u=i[3],c=Object(je.a)(r,2),l=c[0],h=c[1];return e.extent(a,s,o,u).transform(l,h)}(e,t)})),a=this._subscriptions.display.get(e),s=a.signal,o=a.update;a.didSend||(n="replace"),Object(w.h)(i)&&!i.seen&&(o=He.all(),i.seen=!0);var u=!1;r.end&&(t.resolved=!0,u=e===t.tile.id),a.didSend=!0,this.onDisplayTilePatch({type:n,id:e,version:_r++,update:o,addOrUpdate:i,remove:r.remove||[],noData:r.noData,end:u},{signal:s})}}]),e}();new Float64Array(2),new Float64Array(2);function xr(e,t,r,n){n%2&&(n+=1);for(var i=0,a=0,s=-90,o=90,u=-180,c=180,l=0;l<n/2;l++){for(var h=0;h<5;h++){var f=(u+c)/2,d=r>f?1:0;i|=d<<29-(h+5*l),u=(1-d)*u+d*f,c=(1-d)*f+d*c}for(var v=0;v<5;v++){var p=(s+o)/2,y=t>p?1:0;a|=y<<29-(v+5*l),s=(1-y)*s+y*p,o=(1-y)*p+y*o}}e.geohashX=i,e.geohashY=a}function wr(e,t,r,n,i){i%2&&(i+=1);for(var a=0,s=0,o=-90,u=90,c=-180,l=180,h=0;h<i/2;h++){for(var f=0;f<5;f++){var d=(c+l)/2,v=n>d?1:0;a|=v<<29-(f+5*h),c=(1-v)*c+v*d,l=(1-v)*d+v*l}for(var p=0;p<5;p++){var y=(o+u)/2,b=r>y?1:0;s|=b<<29-(p+5*h),o=(1-b)*o+b*y,u=(1-b)*y+b*u}}e[2*t]=a,e[2*t+1]=s}var Ir=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8096;Object(o.a)(this,e),this._nodes=0,this._root=new Sr(0,0,0),this._statisticFields=t,this._pool=r?new er(8096):null}return Object(u.a)(e,[{key:"_acquire",value:function(e,t,r){this._nodes++;var n=null;return Object(w.h)(this._pool)&&(n=this._pool.dequeue()),Object(w.h)(n)?n.realloc(e,t,r):new Sr(e,t,r)}},{key:"_release",value:function(e){this._nodes--,Object(w.h)(this._pool)&&this._pool.enqueue(e)}},{key:"count",get:function(){return this._root.count}},{key:"size",get:function(){return this._nodes}},{key:"poolSize",get:function(){return Object(w.k)(this._pool,0,(function(e){return e.size}))}},{key:"depth",get:function(){var e=0;return this._forEachNode((function(t){return e=Math.max(e,t.depth)})),e}},{key:"dropLevels",value:function(e){var t=this;this._forEachNode((function(r){if(r.depth>=e)for(var n=0;n<r.children.length;n++){var i=r.children[n];r.children[n]=null,i&&t._release(i)}}))}},{key:"clear",value:function(){this.dropLevels(0)}},{key:"insert",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=rt.fromOptimizedFeatures([e],"esriGeometryPoint").getCursor();n.next();var i=n.readGeometry();if(i){var a=Object(je.a)(i.coords,2),s=a[0],o=a[1],u=e.geohashX,c=e.geohashY;this.insertCursor(n,e.displayId,s,o,u,c,t,r)}}},{key:"insertCursor",value:function(e,t,r,n,i,a,s){for(var o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=this._root,c=0,l=0,h=0;null!==u;){if(u.depth>=o&&(u.count+=1,u.xTotal+=r,u.yTotal+=n,u.xGeohashTotal+=i,u.yGeohashTotal+=a,u.displayId=t,this._updateStatisticsCursor(e,u,1)),c>=s)return void u.add(t);var f=Math.ceil((c+1)/2),d=Math.floor((c+1)/2),v=1-c%2,p=30-(3*f+2*d),y=30-(2*f+3*d),b=(i&7*v+3*(1-v)<<p)>>p,g=(a&3*v+7*(1-v)<<y)>>y,_=b+g*(8*v+4*(1-v));l=l<<3*v+2*(1-v)|b,h=h<<2*v+3*(1-v)|g,null==u.children[_]&&(u.children[_]=this._acquire(l,h,c+1)),c+=1,u=u.children[_]}}},{key:"remove",value:function(e,t){var r=rt.fromOptimizedFeatures([e],"esriGeometryPoint").getCursor();r.next();var n=r.readGeometry();if(n){var i=Object(je.a)(n.coords,2),a=i[0],s=i[1],o=e.geohashX,u=e.geohashY;this.removeCursor(r,a,s,o,u,t)}}},{key:"removeCursor",value:function(e,t,r,n,i,a){for(var s=this._root,o=0;null!==s;){if(s.count-=1,s.xTotal-=t,s.yTotal-=r,s.xGeohashTotal-=n,s.yGeohashTotal-=i,this._updateStatisticsCursor(e,s,-1),o>=a)return void s.remove(e.getDisplayId());var u=Math.ceil((o+1)/2),c=Math.floor((o+1)/2),l=1-o%2,h=30-(3*u+2*c),f=30-(2*u+3*c),d=((n&7*l+3*(1-l)<<h)>>h)+((i&3*l+7*(1-l)<<f)>>f)*(8*l+4*(1-l)),v=s.children[d];1===v.count&&(this._release(v),s.children[d]=null),o+=1,s=v}}},{key:"find",value:function(e,t,r){return this._root.find(e,t,r,0,0,0)}},{key:"findSingleOccupancyNode",value:function(e,t,r,n,i){for(var a=this._root;null!==a;){var s=a.depth,o=a.xNode,u=a.yNode,c=1-s%2,l=a.xGeohashTotal/a.count,h=a.yGeohashTotal/a.count;if(1===a.count&&e<l&&l<=r&&t<h&&h<=n)return a;if(s>=i)a=a.next;else{for(var f=Math.ceil((s+1)/2),d=Math.floor((s+1)/2),v=30-(3*f+2*d),p=30-(2*f+3*d),y=~((1<<v)-1),b=~((1<<p)-1),g=(e&y)>>v,_=(t&b)>>p,m=(r&y)>>v,O=(n&b)>>p,k=o<<3*c+2*(1-c),j=u<<2*c+3*(1-c),x=k+8*c+4*(1-c),w=j+4*c+8*(1-c),I=Math.max(k,g),S=Math.max(j,_),F=Math.min(x,m),T=Math.min(w,O),C=null,A=null,E=S;E<=T;E++)for(var M=I;M<=F;M++){var R=M-k+(E-j)*(8*c+4*(1-c)),q=a.children[R];q&&(C||((C=q).next=a.next),A&&(A.next=q),A=q,q.next=a.next)}a=C||a.next}}return null}},{key:"getRegionDisplayIds",value:function(e,t,r,n,i){for(var a=this._root,s=[];null!==a;){var o=a.depth,u=a.xNode,c=a.yNode;if(o>=i){var l=a.xGeohashTotal/a.count,h=a.yGeohashTotal/a.count;e<=l&&l<=r&&t<=h&&h<=n&&a.displayIds.forEach((function(e){return s.push(e)})),a=a.next}else{for(var f=Math.ceil((o+1)/2),d=Math.floor((o+1)/2),v=1-o%2,p=30-(3*f+2*d),y=30-(2*f+3*d),b=~((1<<p)-1),g=~((1<<y)-1),_=(e&b)>>p,m=(t&g)>>y,O=(r&b)>>p,k=(n&g)>>y,j=u<<3*v+2*(1-v),x=c<<2*v+3*(1-v),w=j+8*v+4*(1-v),I=x+4*v+8*(1-v),S=Math.max(j,_),F=Math.max(x,m),T=Math.min(w,O),C=Math.min(I,k),A=null,E=null,M=F;M<=C;M++)for(var R=S;R<=T;R++){var q=R-j+(M-x)*(8*v+4*(1-v)),z=a.children[q];z&&(A||((A=z).next=a.next),E&&(E.next=z),E=z,z.next=a.next)}a=A||a.next}}return s}},{key:"getRegionStatistics",value:function(e,t,r,n,i){for(var a=this._root,s=0,o=0,u=0,c={},l=0;null!==a;){var h=a.depth,f=a.xNode,d=a.yNode;if(h>=i){var v=a.xGeohashTotal/a.count,p=a.yGeohashTotal/a.count;e<v&&v<=r&&t<p&&p<=n&&(s+=a.count,o+=a.xTotal,u+=a.yTotal,1===a.count&&(l=a.displayId),this._aggregateStatistics(c,a.statistics)),a=a.next}else{for(var y=Math.ceil((h+1)/2),b=Math.floor((h+1)/2),g=1-h%2,_=30-(3*y+2*b),m=30-(2*y+3*b),O=~((1<<_)-1),k=~((1<<m)-1),j=(e&O)>>_,x=(t&k)>>m,w=(r&O)>>_,I=(n&k)>>m,S=f<<3*g+2*(1-g),F=d<<2*g+3*(1-g),T=S+8*g+4*(1-g),C=F+4*g+8*(1-g),A=Math.max(S,j),E=Math.max(F,x),M=Math.min(T,w),R=Math.min(C,I),q=null,z=null,L=E;L<=R;L++)for(var N=A;N<=M;N++){var P=N-S+(L-F)*(8*g+4*(1-g)),D=a.children[P];if(D){if(L!==E&&L!==R&&N!==A&&N!==M){var G=D.xGeohashTotal/D.count,B=D.yGeohashTotal/D.count;e<G&&G<=r&&t<B&&B<=n&&(s+=D.count,o+=D.xTotal,u+=D.yTotal,1===D.count&&(l=D.displayId),this._aggregateStatistics(c,D.statistics));continue}q||((q=D).next=a.next),z&&(z.next=D),z=D,D.next=a.next}}a=q||a.next}}return{count:s,attributes:this._normalizeStatistics(c,s),xTotal:o,yTotal:u,referenceId:l}}},{key:"_forEachNode",value:function(e){for(var t=this._root;null!==t;){var r=this._linkChildren(t)||t.next;e(t),t=r}}},{key:"_linkChildren",value:function(e){for(var t=null,r=null,n=0;n<=e.children.length;n++){var i=e.children[n];i&&(t||((t=i).next=e.next),r&&(r.next=i),r=i,i.next=e.next)}return t}},{key:"_updateStatisticsCursor",value:function(e,t,r){var n,i=Object(U.a)(this._statisticFields);try{for(i.s();!(n=i.n()).done;){var a=n.value,s=a.name,o=a.inField?e.readAttribute(a.inField):e.getComputedNumericAtIndex(a.inFieldIndex);switch(a.statisticType){case"norm":t.statistics[s]||(t.statistics[s]={});var u=a.inNormalizationField,c=e.readAttribute(u),l=t.statistics[s].onStatisticField||0,h=t.statistics[s].onStatisticNormalizationField||0;null==o||isNaN(o)||null==c||0===c||isNaN(c)||(t.statistics[s].onStatisticField=l+r*o,t.statistics[s].onStatisticNormalizationField=h+r*c);break;case"sum":case"avg":t.statistics[s]||(t.statistics[s]={value:0,nanCount:0});var f=t.statistics[s].value,d=t.statistics[s].nanCount;null==o||isNaN(o)?t.statistics[s].nanCount=d+r:t.statistics[s].value=f+r*o;break;case"avg_angle":t.statistics[s]||(t.statistics[s]={x:0,y:0,nanCount:0});var v=t.statistics[s].x,p=t.statistics[s].y,y=t.statistics[s].nanCount,b=Math.PI/180;null==o||isNaN(o)?t.statistics[s].nanCount=y+r:(t.statistics[s].x=v+r*Math.cos(o*b),t.statistics[s].y=p+r*Math.sin(o*b));break;case"mode":t.statistics[s]||(t.statistics[s]={});var g=t.statistics[s][o]||0;t.statistics[s][o]=g+r}}}catch(_){i.e(_)}finally{i.f()}}},{key:"_aggregateStatistics",value:function(e,t){var r,n=Object(U.a)(this._statisticFields);try{for(n.s();!(r=n.n()).done;){var i=r.value,a=i.name;switch(i.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":for(var s in e[a]||(e[a]={}),t[a]){var o=e[a][s]||0;e[a][s]=o+t[a][s]}}}}catch(u){n.e(u)}finally{n.f()}}},{key:"_normalizeStatistics",value:function(e,t){var r,n={},i=Object(U.a)(this._statisticFields);try{for(i.s();!(r=i.n()).done;){var a=r.value,s=a.name;switch(a.statisticType){case"norm":var o=e[s];if(t&&null==o.onStatisticNormalizationField)break;if(t&&o.onStatisticNormalizationField){n[s]=o.onStatisticField/o.onStatisticNormalizationField;break}n[s]=0;break;case"sum":if(!t)break;var u=e[s],c=u.value;if(!(t-u.nanCount))break;n[s]=c;break;case"avg":if(!t)break;var l=e[s],h=l.value,f=l.nanCount;if(!(t-f))break;n[s]=h/(t-f);break;case"avg_angle":if(!t)break;var d=e[s],v=d.x,p=d.y,y=d.nanCount;if(!(t-y))break;var b=v/(t-y),g=p/(t-y),_=180/Math.PI,m=Math.atan2(g,b)*_;n[s]=m;break;case"mode":var O=e[s],k=0,j=null;for(var x in O){var w=O[x];w>k&&(k=w,j=x)}n[s]="null"===j?null:j}}}catch(I){i.e(I)}finally{i.f()}return n}}]),e}(),Sr=function(){function e(t,r,n){Object(o.a)(this,e),this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(var i=0;i<this.children.length;i++)this.children[i]=null;this.xNode=t,this.yNode=r,this.depth=n}return Object(u.a)(e,[{key:"realloc",value:function(e,t,r){for(var n=0;n<this.children.length;n++)this.children[n]=null;return this.xNode=e,this.yNode=t,this.depth=r,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}},{key:"add",value:function(e){this.displayIds.add(e)}},{key:"remove",value:function(e){this.displayIds.delete(e)}},{key:"getLngLatBounds",value:function(){var e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2),n=30-(3*t+2*r),i=30-(2*t+3*r);return function(e,t){for(var r=-90,n=90,i=-180,a=180,s=0;s<t;s++){for(var o=Math.ceil((s+1)/2),u=Math.floor((s+1)/2),c=1-s%2,l=30-(3*o+2*u),h=30-(2*o+3*u),f=3*c+2*(1-c),d=2*c+3*(1-c),v=3*c+7*(1-c)<<h,p=(7*c+3*(1-c)<<l&e.geohashX)>>l,y=(v&e.geohashY)>>h,b=f-1;b>=0;b--){var g=(i+a)/2,_=p&1<<b?1:0;i=(1-_)*i+_*g,a=(1-_)*g+_*a}for(var m=d-1;m>=0;m--){var O=(r+n)/2,k=y&1<<m?1:0;r=(1-k)*r+k*O,n=(1-k)*O+k*n}}return[i,r,a,n]}({geohashX:this.xNode<<n,geohashY:this.yNode<<i},this.depth)}},{key:"find",value:function(e,t,r,n,i,a){if(n>=r)return this;var s=1-n%2,o=3*s+2*(1-s),u=2*s+3*(1-s),c=30-i-o,l=30-a-u,h=((e&7*s+3*(1-s)<<c)>>c)+((t&3*s+7*(1-s)<<l)>>l)*(8*s+4*(1-s)),f=this.children[h];return null==f?null:f.find(e,t,r,n+1,i+o,a+u)}}]),e}(),Fr=r(1152),Tr=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e,n,i,a,s){var u;return Object(o.a)(this,r),(u=t.call(this,new Ct.a([],[n,i]),a,null,e)).geohashBoundsInfo=s,u}return Object(u.a)(r,[{key:"count",get:function(){return this.attributes.cluster_count}},{key:"update",value:function(e,t,r,n,i,a){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=r,this.attributes=n,this.geohashBoundsInfo=i,this.referenceId=null,this.referenceId=a,this}},{key:"toJSON",value:function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:Object(Ze.a)(Object(Ze.a)({},this.attributes),{},{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}],[{key:"create",value:function(e,t,n,i,a,s,o,u){var c=new r(t,n,i,s,o);return c.displayId=e.createDisplayId(!0),c.referenceId=u,c.tileLevel=a,c}}]),r}(Tt.a);function Cr(e){return 57.29577951308232*e}var Ar=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e,n,i){var a;return Object(o.a)(this,r),(a=t.call(this,e,i)).events=new Le.a,a._geohashLevel=0,a._aggregateValueRanges={},a._aggregateValueRangesChanged=!1,a._geohashBuf=[],a._clusters=new Map,a._tiles=new Map,a.geometryInfo=e.geometryInfo,a._spatialReference=n,a._projectionSupportCheck=Object(wt.a)(n,V.a.WGS84),a._bitsets.geohash=i.getBitset(i.createBitset()),a._bitsets.inserted=i.getBitset(i.createBitset()),a}return Object(u.a)(r,[{key:"updateSchema",value:function(){var e=Object(s.a)(a.a.mark((function e(t,n){var i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._schema,e.prev=1,e.next=4,Object(Ke.a)(Object(et.a)(r.prototype),"updateSchema",this).call(this,t,n);case 4:return e.next=6,this._projectionSupportCheck;case 6:e.next=10;break;case 8:e.prev=8,e.t0=e.catch(1);case 10:s=Object(yt.a)(i,n),t.mesh&&(t.targets.aggregate=!0),n&&(!Object(w.g)(s)||t.source||t.storage.filters)&&((Object(yt.b)(s,"params.fields")||!this._tree||t.source)&&(this._tree=new Ir(this._statisticFields),this._rebuildTree(),Object(f.a)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),Object(f.a)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",s),t.mesh=!0,t.targets[n.name]=!0,this._aggregateValueRanges={});case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"sweepFeatures",value:function(e,t){var r=this;this._bitsets.inserted.forEachSet((function(n){if(!e.has(n)){var i=t.lookupByDisplayIdUnsafe(n);r._remove(i)}}))}},{key:"sweepClusters",value:function(e,t,r){var n=this;this._clusters.forEach((function(i,a){i&&i.tileLevel!==r&&(e.releaseDisplayId(i.displayId),t.unsetAttributeData(i.displayId),n._clusters.delete(a))}))}},{key:"onTileData",value:function(e,t,r,n,i){if(!this._schema||Object(w.g)(t.addOrUpdate))return t;for(var a=this._tree,s=this._getTransforms(e,this._spatialReference),o=t.addOrUpdate.getCursor();o.next();)this._update(o,n,a);if(!i)return t;var u=new Array,c=this._schema.params.clusterRadius;this._getClustersForTile(u,e,c,r,a,s),t.type="replace"===t.type?"replace":"update",t.addOrUpdate=rt.fromOptimizedFeatures(u,"esriGeometryPoint"),t.addOrUpdate._storage=r;for(var l=t.addOrUpdate.getCursor();l.next();){var h=l.getDisplayId();this._bitsets.computed.unset(h),this.setComputedAttributes(r,l,h,e.scale)}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t}},{key:"onTileUpdate",value:function(e){var t=this,r=e.added,n=e.removed;if(r.length){var i=r[0].level;this._setGeohashLevel(i)}if(this._schema){var a=this._schema.params.clusterRadius;n.forEach((function(e){t._tiles.delete(e.key.id),t._markTileClustersForDeletion(e,a)}))}}},{key:"getAggregate",value:function(e){var t=null;return this._clusters.forEach((function(r){r&&r.displayId===e&&(t=r.toJSON())})),t}},{key:"getDisplayId",value:function(e){var t=this._clusters.get(e);return t?t.displayId:null}},{key:"getFeatureDisplayIdsForAggregate",value:function(e){var t=this._clusters.get(e);if(!t)return[];var r=t.geohashBoundsInfo;return this._tree.getRegionDisplayIds(r.xLL,r.yLL,r.xTR,r.yTR,r.level)}},{key:"getDisplayIdForReferenceId",value:function(e){var t;return this._clusters.forEach((function(r){r&&r.referenceId===e&&(t=r.displayId)})),t}},{key:"getAggregateValueRanges",value:function(){return this._aggregateValueRanges}},{key:"forEach",value:function(e){this._clusters.forEach((function(t,r){t&&e(t,r)}))}},{key:"size",value:function(){var e=0;return this.forEach((function(t){return e++})),e}},{key:"_rebuildTree",value:function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._bitsets.geohash.clear(),this._tree&&this._tree.clear()}},{key:"_remove",value:function(e){var t=e.getDisplayId(),r=e.getXHydrate(),n=e.getYHydrate(),i=this._geohashBuf[2*t],a=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,r,n,i,a,this._geohashLevel))}},{key:"_update",value:function(e,t,r){var n=e.getDisplayId(),i=this._bitsets.inserted,a=t.isVisible(n);if(a!==i.has(n))if(a){var s=e.getXHydrate(),o=e.getYHydrate();if(this._setGeohash(n,s,o)){var u=this._geohashBuf[2*n],c=this._geohashBuf[2*n+1];r.insertCursor(e,n,s,o,u,c,this._geohashLevel),i.set(n)}}else this._remove(e)}},{key:"_setGeohash",value:function(e,t,r){if(this._bitsets.geohash.has(e))return!0;var n=this._geohashBuf;if(this._spatialReference.isWebMercator){var i=Cr(t/Y.a.radius),a=i-360*Math.floor((i+180)/360);wr(n,e,Cr(Math.PI/2-2*Math.atan(Math.exp(-1*r/Y.a.radius))),a,12)}else{var s=Object(wt.b)({x:t,y:r},this._spatialReference,V.a.WGS84);if(!s)return!1;wr(n,e,s.y,s.x,12)}return this._bitsets.geohash.set(e),!0}},{key:"_getClustersForTile",value:function(e,t,r,n,i,a){for(var s=this,o=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],u=this._schema.params.clusterPixelBuffer,c=2*r,l=this._getGeohashLevel(t.key.level),h=Math.ceil(Math.pow(2,t.key.level)*gt.p/c),f=Math.ceil(u/c)+0,d=Math.ceil(gt.p/c),v=t.key,p=v.row,y=v.col,b=y*gt.p,g=p*gt.p,_=Math.floor(b/c)-f,m=Math.floor(g/c)-f,O=_+d+2*f,k=m+d+2*f,j=t.tileInfoView.getLODInfoAt(t.key.level),x=_;x<=O;x++)for(var I=function(r){var u=x;j.wrap&&(u=x<0?x+h:x%h);var c=j.wrap&&x<0,f=j.wrap&&x%h!==x,d=s._lookupCluster(n,j,t.key.level,u,r,l,i);if(Object(w.h)(d)){var v=Object(w.a)(a,(function(e){return c?e.left:f?e.right:e.tile}));if(o&&Object(w.g)(v))return"continue";if(!d.count)return"continue";if(Object(w.h)(v)&&o){var p=d.geometry.clone(),y=d.attributes;p.coords[0]=Object(Je.s)(v,p.coords[0]),p.coords[1]=Object(Je.t)(v,p.coords[1]),1===d.count&&Object(w.h)(d.referenceId)&&(y=Object(Ze.a)(Object(Ze.a)({},d.attributes),{},{referenceId:d.referenceId}));var b=new Tt.a(p,y);b.displayId=d.displayId,e.push(b)}}},S=m;S<=k;S++)I(S)}},{key:"_getGeohashLevel",value:function(e){return Math.min(Math.ceil(e/2+2),12)}},{key:"_setGeohashLevel",value:function(e){var t=this._getGeohashLevel(e),r=1*(Math.floor(t/1)+1)-1;if(this._geohashLevel!==r)return this._geohashLevel=r,void this._rebuildTree()}},{key:"_getTransforms",value:function(e,t){var r={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},n=Object(Q.d)(t);if(!n)return{tile:r,left:null,right:null};var i=Object(je.a)(n.valid,2),a=i[0],s=i[1];return{tile:r,left:Object(Ze.a)(Object(Ze.a)({},r),{},{translate:[s,e.bounds[3]]}),right:Object(Ze.a)(Object(Ze.a)({},r),{},{translate:[a-s+e.bounds[0],e.bounds[3]]})}}},{key:"_getClusterId",value:function(e,t,r){return(15&e)<<28|(16383&t)<<14|16383&r}},{key:"_markForDeletion",value:function(e,t,r){var n=this._getClusterId(e,t,r);this._clusters.delete(n)}},{key:"_getClusterBounds",value:function(e,t,r){var n=this._schema.params.clusterRadius,i=2*n,a=r%2?t*i:t*i-n,s=r*i,o=a+i,u=s-i,c=Math.pow(2,e.level)*gt.p;e.wrap&&a<0&&(a=0),e.wrap&&o>c&&(o=c);var l=a/gt.p,h=s/gt.p,f=o/gt.p,d=u/gt.p;return[e.getXForColumn(l),e.getYForRow(h),e.getXForColumn(f),e.getYForRow(d)]}},{key:"_lookupCluster",value:function(e,t,r,n,i,a,s){var o=this._getClusterId(r,n,i),u=this._clusters.get(o),c=this._getClusterBounds(t,n,i),l=Object(je.a)(c,4),h=l[0],f=l[1],d=l[2],v=l[3],p={x:h,y:f},y={x:d,y:v},b=0,g=0,_=0,m=0;if(this._spatialReference.isWebMercator){var O=Cr(p.x/Y.a.radius);b=O-360*Math.floor((O+180)/360),g=Cr(Math.PI/2-2*Math.atan(Math.exp(-1*p.y/Y.a.radius)));var k=Cr(y.x/Y.a.radius);_=k-360*Math.floor((k+180)/360),m=Cr(Math.PI/2-2*Math.atan(Math.exp(-1*y.y/Y.a.radius)))}else{var j=Object(wt.b)(p,this._spatialReference,V.a.WGS84),x=Object(wt.b)(y,this._spatialReference,V.a.WGS84);if(!j||!x)return null;b=j.x,g=j.y,_=x.x,m=x.y}var I={geohashX:0,geohashY:0},S={geohashX:0,geohashY:0};xr(I,g,b,a),xr(S,m,_,a);var F=I.geohashX,T=I.geohashY,C=S.geohashX,A=S.geohashY,E={xLL:F,yLL:T,xTR:C,yTR:A,level:a},M=s.getRegionStatistics(F,T,C,A,a),R=M.count,q=M.xTotal,z=M.yTotal,L=M.referenceId,N=R?q/R:0,P=R?z/R:0;if(0===R)return this._clusters.set(o,null),null;var D=Object(Ze.a)({cluster_count:R},M.attributes),G=Object(w.h)(u)?u.update(N,P,r,D,E,L):Tr.create(e,o,N,P,r,D,E,L);return 0===R&&(G.geometry.coords[0]=(h+d)/2,G.geometry.coords[1]=(f+v)/2),this._clusters.set(o,G),this._updateAggregateValueRangeForCluster(G,G.tileLevel),G}},{key:"_updateAggregateValueRangeForCluster",value:function(e,t){var r=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},n=r.minValue,i=r.maxValue;r.minValue=Math.min(n,e.count),r.maxValue=Math.max(i,e.count),this._aggregateValueRanges[t]=r,n===r.minValue&&i===r.maxValue||(this._aggregateValueRangesChanged=!0)}},{key:"_markTileClustersForDeletion",value:function(e,t){for(var r=2*t,n=Math.ceil(gt.p/r),i=e.key,a=i.row,s=i.col*gt.p,o=a*gt.p,u=Math.floor(s/r),c=Math.floor(o/r),l=u;l<u+n;l++)for(var h=c;h<c+n;h++)this._markForDeletion(e.key.level,l,h)}}]),r}(Fr.a);function Er(e){if(!Object(b.l)(e)&&!function(e){return"worker:port-closed"===e.name}(e))throw e}var Mr=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments))._storage=new ht,e._markedIdsBufId=e._storage.createBitset(),e._lastCleanup=performance.now(),e._cleanupNeeded=!1,e._invalidated=!1,e._tileToResolver=new Map,e.tileStore=null,e.config=null,e.processor=null,e.remoteClient=null,e.service=null,e._editing=!1,e}return Object(u.a)(r,[{key:"initialize",value:function(){var e=this;this._initAttributeStore(),this._initStores(),this._initQueryEngine(),this._initSource(),this._updateQueue=new st({concurrency:4,process:function(t,r){return e._onDisplayTilePatch(t,{signal:r})}}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),this.watch("updating",(function(t){return!t&&e.onIdle()}))])}},{key:"startup",value:function(){var e=Object(s.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this._initAttributeStore();case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_initSource",value:function(){var e=this;this._source=new jr(this.service,this.spatialReference,this.tileStore.tileScheme),this._source.onDisplayTilePatch=function(t,r){return e._invalidated=!0,e._patchTile(t,r)},this._source.canAcceptPatch=function(){return e._updateQueue.length<50};var t=this._source.sourceEvents;if("geoevent"===t.type){var r=t.events;this.handles.add([r.on("connectionStatus",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:t}).catch(Er)})),r.on("errorString",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"errorString",value:t}).catch(Er)})),r.on("feature",(function(t){return e.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry}}).catch(Er)})),r.on("updateRate",(function(t){return e.remoteClient.invoke("emitEvent",{name:"update-rate",event:Object(Ze.a)({},t)}).catch(Er)}))])}}},{key:"_initAttributeStore",value:function(){var e=this;this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new ot.a({type:"remote",initialize:function(t,r){return Object(b.k)(e.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",t,{signal:r}).catch(Er))},update:function(t,r){return Object(b.k)(e.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",t,{signal:r}).catch(Er))},render:function(t){return Object(b.k)(e.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:t}).catch(Er))}},this.config)}},{key:"_initStores",value:function(){var e=this,t={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new ft.a(t,this._storage),this.aggregateStore=new Ar(t,this.spatialReference,this._storage),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",(function(t){e.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:t.valueRanges}}).catch(Er)})))}},{key:"_initQueryEngine",value:function(){var e,t=this;null==(e=this.queryEngine)||e.destroy(),this.queryEngine=new dt.a({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:function(e){return t.aggregateStore.getFeatureDisplayIdsForAggregate(e).map((function(e){return t.getObjectId(e)}))}},timeInfo:this.service.timeInfo})}},{key:"destroy",value:function(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy()}},{key:"fieldsIndex",get:function(){return new $e.a(this.service.fields)}},{key:"hasAggregates",get:function(){return!!this.config.schema.targets.aggregate}},{key:"spatialReference",get:function(){return this.tileStore.tileScheme.spatialReference}},{key:"updating",get:function(){return this.isUpdating()}},{key:"isUpdating",value:function(){return this._source.updating||!!this._updateQueue.length}},{key:"enableEvent",value:function(e){this._source.enableEvent(e.name,e.value)}},{key:"invalidate",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n,i,s,o,u=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.any()){e.next=2;break}return e.abrupt("return");case 2:if(Object(f.a)("esri-2d-update-debug")&&t.describe(),r=this.tileStore.tiles.map((function(e){var t=e.key,r=Object(b.g)();return u._tileToResolver.set(t.id,r),r.promise})),n=this._updateQueue.takeAll(),this._updateQueue.resume(),!(this.hasAggregates&&t.mesh&&t.targets.aggregate)||t.queryFilter){e.next=9;break}this._repushAggregateMeshTiles(t),e.next=15;break;case 9:if(this._source.resubscribe(t),Object(b.b)(r).then((function(){u._source.resume()})),e.t0=t.mesh,!e.t0){e.next=15;break}return e.next=15,Object(We.g)(this,"updating");case 15:return this.notifyChange("updating"),e.next=18,Object(b.b)(r);case 18:this._updateQueue.pause(),i=Object(U.a)(n);try{for(i.s();!(s=i.n()).done;)o=s.value,this._patchTile(o)}catch(a){i.e(a)}finally{i.f()}t.source&&(this._cleanupNeeded=!0);case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"resume",value:function(){return this._updateQueue.resume(),this._source.resume()}},{key:"update",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.length>2&&void 0!==i[2]&&i[2],e.t0=this._editing,!e.t0){e.next=5;break}return e.next=5,Object(We.g)(this,"updating");case 5:return n&&(this._source.pause(),this._updateQueue.pause()),this._set("config",r),this._schema=r.schema,this._initQueryEngine(),e.next=11,Object(b.b)([this._source.update(t,r.schema.source),this.featureStore.updateSchema(t,r.schema.targets.feature),this.attributeStore.update(t,r),this.attributeStore.updateFilters(t,this)]);case 11:return e.next=13,this.aggregateStore.updateSchema(t,r.schema.targets.aggregate);case 13:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"refresh",value:function(){var e=Object(s.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._source.resubscribe(He.all(),!0),this._cleanupNeeded=!0,this.notifyChange("updating"),e.next=5,Object(We.g)(this,"updating",!0);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"onTileUpdate",value:function(e){this.aggregateStore.onTileUpdate(e);var t,r=Object(U.a)(e.added);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._source.subscribe(n),this._level=n.level}}catch(o){r.e(o)}finally{r.f()}var i,a=Object(U.a)(e.removed);try{for(a.s();!(i=a.n()).done;){var s=i.value;this._source.unsubscribe(s),this._cleanupNeeded=!0,this._tileToResolver.has(s.id)&&(this._tileToResolver.get(s.id).resolve(),this._tileToResolver.delete(s.id))}}catch(o){a.e(o)}finally{a.f()}this.notifyChange("updating")}},{key:"onIdle",value:function(){this.hasAggregates&&this._invalidated&&(this._repushAggregateMeshTiles(),this._invalidated=!1),this._markAndSweep()}},{key:"onEdits",value:function(){var e=Object(s.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._editing){e.next=6;break}return e.next=3,Object(We.g)(this,"updating");case 3:return e.next=5,Object(b.a)(16);case 5:return e.abrupt("return",this.onEdits(t));case 6:return this._editing=!0,e.prev=7,e.next=10,this._source.onEdits(t);case 10:return e.next=12,Object(We.g)(this,"updating");case 12:e.next=16;break;case 14:e.prev=14,e.t0=e.catch(7);case 16:this._editing=!1;case 17:case"end":return e.stop()}}),e,this,[[7,14]])})));return function(t){return e.apply(this,arguments)}}()},{key:"queryExtent",value:function(e){return this.queryEngine.executeQueryForExtent(e)}},{key:"queryFeatures",value:function(e){return this.queryEngine.executeQuery(e)}},{key:"queryFeatureCount",value:function(e){return this.queryEngine.executeQueryForCount(e)}},{key:"queryLatestObservations",value:function(e){return this.queryEngine.executeQueryForLatestObservations(e)}},{key:"queryObjectIds",value:function(e){return this.queryEngine.executeQueryForIds(e)}},{key:"queryStatistics",value:function(){var e=Object(s.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(Ze.a)(Object(Ze.a)({},this.featureStore.storeStatistics),{},{displayedFeatureCount:0,displayedVertexCount:0,displayPreProcessTime:0}));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getObjectId",value:function(e){return this.featureStore.lookupObjectId(e,this._storage)}},{key:"getDisplayId",value:function(e){if(this._schema.targets.aggregate){var t=this.aggregateStore.getDisplayId(e);if(Object(w.g)(t)){var r=this.featureStore.lookupDisplayId(e);return this.aggregateStore.getDisplayIdForReferenceId(r)}return t}return this.featureStore.lookupDisplayId(e)}},{key:"getFeature",value:function(e){var t=this.featureStore.lookupFeatureByDisplayId(e,this._storage);if(Object(w.g)(t))return null;var r=t.readHydratedGeometry(),n=Object(Je.h)(r,t.geometryType,t.hasZ,t.hasM);return{attributes:t.readAttributes(),geometry:n}}},{key:"getAggregate",value:function(e){return this.aggregateStore.getAggregate(e)}},{key:"setHighlight",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.map((function(e){return n.getDisplayId(e)})),e.abrupt("return",this.attributeStore.setHighlight(t,r));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_repushAggregateMeshTiles",value:function(e){var t,r=Object(U.a)(this.tileStore.tiles);try{for(r.s();!(t=r.n()).done;){var n=t.value;this._patchTile({type:"replace",id:n.key.id,addOrUpdate:rt.fromOptimizedFeatures([],this.service.geometryType),remove:[],end:!0,noData:!1,update:e||He.create({mesh:!0,targets:{aggregate:!0}})})}}catch(i){r.e(i)}finally{r.f()}}},{key:"_maybeForceCleanup",value:function(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}},{key:"_patchTile",value:function(e,t){var r=this,n=this._updateQueue.push(e,t).then((function(){r.notifyChange("updating")})).catch((function(e){r.notifyChange("updating")}));return this.notifyChange("updating"),n}},{key:"_onDisplayTilePatch",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i,s,o,u,c,l,h;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(b.u)(r),n=this.tileStore.get(t.id)){e.next=4;break}return e.abrupt("return");case 4:i=t.update,t.remove.length&&(this._cleanupNeeded=!0),s=[],o=Object(U.a)(t.remove);try{for(o.s();!(u=o.n()).done;)c=u.value,s.push(this.featureStore.lookupDisplayId(c))}catch(a){o.e(a)}finally{o.f()}if(t.remove=s,e.prev=10,!Object(w.g)(t.addOrUpdate)){e.next=13;break}return e.abrupt("return",(this.processor.onTileData(n,Object(Ze.a)(Object(Ze.a)({},t),{},{addOrUpdate:null}),r).catch((function(e){Object(b.v)(e)})),void this._finishedPatch(t)));case 13:if(t.addOrUpdate._storage=this._storage,l=t.addOrUpdate.hasFilter(),h=t.addOrUpdate.instance,t.addOrUpdate._arcadeSpatialReference=this.spatialReference,(!this.featureStore.hasInstance(h)||i.targets.feature&&!l)&&this.featureStore.onTileData(n,t,this._storage),e.t0=!i.storage.data&&!i.storage.filters||l,e.t0){e.next=26;break}if(this.attributeStore.onTileData(n,t),!this._source.isStream){e.next=25;break}return e.next=23,this.attributeStore.sendUpdates();case 23:e.next=26;break;case 25:this.attributeStore.sendUpdates();case 26:if(e.t1=this.hasAggregates&&i.targets.aggregate,!e.t1){e.next=34;break}if(this.aggregateStore.onTileData(n,t,this._storage,this.attributeStore,i.mesh),e.t2=i.mesh,!e.t2){e.next=34;break}return this.attributeStore.onTileData(n,t),e.next=34,this.attributeStore.sendUpdates();case 34:if(e.t3=i.mesh,!e.t3){e.next=38;break}return e.next=38,this.processor.onTileData(n,t,r);case 38:this._maybeForceCleanup(),this._finishedPatch(t),e.next=45;break;case 42:e.prev=42,e.t4=e.catch(10),Object(b.v)(e.t4);case 45:case"end":return e.stop()}}),e,this,[[10,42]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_finishedPatch",value:function(e){(e.noData||e.end)&&this._tileToResolver.has(e.id)&&(this._tileToResolver.get(e.id).resolve(),this._tileToResolver.delete(e.id))}},{key:"_markAndSweep",value:function(){var e=this;if(this._lastCleanup=performance.now(),this._cleanupNeeded||this._source.isStream){this._cleanupNeeded=!1;var t=this._storage.getBitset(this._markedIdsBufId),r=new Set;t.clear();var n,i=function(n){var i=e.featureStore.lookupDisplayId(n),a=(4294901760&e._storage.getInstanceId(i))>>>16;i&&(r.add(a),t.set(i))},a=Object(U.a)(this.tileStore.tiles);try{for(a.s();!(n=a.n()).done;){var s=n.value;this._source.forEachRequest(s.key.id,(function(e){if(!Object(w.g)(e.features))for(var t=e.features.getCursor();t.next();){var r=t.getObjectId();i(r)}}))}}catch(o){a.e(o)}finally{a.f()}this._source.forEachPendingEdit((function(e){return i(e)})),this._updateQueue.forEach((function(e){var t,r=Object(U.a)(e.remove);try{for(r.s();!(t=r.n()).done;){var n=t.value;i(n)}}catch(o){r.e(o)}finally{r.f()}})),this.config.schema.targets.aggregate&&(this.aggregateStore.sweepFeatures(t,this.featureStore),this.aggregateStore.sweepClusters(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(t,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(r)}}}]),r}(g.a);Object(h.a)([Object(p.b)({constructOnly:!0})],Mr.prototype,"tileStore",void 0),Object(h.a)([Object(p.b)()],Mr.prototype,"config",void 0),Object(h.a)([Object(p.b)({readOnly:!0,dependsOn:["service"]})],Mr.prototype,"fieldsIndex",null),Object(h.a)([Object(p.b)()],Mr.prototype,"processor",void 0),Object(h.a)([Object(p.b)({constructOnly:!0})],Mr.prototype,"remoteClient",void 0),Object(h.a)([Object(p.b)({constructOnly:!0})],Mr.prototype,"service",void 0),Object(h.a)([Object(p.b)({dependsOn:["tileStore"]})],Mr.prototype,"spatialReference",null),Object(h.a)([Object(p.b)()],Mr.prototype,"updating",null);var Rr=Mr=Object(h.a)([Object(y.a)("esri.views.2d.layers.features.controllers.FeatureController2D")],Mr),qr=new Set;function zr(){return qr}var Lr=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).controller=null,e.processor=null,e.remoteClient=null,e.tileStore=null,e.service=null,e.viewState=null,e}return Object(u.a)(r,[{key:"initialize",value:function(){var e=this;this.handles.add(this.watch("updating",(function(t){e.remoteClient.invoke("setUpdating",t).catch((function(e){}))})))}},{key:"destroy",value:function(){var e,t,r;null==(e=this.controller)||e.destroy(),null==(t=this.processor)||t.destroy(),null==(r=this.tileStore)||r.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}},{key:"updating",get:function(){return!this.controller||this.controller.updating}},{key:"startup",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.service,n=t.config,i=t.tileInfo,this.service=r,this.tileStore||(s=new ze(_.a.fromJSON(i)),this.tileStore=new Ye(s)),e.next=4,this._configure(n);case 4:this.tileStore.clear();case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateTiles",value:function(){var e=Object(s.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.tileStore.updateTiles(t);case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.config,n=t.pause,i=He.empty(),e.next=4,Object(b.b)([this.processor.update(i,r),this.controller.update(i,r,n)]);case 4:return e.abrupt("return",i.toJSON());case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"invalidate",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=He.create(t),n=this.controller.invalidate(r),e.next=3,this.remoteClient.invoke("setUpdating",this.updating);case 3:return e.abrupt("return",n);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setViewState",value:function(e){var t=ke.fromJSON(e);this._set("viewState",t)}},{key:"_configure",value:function(){var e=Object(s.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(b.b)([this._handleControllerConfig(t),this._handleProcessorConfig(t)]);case 2:return this.controller.processor=this.processor,e.next=5,this.update({config:t});case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_handleControllerConfig",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._createController(this.service,t);case 2:return r=e.sent,e.next=5,r.startup();case 5:return e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_handleProcessorConfig",value:function(){var e=Object(s.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._createProcessor(this.service,t));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_createController",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i,s;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.controller&&this.controller.destroy(),n=this.tileStore,i=this.remoteClient,s=new Rr({service:t,config:r,tileStore:n,remoteClient:i}),e.abrupt("return",(this.controller=s,s));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_createProcessor",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var n,i,s,o,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.schema.processors[0].type,e.next=3,Xe(n);case 3:return i=e.sent.default,s=this.remoteClient,o=this.tileStore,u=new i({service:t,config:r,tileStore:o,remoteClient:s}),e.abrupt("return",(this.processor&&this.processor.destroy(),this.processor=u,u));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(g.a);Object(h.a)([Object(p.b)()],Lr.prototype,"controller",void 0),Object(h.a)([Object(p.b)()],Lr.prototype,"processor",void 0),Object(h.a)([Object(p.b)({dependsOn:["controller.updating"]})],Lr.prototype,"updating",null),Object(h.a)([Object(p.b)()],Lr.prototype,"viewState",void 0);var Nr=Lr=Object(h.a)([Object(y.a)("esri.views.2d.layers.features.Pipeline")],Lr);t.default=Nr},980:function(e,t,r){"use strict";var n,i,a,s,o,u,c;r.d(t,"a",(function(){return s})),r.d(t,"b",(function(){return n})),r.d(t,"c",(function(){return o})),r.d(t,"d",(function(){return u})),function(e){e[e.FILL=0]="FILL",e[e.LINE=1]="LINE",e[e.MARKER=2]="MARKER",e[e.TEXT=3]="TEXT",e[e.LABEL=4]="LABEL"}(n||(n={})),function(e){e[e.SUCCEEDED=0]="SUCCEEDED",e[e.FAILED_OUT_OF_MEMORY=1]="FAILED_OUT_OF_MEMORY"}(i||(i={})),function(e){e[e.NONE=0]="NONE",e[e.MAP=1]="MAP",e[e.LABEL=2]="LABEL",e[e.LABEL_ALPHA=4]="LABEL_ALPHA",e[e.HITTEST=8]="HITTEST",e[e.HIGHLIGHT=16]="HIGHLIGHT",e[e.CLIP=32]="CLIP",e[e.DEBUG=64]="DEBUG",e[e.NUM_DRAW_PHASES=9]="NUM_DRAW_PHASES"}(a||(a={})),function(e){e[e.SIZE=0]="SIZE",e[e.COLOR=1]="COLOR",e[e.OPACITY=2]="OPACITY",e[e.ROTATION=3]="ROTATION"}(s||(s={})),function(e){e[e.NONE=0]="NONE",e[e.OPACITY=1]="OPACITY",e[e.COLOR=2]="COLOR",e[e.ROTATION=4]="ROTATION",e[e.SIZE_MINMAX_VALUE=8]="SIZE_MINMAX_VALUE",e[e.SIZE_SCALE_STOPS=16]="SIZE_SCALE_STOPS",e[e.SIZE_FIELD_STOPS=32]="SIZE_FIELD_STOPS",e[e.SIZE_UNIT_VALUE=64]="SIZE_UNIT_VALUE"}(o||(o={})),function(e){e[e.MINMAX_TARGETS_OUTLINE=128]="MINMAX_TARGETS_OUTLINE",e[e.SCALE_TARGETS_OUTLINE=256]="SCALE_TARGETS_OUTLINE",e[e.FIELD_TARGETS_OUTLINE=512]="FIELD_TARGETS_OUTLINE",e[e.UNIT_TARGETS_OUTLINE=1024]="UNIT_TARGETS_OUTLINE"}(u||(u={})),function(e){e[e.SPRITE=0]="SPRITE",e[e.GLYPH=1]="GLYPH"}(c||(c={}))},982:function(e,t,r){"use strict";r.d(t,"a",(function(){return i})),r.d(t,"b",(function(){return a}));var n=new Float32Array(1);new Uint32Array(n.buffer);function i(e,t){return 65535&e|t<<16}function a(e,t,r,n){return 255&e|(255&t)<<8|(255&r)<<16|n<<24}},983:function(e,t,r){"use strict";r.d(t,"a",(function(){return o})),r.d(t,"b",(function(){return s})),r.d(t,"c",(function(){return u})),r.d(t,"d",(function(){return c}));var n=r(32),i=r(982);function a(e,t){return Array.isArray(t)?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]):(e[0]=t.r,e[1]=t.g,e[2]=t.b,e[3]=t.a),e}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=e[t+3];return e[t+0]*=n,e[t+1]*=n,e[t+2]*=n,r||(e[t+3]*=255),e}function o(e){return s(a([],e))}function u(e){if(!e)return 0;var t=e.r,r=e.g,n=e.b,a=e.a;return Object(i.b)(t*a,r*a,n*a,255*a)}function c(e){if(!e)return 0;var t=Object(n.a)(e,4),r=t[0],a=t[1],s=t[2],o=t[3];return Object(i.b)(r*(o/255),a*(o/255),s*(o/255),o)}}}]);
//# sourceMappingURL=26.bf987a1c.chunk.js.map