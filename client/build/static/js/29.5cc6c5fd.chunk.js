(this["webpackJsonpqp-ampd-app"]=this["webpackJsonpqp-ampd-app"]||[]).push([[29,19,30,50,126],{1083:function(e,t,n){"use strict";n.r(t),n.d(t,"constructAssociationMetaDataFeatureSetFromUrl",(function(){return ne})),n.d(t,"constructFeatureSet",(function(){return ee})),n.d(t,"constructFeatureSetFromPortalItem",(function(){return ce})),n.d(t,"constructFeatureSetFromRelationship",(function(){return re})),n.d(t,"constructFeatureSetFromUrl",(function(){return $})),n.d(t,"createFeatureSetCollectionFromMap",(function(){return se})),n.d(t,"createFeatureSetCollectionFromService",(function(){return le})),n.d(t,"getPortal",(function(){return ue})),n.d(t,"initialiseMetaDataCache",(function(){return Z})),n.d(t,"lookupUser",(function(){return oe}));var r=n(11),a=n(2),i=n(4),s=n(5),l=n(6),u=n(15),o=n(16),c=n(94),f=n(59),d=n(85),h=n(289),p=n(866),y=n(981),v=n(908),_=n(852),g=n(927),b=n(928),m=n(39),O=n(242),j=n(867),w=n(320),S=n(869),F=n(875),k=n(893),I=n(426),x=n(871),D=n(982),T=n(929),C=function(){function e(){Object(a.a)(this,e)}return Object(i.a)(e,[{key:"clone",value:function(){var t=new e;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}},{key:"toStatisticsName",value:function(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg";default:return"count"}}}],[{key:"parseStatField",value:function(t,n,r){var a=new e;a.field=t;var i=_.WhereClause.create(n,r),s=function(e){if("function"===e.parseTree.type){if(0===e.parseTree.args.value.length)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");var t=_.WhereClause.create(Object(F.j)(e.parseTree.args.value[0],p.a.Standardised,e.parameters),e.fieldsIndex);return{name:e.parseTree.name,expr:t}}return null}(i);if(null===s)throw new Error("Invalid Statistic Function");var l=s.name.toUpperCase().trim();if("MIN"===l){if(a.typeofstat="MIN",a.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===l){if(a.typeofstat="MAX",a.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===l)a.typeofstat="COUNT",a.workingexpr=s.expr;else if("STDEV"===l){if(a.typeofstat="STDDEV",a.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===l){if(a.typeofstat="SUM",a.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===l){if(a.typeofstat="AVG",a.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===l){if(a.typeofstat="AVG",a.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==l)throw new Error("Invalid Statistic Function");if(a.typeofstat="VAR",a.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}return a}}]),e}(),E=n(909);function R(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}var N=function(e){Object(s.a)(n,e);var t=Object(l.a)(n);function n(e){var r;return Object(a.a)(this,n),(r=t.call(this,e))._decodedStatsfield=[],r._decodedGroupbyfield=[],r._candosimplegroupby=!0,r.phsyicalgroupbyfields=[],r.objectIdField="ROW__ID",r._internalObjectIdField="ROW__ID",r._adaptedFields=[],r.declaredClass="esri.arcade.featureset.actions.Aggregate",r._uniqueIds=1,r._maxQuery=10,r._maxProcessing=10,r._parent=e.parentfeatureset,r._config=e,r}return Object(i.a)(n,[{key:"isTable",value:function(){return!0}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._getFilteredSet("",null,null,null,e).then((function(e){return t._wset=e,t._wset})):Object(o.s)(this._wset)}},{key:"_isInFeatureSet",value:function(){return p.b.InFeatureSet}},{key:"nextUniqueName",value:function(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;var t="T"+this._uniqueIds.toString();return e[t]=1,t}},{key:"convertToEsriFieldType",value:function(e){return e}},{key:"_initialiseFeatureSet",value:function(){var e={},t=!1,n=1,r=this._parent?this._parent.getFieldsIndex():new I.a([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){for(var a=!1,i=0;i<this._config.groupbyfields.length;i++)if(this._config.groupbyfields[i].name.toLowerCase()===this.objectIdField.toLowerCase()){a=!0;break}if(!1===a)for(var s=0;s<this._config.statsfields.length;s++)if(this._config.statsfields[s].name.toLowerCase()===this.objectIdField.toLowerCase()){a=!0;break}!1===a?t=!0:(this.objectIdField="ROW__ID"+n.toString(),n++)}var l,o=Object(u.a)(this._config.statsfields);try{for(o.s();!(l=o.n()).done;){var c=l.value,f=new C;f.field=c.name,f.tofieldname=c.name,f.workingexpr=c.expression instanceof _.WhereClause?c.expression:_.WhereClause.create(c.expression,r),f.typeofstat=R(c.statistic),this._decodedStatsfield.push(f)}}catch(U){o.e(U)}finally{o.f()}this._decodedGroupbyfield=[];var d,h=Object(u.a)(this._config.groupbyfields);try{for(h.s();!(d=h.n()).done;){var y=d.value,v={name:y.name,singlefield:null,tofieldname:y.name,expression:y.expression instanceof _.WhereClause?y.expression:_.WhereClause.create(y.expression,r)};this._decodedGroupbyfield.push(v)}}catch(U){h.e(U)}finally{h.f()}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";var g,b=Object(u.a)(this._parent.fields);try{for(b.s();!(g=b.n()).done;){e[g.value.name.toUpperCase()]=1}}catch(U){b.e(U)}finally{b.f()}this.types=null}else this.geometryType=p.m.point,this.typeIdField="",this.types=null,this.spatialReference=new m.a({wkid:4326});this.fields=[];var O=new C;O.field=this.nextUniqueName(e),O.tofieldname=this.objectIdField,O.workingexpr=_.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),O.typeofstat="MIN",this._decodedStatsfield.push(O);var j,S=Object(u.a)(this._decodedGroupbyfield);try{for(S.s();!(j=S.n()).done;){var k=j.value,x=new w.a;if(k.name=this.nextUniqueName(e),x.name=k.tofieldname,x.alias=x.name,Object(F.c)(k.expression)){var T=this._parent.getField(Object(F.i)(k.expression,p.a.Standardised));if(!T)throw new Error("Field is not present for Aggregation");k.name=T.name,k.singlefield=T.name,this.phsyicalgroupbyfields.push(T.name),x.type=T.type}else{x.type=this.convertToEsriFieldType(Object(F.f)(k.expression,this._parent.fields));var E=new w.a;E.name=k.name,E.alias=E.name,this.phsyicalgroupbyfields.push(k.name),this._adaptedFields.push(new D.d(E,k.expression)),this._candosimplegroupby=!1}this.fields.push(x)}}catch(U){S.e(U)}finally{S.f()}if(this._adaptedFields.length>0){var N,A=Object(u.a)(this._parent.fields);try{for(A.s();!(N=A.n()).done;){var P=N.value;this._adaptedFields.push(new D.c(P))}}catch(U){A.e(U)}finally{A.f()}}for(var L=0;L<this._decodedStatsfield.length;L++){var G=new w.a,B=null,q=this._decodedStatsfield[L];q.field=this.nextUniqueName(e),q.tofieldname===this.objectIdField&&(this._internalObjectIdField=q.field),G.name=q.tofieldname,G.alias=G.name;var M=null!==q.workingexpr&&Object(F.c)(q.workingexpr)?Object(F.i)(q.workingexpr,p.a.Standardised):"";switch(this._decodedStatsfield[L].typeofstat){case"SUM":if(""!==M){if(!(B=this._parent.getField(M)))throw new Error("Field is not present for Aggregation");G.type=B.type}else G.type="double";break;case"MIN":case"MAX":if(""!==M){if(!(B=this._parent.getField(M)))throw new Error("Field is not present for Aggregation");G.type=B.type}else G.type="double";break;case"COUNT":G.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==M&&!(B=this._parent.getField(M)))throw new Error("Field is not present for Aggregation");G.type="double"}this.fields.push(G)}}},{key:"_canDoAggregates",value:function(){return Object(o.s)(!1)}},{key:"_getFeatures",value:function(e,t,n,r){var a=this;-1!==t&&this._featureCache[t];var i=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,i)?this._expandPagedSet(e,i,0,0,r).then((function(){return a._getFeatures(e,t,n,r)})):Object(o.s)("success")}},{key:"_getFilteredSet",value:function(e,t,n,r,a){var i=this;if(""!==e)return Object(o.s)(new S.a([],[],!0,null));var s=null,l={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then((function(){if(null!==n)for(var e=0;e<i._decodedStatsfield.length;e++)if(!0===Object(F.h)(n,i._decodedStatsfield[e].tofieldname)){l.nowhereclause=!0,n=null;break}if(null!==r){l.ordered=!0;for(var t=0;t<i._decodedStatsfield.length;t++)if(!0===r.scanForField(i._decodedStatsfield[t].tofieldname)){r=null,l.ordered=!1;break}if(null!==r){var a,s=Object(u.a)(i._decodedGroupbyfield);try{for(s.s();!(a=s.n()).done;){var c=a.value;if(null===c.singlefield&&!0===r.scanForField(c.tofieldname)){r=null,l.ordered=!1;break}}}catch(f){s.e(f)}finally{s.f()}}}return!1===i._candosimplegroupby?Object(o.s)(!1):i._parent._canDoAggregates(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,null)})).then((function(e){if(e){var t=null;n&&(t=i._reformulateWhereClauseWithoutGroupByFields(n));var u=null;return r&&(u=i._reformulateOrderClauseWithoutGroupByFields(r)),i._parent._getAggregatePagesDataSourceDefinition(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,t,u,i._internalObjectIdField).then((function(e){return i._checkCancelled(a),s=!0===l.nowhereclause?new S.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===l.ordered&&e._ordered,i._clonePageDefinition(e.pagesDefinition)):new S.a(e._candidates.slice(0),e._known.slice(0),!0===l.ordered&&e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}var o=i._parent;if(i._adaptedFields.length>0&&(o=new D.a({parentfeatureset:i._parent,adaptedFields:i._adaptedFields,extraFilter:null})),!0===l.nowhereclause)s=new S.a(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new b.a({parentfeatureset:o,orderbyclause:new T.a(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}});else{var c=o;if(null!==n){var f=null;n&&(f=i._reformulateWhereClauseWithoutGroupByFields(n)),c=new g.a({parentfeatureset:c,whereclause:f})}s=new S.a(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new b.a({parentfeatureset:c,orderbyclause:new T.a(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}})}return s}))}},{key:"_reformulateWhereClauseWithoutStatsFields",value:function(e){var t,n=Object(u.a)(this._decodedStatsfield);try{for(n.s();!(t=n.n()).done;){var r=t.value;e=Object(F.g)(e,r.tofieldname,Object(F.i)(r.workingexpr,p.a.Standardised),this._parent.getFieldsIndex())}}catch(a){n.e(a)}finally{n.f()}return e}},{key:"_reformulateWhereClauseWithoutGroupByFields",value:function(e){var t,n=Object(u.a)(this._decodedGroupbyfield);try{for(n.s();!(t=n.n()).done;){var r=t.value;r.tofieldname!==r.name&&(e=Object(F.g)(e,r.tofieldname,Object(F.i)(r.expression,p.a.Standardised),this._parent.getFieldsIndex()))}}catch(a){n.e(a)}finally{n.f()}return e}},{key:"_reformulateOrderClauseWithoutGroupByFields",value:function(e){var t,n=[],r=Object(u.a)(this._decodedGroupbyfield);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.tofieldname!==a.name&&n.push({field:a.tofieldname,newfield:a.name})}}catch(i){r.e(i)}finally{r.f()}return n.length>0?e.replaceFields(n):e}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}},{key:"_refineSetBlock",value:function(e,t,n){var r=this;try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery))return this._expandPagedSet(e,this._maxQuery,0,0,n).then((function(){return r._refineSetBlock(e,t,n)}));this._checkCancelled(n);e._candidates.length;return this._refineKnowns(e,t),e._candidates.length,e._candidates.length,Object(o.s)(e)}catch(a){return Object(o.r)(a)}}},{key:"_expandPagedSet",value:function(e,t,n,r,a){return this._expandPagedSetFeatureSet(e,t,n,r,a)}},{key:"_getPhysicalPage",value:function(e,t,n){var r=this;return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?Object(o.c)((function(t,a){r._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,n,[]).then((function(e){t(e)}),a)})):this._getAgregagtePhysicalPage(e,t,n).then((function(e){var t,n=Object(u.a)(e);try{for(n.s();!(t=n.n()).done;){var a,i=t.value,s={geometry:i.geometry,attributes:{}},l=Object(u.a)(r._decodedGroupbyfield);try{for(l.s();!(a=l.n()).done;){var o=a.value;s.attributes[o.tofieldname]=i.attributes[o.name]}}catch(h){l.e(h)}finally{l.f()}var c,f=Object(u.a)(r._decodedStatsfield);try{for(f.s();!(c=f.n()).done;){var d=c.value;s.attributes[d.tofieldname]=i.attributes[d.field]}}catch(h){f.e(h)}finally{f.f()}r._featureCache[s.attributes[r.objectIdField]]=new O.a(s)}}catch(h){n.e(h)}finally{n.f()}return e.length}))}},{key:"_sequentialGetPhysicalItem",value:function(e,t,n,r){var a=this;return Object(o.c)((function(i,s){null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(n)),!0===e.pagesDefinition.internal.fullyResolved||0===t?i(r.length):a._nextAggregateItem(e,t,n,r,(function(s){null===s?i(r.length):(t-=1,i(a._sequentialGetPhysicalItem(e,t,n,r)))}),s)}))}},{key:"_nextAggregateItem",value:function(e,t,n,r,a,i){var s=this;try{Object(j.q)(e.pagesDefinition.internal.iterator.next()).then((function(l){if(null===l)if(null!==e.pagesDefinition.internal.workingItem){var u=s._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(u),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(u.attributes[s.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,a(null)}else e.pagesDefinition.internal.fullyResolved=!0,a(null);else{var o=s._generateAggregateHash(l);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[l],id:o};else{if(o!==e.pagesDefinition.internal.workingItem.id){var c=s._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return r.push(c),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(c.attributes[s.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[l],id:o},void a(c)}e.pagesDefinition.internal.workingItem.features.push(l)}s._nextAggregateItem(e,t,n,r,a,i)}}),i)}catch(e){i(e)}}},{key:"_calculateFieldStat",value:function(e,t,n){for(var r=[],a=0;a<e.features.length;a++)if(null!==t.workingexpr){var i=t.workingexpr.calculateValue(e.features[a]);null!==i&&r.push(i)}else r.push(null);switch(t.typeofstat){case"MIN":n.attributes[t.tofieldname]=Object(k.a)("min",r,-1);break;case"MAX":n.attributes[t.tofieldname]=Object(k.a)("max",r,-1);break;case"SUM":n.attributes[t.tofieldname]=Object(k.a)("sum",r,-1);break;case"COUNT":n.attributes[t.tofieldname]=r.length;break;case"VAR":n.attributes[t.tofieldname]=Object(k.a)("var",r,-1);break;case"STDDEV":n.attributes[t.tofieldname]=Object(k.a)("stddev",r,-1);break;case"AVG":n.attributes[t.tofieldname]=Object(k.a)("avg",r,-1)}return!0}},{key:"_calculateAndAppendAggregateItem",value:function(e){var t,n={attributes:{},geometry:null},r=Object(u.a)(this._decodedGroupbyfield);try{for(r.s();!(t=r.n()).done;){var a=t.value,i=a.singlefield?e.features[0].attributes[a.singlefield]:a.expression.calculateValue(e.features[0]);n.attributes[a.tofieldname]=i}}catch(d){r.e(d)}finally{r.f()}var s,l=Object(u.a)(this._decodedStatsfield);try{for(l.s();!(s=l.n()).done;){var o=s.value;this._calculateFieldStat(e,o,n)}}catch(d){l.e(d)}finally{l.f()}for(var c=[],f=0;f<this._decodedStatsfield.length;f++)c.push(this._calculateFieldStat(e,this._decodedStatsfield[f],n));return this._featureCache[n.attributes[this.objectIdField]]=new O.a({attributes:n.attributes,geometry:n.geometry}),n}},{key:"_generateAggregateHash",value:function(e){var t,n="",r=Object(u.a)(this._decodedGroupbyfield);try{for(r.s();!(t=r.n()).done;){var a=t.value,i=a.singlefield?e.attributes[a.singlefield]:a.expression.calculateValue(e);n+=null==i?":":":"+i.toString()}}catch(s){r.e(s)}finally{r.f()}return Object(E.a)(n,E.b.String)}},{key:"_stat",value:function(){return Object(o.s)({calculated:!1})}},{key:"getFeatureByObjectId",value:function(){return Object(o.s)(null)}}],[{key:"registerAction",value:function(){x.a._featuresetFunctions.groupby=function(e,t){return new n({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}]),n}(x.a),A=n(948),P=n(983),L=n(853),G=n(240),B=n(914),q=n(870),M=n(851),U=n(447),W=n(376),J=n(941),V=n(854),Q=n(955),Y=function(e){Object(s.a)(n,e);var t=Object(l.a)(n);function n(e){var r;return Object(a.a)(this,n),(r=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",r._removeGeometry=!1,r._overrideFields=null,r.formulaCredential=null,r._pageJustIds=!1,r._requestStandardised=!1,e.spatialReference&&(r.spatialReference=e.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=e.layer,r._wset=null,void 0!==e.outFields&&(r._overrideFields=e.outFields),void 0!==e.includeGeometry&&(r._removeGeometry=!1===e.includeGeometry),r}return Object(i.a)(n,[{key:"_maxQueryRate",value:function(){return p.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(e){this._pageJustIds=e}},{key:"convertQueryToLruCacheKey",value:function(e){var t=Object(p.q)(e.toJSON());return Object(E.a)(t,E.b.String)}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(o.c)((function(t,n){try{if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(t){n(t)}}),n),e._layer.load()}catch(t){n(t)}}))),this._loadPromise}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e,t=[],n=Object(u.a)(this.fields);try{for(n.s();!(e=n.n()).done;){var r=e.value;if("oid"===r.type)t.push(r);else{var a,i=Object(u.a)(this._layer.outFields);try{for(i.s();!(a=i.n()).done;){if(a.value.toLowerCase()===r.name.toLowerCase()){t.push(r);break}}}catch(b){i.e(b)}finally{i.f()}}}}catch(b){n.e(b)}finally{n.f()}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var s,l=[],o=[],c=Object(u.a)(this.fields);try{for(c.s();!(s=c.n()).done;){var f=s.value;if("oid"===f.type)l.push(f),o.push(f.name);else{var d,h=Object(u.a)(this._overrideFields);try{for(h.s();!(d=h.n()).done;){if(d.value.toLowerCase()===f.name.toLowerCase()){l.push(f),o.push(f.name);break}}}catch(b){h.e(b)}finally{h.f()}}}}catch(b){c.e(b)}finally{c.f()}this.fields=l,this._overrideFields=o}if(this._layer.source&&this._layer.source.sourceJSON){var y=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=p.a.StandardisedNoInterval,null!=y&&y>=10.61&&(this._databaseType=p.a.Standardised)):null!=y&&(y>=10.5&&(this._databaseType=p.a.StandardisedNoInterval,this._requestStandardised=!0),y>=10.61&&(this._databaseType=p.a.Standardised))}this.objectIdField=this._layer.objectIdField;var v,_=Object(u.a)(this.fields);try{for(_.s();!(v=_.n()).done;){var g=v.value;"global-id"===g.type&&(this.globalIdField=g.name)}}catch(b){_.e(b)}finally{_.f()}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"_isInFeatureSet",value:function(){return p.b.InFeatureSet}},{key:"_refineSetBlock",value:function(e){return Object(o.s)(e)}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(o.s)(this._wset)}},{key:"_runDatabaseProbe",value:function(e){var t=this;return Object(o.c)((function(n,r){try{t._ensureLoaded().then((function(){try{var a=new W.a;a.where=e.replace("OBJECTID",t._layer.objectIdField),t._layer.queryObjectIds(a).then((function(){n(!0)}),(function(){try{n(!1)}catch(n){r(n)}}))}catch(n){r(n)}}))}catch(n){r(n)}}))}},{key:"_canUsePagination",value:function(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}},{key:"_cacheableFeatureSetSourceKey",value:function(){return this._layer.url}},{key:"pbfSupportedForQuery",value:function(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}},{key:"queryPBF",value:function(e){return e.quantizationParameters={mode:"edit"},Object(V.executeQueryPBF)(this._layer.parsedUrl,e,new J.b({})).then((function(e){return M.default.fromJSON(Object(q.g)(e.data)).unquantize()}))}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}},{key:"executeQuery",value:function(e,t){var n=this,r=new Q.a({url:this._layer.parsedUrl.path}),a="execute"===t&&this.pbfSupportedForQuery(e),i=null;if(this.recentlyUsedQueries){var s=this.convertQueryToLruCacheKey(e);null===(i=this.recentlyUsedQueries.getFromCache(s))&&(i=!0!==a?r[t](e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(s,i),i=i.catch((function(e){throw n.recentlyUsedQueries.removeFromCache(s),e})))}return null===i&&(i=!0!==a?r[t](e):this.queryPBF(e)),i}},{key:"_getFilteredSet",value:function(e,t,n,r,a){var i=this;return this.databaseType().then((function(s){if(i.isTable()&&t&&null!==e&&""!==e)return new S.a([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,n,r,a);var l="",u=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(l=r.constructClause(),u=!0);var o=new W.a;return o.where=null===n?null===t?"1=1":"":Object(F.i)(n,s),i._requestStandardised&&(o.sqlFormat="standard"),o.spatialRelationship=i._makeRelationshipEnum(e),o.outSpatialReference=i.spatialReference,o.orderByFields=""!==l?l.split(","):null,o.geometry=null===t?null:t,o.relationParameter=i._makeRelationshipParam(e),i.executeQuery(o,"executeForIds").then((function(e){return null===e&&(e=[]),i._checkCancelled(a),new S.a([],e,u,null)}))}))}},{key:"_expandPagedSet",value:function(e,t,n,r,a){return this._expandPagedSetFeatureSet(e,t,n,r,a)}},{key:"_getFilteredSetUsingPaging",value:function(e,t,n,r,a){var i=this;try{var s="",l=!1;return null!==r&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(s=r.constructClause(),l=!0),this.databaseType().then((function(r){var u=null===n?null===t?"1=1":"":Object(F.i)(n,r);i._layer.definitionExpression&&(u=""!==u?"(("+i._layer.definitionExpression+") AND ("+u+"))":i._layer.definitionExpression);var o=i._maxQueryRate(),c=i._layer.capabilities.query.maxRecordCount;void 0!==c&&c<o&&(o=c);var f=null;if(!0===i._pageJustIds)f=new S.a([],["GETPAGES"],l,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:s,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{var d=!0;!0===i._removeGeometry&&(d=!1);var h=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);f=new S.a([],["GETPAGES"],l,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:h.join(","),resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:s,returnGeometry:d,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return i._expandPagedSet(f,o,0,1,a).then((function(){return f}))}))}catch(e){return Object(o.r)(e)}}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,n){var r=this;try{var a=e.pagesDefinition.internal.lastRetrieved,i=a,s=e.pagesDefinition.internal.lastPage,l=new W.a;return this._requestStandardised&&(l.sqlFormat="standard"),l.spatialRelationship=e.pagesDefinition.spatialRel,l.relationParameter=e.pagesDefinition.relationParam,l.outFields=e.pagesDefinition.outFields.split(","),l.num=e.pagesDefinition.resultRecordCount,l.start=e.pagesDefinition.internal.lastPage,l.geometry=e.pagesDefinition.geometry,l.where=e.pagesDefinition.where,l.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,l.returnGeometry=e.pagesDefinition.returnGeometry,l.outSpatialReference=this.spatialReference,this.executeQuery(l,"execute").then((function(t){if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==s)return"done";for(var l=0;l<t.features.length;l++)e.pagesDefinition.internal.set[i+l]=t.features[l].attributes[r._layer.objectIdField];if(!1===r._pageJustIds)for(var u=0;u<t.features.length;u++)r._featureCache[t.features[u].attributes[r._layer.objectIdField]]=t.features[u];return(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}))}catch(e){return Object(o.r)(e)}}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var n,r=!1,a=Object(u.a)(t);try{for(a.s();!(n=a.n()).done;){if(n.value.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}}}catch(i){a.e(i)}finally{a.f()}return!1===r&&t.push(this.objectIdField),t}},{key:"_getFeatures",value:function(e,t,n,r){var a=this,i=[];try{if(-1!==t&&void 0===this._featureCache[t]&&i.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,r).then((function(){return a._getFeatures(e,t,n,r)}));for(var s=0,l=e._lastFetchedIndex;l<e._known.length;l++){if(e._lastFetchedIndex+=1,s++,void 0===this._featureCache[e._known[l]]){var u=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var c=this._layer._mode;if(void 0!==c._featureMap[e._known[l]]){var f=c._featureMap[e._known[l]];null!==f&&(u=!0,this._featureCache[e._known[l]]=f)}}if(!1===u&&(e._known[l]!==t&&i.push(e._known[l]),i.length>=this._maxProcessingRate()-1))break}if(s>=n&&0===i.length)break}if(0===i.length)return Object(o.s)("success");try{var d=new W.a;return this._requestStandardised&&(d.sqlFormat="standard"),d.objectIds=i,d.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),d.returnGeometry=!0,!0===this._removeGeometry&&(d.returnGeometry=!1),d.outSpatialReference=this.spatialReference,this.executeQuery(d,"execute").then((function(e){if(a._checkCancelled(r),void 0!==e.error)return Object(o.r)(new Error(e.error));for(var t=0;t<e.features.length;t++)a._featureCache[e.features[t].attributes[a._layer.objectIdField]]=e.features[t];return"success"}))}catch(e){return Object(o.r)(e)}}catch(e){return Object(o.r)(e)}}},{key:"_getDistinctPages",value:function(e,t,n,r,a,i,s,l,u){var c=this;return this._ensureLoaded().then((function(){return c.databaseType()})).then((function(f){for(var d=n.parseTree.column,h=0;h<c._layer.fields.length;h++)if(c._layer.fields[h].name.toLowerCase()===d.toLowerCase()){d=c._layer.fields[h].name;break}var p=new W.a;c._requestStandardised&&(p.sqlFormat="standard");var y=null===i?null===a?"1=1":"":Object(F.i)(i,f);return c._layer.definitionExpression&&(y=""!==y?"(("+c._layer.definitionExpression+") AND ("+y+"))":c._layer.definitionExpression),p.where=y,p.spatialRelationship=c._makeRelationshipEnum(r),p.relationParameter=c._makeRelationshipParam(r),p.geometry=null===a?null:a,p.returnDistinctValues=!0,p.returnGeometry=!1,p.outFields=[d],c.executeQuery(p,"execute").then((function(f){if(c._checkCancelled(u),!f.hasOwnProperty("features"))return Object(o.r)(new Error("Unnexected Result querying statistics from layer"));for(var h=!1,p=0;p<c._layer.fields.length;p++)if(c._layer.fields[p].name===d){"date"===c._layer.fields[p].type&&(h=!0);break}for(var y=0;y<f.features.length;y++){if(h){var v=f.features[y].attributes[d];null!==v?l.push(new Date(v)):l.push(v)}else l.push(f.features[y].attributes[d]);if(l.length>=s)break}return 0===f.features.length?l:f.features.length===c._layer.capabilities.query.maxRecordCount&&l.length<s?c._getDistinctPages(e+f.features.length,t,n,r,a,i,s,l,u).then((function(e){return{calculated:!0,result:e}})):l}))}))}},{key:"_distinctStat",value:function(e,t,n,r,a,i,s){return this._getDistinctPages(0,e,t,n,r,a,i,[],s).then((function(e){return{calculated:!0,result:e}}))}},{key:"isTable",value:function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}},{key:"_countstat",value:function(e,t,n,r){var a=this;return this.databaseType().then((function(e){var i=new W.a;if(a._requestStandardised&&(i.sqlFormat="standard"),a.isTable()&&n&&null!==t&&""!==t)return{calculated:!0,result:0};var s=null===r?null===n?"1=1":"":Object(F.i)(r,e);return a._layer.definitionExpression&&(s=""!==s?"(("+a._layer.definitionExpression+") AND ("+s+"))":a._layer.definitionExpression),i.where=s,i.where=s,i.spatialRelationship=a._makeRelationshipEnum(t),i.relationParameter=a._makeRelationshipParam(t),i.geometry=null===n?null:n,i.returnGeometry=!1,a.executeQuery(i,"executeForCount").then((function(e){return{calculated:!0,result:e}}))}))}},{key:"_stats",value:function(e,t,n,r,a,i,s){var l=this;return this._ensureLoaded().then((function(){var u=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsSqlExpression,c=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsStatistics,f=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsDistinct;return"count"===e?f?l._countstat(e,n,r,a):{calculated:!1}:!1===c||!1===Object(F.c)(t)&&!1===u||!1===t.isStandardized?""!==n||null!==a?{calculated:!1}:l._manualStat(e,t,i,s):"distinct"===e?!1===f?""!==n||null!==a?{calculated:!1}:l._manualStat(e,t,i,s):l._distinctStat(e,t,n,r,a,i,s):l.databaseType().then((function(i){if(l.isTable()&&r&&null!==n&&""!==n)return{calculated:!0,result:null};var s=new W.a;l._requestStandardised&&(s.sqlFormat="standard");var u=null===a?null===r?"1=1":"":Object(F.i)(a,i);l._layer.definitionExpression&&(u=""!==u?"(("+l._layer.definitionExpression+") AND ("+u+"))":l._layer.definitionExpression),s.where=u,s.spatialRelationship=l._makeRelationshipEnum(n),s.relationParameter=l._makeRelationshipParam(n),s.geometry=null===r?null:r;var c=new U.a;c.statisticType=Object(k.c)(e),c.onStatisticField=Object(F.i)(t,i),c.outStatisticFieldName="ARCADE_STAT_RESULT",s.returnGeometry=!1;var f="ARCADE_STAT_RESULT";return s.outStatistics=[c],l.executeQuery(s,"execute").then((function(e){if(!e.hasOwnProperty("features")||0===e.features.length)return Object(o.r)(new Error("Unnexected Result querying statistics from layer"));for(var t=!1,n=0;n<e.fields.length;n++)if("ARCADE_STAT_RESULT"===e.fields[n].name.toUpperCase()){f=e.fields[n].name,"date"===e.fields[n].type&&(t=!0);break}if(t){var r=e.features[0].attributes[f];return null!==r&&(r=new Date(e.features[0].attributes[f])),{calculated:!0,result:r}}return{calculated:!0,result:e.features[0].attributes[f]}}))}))}))}},{key:"_stat",value:function(e,t,n,r,a,i,s){return this._stats(e,t,n,r,a,i,s)}},{key:"_canDoAggregates",value:function(e,t){var n=this;return this._ensureLoaded().then((function(){var e=!1,r=n._layer.capabilities&&n._layer.capabilities.query&&!0===n._layer.capabilities.query.supportsSqlExpression;if(void 0!==n._layer.capabilities&&null!==n._layer.capabilities.query&&!0===n._layer.capabilities.query.supportsStatistics&&!0===n._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(var a=0;a<t.length-1;a++)null!==t[a].workingexpr&&(!1===t[a].workingexpr.isStandardized||!1===Object(F.c)(t[a].workingexpr)&&!1===r)&&(e=!1);return!1!==e}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,n,r,a,i,s){var l=this;return this._ensureLoaded().then((function(){return l.databaseType()})).then((function(u){var o="",c=!1,f=!1;null!==i&&l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsOrderBy&&(o=i.constructClause(),f=!0),l._layer.capabilities&&l._layer.capabilities.query&&!1===l._layer.capabilities.query.supportsPagination&&(f=!1,c=!0,o=l._layer.objectIdField);for(var d=[],h=0;h<t.length;h++){var p=new U.a;p.onStatisticField=null!==t[h].workingexpr?Object(F.i)(t[h].workingexpr,u):"",p.outStatisticFieldName=t[h].field,p.statisticType=t[h].toStatisticsName(),d.push(p)}""===o&&(o=e.join(","));var y=l._maxQueryRate(),v=l._layer.capabilities.query.maxRecordCount;void 0!==v&&v<y&&(y=v);var _=null===a?null===r?"1=1":"":Object(F.i)(a,u);return l._layer.definitionExpression&&(_=""!==_?"(("+l._layer.definitionExpression+") AND ("+_+"))":l._layer.definitionExpression),new S.a([],["GETPAGES"],f,{groupbypage:!0,spatialRel:l._makeRelationshipEnum(n),relationParam:l._makeRelationshipParam(n),outFields:["*"],useOIDpagination:c,generatedOid:s,resultRecordCount:y,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:d,geometry:null===r?null:r,where:_,orderByFields:o,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))}},{key:"_getAgregagtePhysicalPage",value:function(e,t,n){var r=this;try{var a=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(a=""!==a?"("+a+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());var i=e.pagesDefinition.internal.lastRetrieved,s=i,l=e.pagesDefinition.internal.lastPage,u=new W.a;return this._requestStandardised&&(u.sqlFormat="standard"),u.where=a,u.spatialRelationship=e.pagesDefinition.spatialRel,u.relationParameter=e.pagesDefinition.relationParam,u.outFields=e.pagesDefinition.outFields,u.outStatistics=e.pagesDefinition.outStatistics,u.geometry=e.pagesDefinition.geometry,u.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,u.num=e.pagesDefinition.resultRecordCount,u.start=e.pagesDefinition.internal.lastPage,u.returnGeometry=e.pagesDefinition.returnGeometry,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&u.geometry&&u.spatialRelationship?Object(o.s)([]):this.executeQuery(u,"execute").then((function(t){if(r._checkCancelled(n),!t.hasOwnProperty("features"))return Object(o.r)(new Error("Unnexected Result querying aggregates from layer"));var a=[];if(e.pagesDefinition.internal.lastPage!==l)return[];for(var u=0;u<t.features.length;u++)e.pagesDefinition.internal.set[s+u]=t.features[u].attributes[e.pagesDefinition.generatedOid];for(var c=0;c<t.features.length;c++)a.push(new O.a({attributes:t.features[c].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,a}))}catch(e){return Object(o.r)(e)}}},{key:"relationshipMetaData",value:function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}},{key:"serviceUrl",value:function(){return Object(p.i)(this._layer.parsedUrl.path)}},{key:"queryAttachments",value:function(e,t,n,r){var a=this;if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){var i={objectIds:[e]};return(t&&t>0||n&&n>0)&&(i.size=[t&&t>0?t:0,n&&n>0?n:t+1]),r&&r.length>0&&(i.attachmentTypes=r),this._layer.queryAttachments(i).then((function(t){var n=[];return t&&t[e]&&t[e].forEach((function(t){var r=a._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();n.push(new B.a(t.id,t.name,t.contentType,t.size,r))})),n}))}return Object(o.s)([])}},{key:"queryRelatedFeatures",value:function(e){var t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),Object(f.default)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then((function(e){if(e.data){var t={},n=e.data;if(n&&n.relatedRecordGroups){var r,a=n.spatialReference,i=Object(u.a)(n.relatedRecordGroups);try{for(i.s();!(r=i.n()).done;){var s,l=r.value,c=l.objectId,f=[],d=Object(u.a)(l.relatedRecords);try{for(d.s();!(s=d.n()).done;){var h=s.value;h.geometry&&(h.geometry.spatialReference=a);var p=new O.a({geometry:h.geometry?Object(G.a)(h.geometry):null,attributes:h.attributes});f.push(p)}}catch(y){d.e(y)}finally{d.f()}t[c]={features:f,exceededTransferLimit:!0===n.exceededTransferLimit}}}catch(y){i.e(y)}finally{i.f()}}return t}return Object(o.r)("Invalid Request")}))}},{key:"getFeatureByObjectId",value:function(e,t){var n=new Q.a({url:this._layer.parsedUrl.path}),r=new W.a;return r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=this.spatialReference,r.where=this.objectIdField+"="+e.toString(),n.execute(r).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getIdentityUser",value:function(){var e=this;return this.load().then((function(){var t,n=null==(t=c.b)?void 0:t.findCredential(e._layer.url);return n?n.userId:null}))}},{key:"getOwningSystemUrl",value:function(){var e=this;return this.load().then((function(){var t,n=null==(t=c.b)?void 0:t.findServerInfo(e._layer.url);if(n)return Object(o.s)(n.owningSystemUrl);var r=e._layer.url,a=r.toLowerCase().indexOf("/rest/services");return(r=a>-1?r.substring(0,a):r)?(r+="/rest/info",Object(o.c)((function(e,t){Object(f.default)(r,{query:{f:"json"}}).then((function(t){var n="";t.data&&t.data.owningSystemUrl&&(n=t.data.owningSystemUrl),e(n)}),(function(t){e("")}))}))):Object(o.s)("")}))}},{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}}],[{key:"create",value:function(e,t,r,a){return new n({layer:new L.default({url:e,outFields:null===t?["*"]:t}),spatialReference:r,lrucache:a})}}]),n}(x.a),H=n(984),z=n(923),K=function(e){Object(s.a)(n,e);var t=Object(l.a)(n);function n(e){var r;return Object(a.a)(this,n),(r=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",r._findObjectId=-1,r._requestStandardised=!1,r._removeGeometry=!1,r._overrideFields=null,r.featureObjectId=null,r.relatedLayer=null,r.relationship=null,e.spatialReference&&(r.spatialReference=e.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=e.layer,r._wset=null,r._findObjectId=e.objectId,r.featureObjectId=e.objectId,r.relationship=e.relationship,r.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(r._overrideFields=e.outFields),void 0!==e.includeGeometry&&(r._removeGeometry=!1===e.includeGeometry),r}return Object(i.a)(n,[{key:"_maxQueryRate",value:function(){return p.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(o.c)((function(t,n){Object(o.b)([e._layer.load(),e.relatedLayer.load()]).then((function(){e._initialiseFeatureSet(),t(e)}),n)}))),this._loadPromise}},{key:"nativeCapabilities",value:function(){return this.relatedLayer.nativeCapabilities()}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var e,t=[],n=[],r=Object(u.a)(this.fields);try{for(r.s();!(e=r.n()).done;){var a=e.value;if("oid"===a.type)t.push(a),n.push(a.name);else{var i,s=Object(u.a)(this._overrideFields);try{for(s.s();!(i=s.n()).done;){if(i.value.toLowerCase()===a.name.toLowerCase()){t.push(a),n.push(a.name);break}}}catch(o){s.e(o)}finally{s.f()}}}}catch(o){r.e(o)}finally{r.f()}this.fields=t,this._overrideFields=n}var l=this._layer.nativeCapabilities();l&&(this._databaseType=l.databaseType,this._requestStandardised=l.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}},{key:"databaseType",value:function(){var e=this;return this.relatedLayer.databaseType().then((function(){return e._databaseType=e.relatedLayer._databaseType,e._databaseType}))}},{key:"isTable",value:function(){return this.relatedLayer.isTable()}},{key:"_isInFeatureSet",value:function(){return p.b.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(o.s)(this._wset)}},{key:"_changeFeature",value:function(e){var t,n={},r=Object(u.a)(this.fields);try{for(r.s();!(t=r.n()).done;){var a=t.value;n[a.name]=e.attributes[a.name]}}catch(i){r.e(i)}finally{r.f()}return new O.a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:n})}},{key:"_getFilteredSet",value:function(e,t,n,r,a){var i=this;return this.databaseType().then((function(){if(i.isTable()&&t&&null!==e&&""!==e)return new S.a([],[],!0,null);var s=i._layer.nativeCapabilities();if(!1===s.canQueryRelated)return new S.a([],[],!0,null);if(s.capabilities.queryRelated&&s.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,n,r,a);var l="",u=!1;null!==r&&s.capabilities&&s.capabilities.queryRelated&&!0===s.capabilities.queryRelated.supportsOrderBy&&(l=r.constructClause(),u=!0);var o=new z.a;o.objectIds=[i._findObjectId];var c=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);o.outFields=c,o.relationshipId=i.relationship.id,o.where="1=1";var f=!0;return!0===i._removeGeometry&&(f=!1),o.returnGeometry=f,i._requestStandardised&&(o.sqlFormat="standard"),o.outSpatialReference=i.spatialReference,o.orderByFields=""!==l?l.split(","):null,s.source.queryRelatedFeatures(o).then((function(r){i._checkCancelled(a);for(var s=r[i._findObjectId]?r[i._findObjectId].features:[],l=[],o=0;o<s.length;o++)i._featureCache[s[o].attributes[i._layer.objectIdField]]=s[o],l.push(s[o].attributes[i._layer.objectIdField]);var c=t&&null!==e&&""!==e,f=null!=n;return new S.a(c||f?l:[],c||f?[]:l,u,null)}))}))}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var n,r=!1,a=Object(u.a)(t);try{for(a.s();!(n=a.n()).done;){if(n.value.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}}}catch(i){a.e(i)}finally{a.f()}return!1===r&&t.push(this.objectIdField),t}},{key:"_getFilteredSetUsingPaging",value:function(e,t,n,r,a){var i=this;try{var s="",l=!1,u=this._layer.nativeCapabilities();return null!==r&&u&&u.capabilities.queryRelated&&!0===u.capabilities.queryRelated.supportsOrderBy&&(s=r.constructClause(),l=!0),this.databaseType().then((function(){var r=i._maxQueryRate(),o=u.capabilities.query.maxRecordCount;void 0!==o&&o<r&&(r=o);var c,f=t&&null!==e&&""!==e,d=null!=n,h=!0;!0===i._removeGeometry&&(h=!1);var p=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);return c=new S.a(f||d?["GETPAGES"]:[],f||d?[]:["GETPAGES"],l,{outFields:p.join(","),resultRecordCount:r,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:s,returnGeometry:h,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),i._expandPagedSet(c,r,0,0,a).then((function(){return c}))}))}catch(e){return Object(o.r)(e)}}},{key:"_expandPagedSet",value:function(e,t,n,r,a){return this._expandPagedSetFeatureSet(e,t,n,r,a)}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,n){var r=this;try{var a=e.pagesDefinition.internal.lastRetrieved,i=a,s=e.pagesDefinition.internal.lastPage,l=this._layer.nativeCapabilities(),u=new z.a;return!0===this._requestStandardised&&(u.sqlFormat="standard"),u.relationshipId=this.relationship.id,u.objectIds=e.pagesDefinition.objectIds,u.resultOffset=e.pagesDefinition.internal.lastPage,u.resultRecordCount=e.pagesDefinition.resultRecordCount,u.outFields=e.pagesDefinition.outFields.split(","),u.where=e.pagesDefinition.where,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,u.returnGeometry=e.pagesDefinition.returnGeometry,u.outSpatialReference=this.spatialReference,l.source.queryRelatedFeatures(u).then((function(t){if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==s)return 0;for(var l=t[r._findObjectId]?t[r._findObjectId].features:[],u=0;u<l.length;u++)e.pagesDefinition.internal.set[i+u]=l[u].attributes[r._layer.objectIdField];for(var o=0;o<l.length;o++)r._featureCache[l[o].attributes[r._layer.objectIdField]]=l[o];var c=!t[r._findObjectId]||!1===t[r._findObjectId].exceededTransferLimit;return l.length!==e.pagesDefinition.resultRecordCount&&c&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+l.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,l.length}))}catch(e){return Object(o.r)(e)}}},{key:"_getFeatures",value:function(e,t,n,r){var a=this,i=[];-1!==t&&void 0===this._featureCache[t]&&i.push(t);var s=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,s))return this._expandPagedSet(e,s,0,0,r).then((function(){return a._getFeatures(e,t,n,r)}));for(var l=0,u=e._lastFetchedIndex;u<e._known.length&&(++l<=n&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[u]&&void 0===this._featureCache[e._known[u]]&&(e._known[u]!==t&&i.push(e._known[u]),i.length>n)))&&!(l>=n&&0===i.length);u++);return 0===i.length?Object(o.s)("success"):Object(o.r)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e,t,n){return Object(o.s)(e)}},{key:"_stat",value:function(e,t,n,r,a,i,s){return Object(o.s)({calculated:!1})}},{key:"_canDoAggregates",value:function(e,t,n,r,a){return Object(o.s)(!1)}},{key:"relationshipMetaData",value:function(){return this.relatedLayer.relationshipMetaData()}},{key:"serviceUrl",value:function(){return this.relatedLayer.serviceUrl()}},{key:"queryAttachments",value:function(e,t,n,r){return this.relatedLayer.queryAttachments(e,t,n,r)}},{key:"getFeatureByObjectId",value:function(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}},{key:"getOwningSystemUrl",value:function(){return this.relatedLayer.getOwningSystemUrl()}},{key:"getIdentityUser",value:function(){return this.relatedLayer.getIdentityUser()}},{key:"gdbVersion",get:function(){return this.relatedLayer.gdbVersion}}]),n}(x.a);function Z(){null===v.a.applicationCache&&(v.a.applicationCache=new v.a)}function X(e,t){if(v.a.applicationCache){var n=v.a.applicationCache.getLayerInfo(e);if(n)return n.then((function(n){return Object(o.s)(new L.default({url:e,outFields:t,sourceJSON:n}))}));var r=new L.default({url:e,outFields:t}),a=Object(o.c)((function(e,t){r.load().then((function(){e(r.sourceJSON)}),(function(e){t(e)}))}));return v.a.applicationCache&&(v.a.applicationCache.setLayerInfo(e,a),a=a.catch((function(t){throw v.a.applicationCache.clearLayerInfo(e),t}))),a.then((function(){return Object(o.s)(r)}))}return Object(o.s)(new L.default({url:e,outFields:t}))}function $(e,t,n,r,a){return X(e,["*"]).then((function(e){return Object(o.s)(ee(e,t,n,r,a))}))}function ee(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return!0===e._hasMemorySource()?new H.a({layer:e,spatialReference:t,outFields:n,includeGeometry:r,lrucache:a}):new Y({layer:e,spatialReference:t,outFields:n,includeGeometry:r,lrucache:a})}function te(e){if(null!==v.a.applicationCache){var t=v.a.applicationCache.getLayerInfo(e);if(null!==t)return t}var n=Object(f.default)(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),Object(o.s)(t)}return Object(o.s)({layers:[],tables:[]})}));return null!==v.a.applicationCache&&(v.a.applicationCache.setLayerInfo(e,n),n=n.catch((function(t){throw v.a.applicationCache.clearLayerInfo(e),t}))),n}function ne(e,t){var n={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return te(e).then((function(r){if(n.metadata=r,r.controllerDatasetLayers&&void 0!==r.controllerDatasetLayers.utilityNetworkLayerId&&null!==r.controllerDatasetLayers.utilityNetworkLayerId){if(r.layers){var a,i=Object(u.a)(r.layers);try{for(i.s();!(a=i.n()).done;){var s=a.value;n.layerNameLkp[s.id]=s.name}}catch(p){i.e(p)}finally{i.f()}}if(r.tables){var l,c=Object(u.a)(r.tables);try{for(c.s();!(l=c.n()).done;){var d=l.value;n.layerNameLkp[d.id]=d.name}}catch(p){c.e(p)}finally{c.f()}}var h=r.controllerDatasetLayers.utilityNetworkLayerId;return n.networkId=h,function(e,t){var n="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==v.a.applicationCache){var r=v.a.applicationCache.getLayerInfo(n);if(null!==r)return r}var a=Object(f.default)(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==v.a.applicationCache&&(v.a.applicationCache.setLayerInfo(n,a),a=a.catch((function(e){throw v.a.applicationCache.clearLayerInfo(n),e}))),a}(e,h).then((function(r){if(r){n.queryelem=r,n.queryelem&&n.queryelem.dataElement&&void 0!==n.queryelem.dataElement.schemaGeneration&&(n.unVersion=n.queryelem.dataElement.schemaGeneration),n.lkp={},n.queryelem.dataElement.domainNetworks||(n.queryelem.dataElement.domainNetworks=[]);var a,i=Object(u.a)(n.queryelem.dataElement.domainNetworks);try{for(i.s();!(a=i.n()).done;){var s,l=a.value,c=Object(u.a)(l.edgeSources?l.edgeSources:[]);try{for(c.s();!(s=c.n()).done;){var d=s.value,y={layerId:d.layerId,sourceId:d.sourceId,className:n.layerNameLkp[d.layerId]?n.layerNameLkp[d.layerId]:null};y.className&&(n.lkp[y.className]=y)}}catch(p){c.e(p)}finally{c.f()}var g,b=Object(u.a)(l.junctionSources?l.junctionSources:[]);try{for(b.s();!(g=b.n()).done;){var m=g.value,O={layerId:m.layerId,sourceId:m.sourceId,className:n.layerNameLkp[m.layerId]?n.layerNameLkp[m.layerId]:null};O.className&&(n.lkp[O.className]=O)}}catch(p){b.e(p)}finally{b.f()}}}catch(p){i.e(p)}finally{i.f()}if(n.queryelem.dataElement.terminalConfigurations){var j,w=Object(u.a)(n.queryelem.dataElement.terminalConfigurations);try{for(w.s();!(j=w.n()).done;){var S,F=j.value,k=Object(u.a)(F.terminals);try{for(k.s();!(S=k.n()).done;){var I=S.value;n.terminals.push({terminalId:I.terminalId,terminalName:I.terminalName})}}catch(p){k.e(p)}finally{k.f()}}}catch(p){w.e(p)}finally{w.f()}}return function(e){if(null!==v.a.applicationCache){var t=v.a.applicationCache.getLayerInfo(e);if(null!==t)return t}var n=Object(f.default)(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return Object(o.s)(t)}return Object(o.s)(null)}));return null!==v.a.applicationCache&&(v.a.applicationCache.setLayerInfo(e,n),n=n.catch((function(t){throw v.a.applicationCache.clearLayerInfo(e),t}))),n}(e+"/"+h).then((function(r){if(r.systemLayers&&void 0!==r.systemLayers.associationsTableId&&null!==r.systemLayers.associationsTableId){var a=[];return n.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),$(e+"/"+r.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"].concat(a),!1,null).then((function(e){return e.load()})).then((function(e){return n.unVersion>=4?(e=e.filter(_.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e})).then((function(e){return{lkp:n.lkp,associations:e,unVersion:n.unVersion,terminals:n.terminals}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:n.unVersion,lkp:null,terminals:[]}}))}function re(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,l=e.serviceUrl();return l?$(l="/"===l.charAt(l.length-1)?l+t.relatedTableId.toString():l+"/"+t.relatedTableId.toString(),r,a,i,s).then((function(l){return new K({layer:e,relatedLayer:l,relationship:t,objectId:n,spatialReference:r,outFields:a,includeGeometry:i,lrucache:s})})):null}g.a.registerAction(),N.registerAction(),b.a.registerAction(),A.a.registerAction(),P.a.registerAction();var ae=function(e){Object(s.a)(n,e);var t=Object(l.a)(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return Object(a.a)(this,n),(r=t.call(this))._map=e,r._overridespref=i,r.lrucache=s,r._instantLayers=[],r}return Object(i.a)(n,[{key:"makeAndAddFeatureSet",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=ee(e,this._overridespref,null===n?["*"]:n,t,this.lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}},{key:"featureSetByName",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return t.featureSetByName(e,n,a)}catch(e){return Object(o.r)(e)}}));null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),s=0;s<this._instantLayers.length;s++){var l=this._instantLayers[s];if(l.opitem.title===e&&l.includeGeometry===n&&l.outFields===i)return this.resolvePromise(this._instantLayers[s].featureset)}var u=this._map.layers.find((function(t){return t instanceof L.default&&t.title===e}));if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,n,a));if(this._map.tables){var c=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)}));if(c){if(c instanceof L.default)return this.resolvePromise(this.makeAndAddFeatureSet(c,n,a));if(c._materializedTable);else{var f=c.outFields?c:Object(r.a)(Object(r.a)({},c),{},{outFields:["*"]});c._materializedTable=new L.default(f)}return c._materializedTable.load().then((function(){return t.resolvePromise(t.makeAndAddFeatureSet(c._materializedTable,n,a))}))}}return this.resolvePromise(null)}},{key:"featureSetById",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return t.featureSetById(e,n,a)}catch(e){return Object(o.r)(e)}}));null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),s=0;s<this._instantLayers.length;s++){var l=this._instantLayers[s];if(l.opitem.id===e&&l.includeGeometry===n&&l.outFields===i)return this.resolvePromise(this._instantLayers[s].featureset)}var u=this._map.layers.find((function(t){return t instanceof L.default&&t.id===e}));if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,n,a));if(this._map.tables){var c=this._map.tables.find((function(t){return t.id===e}));if(c){if(c instanceof L.default)return this.resolvePromise(this.makeAndAddFeatureSet(c,n,a));if(c._materializedTable);else{var f=Object(r.a)(Object(r.a)({},c),{},{outFields:["*"]});c._materializedTable=new L.default(f)}return c._materializedTable.load().then((function(){return t.resolvePromise(t.makeAndAddFeatureSet(c._materializedTable,n,a))}))}}return this.resolvePromise(null)}}]),n}(y.a),ie=function(e){Object(s.a)(n,e);var t=Object(l.a)(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return Object(a.a)(this,n),(r=t.call(this))._url=e,r._overridespref=i,r.lrucache=s,r.metadata=null,r._instantLayers=[],r}return Object(i.a)(n,[{key:"makeAndAddFeatureSet",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=ee(e,this._overridespref,null===n?["*"]:n,t,this.lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}},{key:"_loadMetaData",value:function(){var e=this;return te(this._url).then((function(t){return e.metadata=t,t}))}},{key:"load",value:function(){return this._loadMetaData()}},{key:"clone",value:function(){return new n(this._url,this._overridespref,this.lrucache)}},{key:"featureSetByName",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null===r&&(r=["*"]),r=(r=r.slice(0)).sort();for(var a=JSON.stringify(r),i=0;i<this._instantLayers.length;i++){var s=this._instantLayers[i];if(s.opitem.title===e&&s.includeGeometry===n&&s.outFields===a)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(a){var i,s=null,l=Object(u.a)(a.layers?a.layers:[]);try{for(l.s();!(i=l.n()).done;){var o=i.value;o.name===e&&(s=o)}}catch(h){l.e(h)}finally{l.f()}if(!s){var c,f=Object(u.a)(a.tables?a.tables:[]);try{for(f.s();!(c=f.n()).done;){var d=c.value;d.name===e&&(s=d)}}catch(h){f.e(h)}finally{f.f()}}return s?X(t._url+"/"+s.id,["*"]).then((function(e){return t.makeAndAddFeatureSet(e,n,r)})):t.resolvePromise(null)}))}},{key:"featureSetById",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];null===r&&(r=["*"]),r=(r=r.slice(0)).sort();var a=JSON.stringify(r);e=null!=e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var s=this._instantLayers[i];if(s.opitem.id===e&&s.includeGeometry===n&&s.outFields===a)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(a){var i,s=null,l=Object(u.a)(a.layers?a.layers:[]);try{for(l.s();!(i=l.n()).done;){var o=i.value;null!==o.id&&void 0!==o.id&&o.id.toString()===e&&(s=o)}}catch(h){l.e(h)}finally{l.f()}if(!s){var c,f=Object(u.a)(a.tables?a.tables:[]);try{for(f.s();!(c=f.n()).done;){var d=c.value;null!==d.id&&void 0!==d.id&&d.id.toString()===e&&(s=d)}}catch(h){f.e(h)}finally{f.f()}}return s?X(t._url+"/"+s.id,["*"]).then((function(e){return t.makeAndAddFeatureSet(e,n,r)})):t.resolvePromise(null)}))}},{key:"url",get:function(){return this._url}}]),n}(y.a);function se(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new ae(e,t,n)}function le(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new ie(e,t,n)}function ue(e,t){return null===e?t:new d.a({url:e.field("url")})}function oe(e,t,n){return c.b.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===t&&e.user&&e.user.sourceJSON&&!1===n?Object(o.s)(e.user.sourceJSON):""===t?Object(f.default)(e.restUrl+"/community/self",{responseType:"json",query:Object(r.a)({f:"json"},!1===n?{}:{returnUserLicenseTypeExtensions:!0})}).then((function(e){if(e.data){var t=e.data;if(t&&t.username)return Object(o.s)(t)}return Object(o.s)(null)})):Object(f.default)(e.restUrl+"/community/users/"+t,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.error?null:Object(o.s)(t)}return Object(o.s)(null)})):Object(o.s)(null)}function ce(e,t,n,r,a,i,s){if(v.a.applicationCache){var l=v.a.applicationCache.getLayerInfo(e+":"+i.url);if(l)return l.then((function(e){try{var i=new L.default({url:Object(p.i)(e.url)+"/"+t,outFields:["*"]});return Object(o.s)(ee(i,n,r,a,s))}catch(l){return Object(o.r)(l)}}),(function(e){return Object(o.r)(e)}))}return Object(o.c)((function(l,u){var o=new h.default({id:e,portal:i}).load();v.a.applicationCache&&v.a.applicationCache.setLayerInfo(e+":"+i.url,o),o.then((function(e){try{var i=new L.default({url:Object(p.i)(e.url)+"/"+t,outFields:["*"]});l(ee(i,n,r,a,s))}catch(l){u(l)}}),(function(t){v.a.applicationCache&&v.a.applicationCache.clearLayerInfo(e+":"+i.url),u(t)}))}))}},1098:function(e,t,n){"use strict";n.r(t),n.d(t,"registerFunctions",(function(){return D}));var r=n(15),a=n(16),i=n(867),s=n(880),l=n(939),u=n(320),o=n(866),c=n(886),f=n(1024),d=n(981),h=n(852),p=n(875),y=n(927),v=n(982),_=n(929),g=n(928),b=n(910),m=n(983),O=n(853),j=n(984),w=n(1083);function S(e,t,n){var r=e.getVariables();if(r.length>0){for(var i=[],s=0;s<r.length;s++){var l={name:r[s]};i.push(t.evaluateIdentifier(n,l))}return Object(a.b)(i).then((function(t){for(var n={},a=0;a<r.length;a++)n[r[a]]=t[a];return e.parameters=n,e}))}return Object(a.s)(e)}function F(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;for(var r in e)if(r.toLowerCase()===t.toLowerCase())return e[r];return n}function k(e){if(null===e)return null;var t={type:F(e,"type",""),name:F(e,"name","")};if("range"===t.type)t.range=F(e,"range",[]);else{t.codedValues=[];var n,a=Object(r.a)(F(e,"codedValues",[]));try{for(a.s();!(n=a.n()).done;){var i=n.value;t.codedValues.push({name:F(i,"name",""),code:F(i,"code",null)})}}catch(s){a.e(s)}finally{a.f()}}return t}function I(e){if(null===e)return null;var t={},n=F(e,"wkt",null);null!==n&&(t.wkt=n);var r=F(e,"wkid",null);return null!==r&&(t.wkid=r),t}function x(e){if(null===e)return null;var t={hasZ:F(e,"hasz",!1),hasM:F(e,"hasm",!1)},n=F(e,"spatialreference",null);n&&(t.spatialReference=I(n));var r=F(e,"x",null);if(null!==r)return t.x=r,t.y=F(e,"y",null),t;var a=F(e,"rings",null);if(null!==a)return t.rings=a,t;var i=F(e,"paths",null);if(null!==i)return t.paths=i,t;var s=F(e,"points",null);if(null!==s)return t.points=s,t;for(var l=0,u=["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"];l<u.length;l++){var o=u[l],c=F(e,o,null);null!==c&&(t[o]=c)}return t}function D(e){"async"===e.mode&&(e.functions.getuser=function(t,n){return e.standardFunctionAsync(t,n,(function(e,n,r){Object(i.J)(r,1,2);var a=Object(i.c)(r[1],""),u=!0===a;if(a=!0===a||!1===a?"":Object(i.y)(a),r[0]instanceof l.a){var o=null;return t.services&&t.services.portal&&(o=t.services.portal),o=Object(w.getPortal)(r[0],o),Object(w.lookupUser)(o,a,u).then((function(e){if(e){for(var t=JSON.parse(JSON.stringify(e)),n=0,r=["lastLogin","created","modified"];n<r.length;n++){var a=r[n];void 0!==t[a]&&null!==t[a]&&(t[a]=new Date(t[a]))}return s.a.convertObjectToArcadeDictionary(t)}return null}))}var c=null;if(Object(i.T)(r[0])&&(c=r[0]),c)return u=!1,a?null:c.load().then((function(){return c.getOwningSystemUrl()})).then((function(e){if(!e)return a?null:c.getIdentityUser().then((function(e){return e?s.a.convertObjectToArcadeDictionary({username:e}):null}));var n=null;return t.services&&t.services.portal&&(n=t.services.portal),n=Object(w.getPortal)(new l.a(e),n),Object(w.lookupUser)(n,a,u).then((function(e){if(e){for(var t=JSON.parse(JSON.stringify(e)),n=0,r=["lastLogin","created","modified"];n<r.length;n++){var a=r[n];void 0!==t[a]&&null!==t[a]&&(t[a]=new Date(t[a]))}return s.a.convertObjectToArcadeDictionary(t)}return null}))}));throw new Error("Invalid Parameter")}))},e.signatures.push({name:"getuser",min:"1",max:"2"}),e.functions.featuresetbyid=function(t,n){return e.standardFunctionAsync(t,n,(function(e,t,n){if(Object(i.J)(n,2,4),n[0]instanceof d.a){var r=Object(i.y)(n[1]),a=Object(i.c)(n[2],null),s=Object(i.x)(Object(i.c)(n[3],!0));if(null===a&&(a=["*"]),!1===Object(i.B)(a))throw new Error("Invalid Parameter");return n[0].featureSetById(r,s,a)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),e.functions.featuresetbyportalitem=function(t,n){return e.standardFunctionAsync(t,n,(function(e,n,r){if(Object(i.J)(r,2,5),null===r[0])throw new Error("Portal is required");if(r[0]instanceof l.a){var a=Object(i.y)(r[1]),s=Object(i.y)(r[2]),u=Object(i.c)(r[3],null),o=Object(i.x)(Object(i.c)(r[4],!0));if(null===u&&(u=["*"]),!1===Object(i.B)(u))throw new Error("Invalid Parameter");var c=null;return t.services&&t.services.portal&&(c=t.services.portal),c=Object(w.getPortal)(r[0],c),Object(w.constructFeatureSetFromPortalItem)(a,s,t.spatialReference,u,o,c,t.lrucache)}if(!1===Object(i.v)(r[0]))throw new Error("Portal is required");var f=Object(i.y)(r[0]),d=Object(i.y)(r[1]),h=Object(i.c)(r[2],null),p=Object(i.x)(Object(i.c)(r[3],!0));if(null===h&&(h=["*"]),!1===Object(i.B)(h))throw new Error("Invalid Parameter");if(t.services&&t.services.portal)return Object(w.constructFeatureSetFromPortalItem)(f,d,t.spatialReference,h,p,t.services.portal,t.lrucache);throw new Error("Portal is required")}))},e.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),e.functions.featuresetbyname=function(t,n){return e.standardFunctionAsync(t,n,(function(e,t,n){if(Object(i.J)(n,2,4),n[0]instanceof d.a){var r=Object(i.y)(n[1]),a=Object(i.c)(n[2],null),s=Object(i.x)(Object(i.c)(n[3],!0));if(null===a&&(a=["*"]),!1===Object(i.B)(a))throw new Error("Invalid Parameter");return n[0].featureSetByName(r,s,a)}throw new Error("Invalid Parameter")}))},e.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),e.functions.featureset=function(t,n){return e.standardFunction(t,n,(function(e,n,a){Object(i.J)(a,1,1);var l,u=a[0],o={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(Object(i.v)(u))void 0!==(u=JSON.parse(u)).layerDefinition?(o.layerDefinition=u.layerDefinition,o.featureSet=u.featureSet,u.layerDefinition.spatialReference&&(o.layerDefinition.spatialReference=u.layerDefinition.spatialReference)):(o.featureSet.features=u.features,o.featureSet.geometryType=u.geometryType,o.layerDefinition.geometryType=o.featureSet.geometryType,o.layerDefinition.objectIdField=u.objectIdFieldName,o.layerDefinition.typeIdField=u.typeIdFieldName,o.layerDefinition.globalIdField=u.globalIdFieldName,o.layerDefinition.fields=u.fields,u.spatialReference&&(o.layerDefinition.spatialReference=u.spatialReference));else{if(!(a[0]instanceof s.a))throw new Error("Invalid Parameter");var c=F(u=JSON.parse(a[0].castToText()),"layerdefinition");if(null!==c){o.layerDefinition.geometryType=F(c,"geometrytype",""),o.featureSet.geometryType=o.layerDefinition.geometryType,o.layerDefinition.globalIdField=F(c,"globalidfield",""),o.layerDefinition.objectIdField=F(c,"objectidfield",""),o.layerDefinition.typeIdField=F(c,"typeidfield","");var f=F(c,"spatialreference",null);f&&(o.layerDefinition.spatialReference=I(f));var d,h=Object(r.a)(F(c,"fields",[]));try{for(h.s();!(d=h.n()).done;){var p=d.value,y={name:F(p,"name",""),alias:F(p,"alias",""),type:F(p,"type",""),nullable:F(p,"nullable",!0),editable:F(p,"editable",!0),length:F(p,"length",null),domain:k(F(p,"domain"))};o.layerDefinition.fields.push(y)}}catch(Y){h.e(Y)}finally{h.f()}var v=F(u,"featureset",null);if(v){var _,g={},b=Object(r.a)(o.layerDefinition.fields);try{for(b.s();!(_=b.n()).done;){var m=_.value;g[m.name.toLowerCase()]=m.name}}catch(Y){b.e(Y)}finally{b.f()}var O,w=Object(r.a)(F(v,"features",[]));try{for(w.s();!(O=w.n()).done;){var S=O.value,D={},T=F(S,"attributes",{});for(var C in T)D[g[C.toLowerCase()]]=T[C];o.featureSet.features.push({attributes:D,geometry:x(F(S,"geometry",null))})}}catch(Y){w.e(Y)}finally{w.f()}}}else{o.layerDefinition.geometryType=F(u,"geometrytype",""),o.featureSet.geometryType=o.layerDefinition.geometryType,o.layerDefinition.objectIdField=F(u,"objectidfieldname",""),o.layerDefinition.typeIdField=F(u,"typeidfieldname","");var E=F(u,"spatialreference",null);E&&(o.layerDefinition.spatialReference=I(E));var R,N=Object(r.a)(F(u,"fields",[]));try{for(N.s();!(R=N.n()).done;){var A=R.value,P={name:F(A,"name",""),alias:F(A,"alias",""),type:F(A,"type",""),nullable:F(A,"nullable",!0),editable:F(A,"editable",!0),length:F(A,"length",null),domain:k(F(A,"domain"))};o.layerDefinition.fields.push(P)}}catch(Y){N.e(Y)}finally{N.f()}var L,G={},B=Object(r.a)(o.layerDefinition.fields);try{for(B.s();!(L=B.n()).done;){var q=L.value;G[q.name.toLowerCase()]=q.name}}catch(Y){B.e(Y)}finally{B.f()}var M,U=Object(r.a)(F(u,"features",[]));try{for(U.s();!(M=U.n()).done;){var W=M.value,J={},V=F(W,"attributes",{});for(var Q in V)J[G[Q.toLowerCase()]]=V[Q];o.featureSet.features.push({attributes:J,geometry:x(F(W,"geometry",null))})}}catch(Y){U.e(Y)}finally{U.f()}}}if(0==(!!(l=o).layerDefinition&&!!l.featureSet&&!1!==function(e,t){var n,a=Object(r.a)(["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"]);try{for(a.s();!(n=a.n()).done;){if(n.value===e)return!0}}catch(Y){a.e(Y)}finally{a.f()}return!1}(l.layerDefinition.geometryType)&&null!==l.layerDefinition.objectIdField&&""!==l.layerDefinition.objectIdField&&!1!==Object(i.B)(l.layerDefinition.fields)&&!1!==Object(i.B)(l.featureSet.features)))throw new Error("Invalid Parameter");return j.a.create(o,t.spatialReference)}))},e.signatures.push({name:"featureset",min:"1",max:"1"}),e.functions.filter=function(t,n){return e.standardFunctionAsync(t,n,(function(n,r,s){return Object(i.J)(s,2,2),Object(i.T)(s[0])?s[0].load().then((function(n){var r=h.WhereClause.create(s[1],n.getFieldsIndex()),i=r.getVariables();if(i.length>0){for(var l=[],u=0;u<i.length;u++){var o={name:i[u]};l.push(e.evaluateIdentifier(t,o))}return Object(a.b)(l).then((function(e){for(var t={},n=0;n<i.length;n++)t[i[n]]=e[n];return r.parameters=t,new y.a({parentfeatureset:s[0],whereclause:r})}))}return Object(a.s)(new y.a({parentfeatureset:s[0],whereclause:r}))})):e.failDefferred("Filter cannot accept this parameter type")}))},e.signatures.push({name:"filter",min:"2",max:"2"}),e.functions.orderby=function(t,n){return e.standardFunctionAsync(t,n,(function(t,n,r){if(Object(i.J)(r,2,2),Object(i.T)(r[0])){var s=new _.a(r[1]);return Object(a.s)(new g.a({parentfeatureset:r[0],orderbyclause:s}))}return e.failDefferred("Order cannot accept this parameter type")}))},e.signatures.push({name:"orderby",min:"2",max:"2"}),e.functions.top=function(t,n){return e.standardFunctionAsync(t,n,(function(t,n,r){return Object(i.J)(r,2,2),Object(i.T)(r[0])?Object(a.s)(new m.a({parentfeatureset:r[0],topnum:r[1]})):Object(i.B)(r[0])?Object(i.w)(r[1])>=r[0].length?r[0].slice(0):r[0].slice(0,Object(i.w)(r[1])):Object(i.I)(r[0])?Object(i.w)(r[1])>=r[0].length()?r[0].slice(0):r[0].slice(0,Object(i.w)(r[1])):e.failDefferred("Top cannot accept this parameter type")}))},e.signatures.push({name:"top",min:"2",max:"2"}),e.functions.first=function(t,n){return e.standardFunctionAsync(t,n,(function(e,t,n){return Object(i.J)(n,1,1),Object(i.T)(n[0])?n[0].first(e.abortSignal).then((function(e){if(null!==e){var t=c.a.createFromGraphicLikeObject(e.geometry,e.attributes,n[0]);t._underlyingGraphic=e,e=t}return e})):Object(i.B)(n[0])?0===n[0].length?Object(a.s)(null):Object(a.s)(n[0][0]):Object(i.I)(n[0])?0===n[0].length()?Object(a.s)(null):Object(a.s)(n[0].get(0)):null}))},e.signatures.push({name:"first",min:"1",max:"1"}),e.functions.attachments=function(t,n){return e.standardFunctionAsync(t,n,(function(e,n,r){Object(i.J)(r,1,2);var a={minsize:-1,maxsize:-1,types:null};if(r.length>1)if(r[1]instanceof s.a){if(r[1].hasField("minsize")&&(a.minsize=Object(i.w)(r[1].field("minsize"))),r[1].hasField("maxsize")&&(a.maxsize=Object(i.w)(r[1].field("maxsize"))),r[1].hasField("types")){var l=Object(i.t)(r[1].field("types"),!1);l.length>0&&(a.types=l)}}else if(null!==r[1])throw new Error("Invalid Parameter");if(r[0]instanceof c.a){var u=r[0]._layer;return u instanceof O.default&&(u=Object(w.constructFeatureSet)(u,t.spatialReference,["*"],!0,t.lrucache)),null===u||!1===Object(i.T)(u)?[]:u.load().then((function(){return u.queryAttachments(r[0].field(u.objectIdField),a.minsize,a.maxsize,a.types)}))}if(null===r[0])return[];throw new Error("Invalid Parameter")}))},e.signatures.push({name:"attachments",min:"1",max:"2"}),e.functions.featuresetbyrelationshipname=function(t,n){return e.standardFunctionAsync(t,n,(function(e,n,r){Object(i.J)(r,2,4);var a=r[0],s=Object(i.y)(r[1]),l=Object(i.c)(r[2],null),u=Object(i.x)(Object(i.c)(r[3],!0));if(null===l&&(l=["*"]),!1===Object(i.B)(l))throw new Error("Invalid Parameter");if(null===r[0])return null;if(!(r[0]instanceof c.a))throw new Error("Invalid Parameter");var o=a._layer;return o instanceof O.default&&(o=Object(w.constructFeatureSet)(o,t.spatialReference,["*"],!0,t.lrucache)),null===o||!1===Object(i.T)(o)?null:o.load().then((function(e){var n=e.relationshipMetaData().filter((function(e){return e.name===s}));if(0===n.length)return null;if(void 0!==n[0].relationshipTableId&&null!==n[0].relationshipTableId&&n[0].relationshipTableId>-1)return Object(w.constructFeatureSetFromRelationship)(e,n[0],a.field(e.objectIdField),e.spatialReference,l,u,t.lrucache);var r=e.serviceUrl();return r?(r="/"===r.charAt(r.length-1)?r+n[0].relatedTableId.toString():r+"/"+n[0].relatedTableId.toString(),Object(w.constructFeatureSetFromUrl)(r,e.spatialReference,l,u,t.lrucache).then((function(t){return t.load().then((function(){return t.relationshipMetaData()})).then((function(r){if(r=r.filter((function(e){return e.id===n[0].id})),!1===a.hasField(n[0].keyField)||null===a.field(n[0].keyField))return e.getFeatureByObjectId(a.field(e.objectIdField),[n[0].keyField]).then((function(e){if(e){var a=h.WhereClause.create(r[0].keyField+"= @id",t.getFieldsIndex());return a.parameters={id:e.attributes[n[0].keyField]},t.filter(a)}return new b.a({parentfeatureset:t})}));var i=h.WhereClause.create(r[0].keyField+"= @id",t.getFieldsIndex());return i.parameters={id:a.field(n[0].keyField)},t.filter(i)}))}))):null}))}))},e.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),e.functions.featuresetbyassociation=function(t,n){return e.standardFunctionAsync(t,n,(function(e,n,a){Object(i.J)(a,2,3);var s=a[0],l=Object(i.y)(Object(i.c)(a[1],"")).toLowerCase(),f=Object(i.v)(a[2])?Object(i.y)(a[2]):null;if(null===a[0])return null;if(!(a[0]instanceof c.a))throw new Error("Invalid Parameter");var d=s._layer;return d instanceof O.default&&(d=Object(w.constructFeatureSet)(d,t.spatialReference,["*"],!0,t.lrucache)),null===d||!1===Object(i.T)(d)?null:d.load().then((function(){var e=d.serviceUrl();return Object(w.constructAssociationMetaDataFeatureSetFromUrl)(e,t.spatialReference)})).then((function(e){var t=null,n=null,a=!1;if(null!==f&&""!==f&&void 0!==f){var c,p=Object(r.a)(e.terminals);try{for(p.s();!(c=p.n()).done;){var y=c.value;y.terminalName===f&&(n=y.terminalId)}}catch(J){p.e(J)}finally{p.f()}null===n&&(a=!0)}var _,g=e.associations.getFieldsIndex(),b=g.get("TOGLOBALID").name,m=g.get("FROMGLOBALID").name,O=g.get("TOTERMINALID").name,j=g.get("FROMTERMINALID").name,w=g.get("FROMNETWORKSOURCEID").name,S=g.get("TONETWORKSOURCEID").name,F=g.get("ASSOCIATIONTYPE").name,k=g.get("ISCONTENTVISIBLE").name,I=g.get("OBJECTID").name,x=Object(r.a)(d.fields);try{for(x.s();!(_=x.n()).done;){var D=_.value;if("global-id"===D.type){t=s.field(D.name);break}}}catch(J){x.e(J)}finally{x.f()}var T=null,C=new v.d(new u.a({name:"percentalong",alias:"percentalong",type:"double"}),h.WhereClause.create("0",e.associations.getFieldsIndex())),E=new v.d(new u.a({name:"side",alias:"side",type:"string"}),h.WhereClause.create("''",e.associations.getFieldsIndex())),R="globalid",N="globalId",A={};for(var P in e.lkp)A[P]=e.lkp[P].sourceId;var L=new v.e(new u.a({name:"classname",alias:"classname",type:"string"}),null,A),G="";switch(l){case"midspan":G="((".concat(b,"='").concat(t,"') OR ( ").concat(m,"='").concat(t,"')) AND (").concat(F," IN (5))"),L.codefield=h.WhereClause.create("CASE WHEN (".concat(b,"='").concat(t,"') THEN ").concat(w," ELSE ").concat(S," END"),e.associations.getFieldsIndex());var B=Object(o.c)(v.a.findField(e.associations.fields,m));B.name=R,B.alias=R,T=new v.d(B,h.WhereClause.create("CASE WHEN (".concat(m,"='").concat(t,"') THEN ").concat(b," ELSE ").concat(m," END"),e.associations.getFieldsIndex())),C=e.unVersion>=4?new v.c(v.a.findField(e.associations.fields,g.get("PERCENTALONG").name)):new v.d(new u.a({name:"percentalong",alias:"percentalong",type:"double"}),h.WhereClause.create("0",e.associations.getFieldsIndex()));break;case"junctionedge":G="((".concat(b,"='").concat(t,"') OR ( ").concat(m,"='").concat(t,"')) AND (").concat(F," IN (4,6))"),L.codefield=h.WhereClause.create("CASE WHEN (".concat(b,"='").concat(t,"') THEN ").concat(w," ELSE ").concat(S," END"),e.associations.getFieldsIndex());var q=Object(o.c)(v.a.findField(e.associations.fields,m));q.name=R,q.alias=R,T=new v.d(q,h.WhereClause.create("CASE WHEN (".concat(m,"='").concat(t,"') THEN ").concat(b," ELSE ").concat(m," END"),e.associations.getFieldsIndex())),E=new v.d(new u.a({name:"side",alias:"side",type:"string"}),h.WhereClause.create("CASE WHEN (".concat(F,"=4) THEN 'from' ELSE 'to' END"),e.associations.getFieldsIndex()));break;case"connected":var M="".concat(b,"='@T'"),U="".concat(m,"='@T'");null!==n&&(M+=" AND ".concat(O,"=@A"),U+=" AND ".concat(j,"=@A")),G="(("+M+") OR ("+U+"))",G=Object(i.g)(G,"@T",t),M=Object(i.g)(M,"@T",t),null!==n&&(M=Object(i.g)(M,"@A",n.toString()),G=Object(i.g)(G,"@A",n.toString())),L.codefield=h.WhereClause.create("CASE WHEN "+M+" THEN ".concat(w," ELSE ").concat(S," END"),e.associations.getFieldsIndex());var W=Object(o.c)(v.a.findField(e.associations.fields,m));W.name=R,W.alias=R,T=new v.d(W,h.WhereClause.create("CASE WHEN "+M+" THEN ".concat(m," ELSE ").concat(b," END"),e.associations.getFieldsIndex()));break;case"container":G="".concat(b,"='").concat(t,"' AND ").concat(F," = 2"),null!==n&&(G+=" AND ".concat(O," = ")+n.toString()),L.codefield=w,G="( "+G+" )",T=new v.b(v.a.findField(e.associations.fields,m),R,R);case"content":G="(".concat(m,"='").concat(t,"' AND ").concat(F," = 2)"),null!==n&&(G+=" AND ".concat(j," = ")+n.toString()),L.codefield=S,G="( "+G+" )",T=new v.b(v.a.findField(e.associations.fields,b),R,R);break;case"structure":G="(".concat(b,"='").concat(t,"' AND ").concat(F," = 3)"),null!==n&&(G+=" AND ".concat(O," = ")+n.toString()),L.codefield=w,G="( "+G+" )",T=new v.b(v.a.findField(e.associations.fields,m),R,N);break;case"attached":G="(".concat(m,"='").concat(t,"' AND ").concat(F," = 3)"),null!==n&&(G+=" AND ".concat(j," = ")+n.toString()),L.codefield=S,G="( "+G+" )",T=new v.b(v.a.findField(e.associations.fields,b),R,N);break;default:throw new Error("Invalid Parameter")}return a&&(G="1 <> 1"),new v.a({parentfeatureset:e.associations,adaptedFields:[new v.c(v.a.findField(e.associations.fields,I)),new v.c(v.a.findField(e.associations.fields,k)),T,E,L,C],extraFilter:G?h.WhereClause.create(G,e.associations.getFieldsIndex()):null})}))}))},e.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),e.functions.groupby=function(t,n){return e.standardFunctionAsync(t,n,(function(n,l,u){return Object(i.J)(u,3,3),Object(i.T)(u[0])?u[0].load().then((function(n){var l=[],o=[],c=!1,f=[];if(Object(i.v)(u[1]))f.push(u[1]);else if(u[1]instanceof s.a)f.push(u[1]);else if(Object(i.B)(u[1]))f=u[1];else{if(!Object(i.I)(u[1]))return e.failDefferred("Illegal Value: GroupBy");f=u[1].toArray()}var d,y=Object(r.a)(f);try{for(y.s();!(d=y.n()).done;){var v=d.value;if(Object(i.v)(v)){var _=h.WhereClause.create(Object(i.y)(v),n.getFieldsIndex()),g=!0===Object(p.c)(_)?Object(i.y)(v):"%%%%FIELDNAME";l.push({name:g,expression:_}),"%%%%FIELDNAME"===g&&(c=!0)}else{if(!(v instanceof s.a))return e.failDefferred("Illegal Value: GroupBy");var b=v.hasField("name")?v.field("name"):"%%%%FIELDNAME",m=v.hasField("expression")?v.field("expression"):"";if("%%%%FIELDNAME"===b&&(c=!0),!b)return e.failDefferred("Illegal Value: GroupBy");l.push({name:b,expression:h.WhereClause.create(m||b,n.getFieldsIndex())})}}}catch(H){y.e(H)}finally{y.f()}if(f=[],Object(i.v)(u[2]))f.push(u[2]);else if(Object(i.B)(u[2]))f=u[2];else if(Object(i.I)(u[2]))f=u[2].toArray();else{if(!(u[2]instanceof s.a))return e.failDefferred("Illegal Value: GroupBy");f.push(u[2])}var O,j=Object(r.a)(f);try{for(j.s();!(O=j.n()).done;){var w=O.value;if(!(w instanceof s.a))return e.failDefferred("Illegal Value: GroupBy");var F=w.hasField("name")?w.field("name"):"",k=w.hasField("statistic")?w.field("statistic"):"",I=w.hasField("expression")?w.field("expression"):"";if(!F||!k||!I)return e.failDefferred("Illegal Value: GroupBy");o.push({name:F,statistic:k.toLowerCase(),expression:h.WhereClause.create(I,n.getFieldsIndex())})}}catch(H){j.e(H)}finally{j.f()}if(c){var x,D={},T=Object(r.a)(n.fields);try{for(T.s();!(x=T.n()).done;){D[x.value.name.toLowerCase()]=1}}catch(H){T.e(H)}finally{T.f()}var C,E=Object(r.a)(l);try{for(E.s();!(C=E.n()).done;){var R=C.value;"%%%%FIELDNAME"!==R.name&&(D[R.name.toLowerCase()]=1)}}catch(H){E.e(H)}finally{E.f()}var N,A=Object(r.a)(o);try{for(A.s();!(N=A.n()).done;){var P=N.value;"%%%%FIELDNAME"!==P.name&&(D[P.name.toLowerCase()]=1)}}catch(H){A.e(H)}finally{A.f()}var L,G=0,B=Object(r.a)(l);try{for(B.s();!(L=B.n()).done;){var q=L.value;if("%%%%FIELDNAME"===q.name){for(;1===D["field_"+G.toString()];)G++;D["field_"+G.toString()]=1,q.name="FIELD_"+G.toString()}}}catch(H){B.e(H)}finally{B.f()}}for(var M=[],U=0,W=l;U<W.length;U++){var J=W[U];M.push(S(J.expression,e,t))}for(var V=0,Q=o;V<Q.length;V++){var Y=Q[V];M.push(S(Y.expression,e,t))}return M.length>0?Object(a.b)(M).then((function(){return Object(a.s)(u[0].groupby(l,o))})):Object(a.s)(u[0].groupby(l,o))})):e.failDefferred("Illegal Value: GroupBy")}))},e.signatures.push({name:"groupby",min:"3",max:"3"}),e.functions.distinct=function(t,n){return e.standardFunctionAsync(t,n,(function(n,l,u){return Object(i.T)(u[0])?(Object(i.J)(u,2,2),u[0].load().then((function(n){var l=[],o=[];if(Object(i.v)(u[1]))o.push(u[1]);else if(u[1]instanceof s.a)o.push(u[1]);else if(Object(i.B)(u[1]))o=u[1];else{if(!Object(i.I)(u[1]))return e.failDefferred("Illegal Value: GroupBy");o=u[1].toArray()}var c,f=!1,d=Object(r.a)(o);try{for(d.s();!(c=d.n()).done;){var y=c.value;if(Object(i.v)(y)){var v=h.WhereClause.create(Object(i.y)(y),n.getFieldsIndex()),_=!0===Object(p.c)(v)?Object(i.y)(y):"%%%%FIELDNAME";l.push({name:_,expression:v}),"%%%%FIELDNAME"===_&&(f=!0)}else{if(!(y instanceof s.a))return e.failDefferred("Illegal Value: GroupBy");var g=y.hasField("name")?y.field("name"):"%%%%FIELDNAME",b=y.hasField("expression")?y.field("expression"):"";if("%%%%FIELDNAME"===g&&(f=!0),!g)return e.failDefferred("Illegal Value: GroupBy");l.push({name:g,expression:h.WhereClause.create(b||g,n.getFieldsIndex())})}}}catch(A){d.e(A)}finally{d.f()}if(f){var m,O={},j=Object(r.a)(n.fields);try{for(j.s();!(m=j.n()).done;){O[m.value.name.toLowerCase()]=1}}catch(A){j.e(A)}finally{j.f()}var w,F=Object(r.a)(l);try{for(F.s();!(w=F.n()).done;){var k=w.value;"%%%%FIELDNAME"!==k.name&&(O[k.name.toLowerCase()]=1)}}catch(A){F.e(A)}finally{F.f()}var I,x=0,D=Object(r.a)(l);try{for(D.s();!(I=D.n()).done;){var T=I.value;if("%%%%FIELDNAME"===T.name){for(;1===O["field_"+x.toString()];)x++;O["field_"+x.toString()]=1,T.name="FIELD_"+x.toString()}}}catch(A){D.e(A)}finally{D.f()}}for(var C=[],E=0,R=l;E<R.length;E++){var N=R[E];C.push(S(N.expression,e,t))}return C.length>0?Object(a.b)(C).then((function(){return Object(a.s)(u[0].groupby(l,[]))})):Object(a.s)(u[0].groupby(l,[]))}))):function(e,t,n,r){if(1===r.length){if(Object(i.B)(r[0]))return Object(f.a)(e,r[0],-1);if(Object(i.I)(r[0]))return Object(f.a)(e,r[0].toArray(),-1)}return Object(f.a)(e,r,-1)}("distinct",0,0,u)}))})}},851:function(e,t,n){"use strict";n.r(t);var r=n(32),a=n(15),i=n(2),s=n(4),l=n(5),u=n(6),o=n(0),c=(n(12),n(10)),f=(n(13),n(14),n(1)),d=n(34),h=n(31),p=n(7),y=n(28),v=(n(9),n(20),n(21),n(26)),_=n(39),g=n(240),b=n(103),m=n(242),O=n(320),j=new d.a({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh","":null}),w=function(e){Object(l.a)(n,e);var t=Object(u.a)(n);function n(e){var r;return Object(i.a)(this,n),(r=t.call(this,e)).displayFieldName=null,r.exceededTransferLimit=!1,r.features=[],r.fields=null,r.geometryType=null,r.hasM=!1,r.hasZ=!1,r.queryGeometry=null,r.spatialReference=null,r}return Object(s.a)(n,[{key:"readFeatures",value:function(e,t){for(var n=_.a.fromJSON(t.spatialReference),r=[],a=0;a<e.length;a++){var i=e[a],s=m.a.fromJSON(i),l=i.geometry&&i.geometry.spatialReference;Object(c.g)(s.geometry)&&!l&&(s.geometry.spatialReference=n),r.push(s)}return r}},{key:"writeGeometryType",value:function(e,t,n,r){if(e)j.write(e,t,n,r);else{var i=this.features;if(i){var s,l=Object(a.a)(i);try{for(l.s();!(s=l.n()).done;){var u=s.value;if(u&&Object(c.g)(u.geometry))return void j.write(u.geometry.type,t,n,r)}}catch(o){l.e(o)}finally{l.f()}}}}},{key:"readQueryGeometry",value:function(e,t){if(!e)return null;var n=!!e.spatialReference,r=Object(g.a)(e);return!n&&t.spatialReference&&(r.spatialReference=_.a.fromJSON(t.spatialReference)),r}},{key:"writeSpatialReference",value:function(e,t){if(e)t.spatialReference=e.toJSON();else{var n=this.features;if(n){var r,i=Object(a.a)(n);try{for(i.s();!(r=i.n()).done;){var s=r.value;s&&Object(c.g)(s.geometry)&&s.geometry.spatialReference&&(t.spatialReference=s.geometry.spatialReference.toJSON())}}catch(l){i.e(l)}finally{i.f()}}}}},{key:"toJSON",value:function(e){var t=this.write(null);if(t.features&&Array.isArray(e)&&e.length>0)for(var n=0;n<t.features.length;n++){var r=t.features[n];if(r.geometry){var a=e&&e[n];r.geometry=a&&a.toJSON()||r.geometry}}return t}},{key:"quantize",value:function(e){for(var t=Object(r.a)(e.scale,2),n=t[0],a=t[1],i=Object(r.a)(e.translate,2),s=i[0],l=i[1],u=this.features,o=this._getQuantizationFunction(this.geometryType,(function(e){return Math.round((e-s)/n)}),(function(e){return Math.round((l-e)/a)})),f=0,d=u.length;f<d;f++)o(Object(c.m)(u[f].geometry))||(u.splice(f,1),f--,d--);return this.transform=e,this}},{key:"unquantize",value:function(){var e=this.geometryType,t=this.features,n=this.transform;if(!n)return this;var i,s=Object(r.a)(n.translate,2),l=s[0],u=s[1],o=Object(r.a)(n.scale,2),f=o[0],d=o[1],h=this._getHydrationFunction(e,(function(e){return e*f+l}),(function(e){return u-e*d})),p=Object(a.a)(t);try{for(p.s();!(i=p.n()).done;){var y=i.value.geometry;Object(c.g)(y)&&h(y)}}catch(v){p.e(v)}finally{p.f()}return this.transform=null,this}},{key:"_quantizePoints",value:function(e,t,n){for(var r,a,i=[],s=0,l=e.length;s<l;s++){var u=e[s];if(s>0){var o=t(u[0]),c=n(u[1]);o===r&&c===a||(i.push([o-r,c-a]),r=o,a=c)}else r=t(u[0]),a=n(u[1]),i.push([r,a])}return i.length>0?i:null}},{key:"_getQuantizationFunction",value:function(e,t,n){var r=this;return"point"===e?function(e){return e.x=t(e.x),e.y=n(e.y),e}:"polyline"===e||"polygon"===e?function(e){for(var a=Object(g.g)(e)?e.rings:e.paths,i=[],s=0,l=a.length;s<l;s++){var u=a[s],o=r._quantizePoints(u,t,n);o&&i.push(o)}return i.length>0?(Object(g.g)(e)?e.rings=i:e.paths=i,e):null}:"multipoint"===e?function(e){var a;return(a=r._quantizePoints(e.points,t,n)).length>0?(e.points=a,e):null}:"extent"===e?function(e){return e}:null}},{key:"_getHydrationFunction",value:function(e,t,n){return"point"===e?function(e){e.x=t(e.x),e.y=n(e.y)}:"polyline"===e||"polygon"===e?function(e){for(var r,a,i=Object(g.g)(e)?e.rings:e.paths,s=0,l=i.length;s<l;s++)for(var u=i[s],o=0,c=u.length;o<c;o++){var f=u[o];o>0?(r+=f[0],a+=f[1]):(r=f[0],a=f[1]),f[0]=t(r),f[1]=n(a)}}:"extent"===e?function(e){e.xmin=t(e.xmin),e.ymin=n(e.ymin),e.xmax=t(e.xmax),e.ymax=n(e.ymax)}:"multipoint"===e?function(e){for(var r,a,i=e.points,s=0,l=i.length;s<l;s++){var u=i[s];s>0?(r+=u[0],a+=u[1]):(r=u[0],a=u[1]),u[0]=t(r),u[1]=n(a)}}:void 0}}]),n}(v.a);Object(o.a)([Object(f.b)({type:String,json:{write:!0}})],w.prototype,"displayFieldName",void 0),Object(o.a)([Object(f.b)({type:Boolean,json:{write:{overridePolicy:function(e){return{enabled:e}}}}})],w.prototype,"exceededTransferLimit",void 0),Object(o.a)([Object(f.b)({type:[m.a],json:{write:!0}})],w.prototype,"features",void 0),Object(o.a)([Object(h.a)("features")],w.prototype,"readFeatures",null),Object(o.a)([Object(f.b)({type:[O.a],json:{write:!0}})],w.prototype,"fields",void 0),Object(o.a)([Object(f.b)({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:j.read}}})],w.prototype,"geometryType",void 0),Object(o.a)([Object(y.a)("geometryType")],w.prototype,"writeGeometryType",null),Object(o.a)([Object(f.b)({type:Boolean,json:{write:{overridePolicy:function(e){return{enabled:e}}}}})],w.prototype,"hasM",void 0),Object(o.a)([Object(f.b)({type:Boolean,json:{write:{overridePolicy:function(e){return{enabled:e}}}}})],w.prototype,"hasZ",void 0),Object(o.a)([Object(f.b)({types:b.b,json:{write:!0}})],w.prototype,"queryGeometry",void 0),Object(o.a)([Object(h.a)("queryGeometry")],w.prototype,"readQueryGeometry",null),Object(o.a)([Object(f.b)({type:_.a,json:{write:!0}})],w.prototype,"spatialReference",void 0),Object(o.a)([Object(y.a)("spatialReference")],w.prototype,"writeSpatialReference",null),Object(o.a)([Object(f.b)({json:{write:!0}})],w.prototype,"transform",void 0),(w=Object(o.a)([Object(p.a)("esri.tasks.support.FeatureSet")],w)).prototype.toJSON.isDefaultToJSON=!0,w||(w={});var S=w;t.default=S},868:function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return o}));var r=n(15),a=n(10),i=n(41),s=n(82);function l(e,t,n){if(Object(a.f)(t)||Object(a.f)(n)||n.vcsWkid||Object(i.c)(t,n))return null;var l=Object(s.c)(t)/Object(s.c)(n);if(1===l)return null;switch(e){case"point":case"esriGeometryPoint":return function(e){return n=l,void((t=e)&&null!=t.z&&(t.z*=n));var t,n};case"polyline":case"esriGeometryPolyline":return function(e){return function(e,t){if(e){var n,a=Object(r.a)(e.paths);try{for(a.s();!(n=a.n()).done;){var i,s=n.value,l=Object(r.a)(s);try{for(l.s();!(i=l.n()).done;){var u=i.value;u.length>2&&(u[2]*=t)}}catch(o){l.e(o)}finally{l.f()}}}catch(o){a.e(o)}finally{a.f()}}}(e,l)};case"polygon":case"esriGeometryPolygon":return function(e){return function(e,t){if(e){var n,a=Object(r.a)(e.rings);try{for(a.s();!(n=a.n()).done;){var i,s=n.value,l=Object(r.a)(s);try{for(l.s();!(i=l.n()).done;){var u=i.value;u.length>2&&(u[2]*=t)}}catch(o){l.e(o)}finally{l.f()}}}catch(o){a.e(o)}finally{a.f()}}}(e,l)};case"multipoint":case"esriGeometryMultipoint":return function(e){return function(e,t){if(e){var n,a=Object(r.a)(e.points);try{for(a.s();!(n=a.n()).done;){var i=n.value;i.length>2&&(i[2]*=t)}}catch(s){a.e(s)}finally{a.f()}}}(e,l)};default:return null}}function u(e,t,n){if(null==e.hasM||e.hasZ){var a,i=Object(r.a)(t);try{for(i.s();!(a=i.n()).done;){var s,l=a.value,u=Object(r.a)(l);try{for(u.s();!(s=u.n()).done;){var o=s.value;o.length>2&&(o[2]*=n)}}catch(c){u.e(c)}finally{u.f()}}}catch(c){i.e(c)}finally{i.f()}}}function o(e,t,n){if((e||t)&&n){var r=Object(s.c)(n);c(e,n,r),c(t,n,r)}}function c(e,t,n){if(e){var a,i=Object(r.a)(e);try{for(i.s();!(a=i.n()).done;){f(a.value.geometry,t,n)}}catch(s){i.e(s)}finally{i.f()}}}function f(e,t,n){if(e&&e.spatialReference&&!Object(i.c)(e.spatialReference,t)){var a=Object(s.c)(e.spatialReference)/n;if(1!==a)if("x"in e)null!=e.z&&(e.z*=a);else if("rings"in e)u(e,e.rings,a);else if("paths"in e)u(e,e.paths,a);else if("points"in e&&(null==e.hasM||e.hasZ)){var l,o=Object(r.a)(e.points);try{for(o.s();!(l=o.n()).done;){var c=l.value;c.length>2&&(c[2]*=a)}}catch(f){o.e(f)}finally{o.f()}}}}},869:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var r=n(2),a=function e(t,n,a,i){Object(r.a)(this,e),this._candidates=null,this._known=null,this._lastFetchedIndex=0,this._ordered=!1,this.pagesDefinition=null,this._candidates=t,this._known=n,this._ordered=a,this.pagesDefinition=i}},871:function(e,t,n){"use strict";var r=n(15),a=n(2),i=n(4),s=n(16),l=n(39),u=n(866),o=n(885),c=function(){function e(t,n){Object(a.a)(this,e),this._lastId=-1,this._progress=n,this._parent=t}return Object(i.a)(e,[{key:"reset",value:function(){this._lastId=-1}},{key:"nextBatch",value:function(e){var t=this;if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then((function(n){return t.nextBatch(e)}),(function(n){return t.nextBatch(e)}));var n={returnpromise:null,hasset:!1},r=[];return n.returnpromise=Object(s.c)((function(a,i){t._parent._getSet(t._progress).then((function(s){var l=s._known.length-1;if("GETPAGES"===s._known[s._known.length-1]&&(l-=1),t._lastId+e>l&&s._known.length>0&&"GETPAGES"===s._known[s._known.length-1])t._parent._expandPagedSet(s,t._parent._maxQueryRate(),0,0,t._progress).then((function(r){n.hasset=!0,t._parent._mainSetInUse=null,t.nextBatch(e).then(a,i)}),(function(e){n.hasset=!0,t._parent._mainSetInUse=null,i(e)}));else{if(l>=t._lastId+e||0===s._candidates.length){for(var u=0;u<e;u++){var o=u+t._lastId+1;if(o>=s._known.length)break;r[u]=s._known[o]}return t._lastId+=r.length,0===r.length&&(n.hasset=!0,t._parent._mainSetInUse=null,a([])),void t._parent._getFeatureBatch(r,t._progress).then((function(e){n.hasset=!0,t._parent._mainSetInUse=null,a(e)}),(function(e){n.hasset=!0,t._parent._mainSetInUse=null,i(e)}))}t._parent._refineSetBlock(s,t._parent._maxProcessingRate(),t._progress).then((function(){n.hasset=!0,t._parent._mainSetInUse=null,t.nextBatch(e).then(a,i)}),(function(e){n.hasset=!0,t._parent._mainSetInUse=null,i(e)}))}}),(function(e){n.hasset=!0,t._parent._mainSetInUse=null,i(e)}))})),!1===n.hasset&&(this._parent._mainSetInUse=n.returnpromise,n.hasset=!0),n.returnpromise}},{key:"next",value:function(){var e=this;if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then((function(t){return e.next()}),(function(t){return e.next()}));var t={returnpromise:null,hasset:!1};return t.returnpromise=Object(s.c)((function(n,r){e._parent._getSet(e._progress).then((function(a){e._lastId<a._known.length-1?"GETPAGES"===a._known[e._lastId+1]?e._parent._expandPagedSet(a,e._parent._maxQueryRate(),0,0,e._progress).then((function(n){return t.hasset=!0,e._parent._mainSetInUse=null,e.next()})).then(n,r):(e._lastId+=1,e._parent._getFeature(a,a._known[e._lastId],e._progress).then((function(r){t.hasset=!0,e._parent._mainSetInUse=null,n(r)}),(function(n){t.hasset=!0,e._parent._mainSetInUse=null,r(n)}))):a._candidates.length>0?e._parent._refineSetBlock(a,e._parent._maxProcessingRate(),e._progress).then((function(){t.hasset=!0,e._parent._mainSetInUse=null,e.next().then(n,r)}),(function(n){t.hasset=!0,e._parent._mainSetInUse=null,r(n)})):(t.hasset=!0,e._parent._mainSetInUse=null,n(null))}),(function(n){t.hasset=!0,e._parent._mainSetInUse=null,r(n)}))})),!1===t.hasset&&(this._parent._mainSetInUse=t.returnpromise,t.hasset=!0),t.returnpromise}},{key:"count",value:function(){var e=this;return-1!==this._parent._totalCount?Object(s.s)(this._parent._totalCount):this._parent._getSet(this._progress).then((function(t){return e._refineAllSets(t)})).then((function(t){return e._parent._totalCount=t._known.length,Object(s.s)(e._parent._totalCount)}))}},{key:"_refineAllSets",value:function(e){var t=this;return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,1,this._progress).then((function(n){return t._refineAllSets(e)})).then((function(e){return Object(s.s)(e)})):e._candidates.length>0?"GETPAGES"===e._known[e._candidates.length-1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,2,this._progress).then((function(n){return t._refineAllSets(e)})).then((function(e){return Object(s.s)(e)})):this._parent._refineSetBlock(e,this._parent._maxProcessingRate(),this._progress).then((function(e){return e._candidates.length>0?t._refineAllSets(e):Object(s.s)(e)})):Object(s.s)(e)}}]),e}(),f=n(869),d=n(908),h=n(852),p=n(893),y=n(426),v=function(){function e(t){Object(a.a)(this,e),this.recentlyUsedQueries=null,this._idstates=[],this._parent=null,this._wset=null,this._mainSetInUse=null,this._maxProcessing=200,this._maxQuery=500,this._totalCount=-1,this._databaseType=u.a.NotEvaluated,this._databaseTypeProbed=null,this.declaredRootClass="esri.arcade.featureset.support.FeatureSet",this._featureCache=[],this.types=null,this.fields=null,this.geometryType="",this.objectIdField="",this.globalIdField="",this.spatialReference=null,this.hasM=!1,this.hasZ=!1,this._transparent=!1,this.loaded=!1,this._loadPromise=null,this._fieldsIndex=null,t&&t.lrucache&&(this.recentlyUsedQueries=t.lrucache)}return Object(i.a)(e,[{key:"optimisePagingFeatureQueries",value:function(e){this._parent&&this._parent.optimisePagingFeatureQueries(e)}},{key:"_hasMemorySource",value:function(){return!0}},{key:"prop",value:function(e,t){return void 0===t?this[e]:(void 0!==this[e]&&(this[e]=t),this)}},{key:"end",value:function(){return null!==this._parent&&!0===this._parent._transparent?this._parent.end():this._parent}},{key:"_ensureLoaded",value:function(){return this.load()}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(s.c)((function(t,n){if(!0===e._parent.loaded)return e._initialiseFeatureSet(),void t(e);e._parent.load().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(t){n(t)}}),n)}))),this._loadPromise}},{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new l.a({wkid:4326}),this.geometryType=u.m.point)}},{key:"getField",value:function(e,t){var n;return(t=t||this.fields)&&(e=e.toLowerCase(),t.some((function(t){return t&&t.name.toLowerCase()===e&&(n=t),!!n}))),n}},{key:"getFieldsIndex",value:function(){return null===this._fieldsIndex&&(this._fieldsIndex=new y.a(this.fields)),this._fieldsIndex}},{key:"_maxProcessingRate",value:function(){return null!==this._parent?Math.min(this._maxProcessing,this._parent._maxProcessingRate()):Math.min(this._maxProcessing,this._maxQueryRate())}},{key:"_maxQueryRate",value:function(){return null!==this._parent?Math.max(this._maxQuery,this._parent._maxQueryRate()):this._maxQuery}},{key:"_checkCancelled",value:function(e){if(null!==e&&e.aborted)throw new Error("Operation has been cancelled.")}},{key:"nativeCapabilities",value:function(){return this._parent.nativeCapabilities()}},{key:"_canDoAggregates",value:function(e,t,n,r,a){return null===this._parent?Object(s.s)(!1):this._parent._canDoAggregates(e,t,n,r,a)}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,n,r,a,i,l){return null===this._parent?Object(s.r)(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,t,n,r,a,i,l)}},{key:"_getAgregagtePhysicalPage",value:function(e,t,n){return null===this._parent?Object(s.r)(new Error("Should never be called")):this._parent._getAgregagtePhysicalPage(e,t,n)}},{key:"databaseType",value:function(){var e=this;if(this._databaseType===u.a.NotEvaluated){if(null!==d.a.applicationCache){var t=d.a.applicationCache.getDatabaseType(this._cacheableFeatureSetSourceKey());if(null!==t)return t}if(null!==this._databaseTypeProbed)return this._databaseTypeProbed;var n=[{thetype:u.a.SqlServer,testwhere:"(CAST( '2015-01-01' as DATETIME) = CAST( '2015-01-01' as DATETIME)) AND OBJECTID<0"},{thetype:u.a.Oracle,testwhere:"(TO_DATE('2003-11-18','YYYY-MM-DD') = TO_DATE('2003-11-18','YYYY-MM-DD')) AND OBJECTID<0"},{thetype:u.a.StandardisedNoInterval,testwhere:"(date '2015-01-01 10:10:10' = date '2015-01-01 10:10:10') AND OBJECTID<0"}],r=Object(s.c)((function(t,r){e._getDatabaseTypeImpl(n,0).then((function(n){e._databaseType=n,t(e._databaseType)}),(function(e){r(e)}))}));return null!==d.a.applicationCache&&(d.a.applicationCache.setDatabaseType(this._cacheableFeatureSetSourceKey(),r),r=r.catch((function(t){throw d.a.applicationCache.clearDatabaseType(e._cacheableFeatureSetSourceKey()),t}))),this._databaseTypeProbed=r,this._databaseTypeProbed}return Object(s.s)(this._databaseType)}},{key:"_cacheableFeatureSetSourceKey",value:function(){return"MUSTBESET"}},{key:"_getDatabaseTypeImpl",value:function(e,t){var n=this;return t>=e.length?Object(s.s)(u.a.StandardisedNoInterval):this._runDatabaseProbe(e[t].testwhere).then((function(r){return!0===r?e[t].thetype:n._getDatabaseTypeImpl(e,t+1)}))}},{key:"_runDatabaseProbe",value:function(e){return null!==this._parent?this._parent._runDatabaseProbe(e):Object(s.r)(new Error("Not Implemented"))}},{key:"isTable",value:function(){return this._parent.isTable()}},{key:"_featureFromCache",value:function(e){if(void 0!==this._featureCache[e])return this._featureCache[e]}},{key:"_isInFeatureSet",value:function(e){return u.b.Unknown}},{key:"_getSet",value:function(e){throw new Error("Not implemented in abstract class")}},{key:"_getFeature",value:function(e,t,n){var r=this;try{return this._checkCancelled(n),void 0!==this._featureFromCache(t)?Object(s.s)(this._featureFromCache(t)):this._getFeatures(e,t,this._maxProcessingRate(),n).then((function(){return r._checkCancelled(n),void 0!==r._featureFromCache(t)?r._featureFromCache(t):Object(s.r)(new Error("Feature Not Found"))}))}catch(e){return Object(s.r)(e)}}},{key:"_getFeatureBatch",value:function(e,t){var n=this;try{this._checkCancelled(t);var a=new f.a([],e,!1,null),i=[];return this._getFeatures(a,-1,e.length,t).then((function(){n._checkCancelled(t);var a,s=Object(r.a)(e);try{for(s.s();!(a=s.n()).done;){var l=a.value;void 0!==n._featureFromCache(l)&&i.push(n._featureFromCache(l))}}catch(u){s.e(u)}finally{s.f()}return i}))}catch(e){return Object(s.r)(e)}}},{key:"_getFeatures",value:function(e,t,n,r){return Object(s.s)("success")}},{key:"_getFilteredSet",value:function(e,t,n,r,a){throw new Error("Not implemented in abstract class")}},{key:"_refineSetBlock",value:function(e,t,n){var r=this;try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQueryRate()))return this._expandPagedSet(e,this._maxQueryRate(),0,0,n).then((function(){return r._refineSetBlock(e,t,n)}));this._checkCancelled(n);var a=e._candidates.length;this._refineKnowns(e,t);var i=a-e._candidates.length;return 0===e._candidates.length||i>=t?Object(s.s)(e):this._refineIfParentKnown(e,t-i,n).then((function(){if(r._checkCancelled(n),r._refineKnowns(e,t-i),(i=a-e._candidates.length)<t&&e._candidates.length>0){var s=t-i,l=r._prepareFetchAndRefineSet(e._candidates);return r._fetchAndRefineFeatures(l,l.length>s?s:e._candidates.length,n).then((function(){return r._checkCancelled(n),r._refineKnowns(e,t-i),e}))}return e}))}catch(e){return Object(s.r)(e)}}},{key:"_fetchAndRefineFeatures",value:function(e,t,n){return null}},{key:"_prepareFetchAndRefineSet",value:function(e){for(var t=[],n=0;n<e.length;n++)this._isPhysicalFeature(e[n])&&t.push(e[n]);return t}},{key:"_isPhysicalFeature",value:function(e){return null===this._parent||this._parent._isPhysicalFeature(e)}},{key:"_refineKnowns",value:function(e,t){var n=0,r=null,a=[];t=this._maxQueryRate();for(var i=0;i<e._candidates.length&&"GETPAGES"!==e._candidates[i];i++){var s=!1,l=this._candidateIdTransform(e._candidates[i]);l!==e._candidates[i]&&(s=!0);var o=this._isInFeatureSet(l);if(o===u.b.InFeatureSet)!0===s?e._known.indexOf(l)<0&&(e._known.push(l),n+=1):(e._known.push(e._candidates[i]),n+=1),null===r?r={start:i,end:i}:r.end===i-1?r.end=i:(a.push(r),r={start:i,end:i});else if(o===u.b.NotInFeatureSet)null===r?r={start:i,end:i}:r.end===i-1?r.end=i:(a.push(r),r={start:i,end:i}),n+=1;else if(o===u.b.Unknown&&(n+=1,!0===e._ordered))break;if(n>=t)break}null!==r&&a.push(r);for(var c=a.length-1;c>=0;c--)e._candidates.splice(a[c].start,a[c].end-a[c].start+1)}},{key:"_refineIfParentKnown",value:function(e,t,n){var r=new f.a([],[],e._ordered,null);return r._candidates=e._candidates.slice(0),this._parent._refineSetBlock(r,t,n)}},{key:"_candidateIdTransform",value:function(e){return this._parent._candidateIdTransform(e)}},{key:"_checkIfNeedToExpandKnownPage",value:function(e,t){if(null===e.pagesDefinition)return!1;for(var n=0,r=e._lastFetchedIndex;r<e._known.length;r++){if("GETPAGES"===e._known[r])return!0;if(void 0===this._featureCache[e._known[r]]&&(n+=1)>=t)break}return!1}},{key:"_checkIfNeedToExpandCandidatePage",value:function(e,t){if(null===e.pagesDefinition)return!1;for(var n=0,r=0;r<e._candidates.length;r++){if("GETPAGES"===e._candidates[r])return!0;if((n+=1)>=t)break}return!1}},{key:"_expandPagedSet",value:function(e,t,n,r,a){return null===this._parent?Object(s.r)(new Error("Parent Paging not implemented")):this._parent._expandPagedSet(e,t,n,r,a)}},{key:"_expandPagedSetFeatureSet",value:function(e,t,n,r,a){var i=this;return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]&&(r=1),0===r&&e._candidates.length>0&&"GETPAGES"===e._candidates[e._candidates.length-1]&&(r=2),0===r?Object(s.s)("finished"):this._getPage(e,r,a).then((function(r){return n+r<t?i._expandPagedSet(e,t,n+r,0,a):"success"}))}},{key:"_getPage",value:function(e,t,n){var r=this,a=1===t?e._known:e._candidates;if(e.pagesDefinition.internal.set.length>e.pagesDefinition.resultOffset||!0===e.pagesDefinition.internal.fullyResolved){a.length=a.length-1;for(var i=0,l=0;l<e.pagesDefinition.resultRecordCount&&!(e.pagesDefinition.resultOffset+l>=e.pagesDefinition.internal.set.length);l++)a[a.length]=e.pagesDefinition.internal.set[e.pagesDefinition.resultOffset+l],i++;e.pagesDefinition.resultOffset+=i;var u=!1;return!0===e.pagesDefinition.internal.fullyResolved&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset&&(u=!0),!1===u&&a.push("GETPAGES"),Object(s.s)(i)}return this._getPhysicalPage(e,t,n).then((function(){return r._getPage(e,t,n)}))}},{key:"_getPhysicalPage",value:function(e,t,n){return null}},{key:"_clonePageDefinition",value:function(e){return null===this._parent?null:this._parent._clonePageDefinition(e)}},{key:"_first",value:function(e){return this.iterator(e).next()}},{key:"first",value:function(e){return this._first(e)}},{key:"calculateStatistic",value:function(e,t,n,r){var a=this;return this._ensureLoaded().then((function(){return a._stat(e,t,"",null,null,n,r).then((function(i){return!1===i.calculated?a._manualStat(e,t,n,r).then((function(e){return e.result})):i.result}))}))}},{key:"_manualStat",value:function(e,t,n,r){switch(e.toLowerCase()){case"count":return Object(p.b)(this,r).then((function(e){return{calculated:!0,result:e}}));case"distinct":return Object(p.d)(this,t,n).then((function(e){return{calculated:!0,result:e}}));case"avg":case"mean":return Object(p.f)(this,t,r).then((function(e){return{calculated:!0,result:e}}));case"stdev":return Object(p.h)(this,t,r).then((function(e){return{calculated:!0,result:e}}));case"variance":return Object(p.j)(this,t,r).then((function(e){return{calculated:!0,result:e}}));case"sum":return Object(p.i)(this,t,r).then((function(e){return{calculated:!0,result:e}}));case"min":return Object(p.g)(this,t,r).then((function(e){return{calculated:!0,result:e}}));case"max":return Object(p.e)(this,t,r).then((function(e){return{calculated:!0,result:e}}));default:return Object(s.s)({calculated:!0,result:0})}}},{key:"_stat",value:function(e,t,n,r,a,i,s){var l=this;return this._parent._stat(e,t,n,r,a,i,s).then((function(u){return!1===u.calculated?null===a&&""===n&&null===r?l._manualStat(e,t,i,s):{calculated:!1}:u}))}},{key:"_unionAllGeomSelf",value:function(e){var t=this,n=this.iterator(this._defaultTracker(e)),r=[];return Object(s.c)((function(e,a){t._unionShapeInBatches(r,n,e,a)}))}},{key:"_unionAllGeom",value:function(e){var t=this;return Object(s.c)((function(n,r){var a=t.iterator(t._defaultTracker(e));t._unionShapeInBatches([],a,n,r)}))}},{key:"_unionShapeInBatches",value:function(e,t,n,r){var a=this;t.next().then((function(i){try{null!==i&&null!==i.geometry&&e.push(i.geometry),e.length>30||null===i&&e.length>1?Object(o.B)(e).then((function(s){try{null===i?n(s):(e=[s],a._unionShapeInBatches(e,t,n,r))}catch(e){r(e)}}),r):null===i?1===e.length?n(e[0]):n(null):a._unionShapeInBatches(e,t,n,r)}catch(e){r(e)}}),r)}},{key:"iterator",value:function(e){return new c(this,e)}},{key:"intersection",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e._featuresetFunctions.intersection.bind(this)(t,n)}},{key:"difference",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return e._featuresetFunctions.difference.bind(this)(t,n,r)}},{key:"symmetricDifference",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return e._featuresetFunctions.symmetricDifference.bind(this)(t,n,r)}},{key:"morphShape",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unknown",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return e._featuresetFunctions.morphShape.bind(this)(t,n,r,a)}},{key:"morphShapeAndAttributes",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unknown";return e._featuresetFunctions.morphShapeAndAttributes.bind(this)(t,n,r)}},{key:"union",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e._featuresetFunctions.union.bind(this)(t,n)}},{key:"intersects",value:function(t){return e._featuresetFunctions.intersects.bind(this)(t)}},{key:"envelopeIntersects",value:function(t){return e._featuresetFunctions.envelopeIntersects.bind(this)(t)}},{key:"contains",value:function(t){return e._featuresetFunctions.contains.bind(this)(t)}},{key:"overlaps",value:function(t){return e._featuresetFunctions.overlaps.bind(this)(t)}},{key:"relate",value:function(t,n){return e._featuresetFunctions.relate.bind(this)(t,n)}},{key:"within",value:function(t){return e._featuresetFunctions.within.bind(this)(t)}},{key:"touches",value:function(t){return e._featuresetFunctions.touches.bind(this)(t)}},{key:"top",value:function(t){return e._featuresetFunctions.top.bind(this)(t)}},{key:"crosses",value:function(t){return e._featuresetFunctions.crosses.bind(this)(t)}},{key:"buffer",value:function(t,n,r){var a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return e._featuresetFunctions.buffer.bind(this)(t,n,r,a)}},{key:"filter",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return e._featuresetFunctions.filter.bind(this)(t,n)}},{key:"orderBy",value:function(t){return e._featuresetFunctions.orderBy.bind(this)(t)}},{key:"dissolve",value:function(t,n){return e._featuresetFunctions.dissolve.bind(this)(t,n)}},{key:"groupby",value:function(t,n){return e._featuresetFunctions.groupby.bind(this)(t,n)}},{key:"reduce",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0;return Object(s.c)((function(a,i){t._reduceImpl(t.iterator(t._defaultTracker(r)),e,n,0,a,i,0)}))}},{key:"_reduceImpl",value:function(e,t,n,r,a,i,l){var u=this;try{if(++l>1e3)return void setTimeout((function(){l=0,u._reduceImpl(e,t,n,r,a,i,l)}));e.next().then((function(o){try{if(null===o)a(n);else{var c=t(n,o,r,u);Object(s.n)(c)?c.then((function(n){u._reduceImpl(e,t,n,r+1,a,i,l)}),i):u._reduceImpl(e,t,c,r+1,a,i,l)}}catch(e){i(e)}}),i)}catch(e){i(e)}}},{key:"removeField",value:function(t){return e._featuresetFunctions.removeField.bind(this)(t)}},{key:"addField",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return e._featuresetFunctions.addField.bind(this)(t,n,r)}},{key:"sumArea",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0,r=Object(u.e)(e);return this.reduce((function(e,n){return null===n.geometry?0:t?Object(o.l)(n.geometry,r).then((function(t){return e+t})):Object(o.u)(n.geometry,r).then((function(t){return e+t}))}),0,n)}},{key:"sumLength",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0,r=Object(u.d)(e);return this.reduce((function(e,n){return null===n.geometry?0:t?Object(o.o)(n.geometry,r).then((function(t){return e+t})):Object(o.v)(n.geometry,r).then((function(t){return e+t}))}),0,n)}},{key:"_substituteVars",value:function(e,t){if(null!==t){var n={};for(var r in t)n[r.toLowerCase()]=t[r];e.parameters=n}}},{key:"distinct",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3?arguments[3]:void 0;return this.load().then((function(){var i=h.WhereClause.create(e,t.getFieldsIndex());return t._substituteVars(i,r),t.calculateStatistic("distinct",i,n,t._defaultTracker(a))}))}},{key:"min",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0;return this.load().then((function(){var a=h.WhereClause.create(e,t.getFieldsIndex());return t._substituteVars(a,n),t.calculateStatistic("min",a,-1,t._defaultTracker(r))}))}},{key:"max",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0;return this.load().then((function(){var a=h.WhereClause.create(e,t.getFieldsIndex());return t._substituteVars(a,n),t.calculateStatistic("max",a,-1,t._defaultTracker(r))}))}},{key:"avg",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0;return this.load().then((function(){var a=h.WhereClause.create(e,t.getFieldsIndex());return t._substituteVars(a,n),t.calculateStatistic("avg",a,-1,t._defaultTracker(r))}))}},{key:"sum",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0;return this.load().then((function(){var a=h.WhereClause.create(e,t.getFieldsIndex());return t._substituteVars(a,n),t.calculateStatistic("sum",a,-1,t._defaultTracker(r))}))}},{key:"stdev",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0;return this.load().then((function(){var a=h.WhereClause.create(e,t.getFieldsIndex());return t._substituteVars(a,n),t.calculateStatistic("stdev",a,-1,t._defaultTracker(r))}))}},{key:"variance",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2?arguments[2]:void 0;return this.load().then((function(){var a=h.WhereClause.create(e,t.getFieldsIndex());return t._substituteVars(a,n),t.calculateStatistic("variance",a,-1,t._defaultTracker(r))}))}},{key:"count",value:function(e){var t=this;return this.load().then((function(){return t.calculateStatistic("count",h.WhereClause.create("1",t.getFieldsIndex()),-1,t._defaultTracker(e))}))}},{key:"_defaultTracker",value:function(e){return e||{aborted:!1}}},{key:"forEach",value:function(e,t){var n=this;return Object(s.c)((function(r,a){n._forEachImpl(n.iterator(n._defaultTracker(t)),e,n,r,a,0)}))}},{key:"_forEachImpl",value:function(e,t,n,r,a,i){var l=this;try{if(++i>1e3)return void setTimeout((function(){i=0,l._forEachImpl(e,t,n,r,a,i)}),0);e.next().then((function(u){try{if(null===u)r(n);else{var o=t(u);null==o?l._forEachImpl(e,t,n,r,a,i):Object(s.n)(o)?o.then((function(){try{l._forEachImpl(e,t,n,r,a,i)}catch(e){a(e)}}),a):l._forEachImpl(e,t,n,r,a,i)}}catch(e){a(e)}}),a)}catch(e){a(e)}}},{key:"convertToJSON",value:function(e){for(var t={layerDefinition:{geometryType:this.geometryType,fields:[]},featureSet:{features:[],geometryType:this.geometryType}},n=0;n<this.fields.length;n++)t.layerDefinition.fields.push(Object(u.h)(this.fields[n]));return this.reduce((function(e,n){var r={geometry:n.geometry&&n.geometry.toJSON(),attributes:{}};for(var a in n.attributes)r.attributes[a]=n.attributes[a];return t.featureSet.features.push(r),1}),0,e).then((function(){return t}))}},{key:"castToText",value:function(){return"object, FeatureSet"}},{key:"queryAttachments",value:function(e,t,n,r){return this._parent.queryAttachments(e,t,n,r)}},{key:"serviceUrl",value:function(){return this._parent.serviceUrl()}},{key:"subtypes",value:function(){return this.typeIdField?{subtypeField:this.typeIdField,subtypes:this.types?this.types.map((function(e){return{name:e.name,code:e.id}})):[]}:null}},{key:"relationshipMetaData",value:function(){return this._parent.relationshipMetaData()}},{key:"schema",value:function(){var e,t=[],n=Object(r.a)(this.fields);try{for(n.s();!(e=n.n()).done;){var a=e.value;t.push(Object(u.h)(a))}}catch(i){n.e(i)}finally{n.f()}return{objectIdField:this.objectIdField,globalIdField:this.globalIdField,geometryType:void 0===u.n[this.geometryType]?"":u.n[this.geometryType],fields:t}}},{key:"convertToText",value:function(e,t){var n=this;return"schema"===e?this._ensureLoaded().then((function(){return JSON.stringify(n.schema())})):"featureset"===e?this._ensureLoaded().then((function(){var e=[];return n.reduce((function(t,n){var r={geometry:n.geometry?n.geometry.toJSON():null,attributes:n.attributes};return null!==r.geometry&&r.geometry.spatialReference&&delete r.geometry.spatialReference,e.push(r),1}),0,t).then((function(){var t=n.schema();return t.features=e,t.spatialReference=n.spatialReference.toJSON(),JSON.stringify(t)}))})):Object(s.s)(this.castToText())}},{key:"getFeatureByObjectId",value:function(e,t){return this._parent.getFeatureByObjectId(e,t)}},{key:"getOwningSystemUrl",value:function(){return this._parent.getOwningSystemUrl()}},{key:"getIdentityUser",value:function(){return this._parent.getIdentityUser()}},{key:"gdbVersion",get:function(){return this._parent?this._parent.gdbVersion:""}}]),e}();v._featuresetFunctions={};t.a=v},873:function(e,t,n){"use strict";n.d(t,"a",(function(){return A}));var r=n(8),a=n.n(r),i=(n(32),n(23)),s=n(15),l=n(78),u=n(10),o=n(13),c=n(24),f=n(16),d=n(41),h=n(39),p=n(83),y=n(132),v=n(131),_=n(11),g=n(9),b=n(240),m=(n(103),n(59));function O(e,t,n,r){return j.apply(this,arguments)}function j(){return(j=Object(i.a)(a.a.mark((function e(t,n,r,i){var s,l,u,o,c,f,d,h;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s="string"==typeof t?Object(g.I)(t):t,l=n[0].spatialReference,u=Object(_.a)(Object(_.a)({},i),{},{query:Object(_.a)(Object(_.a)({},s.query),{},{f:"json",sr:JSON.stringify(l),target:JSON.stringify({geometryType:Object(b.c)(n[0]),geometries:n}),cutter:JSON.stringify(r)})}),e.next=5,Object(m.default)(s.path+"/cut",u);case 5:return o=e.sent,c=o.data,f=c.cutIndexes,d=c.geometries,h=void 0===d?[]:d,e.abrupt("return",{cutIndexes:f,geometries:h.map((function(e){var t=Object(b.a)(e);return t.spatialReference=l,t}))});case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function w(e,t,n){return S.apply(this,arguments)}function S(){return(S=Object(i.a)(a.a.mark((function e(t,n,r){var i,s,l,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i="string"==typeof t?Object(g.I)(t):t,s=n[0].spatialReference,l=Object(b.c)(n[0]),u=Object(_.a)(Object(_.a)({},r),{},{query:Object(_.a)(Object(_.a)({},i.query),{},{f:"json",sr:s.wkid?s.wkid:JSON.stringify(s),geometries:JSON.stringify(F(n))})}),e.t0=function(e,t,n){var r=Object(b.b)(t);return e.map((function(e){var t=r.fromJSON(e);return t.spatialReference=n,t}))},e.next=4,Object(m.default)(i.path+"/simplify",u);case 4:return e.t1=e.sent.data,e.t2=l,e.t3=s,e.abrupt("return",(0,e.t0)(e.t1,e.t2,e.t3));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function F(e){return{geometryType:Object(b.c)(e[0]),geometries:e.map((function(e){return e.toJSON()}))}}var k=o.a.getLogger("esri.geometry.support.normalizeUtils"),I={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:new v.a({paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:h.a.WebMercator}),minus180Line:new v.a({paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:h.a.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new v.a({paths:[[[180,-180],[180,180]]],spatialReference:h.a.WGS84}),minus180Line:new v.a({paths:[[[-180,-180],[-180,180]]],spatialReference:h.a.WGS84})}};function x(e){return"polygon"===e.type}function D(e){return"polyline"===e[0].type}function T(e){return x(e)?e.rings:e.paths}function C(e,t){return Math.ceil((e-t)/(2*t))}function E(e,t){var n,r=T(e),a=Object(s.a)(r);try{for(a.s();!(n=a.n()).done;){var i,l=n.value,u=Object(s.a)(l);try{for(u.s();!(i=u.n()).done;){i.value[0]+=t}}catch(o){u.e(o)}finally{u.f()}}}catch(o){a.e(o)}finally{a.f()}return e}function R(e,t,n){if(t){var r=function(e,t){if(!(e instanceof v.a||e instanceof y.a)){var n="straightLineDensify: the input geometry is neither polyline nor polygon";throw k.error(n),new c.a(n)}var r,a=T(e),i=[],l=Object(s.a)(a);try{for(l.s();!(r=l.n()).done;){var u=r.value,o=[];i.push(o),o.push([u[0][0],u[0][1]]);for(var f=0;f<u.length-1;f++){var d=u[f][0],h=u[f][1],p=u[f+1][0],_=u[f+1][1],g=Math.sqrt((p-d)*(p-d)+(_-h)*(_-h)),b=(_-h)/g,m=(p-d)/g,O=g/t;if(O>1){for(var j=1;j<=O-1;j++){var w=j*t,S=m*w+d,F=b*w+h;o.push([S,F])}var I=(g+Math.floor(O-1)*t)/2,D=m*I+d,C=b*I+h;o.push([D,C])}o.push([p,_])}}}catch(E){l.e(E)}finally{l.f()}return x(e)?new y.a({rings:i,spatialReference:e.spatialReference}):new v.a({paths:i,spatialReference:e.spatialReference})}(e,1e6);e=Object(p.e)(r,!0)}return n&&(e=E(e,n)),e}function N(e,t,n){if(Array.isArray(e)){var r=e[0];if(r>t){var a=C(r,t);e[0]=r+a*(-2*t)}else if(r<n){var i=C(r,n);e[0]=r+i*(-2*n)}}else{var s=e.x;if(s>t){var l=C(s,t);e=e.clone().offset(l*(-2*t),0)}else if(s<n){var u=C(s,n);e=e.clone().offset(u*(-2*n),0)}}return e}function A(e,t,n){return P.apply(this,arguments)}function P(){return(P=Object(i.a)(a.a.mark((function e(t,n,r){var i,o,c,h,_,g,b,m,j,S,F,k,x,P,L,G,B,q,M,U,W,J,V,Q,Y,H,z,K,Z,X,$,ee,te,ne,re,ae,ie,se,le,ue;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Array.isArray(t)){e.next=2;break}return e.abrupt("return",A([t],n));case 2:i=n?n.url:l.a.geometryServiceUrl,S=0,F=[],k=[],x=Object(s.a)(t);try{for(x.s();!(P=x.n()).done;)L=P.value,Object(u.f)(L)?k.push(L):(o||(o=L.spatialReference,c=Object(d.d)(o),h=o.isWebMercator,_=I[b=h?102100:4326].maxX,g=I[b].minX,m=I[b].plus180Line,j=I[b].minus180Line),c?"mesh"===L.type?k.push(L):"point"===L.type?k.push(N(L.clone(),_,g)):"multipoint"===L.type?((G=L.clone()).points=G.points.map((function(e){return N(e,_,g)})),k.push(G)):"extent"===L.type?(B=L.clone()._normalize(!1,!1,c),k.push(B.rings?new y.a(B):B)):L.extent?(q=L.extent,M=C(q.xmin,g)*(2*_),U=0===M?L.clone():E(L.clone(),M),q.offset(M,0),q.intersects(m)&&q.xmax!==_?(S=q.xmax>S?q.xmax:S,U=R(U,h),F.push(U),k.push("cut")):q.intersects(j)&&q.xmin!==g?(S=q.xmax*(2*_)>S?q.xmax*(2*_):S,U=R(U,h,360),F.push(U),k.push("cut")):k.push(U)):k.push(L.clone()):k.push(L))}catch(a){x.e(a)}finally{x.f()}for(W=C(S,_),J=-90,V=W,Q=new v.a;W>0;)Y=360*W-180,Q.addPath([[Y,J],[Y,-1*J]]),J*=-1,W--;if(!(F.length>0&&V>0)){e.next=28;break}return e.t0=function(e,t){for(var n=-1,r=function(r){for(var i=t.cutIndexes[r],l=t.geometries[r],u=T(l),o=function(e){var t=u[e];t.some((function(n){if(n[0]<180)return!0;for(var r=0,a=0;a<t.length;a++){var i=t[a][0];r=i>r?i:r}for(var s=-360*C(r=Number(r.toFixed(9)),180),u=0;u<t.length;u++){var o=l.getPoint(e,u);l.setPoint(e,u,o.clone().offset(s,0))}return!0}))},c=0;c<u.length;c++)o(c);if(i===n){if("polygon"===e[0].type){var f,d=Object(s.a)(T(l));try{for(d.s();!(f=d.n()).done;){var h=f.value;e[i]=e[i].addRing(h)}}catch(a){d.e(a)}finally{d.f()}}else if(D(e)){var p,y=Object(s.a)(T(l));try{for(y.s();!(p=y.n()).done;){var v=p.value;e[i]=e[i].addPath(v)}}catch(a){y.e(a)}finally{y.f()}}}else n=i,e[i]=l},i=0;i<t.cutIndexes.length;i++)r(i);return e},e.t1=F,e.next=15,O(i,F,Q,r);case 15:for(e.t2=e.sent,H=(0,e.t0)(e.t1,e.t2),z=[],K=[],Z=0;Z<k.length;Z++)"cut"!==(X=k[Z])?K.push(X):($=H.shift(),ee=t[Z],Object(u.g)(ee)&&"polygon"===ee.type&&ee.rings&&ee.rings.length>1&&$.rings.length>=ee.rings.length?(z.push($),K.push("simplify")):K.push(h?Object(p.b)($):$));if(z.length){e.next=22;break}return e.abrupt("return",K);case 22:return e.next=24,w(i,z,r);case 24:for(te=e.sent,ne=[],re=0;re<K.length;re++)"simplify"!==(ae=K[re])?ne.push(ae):ne.push(h?Object(p.b)(te.shift()):te.shift());return e.abrupt("return",ne);case 28:for(ie=[],se=0;se<k.length;se++)"cut"!==(le=k[se])?ie.push(le):(ue=F.shift(),ie.push(!0===h?Object(p.b)(ue):ue));return e.abrupt("return",Object(f.s)(ie));case 31:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},875:function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return j})),n.d(t,"c",(function(){return m})),n.d(t,"d",(function(){return h})),n.d(t,"e",(function(){return p})),n.d(t,"f",(function(){return y})),n.d(t,"g",(function(){return o})),n.d(t,"h",(function(){return b})),n.d(t,"i",(function(){return l})),n.d(t,"j",(function(){return u})),n.d(t,"k",(function(){return d}));var r=n(15),a=n(867),i=n(866),s=n(852);function l(e,t){return f(e.parseTree,t,e.parameters)}function u(e,t,n){return f(e,t,n)}function o(e,t,n,r){return s.WhereClause.create(f(e.parseTree,i.a.Standardised,e.parameters,t,n),r)}function c(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"AND";return s.WhereClause.create("(("+l(e,i.a.Standardised)+")"+n+"("+l(t,i.a.Standardised)+"))",e.fieldsIndex)}function f(e,t,n){var a,i,s,l,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;switch(e.type){case"interval":return j(f(e.value,t,n,u,o),e.qualifier,e.op);case"case_expression":var c=" CASE ";"simple"===e.format&&(c+=f(e.operand,t,n,u,o));for(var y=0;y<e.clauses.length;y++)c+=" WHEN "+f(e.clauses[y].operand,t,n,u,o)+" THEN "+f(e.clauses[y].value,t,n,u,o);return null!==e.else&&(c+=" ELSE "+f(e.else,t,n,u,o)),c+=" END ";case"param":var v=n[e.value.toLowerCase()];if("string"==typeof v)return"'"+n[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(v instanceof Date)return h(v,t);if(v instanceof Array){for(var _=[],g=0;g<v.length;g++)"string"==typeof v[g]?_.push("'"+v[g].toString().replace(/'/g,"''")+"'"):v[g]instanceof Date?_.push(h(v[g],t)):_.push(v[g].toString());return _}return v.toString();case"expr_list":i=[];var b,m=Object(r.a)(e.value);try{for(m.s();!(b=m.n()).done;){var O=b.value;i.push(f(O,t,n,u,o))}}catch(S){m.e(S)}finally{m.f()}return i;case"unary_expr":return" ( NOT "+f(e.expr,t,n,u,o)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+f(e.left,t,n,u,o)+" AND "+f(e.right,t,n,u,o)+") ";case"OR":return" ("+f(e.left,t,n,u,o)+" OR "+f(e.right,t,n,u,o)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+f(e.left,t,n,u,o)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+f(e.left,t,n,u,o)+" IS NOT NULL )";case"IN":return a=[],"expr_list"===e.right.type?(a=f(e.right,t,n,u,o)," ("+f(e.left,t,n,u,o)+" IN ("+a.join(",")+")) "):(l=f(e.right,t,n,u,o))instanceof Array?" ("+f(e.left,t,n,u,o)+" IN ("+l.join(",")+")) ":" ("+f(e.left,t,n,u,o)+" IN ("+l+")) ";case"NOT IN":return a=[],"expr_list"===e.right.type?(a=f(e.right,t,n,u,o)," ("+f(e.left,t,n,u,o)+" NOT IN ("+a.join(",")+")) "):(l=f(e.right,t,n,u,o))instanceof Array?" ("+f(e.left,t,n,u,o)+" NOT IN ("+l.join(",")+")) ":" ("+f(e.left,t,n,u,o)+" NOT IN ("+l+")) ";case"BETWEEN":return s=f(e.right,t,n,u,o)," ("+f(e.left,t,n,u,o)+" BETWEEN "+s[0]+" AND "+s[1]+" ) ";case"NOTBETWEEN":return s=f(e.right,t,n,u,o)," ("+f(e.left,t,n,u,o)+" NOT BETWEEN "+s[0]+" AND "+s[1]+" ) ";case"LIKE":return""!==e.escape?" ("+f(e.left,t,n,u,o)+" LIKE "+f(e.right,t,n,u,o)+" ESCAPE '"+e.escape+"') ":" ("+f(e.left,t,n,u,o)+" LIKE "+f(e.right,t,n,u,o)+") ";case"NOT LIKE":return""!==e.escape?" ("+f(e.left,t,n,u,o)+" NOT LIKE "+f(e.right,t,n,u,o)+" ESCAPE '"+e.escape+"') ":" ("+f(e.left,t,n,u,o)+" NOT LIKE "+f(e.right,t,n,u,o)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+f(e.left,t,n,u,o)+" "+e.operator+" "+f(e.right,t,n,u,o)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return h(e.value,t);case"number":return e.value.toString();case"current_time":return p("date"===e.mode,t);case"column_ref":return u&&u.toLowerCase()===e.column.toLowerCase()?"("+o+")":e.column;case"function":var w=f(e.args,t,n,u,o);return d(e.name,w,t)}throw new Error("Unsupported sql syntax "+e.type)}function d(e,t,n){switch(e.toLowerCase().trim()){case"abs":if(1!==t.length)throw new Error("Invalid Parameter for call to ABS");return"abs("+t[0]+")";case"ceiling":case"ceil":if(1!==t.length)throw new Error("Invalid Parameter for call to CEILING");switch(n){case i.a.Standardised:case i.a.StandardisedNoInterval:default:return"CEILING("+t[0]+")"}case"floor":if(1!==t.length)throw new Error("Invalid Parameter for call to Floor");return"FLOOR("+t[0]+")";case"log":if(1!==t.length)throw new Error("Invalid Parameter for call to LOG");return"LOG("+t[0]+")";case"log10":if(1!==t.length)throw new Error("Invalid Parameter for call to LOG10");return"LOG10("+t[0]+")";case"power":if(2!==t.length)throw new Error("Invalid Parameter for call to POWER");return"POWER("+t[0]+","+t[1]+")";case"round":if(2===t.length)return"ROUND("+t[0]+","+t[1]+")";if(1===t.length)return"ROUND("+t[0]+")";throw new Error("Invalid Parameter for call to ROUND");case"truncate":if(t.length<1||t.length>2)throw new Error("Invalid Parameter for TRUNCATE function");switch(n){case i.a.SqlServer:return"ROUND("+t[0]+(1===t.length?"0":","+t[1])+",1)";default:return"TRUNCATE("+t[0]+(1===t.length?")":","+t[1]+")")}case"char_length":case"len":if(1!==t.length)throw new Error("Invalid Parameter for CHAR_LENGTH function");switch(n){case i.a.SqlServer:return"LEN("+t[0]+")";case i.a.Oracle:return"LENGTH("+t[0]+")";default:return"CHAR_LENGTH("+t[0]+")"}case"concat":if(t.length<1)throw new Error("Invalid Parameter for CONCAT function");for(var r="CONCAT(",a=0;a<t.length;a++)0!==a&&(r+=","),r+=t[a];return r+=")";case"lower":case"lcase":if(1!==t.length)throw new Error("Invalid Parameter for Lower function");return"LOWER("+t[0]+")";case"upper":case"ucase":if(1!==t.length)throw new Error("Invalid Parameter for Upper function");return"UPPER("+t[0]+")";case"substring":var s="";switch(n){case i.a.Oracle:return s="SUBSTR("+t[0]+","+t[1],3===t.length&&(s+=","+t[2]),s+=")";case i.a.SqlServer:return s=3===t.length?"SUBSTRING("+t[0]+","+t[1]+","+t[2]+")":"SUBSTRING("+t[0]+",  "+t[1]+", LEN("+t[0]+") - "+t[1]+")";default:return s="SUBSTRING("+t[0]+" FROM "+t[1],3===t.length&&(s+=" FOR "+t[2]),s+=")"}case"extract":return"EXTRACT("+t[0].replace(/\'/g,"")+" FROM "+t[1]+")"}throw new Error("Function Not Recognised")}function h(e,t){var n=a.m.Moment(e),r=0===n.minute()&&0===n.hour()&&0===n.second()&&0===n.millisecond();switch(t){case i.a.FILEGDB:case i.a.Standardised:case i.a.StandardisedNoInterval:return r?"date '"+n.format("YYYY-MM-DD")+"'":"date '"+n.format("YYYY-MM-DD HH:mm:ss")+"'";case i.a.Oracle:return r?"TO_DATE('"+n.format("YYYY-MM-DD")+"','YYYY-MM-DD')":"TO_DATE('"+n.format("YYYY-MM-DD HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case i.a.SqlServer:return"'"+n.format(r?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";case i.a.PGDB:return"#"+n.format(r?"MM-DD-YYYY":"MM-DD-YYYY HH:mm:ss")+"#";case i.a.Postgres:return"TIMESTAMP '"+n.format(r?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";default:return"date '"+n.format("YYYY-MM-DD HH:mm:ss")+"'"}}function p(e,t){switch(t){case i.a.FILEGDB:case i.a.Standardised:case i.a.StandardisedNoInterval:case i.a.Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case i.a.SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case i.a.PGDB:case i.a.Postgres:default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function y(e,t){var n,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i={},s={},l={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",string:"string"},u=Object(r.a)(t);try{for(u.s();!(n=u.n()).done;){var o=n.value,c=l[o.type];i[o.name.toLowerCase()]=void 0===c?"":c}}catch(h){u.e(h)}finally{u.f()}for(var f in a){var d=l[a[f]];s[f.toLowerCase()]=void 0===d?"":d}switch(v(i,e.parseTree,e.parameters,s)){case"double":return"double";case"integer":return"integer";case"double":return"double";case"date":return"date";case"string":return"string"}return""}function v(e,t,n,a){var i;switch(t.type){case"interval":return"integer";case"case_expression":var s=[];if("simple"===t.format){for(var l=0;l<t.clauses.length;l++)s.push(v(e,t.clauses[l].value,n,a));null!==t.else&&s.push(v(e,t.else,n,a))}else{for(var u=0;u<t.clauses.length;u++)s.push(v(e,t.else,n,a));null!==t.else&&s.push(v(e,t.else,n,a))}return g(s);case"param":var o=a[t.value.toLowerCase()];if(void 0===o&&n){var c=n[t.value.toLowerCase()];if(void 0===c)return"";if(null===c)return"";if("string"==typeof c||c instanceof String)return"string";if("boolean"==typeof c)return"boolean";if(c instanceof Date)return"date";if("number"==typeof c)return c%1==0?"integer":"double"}return void 0===o?"":o;case"expr_list":var f,d=[],h=Object(r.a)(t.value);try{for(h.s();!(f=h.n()).done;){var p=f.value;d.push(v(e,p,n,a))}}catch(b){h.e(b)}finally{h.f()}return d;case"unary_expr":return"boolean";case"binary_expr":switch(t.operator){case"AND":case"OR":return"boolean";case"IS":case"ISNOT":if("null"!==t.right.type)throw new Error("Unsupported RHS for IS");return"boolean";case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":return"boolean";case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"*":case"-":case"+":case"/":return g([v(e,t.left,n,a),v(e,t.right,n,a)]);default:throw new Error("Not Supported Operator "+t.operator)}case"null":return"";case"bool":return"boolean";case"string":return"string";case"number":return null===t.value?"":t.value%1==0?"integer":"double";case"date":case"timestamp":case"current_time":return"date";case"column_ref":var y=e[t.column.toLowerCase()];return void 0===y?"":y;case"function":switch(t.name.toLowerCase()){case"position":case"extract":case"char_length":return"integer";case"round":return(i=v(e,t.args,n,a))instanceof Array?i.length>0?i[0]:"":i;case"sign":return(i=v(e,t.args,n,a))instanceof Array&&(i=g(i)),"integer"===i||"double"===i?i:"double";case"ceiling":case"floor":case"abs":var _=v(e,t.args,n,a);return _ instanceof Array?g(_):_;case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"power":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string";case"truncate":return"double";case"round":return(i=v(e,t.args,n,a))instanceof Array?i.length>0?i[0]:"":i}return""}throw new Error("Unsupported sql syntax "+t.type)}var _={boolean:1,string:2,integer:3,double:4,date:5};function g(e){if(e){var t,n="",a=Object(r.a)(e);try{for(a.s();!(t=a.n()).done;){var i=t.value;""!==i&&(n=""===n||_[n]<_[i]?i:n)}}catch(s){a.e(s)}finally{a.f()}return n}return""}function b(e,t){return function e(t,n){if(null==t)return!1;switch(t.type){case"when_clause":return e(t.operand,n)||e(t.value,n);case"case_expression":var a,i=Object(r.a)(t.clauses);try{for(i.s();!(a=i.n()).done;){var s=a.value;if(e(s,n))return!0}}catch(c){i.e(c)}finally{i.f()}return!("simple"!==t.format||!e(t.operand,n))||!(null===t.else||!e(t.else,n));case"param":return!1;case"expr_list":var l,u=Object(r.a)(t.value);try{for(u.s();!(l=u.n()).done;){var o=l.value;if(e(o,n))return!0}}catch(c){u.e(c)}finally{u.f()}return!1;case"unary_expr":return e(t.expr,n);case"binary_expr":return e(t.left,n)||e(t.right,n);case"null":case"bool":case"date":case"timestamp":case"string":case"number":return!1;case"column_ref":return n.toLowerCase()===t.column.toLowerCase();case"function":return e(t.args,n)}return!1}(e.parseTree,t)}function m(e){return"column_ref"===e.parseTree.type}function O(e){var t="";return t+=e.period.toUpperCase()}function j(e,t,n){return"INTERVAL "+n+" "+e+" "+("interval-period"===t.type?O(t):O(t.start)+" TO "+O(t.end))}},876:function(e,t,n){"use strict";var r=n(11),a=n(2),i=n(4),s=n(5),l=n(6),u=n(0),o=(n(12),n(13),n(14),n(1)),c=n(7),f=n(9),d=(n(20),n(21),function(e){Object(s.a)(n,e);var t=Object(l.a)(n);function n(){var e;Object(a.a)(this,n);for(var r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];return(e=t.call.apply(t,[this].concat(i))).requestOptions=null,e.url=null,e}return Object(i.a)(n,[{key:"normalizeCtorArgs",value:function(e,t){return"string"!=typeof e?e:Object(r.a)({url:e},t)}},{key:"_parseUrl",value:function(e){return e?Object(f.I)(e):null}},{key:"_encode",value:function(e,t,n){var r={};for(var a in e)if("declaredClass"!==a){var i=e[a];if(null!=i&&"function"!=typeof i)if(Array.isArray(i)){r[a]=[];for(var s=0;s<i.length;s++)r[a][s]=this._encode(i[s])}else if("object"==typeof i)if(i.toJSON){var l=i.toJSON(n&&n[a]);r[a]=t?l:JSON.stringify(l)}else r[a]=t?i:JSON.stringify(i);else r[a]=i}return r}},{key:"parsedUrl",get:function(){return this._parseUrl(this.url)}}]),n}(n(44).a));Object(u.a)([Object(o.b)({readOnly:!0,dependsOn:["url"]})],d.prototype,"parsedUrl",null),Object(u.a)([Object(o.b)()],d.prototype,"requestOptions",void 0),Object(u.a)([Object(o.b)({type:String})],d.prototype,"url",void 0);var h=d=Object(u.a)([Object(c.a)("esri.tasks.Task")],d);t.a=h},883:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n(15),a=n(868);function i(e,t,n){if(n&&n.features&&n.hasZ){var i=Object(a.a)(n.geometryType,t,e.outSpatialReference);if(i){var s,l=Object(r.a)(n.features);try{for(l.s();!(s=l.n()).done;){i(s.value.geometry)}}catch(u){l.e(u)}finally{l.f()}}}}},885:function(e,t,n){"use strict";n.d(t,"a",(function(){return M})),n.d(t,"b",(function(){return p})),n.d(t,"c",(function(){return g})),n.d(t,"d",(function(){return b})),n.d(t,"e",(function(){return v})),n.d(t,"f",(function(){return K})),n.d(t,"g",(function(){return C})),n.d(t,"h",(function(){return F})),n.d(t,"i",(function(){return m})),n.d(t,"j",(function(){return O})),n.d(t,"k",(function(){return H})),n.d(t,"l",(function(){return ne})),n.d(t,"m",(function(){return W})),n.d(t,"n",(function(){return X})),n.d(t,"o",(function(){return re})),n.d(t,"p",(function(){return A})),n.d(t,"q",(function(){return j})),n.d(t,"r",(function(){return x})),n.d(t,"s",(function(){return B})),n.d(t,"t",(function(){return k})),n.d(t,"u",(function(){return ee})),n.d(t,"v",(function(){return te})),n.d(t,"w",(function(){return I})),n.d(t,"x",(function(){return Q})),n.d(t,"y",(function(){return D})),n.d(t,"z",(function(){return R})),n.d(t,"A",(function(){return w})),n.d(t,"B",(function(){return L})),n.d(t,"C",(function(){return S}));n(11);var r,a=n(8),i=n.n(a),s=n(23),l=(n(50),n(240)),u=(n(103),n(431));function o(e){var t;return Array.isArray(e)?null==(t=e[0])?void 0:t.spatialReference:null==e?void 0:e.spatialReference}function c(e){return e?Array.isArray(e)?e.map(c):e.toJSON?e.toJSON():e:e}function f(e){return Array.isArray(e)?e.map((function(e){return Object(l.a)(e)})):Object(l.a)(e)}function d(e,t){return h.apply(this,arguments)}function h(){return(h=Object(s.a)(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(s.a)(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(r||(r=Object(u.a)("geometryEngineWorker",{strategy:"distributed"})),r));case 1:case"end":return e.stop()}}),e)})))();case 2:return e.abrupt("return",e.sent.invoke("executeGEOperation",{operation:t,parameters:c(n)}));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function p(e,t){return y.apply(this,arguments)}function y(){return(y=Object(s.a)(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=f,e.next=3,d("clip",[o(t),t,n]);case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function v(e,t){return _.apply(this,arguments)}function _(){return(_=Object(s.a)(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=f,e.next=3,d("cut",[o(t),t,n]);case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e,t){return d("contains",[o(e),e,t])}function b(e,t){return d("crosses",[o(e),e,t])}function m(e,t,n){return d("distance",[o(e),e,t,n])}function O(e,t){return d("equals",[o(e),e,t])}function j(e,t){return d("intersects",[o(e),e,t])}function w(e,t){return d("touches",[o(e),e,t])}function S(e,t){return d("within",[o(e),e,t])}function F(e,t){return d("disjoint",[o(e),e,t])}function k(e,t){return d("overlaps",[o(e),e,t])}function I(e,t,n){return d("relate",[o(e),e,t,n])}function x(e){return d("isSimple",[o(e),e])}function D(e){return T.apply(this,arguments)}function T(){return(T=Object(s.a)(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=f,e.next=3,d("simplify",[o(t),t]);case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function C(e,t){return E.apply(this,arguments)}function E(){return(E=Object(s.a)(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=f,e.next=3,d("difference",[o(t),t,n]);case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function R(e,t){return N.apply(this,arguments)}function N(){return(N=Object(s.a)(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=f,e.next=3,d("symmetricDifference",[o(t),t,n]);case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function A(e,t){return P.apply(this,arguments)}function P(){return(P=Object(s.a)(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=f,e.next=3,d("intersect",[o(t),t,n]);case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function L(e){return G.apply(this,arguments)}function G(){return(G=Object(s.a)(i.a.mark((function e(t){var n,r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:null,r=function(e,t){var n;return Array.isArray(e)?n=e:((n=[]).push(e),null!=t&&n.push(t)),n}(t,n),e.t0=f,e.next=5,d("union",[o(r),r]);case 5:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function B(e,t,n,r,a,i){return q.apply(this,arguments)}function q(){return(q=Object(s.a)(i.a.mark((function e(t,n,r,a,s,l){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=f,e.next=3,d("offset",[o(t),t,n,r,a,s,l]);case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function M(e,t,n){return U.apply(this,arguments)}function U(){return(U=Object(s.a)(i.a.mark((function e(t,n,r){var a,s,l=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=l.length>3&&void 0!==l[3]&&l[3],s=[o(t),t,n,r,a],e.t0=f,e.next=5,d("buffer",s);case 5:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function W(e,t,n,r,a,i){return J.apply(this,arguments)}function J(){return(J=Object(s.a)(i.a.mark((function e(t,n,r,a,s,l){var u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=[o(t),t,n,r,a,s,l],e.t0=f,e.next=4,d("geodesicBuffer",u);case 4:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function V(e){return"xmin"in e?e.center:"x"in e?e:e.extent.center}function Q(e,t,n){return Y.apply(this,arguments)}function Y(){return(Y=Object(s.a)(i.a.mark((function e(t,n,r){var a,s,l;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t){e.next=2;break}throw new Error("Illegal Argument Exception");case 2:return s=t.spatialReference,r=null!=(a=r)?a:V(t),e.t0=t.constructor,e.next=7,d("rotate",[s,t,n,r]);case 7:return e.t1=e.sent,l=e.t0.fromJSON.call(e.t0,e.t1),e.abrupt("return",(l.spatialReference=s,l));case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function H(e,t,n,r){return z.apply(this,arguments)}function z(){return(z=Object(s.a)(i.a.mark((function e(t,n,r,a){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=f,e.next=3,d("generalize",[o(t),t,n,r,a]);case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function K(e,t,n){return Z.apply(this,arguments)}function Z(){return(Z=Object(s.a)(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=f,e.next=3,d("densify",[o(t),t,n,r]);case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function X(e,t,n){return $.apply(this,arguments)}function $(){return($=Object(s.a)(i.a.mark((function e(t,n,r){var a,s=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=s.length>3&&void 0!==s[3]?s[3]:0,e.t0=f,e.next=4,d("geodesicDensify",[o(t),t,n,r,a]);case 4:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ee(e,t){return d("planarArea",[o(e),e,t])}function te(e,t){return d("planarLength",[o(e),e,t])}function ne(e,t,n){return d("geodesicArea",[o(e),e,t,n])}function re(e,t,n){return d("geodesicLength",[o(e),e,t,n])}},893:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return b})),n.d(t,"c",(function(){return f})),n.d(t,"d",(function(){return j})),n.d(t,"e",(function(){return p})),n.d(t,"f",(function(){return y})),n.d(t,"g",(function(){return h})),n.d(t,"h",(function(){return _})),n.d(t,"i",(function(){return g})),n.d(t,"j",(function(){return v}));var r=n(16),a=n(867),i=n(866),s=n(875);function l(e){for(var t=0,n=0;n<e.length;n++)t+=e[n];return t/e.length}function u(e){for(var t=l(e),n=0,r=0;r<e.length;r++)n+=Math.pow(t-e[r],2);return n/e.length}function o(e){for(var t=l(e),n=0,r=0;r<e.length;r++)n+=Math.pow(t-e[r],2);return n/(e.length-1)}function c(e){for(var t=0,n=0;n<e.length;n++)t+=e[n];return t}function f(e){switch(e.toLowerCase()){case"distinct":return"distinct";case"avg":case"mean":return"avg";case"min":return"min";case"sum":return"sum";case"max":return"max";case"stdev":case"stddev":return"stddev";case"var":case"variance":return"var";case"count":return"count"}return""}function d(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;switch(e.toLowerCase()){case"distinct":return function(e,t){for(var n=[],r={},a=[],s=0;s<e.length;s++){if(void 0!==e[s]&&null!==e[s]){var l=e[s];if(Object(i.j)(l)||Object(i.k)(l))void 0===r[l]&&(n.push(l),r[l]=1);else{for(var u=!1,o=0;o<a.length;o++)!0===Object(i.g)(a[o],l)&&(u=!0);!1===u&&(a.push(l),n.push(l))}}if(n.length>=t&&-1!==t)return n}return n}(t,n);case"avg":case"mean":return l(t);case"min":return Math.min.apply(Math,t);case"sum":return c(t);case"max":return Math.max.apply(Math,t);case"stdev":case"stddev":return Math.sqrt(u(t));case"var":case"variance":return u(t);case"count":return t.length}return 0}function h(e,t,n){return m(e,t,n,!0).then((function(e){return 0===e.length?null:Math.min.apply(Math,e)}))}function p(e,t,n){return m(e,t,n,!0).then((function(e){return 0===e.length?null:Math.max.apply(Math,e)}))}function y(e,t,n){var r="";return!1===Object(s.c)(t)&&(r=Object(s.f)(t,e.fields,null)),m(e,t,n,!0).then((function(e){if(0===e.length)return null;var t,n=l(e);return null===n?n:"integer"===r?(t=+(t=n),isFinite(t)?t-t%1||(t<0?-0:0===t?t:0):t):n}))}function v(e,t,n){return m(e,t,n,!0).then((function(e){return 0===e.length?null:o(e)}))}function _(e,t,n){return m(e,t,n,!0).then((function(e){return 0===e.length?null:Math.sqrt(o(e))}))}function g(e,t,n){return m(e,t,n,!0).then((function(e){return 0===e.length?null:c(e)}))}function b(e,t){try{return e.iterator(t).count()}catch(e){return Object(r.r)(e)}}function m(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];try{var i=e.iterator(n);return Object(r.c)((function(e,n){O(i,[],t,a,e,n)}))}catch(s){return Object(r.r)(s)}}function O(e,t,n,r,i,s){Object(a.q)(e.next().then((function(a){try{if(null!==a){var l=n.calculateValue(a);return null===l?!1===r&&(t[t.length]=l):t[t.length]=l,O(e,t,n,r,i,s)}i(t)}catch(e){s(e)}}),s))}function j(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return function(e,t,n,a){try{return w(e.iterator(a),{},[],t,n)}catch(e){return Object(r.r)(e)}}(e,t,n,a)}function w(e,t,n,r,a){return e.next().then((function(i){if(null!==i){var s=r.calculateValue(i);return null!=s&&void 0===t[s]&&(n.push(s),t[s]=1),n.length>=a&&-1!==a?n:w(e,t,n,r,a)}return n}))}},908:function(e,t,n){"use strict";var r=n(2),a=n(4),i=function(){function e(){Object(r.a)(this,e),this._databaseTypeMetaData={},this._layerInfo={}}return Object(a.a)(e,[{key:"clearDatabaseType",value:function(e){void 0===this._databaseTypeMetaData[e]&&delete this._databaseTypeMetaData[e]}},{key:"getDatabaseType",value:function(e){return"MUSTBESET"===e||void 0===this._databaseTypeMetaData[e]?null:this._databaseTypeMetaData[e]}},{key:"setDatabaseType",value:function(e,t){this._databaseTypeMetaData[e]=t}},{key:"getLayerInfo",value:function(e){return void 0===this._layerInfo[e]?null:this._layerInfo[e]}},{key:"setLayerInfo",value:function(e,t){this._layerInfo[e]=t}},{key:"clearLayerInfo",value:function(e){void 0!==this._layerInfo[e]&&delete this._layerInfo[e]}}]),e}();i.applicationCache=null,t.a=i},909:function(e,t,n){"use strict";n.d(t,"a",(function(){return c})),n.d(t,"b",(function(){return r}));var r={Base64:0,Hex:1,String:2,Raw:3};function a(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function i(e,t,n,r,i,s){return a((l=a(a(t,e),a(r,s)))<<(u=i)|l>>>32-u,n);var l,u}function s(e,t,n,r,a,s,l){return i(t&n|~t&r,e,t,a,s,l)}function l(e,t,n,r,a,s,l){return i(t&r|n&~r,e,t,a,s,l)}function u(e,t,n,r,a,s,l){return i(t^n^r,e,t,a,s,l)}function o(e,t,n,r,a,s,l){return i(n^(t|~r),e,t,a,s,l)}function c(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r.Hex,n=t||r.Base64,i=function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,r=-271733879,i=-1732584194,c=271733878,f=0;f<e.length;f+=16){var d=n,h=r,p=i,y=c;n=s(n,r,i,c,e[f+0],7,-680876936),c=s(c,n,r,i,e[f+1],12,-389564586),i=s(i,c,n,r,e[f+2],17,606105819),r=s(r,i,c,n,e[f+3],22,-1044525330),n=s(n,r,i,c,e[f+4],7,-176418897),c=s(c,n,r,i,e[f+5],12,1200080426),i=s(i,c,n,r,e[f+6],17,-1473231341),r=s(r,i,c,n,e[f+7],22,-45705983),n=s(n,r,i,c,e[f+8],7,1770035416),c=s(c,n,r,i,e[f+9],12,-1958414417),i=s(i,c,n,r,e[f+10],17,-42063),r=s(r,i,c,n,e[f+11],22,-1990404162),n=s(n,r,i,c,e[f+12],7,1804603682),c=s(c,n,r,i,e[f+13],12,-40341101),i=s(i,c,n,r,e[f+14],17,-1502002290),n=l(n,r=s(r,i,c,n,e[f+15],22,1236535329),i,c,e[f+1],5,-165796510),c=l(c,n,r,i,e[f+6],9,-1069501632),i=l(i,c,n,r,e[f+11],14,643717713),r=l(r,i,c,n,e[f+0],20,-373897302),n=l(n,r,i,c,e[f+5],5,-701558691),c=l(c,n,r,i,e[f+10],9,38016083),i=l(i,c,n,r,e[f+15],14,-660478335),r=l(r,i,c,n,e[f+4],20,-405537848),n=l(n,r,i,c,e[f+9],5,568446438),c=l(c,n,r,i,e[f+14],9,-1019803690),i=l(i,c,n,r,e[f+3],14,-187363961),r=l(r,i,c,n,e[f+8],20,1163531501),n=l(n,r,i,c,e[f+13],5,-1444681467),c=l(c,n,r,i,e[f+2],9,-51403784),i=l(i,c,n,r,e[f+7],14,1735328473),n=u(n,r=l(r,i,c,n,e[f+12],20,-1926607734),i,c,e[f+5],4,-378558),c=u(c,n,r,i,e[f+8],11,-2022574463),i=u(i,c,n,r,e[f+11],16,1839030562),r=u(r,i,c,n,e[f+14],23,-35309556),n=u(n,r,i,c,e[f+1],4,-1530992060),c=u(c,n,r,i,e[f+4],11,1272893353),i=u(i,c,n,r,e[f+7],16,-155497632),r=u(r,i,c,n,e[f+10],23,-1094730640),n=u(n,r,i,c,e[f+13],4,681279174),c=u(c,n,r,i,e[f+0],11,-358537222),i=u(i,c,n,r,e[f+3],16,-722521979),r=u(r,i,c,n,e[f+6],23,76029189),n=u(n,r,i,c,e[f+9],4,-640364487),c=u(c,n,r,i,e[f+12],11,-421815835),i=u(i,c,n,r,e[f+15],16,530742520),n=o(n,r=u(r,i,c,n,e[f+2],23,-995338651),i,c,e[f+0],6,-198630844),c=o(c,n,r,i,e[f+7],10,1126891415),i=o(i,c,n,r,e[f+14],15,-1416354905),r=o(r,i,c,n,e[f+5],21,-57434055),n=o(n,r,i,c,e[f+12],6,1700485571),c=o(c,n,r,i,e[f+3],10,-1894986606),i=o(i,c,n,r,e[f+10],15,-1051523),r=o(r,i,c,n,e[f+1],21,-2054922799),n=o(n,r,i,c,e[f+8],6,1873313359),c=o(c,n,r,i,e[f+15],10,-30611744),i=o(i,c,n,r,e[f+6],15,-1560198380),r=o(r,i,c,n,e[f+13],21,1309151649),n=o(n,r,i,c,e[f+4],6,-145523070),c=o(c,n,r,i,e[f+11],10,-1120210379),i=o(i,c,n,r,e[f+2],15,718787259),r=o(r,i,c,n,e[f+9],21,-343485551),n=a(n,d),r=a(r,h),i=a(i,p),c=a(c,y)}return[n,r,i,c]}(function(e){for(var t=[],n=0,r=8*e.length;n<r;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}(e),8*e.length);switch(n){case r.Raw:return i;case r.Hex:return function(e){for(var t="0123456789abcdef",n=[],r=0,a=4*e.length;r<a;r++)n.push(t.charAt(e[r>>2]>>r%4*8+4&15)+t.charAt(e[r>>2]>>r%4*8&15));return n.join("")}(i);case r.String:return function(e){for(var t=[],n=0,r=32*e.length;n<r;n+=8)t.push(String.fromCharCode(e[n>>5]>>>n%32&255));return t.join("")}(i);case r.Base64:return function(e){for(var t=[],n=0,r=4*e.length;n<r;n+=3)for(var a=(e[n>>2]>>n%4*8&255)<<16|(e[n+1>>2]>>(n+1)%4*8&255)<<8|e[n+2>>2]>>(n+2)%4*8&255,i=0;i<4;i++)8*n+6*i>32*e.length?t.push("="):t.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>6*(3-i)&63));return t.join("")}(i)}}},910:function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));var r=n(2),a=n(4),i=n(5),s=n(6),l=n(16),u=n(866),o=n(869),c=function(e){Object(i.a)(n,e);var t=Object(s.a)(n);function n(e){var a;return Object(r.a)(this,n),(a=t.call(this,e)).declaredClass="esri.layers.featureset.sources.Empty",a._maxProcessing=1e3,a._wset=new o.a([],[],!1,null),a._parent=e.parentfeatureset,a._databaseType=u.a.Standardised,a}return Object(a.a)(n,[{key:"_getSet",value:function(){return Object(l.s)(this._wset)}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"_isInFeatureSet",value:function(){return u.b.NotInFeatureSet}},{key:"_getFeature",value:function(){return Object(l.r)(new Error("No Feature Found in EmptySet"))}},{key:"queryAttachments",value:function(){return Object(l.s)([])}},{key:"_getFeatures",value:function(){return Object(l.s)("success")}},{key:"_featureFromCache",value:function(){return null}},{key:"_fetchAndRefineFeatures",value:function(){return Object(l.r)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(){return Object(l.s)(new o.a([],[],!1,null))}},{key:"_stat",value:function(e,t,n,r,a,i,s){return this._manualStat(e,t,i,s)}},{key:"_canDoAggregates",value:function(){return Object(l.s)(!1)}}]),n}(n(871).a)},927:function(e,t,n){"use strict";var r=n(2),a=n(4),i=n(5),s=n(6),l=n(16),u=n(39),o=n(866),c=n(869),f=n(852),d=n(875),h=n(871),p=function(e){Object(i.a)(n,e);var t=Object(s.a)(n);function n(e){var a;return Object(r.a)(this,n),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.actions.AttributeFilter",a._maxProcessing=1e3,a._parent=e.parentfeatureset,e.whereclause instanceof f.WhereClause?(a._whereclause=e.whereclause,a._whereClauseFunction=null):(a._whereClauseFunction=e.whereclause,a._whereclause=null),a}return Object(a.a)(n,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new u.a({wkid:4326}),this.geometryType=o.m.point)}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getFilteredSet("",null,t._whereclause,null,e)})).then((function(n){return t._checkCancelled(e),null!==t._whereClauseFunction?t._wset=new c.a(n._candidates.slice(0).concat(n._known.slice(0)),[],n._ordered,t._clonePageDefinition(n.pagesDefinition)):t._wset=new c.a(n._candidates.slice(0),n._known.slice(0),n._ordered,t._clonePageDefinition(n.pagesDefinition)),t._wset})):Object(l.s)(this._wset)}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);return t===o.b.NotInFeatureSet?t:void 0===(t=this._idstates[e])?o.b.Unknown:t}},{key:"_getFeature",value:function(e,t,n){return this._parent._getFeature(e,t,n)}},{key:"_getFeatures",value:function(e,t,n,r){return this._parent._getFeatures(e,t,n,r)}},{key:"_featureFromCache",value:function(e){return this._parent._featureFromCache(e)}},{key:"executeWhereClause",value:function(e){return this._whereclause.testFeature(e)}},{key:"executeWhereClauseDeferred",value:function(e){if(null!==this._whereClauseFunction)try{var t=this._whereClauseFunction(e);return Object(l.n)(t)?t:Object(l.s)(t)}catch(n){return Object(l.r)(n)}return Object(l.s)(this.executeWhereClause(e))}},{key:"_fetchAndRefineFeatures",value:function(e,t,n){var r=this,a=new c.a([],e,!1,null),i=Math.min(t,e.length);return this._parent._getFeatures(a,-1,i,n).then((function(){if(r._checkCancelled(n),null==r._whereClauseFunction){for(var a=0;a<i;a++){var s=r._parent._featureFromCache(e[a]);!0===r.executeWhereClause(s)?r._idstates[e[a]]=o.b.InFeatureSet:r._idstates[e[a]]=o.b.NotInFeatureSet}return"success"}for(var u=[],c=0;c<i;c++){var f=r._parent._featureFromCache(e[c]);u.push(r.executeWhereClauseDeferred(f))}return Object(l.b)(u).then((function(n){for(var a=0;a<t;a++)!0===n[a]?r._idstates[e[a]]=o.b.InFeatureSet:r._idstates[e[a]]=o.b.NotInFeatureSet;return"success"}))}))}},{key:"_getFilteredSet",value:function(e,t,n,r,a){var i=this;return null!==this._whereClauseFunction||(null!==n?null!==this._whereclause&&(n=Object(d.a)(this._whereclause,n)):n=this._whereclause),this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,n,r,a)})).then((function(e){return i._checkCancelled(a),null!==i._whereClauseFunction?new c.a(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)):new c.a(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_stat",value:function(e,t,n,r,a,i,s){var u=this;if(null!==this._whereClauseFunction)return null===a&&""===n&&null===r?this._manualStat(e,t,i,s):Object(l.s)({calculated:!1});var o=this._whereclause;return null!==a&&null!==this._whereclause&&(o=Object(d.a)(this._whereclause,a)),this._parent._stat(e,t,n,r,o,i,s).then((function(l){return!1===l.calculated?null===a&&""===n&&null===r?u._manualStat(e,t,i,s):{calculated:!1}:l}))}},{key:"_canDoAggregates",value:function(e,t,n,r,a){return null!==this._whereClauseFunction?Object(l.s)(!1):(null!==a?null!==this._whereclause&&(a=Object(d.a)(this._whereclause,a)):a=this._whereclause,null===this._parent?Object(l.s)(!1):this._parent._canDoAggregates(e,t,n,r,a))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,n,r,a,i,s){return null===this._parent?Object(l.r)(new Error("Should never be called")):(null!==a?null!==this._whereclause&&(a=Object(d.a)(this._whereclause,a)):a=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,n,r,a,i,s))}}],[{key:"registerAction",value:function(){h.a._featuresetFunctions.filter=function(e){if("function"==typeof e)return new n({parentfeatureset:this,whereclause:e});var t=null;return e instanceof f.WhereClause&&(t=e),new n({parentfeatureset:this,whereclause:t})}}}]),n}(h.a);t.a=p},928:function(e,t,n){"use strict";var r=n(15),a=n(2),i=n(4),s=n(5),l=n(6),u=n(16),o=n(867),c=n(869),f=n(871),d=n(929),h=function(e){Object(s.a)(n,e);var t=Object(l.a)(n);function n(e){var r;return Object(a.a)(this,n),(r=t.call(this,e))._orderbyclause=null,r.declaredClass="esri.arcade.featureset.actions.OrderBy",r._maxProcessing=100,r._orderbyclause=e.orderbyclause,r._parent=e.parentfeatureset,r}return Object(i.a)(n,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,t._orderbyclause,e)})).then((function(n){return t._checkCancelled(e),t._wset=n,t._wset})):Object(u.s)(this._wset)}},{key:"manualOrderSet",value:function(e,t){var n=this;return this.getIdColumnDictionary(e,[],-1,t).then((function(e){n._orderbyclause.order(e);for(var t=new c.a([],[],!0,null),r=0;r<e.length;r++)t._known.push(e[r].id);return t}))}},{key:"getIdColumnDictionary",value:function(e,t,n,a){var i=this;if(n<e._known.length-1){var s=this._maxQueryRate();if("GETPAGES"===e._known[n+1])return Object(o.q)(this._parent._expandPagedSet(e,s,0,0,a)).then((function(){return i.getIdColumnDictionary(e,t,n,a)}));for(var l=n+1,c=[];l<e._known.length&&"GETPAGES"!==e._known[l];)c.push(e._known[l]),l++;return n+=c.length,Object(o.q)(this._parent._getFeatureBatch(c,a)).then((function(s){i._checkCancelled(a);var l,u=Object(r.a)(s);try{for(u.s();!(l=u.n()).done;){var o=l.value;t.push({id:o.attributes[i.objectIdField],feature:o})}}catch(c){u.e(c)}finally{u.f()}return i.getIdColumnDictionary(e,t,n,a)}))}return e._candidates.length>0?Object(o.q)(this._refineSetBlock(e,this._maxProcessingRate(),a)).then((function(){return i._checkCancelled(a),i.getIdColumnDictionary(e,t,n,a)})):Object(u.s)(t)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,n,r){return this._parent._getFeatures(e,t,n,r)}},{key:"_featureFromCache",value:function(e){if(void 0===this._featureCache[e]){var t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}},{key:"_fetchAndRefineFeatures",value:function(){return Object(u.r)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,n,r,a){var i=this;return this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,n,null===r?i._orderbyclause:r,a)})).then((function(e){var r;i._checkCancelled(a),r=new c.a(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition));var s=!0;return e._candidates.length>0&&(s=!1),!1===r._ordered?i.manualOrderSet(r,a).then((function(e){return!1===s&&(null===t&&null===n||(e=new c.a(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)))),e})):r}))}}],[{key:"registerAction",value:function(){f.a._featuresetFunctions.orderBy=function(e){return""===e?this:new n({parentfeatureset:this,orderbyclause:new d.a(e)})}}}]),n}(f.a);t.a=h},929:function(e,t,n){"use strict";var r=n(15),a=n(2),i=n(4);function s(e,t){return e===t?0:null===e?-1:null===t?1:e<t?-1:1}var l=function(){function e(t){Object(a.a)(this,e);var n=t.split(",");this._fields=[],this._directions=[];for(var r=0;r<n.length;r++){var i=n[r].match(/\S+/g);this._fields.push(i[0]),2===i.length?"asc"===i[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}return Object(i.a)(e,[{key:"constructClause",value:function(){for(var e="",t=0;t<this._fields.length;t++)0!==t&&(e+=","),e+=this._fields[t],1===this._directions[t]?e+=" ASC":e+=" DESC";return e}},{key:"order",value:function(e){var t=this;e.sort((function(e,n){for(var r=0;r<t._fields.length;r++){var a,i=t.featureValue(e.feature,t._fields[r],r),l=t.featureValue(n.feature,t._fields[r],r);if(0!==(a=1===t._directions[r]?s(i,l):-1*s(i,l)))return a}return 0}))}},{key:"scanForField",value:function(e){for(var t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}},{key:"replaceFields",value:function(t){for(var n="",a=0;a<this._fields.length;a++){0!==a&&(n+=",");var i,s=this._fields[a],l=Object(r.a)(t);try{for(l.s();!(i=l.n()).done;){var u=i.value;if(s.toLowerCase()===u.field.toLowerCase()){s=u.newfield;break}}}catch(o){l.e(o)}finally{l.f()}n+=s,1===this._directions[a]?n+=" ASC":n+=" DESC"}return new e(n)}},{key:"featureValue",value:function(e,t,n){var r=e.attributes[t];if(void 0!==r)return r;for(var a in e.attributes)if(t.toLowerCase()===a.toLowerCase())return this._fields[n]=a,e.attributes[a];return null}}]),e}();t.a=l},948:function(e,t,n){"use strict";var r=n(2),a=n(4),i=n(5),s=n(6),l=n(16),u=n(866),o=n(885),c=n(869),f=n(871),d=n(910),h=function(e){Object(i.a)(n,e);var t=Object(s.a)(n);function n(e){var a;return Object(r.a)(this,n),(a=t.call(this,e))._relation="",a._relationGeom=null,a._relationString="",a.declaredClass="esri.arcade.featureset.actions.SpatialFilter",a._relationString=e.relationString,a._parent=e.parentfeatureset,a._maxProcessing=40,a._relation=e.relation,a._relationGeom=e.relationGeom,a}return Object(a.a)(n,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getFilteredSet("esriSpatialRelRelation"!==t._relation?t._relation:t._relation+":"+t._relationString,t._relationGeom,null,null,e)})).then((function(n){return t._checkCancelled(e),t._wset=new c.a(n._candidates.slice(0),n._known.slice(0),n._ordered,t._clonePageDefinition(n.pagesDefinition)),t._wset})):Object(l.s)(this._wset)}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);return t===u.b.NotInFeatureSet?t:void 0===(t=this._idstates[e])?u.b.Unknown:t}},{key:"_getFeature",value:function(e,t,n){return this._parent._getFeature(e,t,n)}},{key:"_getFeatures",value:function(e,t,n,r){return this._parent._getFeatures(e,t,n,r)}},{key:"_featureFromCache",value:function(e){return this._parent._featureFromCache(e)}},{key:"executeSpatialRelationTest",value:function(e){if(null===e.geometry)return Object(l.s)(!1);switch(this._relation){case"esriSpatialRelEnvelopeIntersects":var t=Object(u.p)(this._relationGeom),n=Object(u.p)(e.geometry);return Object(o.q)(t,n);case"esriSpatialRelIntersects":return Object(o.q)(this._relationGeom,e.geometry);case"esriSpatialRelContains":return Object(o.c)(this._relationGeom,e.geometry);case"esriSpatialRelOverlaps":return Object(o.t)(this._relationGeom,e.geometry);case"esriSpatialRelWithin":return Object(o.C)(this._relationGeom,e.geometry);case"esriSpatialRelTouches":return Object(o.A)(this._relationGeom,e.geometry);case"esriSpatialRelCrosses":return Object(o.d)(this._relationGeom,e.geometry);case"esriSpatialRelRelation":return Object(o.w)(this._relationGeom,e.geometry,this._relationString)}}},{key:"_fetchAndRefineFeatures",value:function(e,t,n){var r=this,a=new c.a([],e,!1,null),i=Math.min(t,e.length);return this._parent._getFeatures(a,-1,i,n).then((function(){r._checkCancelled(n);for(var t=[],a=0;a<i;a++){var s=r._parent._featureFromCache(e[a]);t.push(r.executeSpatialRelationTest(s))}return Object(l.b)(t)})).then((function(n){for(var a=0;a<t;a++)!0===n[a]?r._idstates[e[a]]=u.b.InFeatureSet:r._idstates[e[a]]=u.b.NotInFeatureSet;return"success"}))}},{key:"_getFilteredSet",value:function(e,t,n,r,a){var i=this;return this._ensureLoaded().then((function(){return i._parent._getFilteredSet("esriSpatialRelRelation"!==i._relation?i._relation:i._relation+":"+i._relationString,i._relationGeom,n,r,a)})).then((function(e){return i._checkCancelled(a),null!==t?new c.a(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)):new c.a(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_stat",value:function(e,t,n,r,a,i,s){var u=this;return""!==n?Object(l.s)({calculated:!1}):this._parent._stat(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,a,i,s).then((function(l){return!1===l.calculated?null===a&&""===n&&null===r?u._manualStat(e,t,i,s):{calculated:!1}:l}))}},{key:"_canDoAggregates",value:function(e,t,n,r,a){return""!==n||null!==r||null===this._parent?Object(l.s)(!1):this._parent._canDoAggregates(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,a)}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,n,r,a,i,s){return null===this._parent?Object(l.r)(new Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(e,t,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,a,i,s)}}],[{key:"registerAction",value:function(){f.a._featuresetFunctions.intersects=function(e){return null==e?new d.a({parentfeatureset:this}):new n({parentfeatureset:this,relation:"esriSpatialRelIntersects",relationGeom:e})},f.a._featuresetFunctions.envelopeIntersects=function(e){return null==e?new d.a({parentfeatureset:this}):new n({parentfeatureset:this,relation:"esriSpatialRelEnvelopeIntersects",relationGeom:e})},f.a._featuresetFunctions.contains=function(e){return null==e?new d.a({parentfeatureset:this}):new n({parentfeatureset:this,relation:"esriSpatialRelContains",relationGeom:e})},f.a._featuresetFunctions.overlaps=function(e){return null==e?new d.a({parentfeatureset:this}):new n({parentfeatureset:this,relation:"esriSpatialRelOverlaps",relationGeom:e})},f.a._featuresetFunctions.within=function(e){return null==e?new d.a({parentfeatureset:this}):new n({parentfeatureset:this,relation:"esriSpatialRelWithin",relationGeom:e})},f.a._featuresetFunctions.touches=function(e){return null==e?new d.a({parentfeatureset:this}):new n({parentfeatureset:this,relation:"esriSpatialRelTouches",relationGeom:e})},f.a._featuresetFunctions.crosses=function(e){return null==e?new d.a({parentfeatureset:this}):new n({parentfeatureset:this,relation:"esriSpatialRelCrosses",relationGeom:e})},f.a._featuresetFunctions.relate=function(e,t){return null==e?new d.a({parentfeatureset:this}):new n({parentfeatureset:this,relation:"esriSpatialRelRelation",relationGeom:e,relationString:t})}}}]),n}(f.a);t.a=h},981:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(2),a=n(4),i=n(16),s=function(){function e(){Object(r.a)(this,e),this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}return Object(a.a)(e,[{key:"add",value:function(e,t,n){this._layerById[t]=n,this._layerByName[e]=n}},{key:"featureSetByName",value:function(e){return void 0===this._layerByName[e]?this.resolvePromise(null):this.resolvePromise(this._layerByName[e])}},{key:"featureSetById",value:function(e){return void 0===this._layerById[e]?this.resolvePromise(null):this.resolvePromise(this._layerById[e])}},{key:"castToText",value:function(){return"object, FeatureSetCollection"}},{key:"resolvePromise",value:function(e){return Object(i.s)(e)}}]),e}()},982:function(e,t,n){"use strict";n.d(t,"a",(function(){return j})),n.d(t,"b",(function(){return b})),n.d(t,"c",(function(){return g})),n.d(t,"d",(function(){return O})),n.d(t,"e",(function(){return m}));var r=n(15),a=n(5),i=n(6),s=n(2),l=n(4),u=n(16),o=n(39),c=n(242),f=n(866),d=n(940),h=n(869),p=n(852),y=n(875),v=n(871),_=function(){function e(){Object(s.a)(this,e),this.sqlRewritable=!1}return Object(l.a)(e,[{key:"postInitialization",value:function(e,t){}}]),e}(),g=function(e){Object(a.a)(n,e);var t=Object(i.a)(n);function n(e){var r;return Object(s.a)(this,n),(r=t.call(this)).field=e,r.sqlRewritable=!0,r}return Object(l.a)(n,[{key:"extractValue",value:function(e){return e.attributes[this.field.name]}},{key:"rewriteSql",value:function(e){return{rewritten:this.sqlRewritable,where:e}}}]),n}(_),b=function(e){Object(a.a)(n,e);var t=Object(i.a)(n);function n(e,r,a){var i;return Object(s.a)(this,n),(i=t.call(this)).originalField=e,i.sqlRewritable=!0,i.field=Object(f.c)(e),i.field.name=r,i.field.alias=a,i}return Object(l.a)(n,[{key:"rewriteSql",value:function(e,t){return{rewritten:this.sqlRewritable,where:Object(y.g)(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return e.attributes[this.originalField.name]}}]),n}(_),m=function(e){Object(a.a)(n,e);var t=Object(i.a)(n);function n(e,r,a){var i;for(var l in Object(s.a)(this,n),(i=t.call(this)).field=e,i.codefield=r,i.lkp=a,i.reverseLkp={},a)i.reverseLkp[a[l]]=l;return i.sqlRewritable=!0,i}return Object(l.a)(n,[{key:"rewriteSql",value:function(e,t){var r=this.evaluateNodeToWhereClause(e.parseTree,f.a.Standardised,this.field.name,this.codefield instanceof p.WhereClause?Object(y.i)(this.codefield,f.a.Standardised):this.codefield,e.parameters);return r.indexOf(n.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:p.WhereClause.create(r,t._parent.getFieldsIndex())}}},{key:"evaluateNodeToWhereClause",value:function(e,t){var a,i,s,l,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,c=arguments.length>4?arguments[4]:void 0;switch(e.type){case"interval":return Object(y.b)(this.evaluateNodeToWhereClause(e.value,t,u,o,c),e.qualifier,e.op);case"case_expression":var f=" CASE ";"simple"===e.format&&(f+=this.evaluateNodeToWhereClause(e.operand,t,u,n.BADNESS,c));for(var d=0;d<e.clauses.length;d++)f+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[d].operand,t,u,n.BADNESS,c)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[d].value,t,u,n.BADNESS,c);return null!==e.else&&(f+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,u,n.BADNESS,c)),f+=" END ";case"param":var h=c[e.value.toLowerCase()];if("string"==typeof h)return"'"+c[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(h instanceof Date)return Object(y.d)(h,t);if(h instanceof Array){for(var p=[],v=0;v<h.length;v++)"string"==typeof h[v]?p.push("'"+h[v].toString().replace(/'/g,"''")+"'"):h[v]instanceof Date?p.push(Object(y.d)(h[v],t)):p.push(h[v].toString());return p}return h.toString();case"expr_list":i=[];var _,g=Object(r.a)(e.value);try{for(g.s();!(_=g.n()).done;){var b=_.value;i.push(this.evaluateNodeToWhereClause(b,t,u,o,c))}}catch(C){g.e(C)}finally{g.f()}return i;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,u,n.BADNESS,c)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" AND "+this.evaluateNodeToWhereClause(e.right,t,u,o,c)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" OR "+this.evaluateNodeToWhereClause(e.right,t,u,o,c)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IS NOT NULL )";case"IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var m,O=[],j=!0,w=Object(r.a)(e.right.value);try{for(w.s();!(m=w.n()).done;){var S=m.value;if("string"!==S.type){j=!1;break}if(void 0===this.lkp[S.value]){j=!1;break}O.push(this.lkp[S.value].toString())}}catch(C){w.e(C)}finally{w.f()}if(j)return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+O.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,u,o,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+a.join(",")+")) "}return(l=this.evaluateNodeToWhereClause(e.right,t,u,o,c))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+l.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+l+")) ";case"NOT IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var F,k=[],I=!0,x=Object(r.a)(e.right.value);try{for(x.s();!(F=x.n()).done;){var D=F.value;if("string"!==D.type){I=!1;break}if(void 0===this.lkp[D.value]){I=!1;break}k.push(this.lkp[D.value].toString())}}catch(C){x.e(C)}finally{x.f()}if(I)return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+k.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,u,o,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+a.join(",")+")) "}return(l=this.evaluateNodeToWhereClause(e.right,t,u,o,c))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+l.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+l+")) ";case"BETWEEN":return s=this.evaluateNodeToWhereClause(e.right,t,u,n.BADNESS,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,n.BADNESS,c)+" BETWEEN "+s[0]+" AND "+s[1]+" ) ";case"NOTBETWEEN":return s=this.evaluateNodeToWhereClause(e.right,t,u,n.BADNESS,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,n.BADNESS,c)+" NOT BETWEEN "+s[0]+" AND "+s[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,u,n.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,n.BADNESS,c)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,n.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,n.BADNESS,c)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,u,n.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,n.BADNESS,c)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,n.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,n.BADNESS,c)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+o+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+o+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,u,n.BADNESS,c)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,u,n.BADNESS,c)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,n.BADNESS,c)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,u,n.BADNESS,c)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return Object(y.d)(e.value,t);case"number":return e.value.toString();case"current_time":return Object(y.e)("date"===e.mode,t);case"column_ref":return u&&u.toLowerCase()===e.column.toLowerCase()?"("+o+")":e.column;case"function":var T=this.evaluateNodeToWhereClause(e.args,t,u,n.BADNESS,c);return Object(y.k)(e.name,T,t)}throw new Error("Unsupported sql syntax "+e.type)}},{key:"extractValue",value:function(e){return this.codefield instanceof p.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]}}]),n}(_);m.BADNESS="_!!!_BAD_LKP_!!!!";var O=function(e){Object(a.a)(n,e);var t=Object(i.a)(n);function n(e,r){var a;return Object(s.a)(this,n),(a=t.call(this)).field=e,a.sql=r,a}return Object(l.a)(n,[{key:"rewriteSql",value:function(e,t){return{rewritten:!0,where:Object(y.g)(e,this.field.name,Object(y.i)(this.sql,f.a.Standardised),t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return this.sql.calculateValueCompiled(e)}}]),n}(_),j=function(e){Object(a.a)(n,e);var t=Object(i.a)(n);function n(e){var r;return Object(s.a)(this,n),(r=t.call(this,e))._calcFunc=null,r.declaredClass="esri.arcade.featureset.actions.Adapted",r.adaptedFields=null,r._extraFilter=null,r._extraFilter=e.extraFilter,r._parent=e.parentfeatureset,r._maxProcessing=30,r.adaptedFields=e.adaptedFields,r}return Object(l.a)(n,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new o.a({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=f.m.point,this.typeIdField="",this.types=null),this.fields=[];var e,t=Object(r.a)(this.adaptedFields);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.postInitialization(this,this._parent),this.fields.push(n.field)}}catch(a){t.e(a)}finally{t.f()}}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._extraFilter?t._getFilteredSet("",null,null,null,e):t._parent._getSet(e)})).then((function(n){return t._checkCancelled(e),t._wset=new h.a(n._candidates.slice(0),n._known.slice(0),n._ordered,t._clonePageDefinition(n.pagesDefinition)),t._wset})):Object(u.s)(this._wset)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,n,a){var i=this,s=[];-1!==t&&void 0===this._featureCache[t]&&s.push(t);var l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,a).then((function(){return i._getFeatures(e,t,n,a)}));for(var o=0,f=e._lastFetchedIndex;f<e._known.length&&(++o<=n&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[f]]&&(e._known[f]!==t&&s.push(e._known[f]),s.length>=l-1)));f++);if(0===s.length)return Object(u.s)("success");e=new h.a([],s,e._ordered,null);var p=Math.min(s.length,n);return this._parent._getFeatures(e,-1,p,a).then((function(){i._checkCancelled(a);for(var e=[],t=0;t<p;t++){var n=i._parent._featureFromCache(s[t]);void 0!==n&&e.push({geometry:n.geometry,attributes:n.attributes,id:s[t]})}for(var l=0,u=e;l<u.length;l++){var o,f=u[l],h=[],y=Object(r.a)(i.adaptedFields);try{for(y.s();!(o=y.n()).done;){var v=o.value;h[v.field.name]=v.extractValue(f)}}catch(_){y.e(_)}finally{y.f()}i._featureCache[f.id]=new c.a({attributes:h,geometry:Object(d.a)(f.geometry)})}return"success"}))}},{key:"_fetchAndRefineFeatures",value:function(){return Object(u.r)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,n,a,i){var s,l=this,u=this.reformulateWithoutAdaptions(n);s=u.cannot,n=u.where;var o=!1;if(null!==a){o=!0;var c,f=[],d=Object(r.a)(this.adaptedFields);try{for(d.s();!(c=d.n()).done;){var p=c.value;if(!(p instanceof g)&&!0===a.scanForField(p.field.name)){if(!(p instanceof b)){a=null,o=!1;break}f.push({field:p.field.name,newfield:p.originalField.name})}}}catch(v){d.e(v)}finally{d.f()}a&&f.length>0&&(a=a.replaceFields(f))}return null!==n?null!==this._extraFilter&&(n=Object(y.a)(this._extraFilter,n)):n=this._extraFilter,this._ensureLoaded().then((function(){return l._parent._getFilteredSet(e,t,n,a,i)})).then((function(e){return l._checkCancelled(i),!0===s?new h.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===o&&e._ordered,l._clonePageDefinition(e.pagesDefinition)):new h.a(e._candidates.slice(0),e._known.slice(0),!0===o&&e._ordered,l._clonePageDefinition(e.pagesDefinition))}))}},{key:"reformulateWithoutAdaptions",value:function(e){var t={cannot:!1,where:e};if(null!==e){var n,a=Object(r.a)(this.adaptedFields);try{for(a.s();!(n=a.n()).done;){var i=n.value;if(!0===Object(y.h)(e,i.field.name)){var s=i.rewriteSql(e,this);if(!0!==s.rewritten){t.cannot=!0,t.where=null;break}t.where=s.where}}}catch(l){a.e(l)}finally{a.f()}}return t}},{key:"_stat",value:function(e,t,n,r,a,i,s){var l=this,o=!1,c=this.reformulateWithoutAdaptions(t);return o=c.cannot,t=c.where,c=this.reformulateWithoutAdaptions(a),o=o||c.cannot,null!==(a=c.where)?null!==this._extraFilter&&(a=Object(y.a)(this._extraFilter,a)):a=this._extraFilter,!0===o?null===a&&""===n&&null===r?this._manualStat(e,t,i,s):Object(u.s)({calculated:!1}):this._parent._stat(e,t,n,r,a,i,s).then((function(u){return!1===u.calculated?null===a&&""===n&&null===r?l._manualStat(e,t,i,s):{calculated:!1}:u}))}},{key:"_canDoAggregates",value:function(e,t,n,a,i){if(null===this._parent)return Object(u.s)(!1);for(var s=0;s<e.length;s++){var l,o=Object(r.a)(this.adaptedFields);try{for(o.s();!(l=o.n()).done;){var c=l.value;if(e[s].toLowerCase()===c.field.name.toLowerCase()&&!(c instanceof g))return Object(u.s)(!1)}}catch(b){o.e(b)}finally{o.f()}}for(var f=[],d=0;d<t.length;d++){var h=t[d];if(null!==h.workingexpr){var p=this.reformulateWithoutAdaptions(h.workingexpr);if(p.cannot)return Object(u.s)(!1);var v=h.clone();v.workingexpr=p.where,f.push(v)}else f.push(h)}var _=this.reformulateWithoutAdaptions(i);return _.cannot?Object(u.s)(!1):(null!==(i=_.where)?null!==this._extraFilter&&(i=Object(y.a)(this._extraFilter,i)):i=this._extraFilter,this._parent._canDoAggregates(e,f,n,a,i))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,n,r,a,i,s){if(null===this._parent)return Object(u.r)(new Error("Should never be called"));for(var l=[],o=0;o<t.length;o++){var c=t[o];if(null!==c.workingexpr){var f=this.reformulateWithoutAdaptions(c.workingexpr);if(f.cannot)return Object(u.r)(new Error("Should never be called"));var d=c.clone();d.workingexpr=f.where,l.push(d)}else l.push(c)}var h=this.reformulateWithoutAdaptions(a);return h.cannot?Object(u.r)(new Error("Should never be called")):(null!==(a=h.where)?null!==this._extraFilter&&(a=Object(y.a)(this._extraFilter,a)):a=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,l,n,r,a,i,s))}}],[{key:"findField",value:function(e,t){var n,a=Object(r.a)(e);try{for(a.s();!(n=a.n()).done;){var i=n.value;if(i.name.toLowerCase()===t.toString().toLowerCase())return i}}catch(s){a.e(s)}finally{a.f()}return null}}]),n}(v.a)},983:function(e,t,n){"use strict";var r=n(2),a=n(4),i=n(5),s=n(6),l=n(16),u=n(866),o=n(869),c=n(871),f=function(e){Object(i.a)(n,e);var t=Object(s.a)(n);function n(e){var a;return Object(r.a)(this,n),(a=t.call(this,e))._topnum=0,a.declaredClass="esri.arcade.featureset.actions.Top",a._countedin=0,a._maxProcessing=100,a._topnum=e.topnum,a._parent=e.parentfeatureset,a}return Object(a.a)(n,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getSet(e)})).then((function(e){return t._wset=new o.a(e._candidates.slice(0),e._known.slice(0),!1,t._clonePageDefinition(e.pagesDefinition)),t._setKnownLength(t._wset)>t._topnum&&(t._wset._known=t._wset._known.slice(0,t._topnum)),t._setKnownLength(t._wset)>=t._topnum&&(t._wset._candidates=[]),t._wset})):Object(l.s)(this._wset)}},{key:"_setKnownLength",value:function(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?e._known.length-1:e._known.length}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);if(t===u.b.NotInFeatureSet)return t;var n=this._idstates[e];return n===u.b.InFeatureSet||n===u.b.NotInFeatureSet?n:t===u.b.InFeatureSet&&void 0===n?this._countedin<this._topnum?(this._idstates[e]=u.b.InFeatureSet,this._countedin++,u.b.InFeatureSet):(this._idstates[e]=u.b.NotInFeatureSet,u.b.NotInFeatureSet):u.b.Unknown}},{key:"_expandPagedSet",value:function(e,t,n,r,a){var i=this;if(null===this._parent)return Object(l.r)(new Error("Parent Paging not implemented"));if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){var s=e._known.length;return s>0&&"GETPAGES"===e._known[s-1]&&(e._known.length=s-1),(s=e._candidates.length)>0&&"GETPAGES"===e._candidates[s-1]&&(e._candidates.length=s-1),Object(l.s)("success")}return this._parent._expandPagedSet(e,t,n,r,a).then((function(t){return i._setKnownLength(e)>i._topnum&&(e._known.length=i._topnum),i._setKnownLength(e)>=i._topnum&&(e._candidates.length=0),t}))}},{key:"_getFeatures",value:function(e,t,n,r){var a=this,i=[],s=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,s))return this._expandPagedSet(e,s,0,0,r).then((function(){return a._getFeatures(e,t,n,r)}));-1!==t&&void 0===this._featureCache[t]&&i.push(t);for(var u=0,c=e._lastFetchedIndex;c<e._known.length&&(++u<=n&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[c]]&&(e._known[c]!==t&&i.push(e._known[c]),i.length>s-1)));c++);if(0===i.length)return Object(l.s)("success");var f=new o.a([],i,!1,null),d=Math.min(i.length,n);return this._parent._getFeatures(f,-1,d,r).then((function(){for(var e=0;e<d;e++){var t=a._parent._featureFromCache(i[e]);void 0!==t&&(a._featureCache[i[e]]=t)}return"success"}))}},{key:"_getFilteredSet",value:function(e,t,n,r,a){var i=this;return this._ensureLoaded().then((function(){return i._getSet(a)})).then((function(e){return new o.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!1,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_refineKnowns",value:function(e,t){for(var n=0,r=null,a=[],i=0;i<e._candidates.length;i++){var s=this._isInFeatureSet(e._candidates[i]);if(s===u.b.InFeatureSet){if(e._known.push(e._candidates[i]),n+=1,null===r?r={start:i,end:i}:r.end===i-1?r.end=i:(a.push(r),r={start:i,end:i}),e._known.length>=this._topnum)break}else if(s===u.b.NotInFeatureSet)null===r?r={start:i,end:i}:r.end===i-1?r.end=i:(a.push(r),r={start:i,end:i}),n+=1;else if(s===u.b.Unknown)break;if(n>=t)break}null!==r&&a.push(r);for(var l=a.length-1;l>=0;l--)e._candidates.splice(a[l].start,a[l].end-a[l].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])}},{key:"_stat",value:function(){return Object(l.s)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return Object(l.s)(!1)}}],[{key:"registerAction",value:function(){c.a._featuresetFunctions.top=function(e){return new n({parentfeatureset:this,topnum:e})}}}]),n}(c.a);t.a=f},984:function(e,t,n){"use strict";var r=n(15),a=n(2),i=n(4),s=n(5),l=n(6),u=n(16),o=n(107),c=n(242),f=n(320),d=n(866),h=n(869),p=n(875),y=n(871),v=n(446),_=n(376),g=n(853),b=function(e){Object(s.a)(n,e);var t=Object(l.a)(n);function n(e){var r;return Object(a.a)(this,n),(r=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",r._removeGeometry=!1,r._overrideFields=null,r._forceIsTable=!1,e.spatialReference&&(r.spatialReference=e.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=e.layer,r._wset=null,!0===e.isTable&&(r._forceIsTable=!0),void 0!==e.outFields&&(r._overrideFields=e.outFields),void 0!==e.includeGeometry&&(r._removeGeometry=!1===e.includeGeometry),r}return Object(i.a)(n,[{key:"_maxQueryRate",value:function(){return d.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(u.c)((function(t,n){if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(t){n(t)}}),n),e._layer.load()}))),this._loadPromise}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e,t=[],n=Object(r.a)(this.fields);try{for(n.s();!(e=n.n()).done;){var a=e.value;if("oid"===a.type)t.push(a);else{var i,s=Object(r.a)(this._layer.outFields);try{for(s.s();!(i=s.n()).done;){if(i.value.toLowerCase()===a.name.toLowerCase()){t.push(a);break}}}catch(g){s.e(g)}finally{s.f()}}}}catch(g){n.e(g)}finally{n.f()}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var l,u=[],o=[],c=Object(r.a)(this.fields);try{for(c.s();!(l=c.n()).done;){var f=l.value;if("oid"===f.type)u.push(f),o.push(f.name);else{var h,p=Object(r.a)(this._overrideFields);try{for(p.s();!(h=p.n()).done;){if(h.value.toLowerCase()===f.name.toLowerCase()){u.push(f),o.push(f.name);break}}}catch(g){p.e(g)}finally{p.f()}}}}catch(g){c.e(g)}finally{c.f()}this.fields=u,this._overrideFields=o}this.objectIdField=this._layer.objectIdField;var y,v=Object(r.a)(this.fields);try{for(v.s();!(y=v.n()).done;){var _=y.value;"global-id"===_.type&&(this.globalIdField=_.name)}}catch(g){v.e(g)}finally{v.f()}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=d.a.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"isTable",value:function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}},{key:"_isInFeatureSet",value:function(){return d.b.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(u.s)(this._wset)}},{key:"_changeFeature",value:function(e){var t,n={},a=Object(r.a)(this.fields);try{for(a.s();!(t=a.n()).done;){var i=t.value;n[i.name]=e.attributes[i.name]}}catch(s){a.e(s)}finally{a.f()}return new c.a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:n})}},{key:"_getFilteredSet",value:function(e,t,n,r,a){var i=this,s="",l=!1;if(null!==r&&(s=r.constructClause(),l=!0),this.isTable()&&t&&null!==e&&""!==e){var o=new h.a([],[],!0,null);return Object(u.s)(o)}var c=new _.a;return c.where=null===n?null===t?"1=1":"":Object(p.i)(n,d.a.Standardised),c.spatialRelationship=this._makeRelationshipEnum(e),c.outSpatialReference=this.spatialReference,c.orderByFields=""!==s?s.split(","):null,c.geometry=null===t?null:t,c.returnGeometry=!0,c.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(c).then((function(e){if(null===e)return new h.a([],[],l,null);i._checkCancelled(a);var t=[];return e.features.forEach((function(e){var n=e.attributes[i._layer.objectIdField];t.push(n),i._featureCache[n]=i._changeFeature(e)})),new h.a([],t,l,null)}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_queryAllFeatures",value:function(){var e=this;if(this._wset)return Object(u.s)(this._wset);var t=new _.a;return t.where="1=1",this._ensureLoaded().then((function(){if(e._layer.source&&e._layer.source.items){var n=[];return e._layer.source.items.forEach((function(t){var r=t.attributes[e._layer.objectIdField];n.push(r),e._featureCache[r]=e._changeFeature(t)})),e._wset=new h.a([],n,!1,null),e._wset}return e._layer.queryFeatures(t).then((function(t){var n=[];return t.features.forEach((function(t){var r=t.attributes[e._layer.objectIdField];n.push(r),e._featureCache[r]=e._changeFeature(t)})),e._wset=new h.a([],n,!1,null),e._wset}))}))}},{key:"_getFeatures",value:function(e,t,n){var r=[];-1!==t&&void 0===this._featureCache[t]&&r.push(t);for(var a=e._lastFetchedIndex;a<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[a]]&&(e._known[a]!==t&&r.push(e._known[a]),r.length>n)));a++);return 0===r.length?Object(u.s)("success"):Object(u.r)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e){return Object(u.s)(e)}},{key:"_stat",value:function(){return Object(u.s)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return Object(u.s)(!1)}},{key:"relationshipMetaData",value:function(){return[]}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}},{key:"queryAttachments",value:function(){return Object(u.s)([])}},{key:"getFeatureByObjectId",value:function(e){var t=new _.a;return t.where=this.objectIdField+"="+e.toString(),this._layer.queryFeatures(t).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getOwningSystemUrl",value:function(){return Object(u.s)("")}},{key:"getIdentityUser",value:function(){return Object(u.s)("")}},{key:"gdbVersion",get:function(){return""}}],[{key:"_cloneAttr",value:function(e){var t={};for(var n in e)t[n]=e[n];return t}},{key:"create",value:function(e,t){var a=e.layerDefinition.objectIdField,i=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",s=[];if(e.layerDefinition.types){var l,u=Object(r.a)(e.layerDefinition.types);try{for(u.s();!(l=u.n()).done;){var c=l.value;s.push(v.a.fromJSON(c))}}catch(G){u.e(G)}finally{u.f()}}var d=e.layerDefinition.geometryType;void 0===d&&(d=e.featureSet.geometryType||"");var h=e.featureSet.features,p=t.toJSON();if(""===a||void 0===a){var y,_=!1,b=Object(r.a)(e.layerDefinition.fields);try{for(b.s();!(y=b.n()).done;){var m=y.value;if("oid"===m.type||"esriFieldTypeOID"===m.type){a=m.name,_=!0;break}}}catch(G){b.e(G)}finally{b.f()}if(!1===_){for(var O="FID",j=!0,w=0;j;){var S,F=!0,k=Object(r.a)(e.layerDefinition.fields);try{for(k.s();!(S=k.n()).done;){if(S.value.name===O){F=!1;break}}}catch(G){k.e(G)}finally{k.f()}!0===F?j=!1:O="FID"+(++w).toString()}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:O,alias:O});for(var I=[],x=0;x<h.length;x++)I.push({geometry:e.featureSet.features[x].geometry,attributes:e.featureSet.features[x].attributes?this._cloneAttr(e.featureSet.features[x].attributes):{}}),I[x].attributes[O]=x;h=I,a=O}}var D,T=[],C=Object(r.a)(e.layerDefinition.fields);try{for(C.s();!(D=C.n()).done;){var E=D.value;E instanceof f.a?T.push(E):T.push(f.a.fromJSON(E))}}catch(G){C.e(G)}finally{C.f()}var R=d;switch(R){case"esriGeometryPoint":R="point";break;case"esriGeometryPolyline":R="polyline";break;case"esriGeometryPolygon":R="polygon";break;case"esriGeometryExtent":R="extent";break;case"esriGeometryMultipoint":R="multipoint"}var N,A=Object(r.a)(h);try{for(A.s();!(N=A.n()).done;){var P=N.value;P.geometry&&P.geometry instanceof o.a==0&&(P.geometry.type=R,void 0===P.geometry.spatialReference&&(P.geometry.spatialReference=p))}}catch(G){A.e(G)}finally{A.f()}var L={outFields:["*"],source:h,fields:T,types:s,typeIdField:i,objectIdField:a,spatialReference:t};return L.geometryType=R||"point",new n({layer:new g.default(L),spatialReference:t,isTable:null===R||""===R})}}]),n}(y.a);t.a=b}}]);
//# sourceMappingURL=29.5cc6c5fd.chunk.js.map